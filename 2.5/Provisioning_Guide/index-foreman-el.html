<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.18">
<title>Provisioning Guide</title>
<link rel="stylesheet" href="./foreman-el.css">
<!-- docinfo -->
</head>
<body class="book toc2 toc-left">
    <div id="wrap">
      <script src="/js/versions.js"></script>
      <script src="/js/nav.js"></script>
      <script>
        document.open();
        document.write(buildNavigation());
        addNavbarListeners();
        document.close();
      </script>
    </div>
<div id="header">
<h1>Provisioning Guide</h1>
<div class="details">
<span id="revnumber">version 2.5 (unsupported),</span>
<span id="revdate">published Feb 22 2023</span>
</div>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#provisioning-introduction">1. Introduction</a>
<ul class="sectlevel2">
<li><a href="#provisioning-overview_provisioning">1.1. Provisioning Overview</a></li>
<li><a href="#provisioning-workflow_provisioning">1.2. Network Boot Provisioning Workflow</a></li>
</ul>
</li>
<li><a href="#configuring-provisioning-resources">2. Configuring Provisioning Resources</a>
<ul class="sectlevel2">
<li><a href="#provisioning-contexts_provisioning">2.1. Provisioning Contexts</a></li>
<li><a href="#setting-the-provisioning-context_provisioning">2.2. Setting the Provisioning Context</a></li>
<li><a href="#creating-operating-systems_provisioning">2.3. Creating Operating Systems</a></li>
<li><a href="#updating-the-details-of-multiple-operating-systems_provisioning">2.4. Updating the Details of Multiple Operating Systems</a></li>
<li><a href="#creating-architectures_provisioning">2.5. Creating Architectures</a></li>
<li><a href="#creating-hardware-models_provisioning">2.6. Creating Hardware Models</a></li>
<li><a href="#using-a-synced-kickstart-repository_provisioning">2.7. Using a Synced Kickstart Repository for a Host&#8217;s Operating System</a></li>
<li><a href="#adding-installation-media_provisioning">2.8. Adding Installation Media to Foreman</a></li>
<li><a href="#creating-partition-tables_provisioning">2.9. Creating Partition Tables</a></li>
<li><a href="#dynamic-partition-example_provisioning">2.10. Dynamic Partition Example</a></li>
<li><a href="#provisioning-templates_provisioning">2.11. Provisioning Templates</a></li>
<li><a href="#types-of-provisioning-templates_provisioning">2.12. Types of Provisioning Templates</a></li>
<li><a href="#creating-provisioning-templates_provisioning">2.13. Creating Provisioning Templates</a></li>
<li><a href="#cloning-provisioning-templates_provisioning">2.14. Cloning Provisioning Templates</a></li>
<li><a href="#creating-compute-profiles_provisioning">2.15. Creating Compute Profiles</a></li>
<li><a href="#setting-a-default-encrypted-root-password_provisioning">2.16. Setting a Default Encrypted Root Password for Hosts</a></li>
<li><a href="#using-novnc-to-access-virtual-machines_provisioning">2.17. Using noVNC to Access Virtual Machines</a></li>
</ul>
</li>
<li><a href="#Configuring_Networking">3. Configuring Networking</a>
<ul class="sectlevel2">
<li><a href="#networking_resources">3.1. Network Resources</a></li>
<li><a href="#_foreman_and_dhcp_options">3.2. Foreman and DHCP Options</a></li>
<li><a href="#_troubleshooting_dhcp_problems_in_foreman">3.3. Troubleshooting DHCP Problems in Foreman</a></li>
<li><a href="#_prerequisites_for_image_based_provisioning">3.4. Prerequisites for Image Based Provisioning</a></li>
<li><a href="#Configuring_Networking-Configuring_Network_Services_for_PXE_Boot">3.5. Configuring Network Services</a></li>
<li><a href="#Configuring_Networking-Adding_a_Domain_to_the_Satellite_Server">3.6. Adding a Domain to Foreman&#160;server</a></li>
<li><a href="#Configuring_Networking-Adding_a_Subnet_to_the_Satellite_Server">3.7. Adding a Subnet to Foreman&#160;server</a></li>
</ul>
</li>
<li><a href="#chap-Infoblox-Integration">4. Using Infoblox as DHCP and DNS Providers</a>
<ul class="sectlevel2">
<li><a href="#_limitations">4.1. Limitations</a></li>
<li><a href="#_prerequisites">4.2. Prerequisites</a></li>
<li><a href="#_installing_the_infoblox_ca_certificate_on_smartproxyserver">4.3. Installing the Infoblox CA Certificate on Smart&#160;Proxy&#160;server</a></li>
<li><a href="#Infoblox-Integration-Installing_the_DHCP_Infoblox_Module">4.4. Installing the DHCP Infoblox module</a></li>
<li><a href="#Infoblox-Integration-Installing_the_DNS_Infoblox_Module">4.5. Installing the DNS Infoblox Module</a></li>
</ul>
</li>
<li><a href="#Configuring_Networking-Configuring_gPXE_to_Reduce_Provisioning_Times">5. Configuring iPXE to Reduce Provisioning Times</a>
<ul class="sectlevel2">
<li><a href="#_booting_virtual_machines">5.1. Booting virtual machines</a></li>
<li><a href="#_chainbooting_ipxe_from_pxelinux">5.2. Chainbooting iPXE from PXELinux</a></li>
</ul>
</li>
<li><a href="#Using_PXE_to_Provision_Hosts">6. Using PXE to Provision Hosts</a>
<ul class="sectlevel2">
<li><a href="#Provisioning_Bare_Metal_Hosts-Prerequisites_for_Bare_Metal_Provisioning">6.1. Prerequisites for Bare Metal Provisioning</a></li>
<li><a href="#Provisioning_Bare_Metal_Hosts-Security_Token_in_the_Boot_Process">6.2. Configuring the Security Token Validity Duration</a></li>
<li><a href="#Provisioning_Bare_Metal_Hosts-Creating_New_Hosts_with_Unattended_Provisioning">6.3. Creating Hosts with Unattended Provisioning</a></li>
<li><a href="#Provisioning_Bare_Metal_Hosts-Creating_New_Hosts_with_PXE-less_Provisioning">6.4. Creating Hosts with PXE-less Provisioning</a></li>
<li><a href="#creating-hosts-with-uefi-http-boot-provisioning_provisioning">6.5. Creating Hosts with UEFI HTTP Boot Provisioning</a></li>
<li><a href="#Configuring_Provisioning_Resources-Creating_Provisioning_Templates-Deploying_SSH_Keys_during_Provisioning">6.6. Deploying SSH Keys during Provisioning</a></li>
</ul>
</li>
<li><a href="#configuring-the-discovery-service">7. Configuring the Discovery Service</a>
<ul class="sectlevel2">
<li><a href="#installing-the-discovery-service">7.1. Installing the Discovery Service</a></li>
<li><a href="#the-provisioning-template-pxelinux-discovery-snippet">7.2. The Provisioning Template PXELinux Discovery Snippet</a></li>
<li><a href="#automatic-contexts-for-discovered-hosts">7.3. Automatic Contexts for Discovered Hosts</a></li>
<li><a href="#discovery-templates-and-snippets-settings">7.4. Discovery Templates and Snippets Settings</a></li>
<li><a href="#creating-hosts-from-discovered-hosts">7.5. Creating Hosts from Discovered Hosts</a></li>
<li><a href="#creating-discovery-rules">7.6. Creating Discovery Rules</a></li>
<li><a href="#implementing-pxe-less-discovery">7.7. Implementing PXE-less Discovery</a></li>
<li><a href="#building-a-discovery-image">7.8. Building a Discovery Image</a></li>
<li><a href="#unattended-use-and-customization">7.9. Unattended Use, Customization, and Image Remastering</a></li>
<li><a href="#Extending_the_Discovery_Image">7.10. Extending the Discovery Image</a></li>
<li><a href="#troubleshooting-discovery-problems">7.11. Troubleshooting Discovery</a></li>
</ul>
</li>
<li><a href="#using-an-image-builder-image-for-provisioning">8. Using a Lorax Composer Image for Provisioning</a></li>
<li><a href="#provisioning-virtual-machines-kvm_provisioning">9. Provisioning Virtual Machines on KVM (libvirt)</a>
<ul class="sectlevel2">
<li><a href="#configuring-server-for-kvm-connections_kvm-provisioning">9.1. Configuring Foreman&#160;server for KVM Connections</a></li>
<li><a href="#adding-kvm-connection_kvm-provisioning">9.2. Adding a KVM Connection to Foreman&#160;server</a></li>
<li><a href="#adding-images-to-server_kvm-provisioning">9.3. Adding KVM Images to Foreman&#160;server</a></li>
<li><a href="#adding-kvm-details-to-a-compute-profile_kvm-provisioning">9.4. Adding KVM Details to a Compute Profile</a></li>
<li><a href="#creating-network-or-image-based-hosts_kvm-provisioning">9.5. Creating Hosts on KVM</a></li>
</ul>
</li>
<li><a href="#provisioning-virtual-machines-rhv_provisioning">10. Provisioning Virtual Machines on oVirt</a>
<ul class="sectlevel2">
<li><a href="#adding-rhv-connection_rhv-provisioning">10.1. Adding the oVirt Connection to Foreman&#160;server</a></li>
<li><a href="#preparing-cloud-init-images-in-rhv_rhv-provisioning">10.2. Preparing Cloud-init Images in oVirt</a></li>
<li><a href="#adding-images-to-server_rhv-provisioning">10.3. Adding oVirt Images to Foreman&#160;server</a></li>
<li><a href="#preparing-a-cloud-init-template_rhv-provisioning">10.4. Preparing a Cloud-init Template</a></li>
<li><a href="#adding-rhv-details-to-a-compute-profile_rhv-provisioning">10.5. Adding oVirt Details to a Compute Profile</a></li>
<li><a href="#creating-network-or-image-based-hosts_rhv-provisioning">10.6. Creating Hosts on oVirt</a></li>
</ul>
</li>
<li><a href="#Provisioning_Virtual_Machines_in_VMware_vSphere">11. Provisioning Virtual Machines in VMware vSphere</a>
<ul class="sectlevel2">
<li><a href="#Provisioning_Virtual_Machines_in_VMware_vSphere-Prerequisites_for_VMware_vSphere_Provisioning">11.1. Prerequisites for VMware vSphere Provisioning</a></li>
<li><a href="#Provisioning_Virtual_Machines_in_VMware_vSphere-Creating_a_VMware_vSphere_User">11.2. Creating a VMware vSphere User</a></li>
<li><a href="#Provisioning_Virtual_Machines_in_VMware_vSphere-Adding_a_VMware_vSphere_Connection_to_the_Satellite_Server">11.3. Adding a VMware vSphere Connection to Foreman&#160;server</a></li>
<li><a href="#Provisioning_Virtual_Machines_in_VMware_vSphere-Adding_VMware_vSphere_Images_on_the_Satellite_Server">11.4. Adding VMware vSphere Images to Foreman&#160;server</a></li>
<li><a href="#Provisioning_Virtual_Machines_in_VMware_vSphere-Adding_VMware_vSphere_Details_to_a_Compute_Profile">11.5. Adding VMware vSphere Details to a Compute Profile</a></li>
<li><a href="#Provisioning_Virtual_Machines_in_VMware_vSphere-Creating_Hosts_on_a_VMware_vSphere_Server">11.6. Creating Hosts on a VMware vSphere Server</a></li>
<li><a href="#Provisioning_Virtual_Machines_in_VMware_vSphere-Provisioning_with_cloudinit_and_userdata_templates">11.7. Using the VMware vSphere Cloud-init and Userdata Templates for Provisioning</a></li>
<li><a href="#Provisioning_Virtual_Machines_in_VMware_vSphere-Caching_of_Compute_resources">11.8. Caching of Compute Resources</a></li>
</ul>
</li>
<li><a href="#provisioning-virtual-machines-kubevirt_provisioning">12. Provisioning Virtual Machines on KubeVirt</a>
<ul class="sectlevel2">
<li><a href="#adding-kubevirt-connection_kubevirt-provisioning">12.1. Adding a KubeVirt Connection to Foreman&#160;server</a></li>
</ul>
</li>
<li><a href="#provisioning-cloud-instances-openstack_provisioning">13. Provisioning Cloud Instances on OpenStack</a>
<ul class="sectlevel2">
<li><a href="#adding-openstack-connection_openstack-provisioning">13.1. Adding the OpenStack Connection to Foreman&#160;server</a></li>
<li><a href="#adding-images-to-server_openstack-provisioning">13.2. Adding OpenStack Images to Foreman&#160;server</a></li>
<li><a href="#adding-openstack-details-to-a-compute-profile_openstack-provisioning">13.3. Adding OpenStack Details to a Compute Profile</a></li>
<li><a href="#creating-image-only-hosts_openstack-provisioning">13.4. Creating Image-based Hosts on OpenStack</a></li>
</ul>
</li>
<li><a href="#Provisioning_Cloud_Instances_in_Amazon_EC2">14. Provisioning Cloud Instances in Amazon EC2</a>
<ul class="sectlevel2">
<li><a href="#Provisioning_Cloud_Instances_in_Amazon_EC2-Prerequisites_for_Amazon_EC2_Provisioning">14.1. Prerequisites for Amazon EC2 Provisioning</a></li>
<li><a href="#Provisioning_Cloud_Instances_in_Amazon_EC2-Adding_a_Amazon_EC2_Connection_to_the_Satellite_Server">14.2. Adding an Amazon EC2 Connection to the Foreman&#160;server</a></li>
<li><a href="#Provisioning_Cloud_Instances_in_Amazon_EC2-Using-an-HTTP-Smart-Proxy">14.3. Using an HTTP Proxy with Compute Resources</a></li>
<li><a href="#Provisioning_Cloud_Instances_in_Amazon_EC2-Adding_Amazon_EC2_Images_on_the_Satellite_Server">14.4. Adding Amazon EC2 Images to Foreman&#160;server</a></li>
<li><a href="#Provisioning_Cloud_Instances_in_Amazon_EC2-Adding_Amazon_EC2_Details_to_a_Compute_Profile">14.5. Adding Amazon EC2 Details to a Compute Profile</a></li>
<li><a href="#Provisioning_Cloud_Instances_in_Amazon_EC2-Creating_Image_Based_Hosts_on_Amazon_EC2">14.6. Creating Image-Based Hosts on Amazon EC2</a></li>
<li><a href="#connecting_to_an_Amazon_EC2_instance_using_SSH">14.7. Connecting to an Amazon EC2 instance using SSH</a></li>
<li><a href="#_configuring_a_finish_template_for_an_amazon_web_service_ec2_environment">14.8. Configuring a Finish Template for an Amazon Web Service EC2 Environment</a></li>
<li><a href="#_more_information_about_amazon_web_services_and_foreman">14.9. More Information about Amazon Web Services and Foreman</a></li>
</ul>
</li>
<li><a href="#provisioning-cloud-instances-gce_provisioning">15. Provisioning Cloud Instances on Google Compute Engine</a>
<ul class="sectlevel2">
<li><a href="#adding-gce-connection_gce-provisioning">15.1. Adding a Google Compute Engine Connection to Foreman&#160;server</a></li>
<li><a href="#adding-images-to-server_gce-provisioning">15.2. Adding Google Compute Engine Images to Foreman&#160;server</a></li>
<li><a href="#adding-gce-details-to-a-compute-profile_gce-provisioning">15.3. Adding Google Compute Engine Details to a Compute Profile</a></li>
<li><a href="#creating-image-only-hosts_gce-provisioning">15.4. Creating Image-based Hosts on Google Compute Engine</a></li>
</ul>
</li>
<li><a href="#provisioning-cloud-instances-azure_provisioning">16. Provisioning Cloud Instances on Microsoft Azure Resource Manager</a>
<ul class="sectlevel2">
<li><a href="#installing-the-azurerm-plugin_azure-provisioning">16.1. Installing the Foreman AzureRm Plug-in</a></li>
<li><a href="#adding-azure-connection_azure-provisioning">16.2. Adding a Microsoft Azure Resource Manager Connection to Foreman&#160;server</a></li>
<li><a href="#adding-images-to-server_azure-provisioning">16.3. Adding Microsoft Azure Resource Manager Images to Foreman&#160;server</a></li>
<li><a href="#adding-azure-details-to-a-compute-profile_azure-provisioning">16.4. Adding Microsoft Azure Resource Manager Details to a Compute Profile</a></li>
<li><a href="#creating-image-only-hosts_azure-provisioning">16.5. Creating Image-based Hosts on Microsoft Azure Resource Manager</a></li>
</ul>
</li>
<li><a href="#Initialization_Script_for_Provisioning_Examples">Appendix A: Initialization Script for Provisioning Examples</a></li>
<li><a href="#Provision_FIPS_Hosts">Appendix B: Provisioning FIPS-Compliant Hosts</a>
<ul class="sectlevel2">
<li><a href="#_change_the_provisioning_password_hashing_algorithm">B.1. Change the Provisioning Password Hashing Algorithm</a></li>
<li><a href="#_setting_the_fips_enabled_parameter">B.2. Setting the FIPS-Enabled Parameter</a></li>
<li><a href="#verifying_fips_mode_enabled">B.3. Verifying FIPS Mode is Enabled</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div class="sect1">
<h2 id="provisioning-introduction">1. Introduction</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="provisioning-overview_provisioning">1.1. Provisioning Overview</h3>
<div class="paragraph">
<p>Provisioning is a process that starts with a bare physical or virtual machine and ends with a fully configured, ready-to-use operating system.
Using Foreman, you can define and automate fine-grained provisioning for a large number of hosts.</p>
</div>
<div class="paragraph">
<p>There are many provisioning methods.
For example, you can use Foreman&#160;server&#8217;s integrated Smart&#160;Proxy or an external Smart&#160;Proxy&#160;server to provision bare metal hosts using both PXE based and non-PXE based methods.
You can also provision cloud instances from specific providers through their APIs.
These provisioning methods are part of the Foreman application life cycle to create, manage, and update hosts.</p>
</div>
<div class="paragraph">
<p>Foreman has different methods for provisioning hosts:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Bare Metal Provisioning</dt>
<dd>
<p>Foreman provisions bare metal hosts primarily through PXE boot and MAC address identification.
You can create host entries and specify the MAC address of the physical host to provision.
You can also boot blank hosts to use Foreman&#8217;s discovery service, which creates a pool of ready-to-provision hosts.
You can also boot and provision hosts through PXE-less methods.</p>
</dd>
<dt class="hdlist1">Cloud Providers</dt>
<dd>
<p>Foreman connects to private and public cloud providers to provision instances of hosts from images that are stored with the Cloud environment.
This also includes selecting which hardware profile or flavor to use.</p>
</dd>
<dt class="hdlist1">Virtualization Infrastructure</dt>
<dd>
<p>Foreman connects to virtualization infrastructure services such as oVirt and VMware to provision virtual machines from virtual image templates or using the same PXE-based boot methods as bare metal providers.</p>
</dd>
</dl>
</div>
</div>
<div class="sect2">
<h3 id="provisioning-workflow_provisioning">1.2. Network Boot Provisioning Workflow</h3>
<div class="paragraph">
<p>PXE booting assumes that a host, either physical or virtual, is configured to boot from network as the first booting device, and from the hard drive as the second booting device.</p>
</div>
<div class="paragraph">
<p>The provisioning process follows a basic PXE workflow:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>You create a host and select a domain and subnet.
Foreman requests an available IP address from the DHCP Smart&#160;Proxy&#160;server that is associated with the subnet or from the PostgreSQL database in Foreman.
Foreman loads this IP address into the <strong>IP address</strong> field in the Create Host window.
When you complete all the options for the new host, submit the new host request.</p>
</li>
<li>
<p>Depending on the configuration specifications of the host and its domain and subnet, Foreman creates the following settings:</p>
<div class="ulist">
<ul>
<li>
<p>A DHCP record on Smart&#160;Proxy&#160;server that is associated with the subnet.</p>
</li>
<li>
<p>A forward DNS record on Smart&#160;Proxy&#160;server that is associated with the domain.</p>
</li>
<li>
<p>A reverse DNS record on the DNS Smart&#160;Proxy&#160;server that is associated with the subnet.</p>
</li>
<li>
<p>PXELinux, Grub, Grub2, and iPXE configuration files for the host in the TFTP Smart&#160;Proxy&#160;server that is associated with the subnet.</p>
</li>
<li>
<p>A Puppet certificate on the associated Puppet server.</p>
</li>
<li>
<p>A realm on the associated identity server.</p>
</li>
</ul>
</div>
</li>
<li>
<p>The new host requests a DHCP reservation from the DHCP server.</p>
</li>
<li>
<p>The DHCP server responds to the reservation request and returns TFTP <code>next-server</code> and <code>filename</code> options.</p>
</li>
<li>
<p>The host requests the boot loader and menu from the TFTP server according to the PXELoader setting.</p>
</li>
<li>
<p>A boot loader is returned over TFTP.</p>
</li>
<li>
<p>The boot loader fetches configuration for the host through its provisioning interface MAC address.</p>
</li>
<li>
<p>The boot loader fetches the operating system installer kernel, init RAM disk, and boot parameters.</p>
</li>
<li>
<p>The installer requests the provisioning template from Foreman.</p>
</li>
<li>
<p>Foreman renders the provision template and returns the result to the host.</p>
</li>
<li>
<p>The installer performs installation of the operating system.</p>
<div class="ulist">
<ul>
<li>
<p>When Katello plugin is installed, the installer registers the host to Foreman using Red Hat Subscription Manager.</p>
</li>
<li>
<p>When Katello plugin is installed, management tools such as <code>katello-agent</code> and <code>puppet</code> are installed.</p>
</li>
<li>
<p>The installer notifies Foreman of a successful build in the <code>postinstall</code> script.</p>
</li>
</ul>
</div>
</li>
<li>
<p>The PXE configuration files revert to a local boot template.</p>
</li>
<li>
<p>The host reboots.</p>
</li>
<li>
<p>The new host requests a DHCP reservation from the DHCP server.</p>
</li>
<li>
<p>The DHCP server responds to the reservation request and returns TFTP <code>next-server</code> and <code>filename</code> options.</p>
</li>
<li>
<p>The host requests the bootloader and menu from the TFTP server according to the PXELoader setting.</p>
</li>
<li>
<p>A boot loader is returned over TFTP.</p>
</li>
<li>
<p>The boot loader fetches the configuration for the host through its provision interface MAC address.</p>
</li>
<li>
<p>The boot loader initiates boot from the local drive.</p>
</li>
<li>
<p>If you configured the host to use any Puppet classes, the host configures itself using the modules.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>This workflow differs depending on custom options.
For example:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Discovery</dt>
<dd>
<p>If you use the discovery service, Foreman automatically detects the MAC address of the new host and restarts the host after you submit a request.
Note that TCP port 8443 must be reachable by the Smart&#160;Proxy to which the host is attached for Foreman to restart the host.</p>
</dd>
<dt class="hdlist1">PXE-less Provisioning</dt>
<dd>
<p>After you submit a new host request, you must boot the specific host with the boot disk that you download from Foreman and transfer using a USB port of the host.</p>
</dd>
<dt class="hdlist1">Compute Resources</dt>
<dd>
<p>Foreman creates the virtual machine and retrieves the MAC address and stores the MAC address in Foreman.
If you use image-based provisioning, the host does not follow the standard PXE boot and operating system installation.
The compute resource creates a copy of the image for the host to use.
Depending on image settings in Foreman, seed data can be passed in for initial configuration, for example using <code>cloud-init</code>.
Foreman can connect using SSH to the host and execute a template to finish the customization.</p>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>By default, deleting the provisioned profile host from Foreman does not destroy the actual VM on the external compute resource.
To destroy the VM when deleting the host entry on Foreman, navigate to <strong>Administer</strong> &gt; <strong>Settings</strong> &gt; <strong>Provisioning</strong> and configure this behavior using the <strong>destroy_vm_on_host_delete</strong> setting.
If you do not destroy the associated VM and attempt to create a new VM with the same resource name later, it will fail because that VM name already exists in the external compute resource.
You can still register the existing VM to Foreman using the standard host registration workflow you would use for any already provisioned host.</p>
</div>
</td>
</tr>
</table>
</div>
</dd>
</dl>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="configuring-provisioning-resources">2. Configuring Provisioning Resources</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="provisioning-contexts_provisioning">2.1. Provisioning Contexts</h3>
<div class="paragraph">
<p>A provisioning context is the combination of an organization and location that you specify for Foreman components.
The organization and location that a component belongs to sets the ownership and access for that component.</p>
</div>
<div class="paragraph">
<p>Organizations divide Foreman components into logical groups based on ownership, purpose, content, security level, and other divisions.
You can create and manage multiple organizations through Foreman and assign components to each individual organization.
This ensures Foreman&#160;server provisions hosts within a certain organization and only uses components that are assigned to that organization.
For more information about organizations, see <a href="https://docs.theforeman.org/2.5/Content_Management_Guide/index-foreman-el.html#Managing_Organizations">Managing Organizations</a> in the <em>Content Management Guide</em>.</p>
</div>
<div class="paragraph">
<p>Locations function similar to organizations.
The difference is that locations are based on physical or geographical setting.
Users can nest locations in a hierarchy.
For more information about locations, see <a href="https://docs.theforeman.org/2.5/Content_Management_Guide/index-foreman-el.html#Managing_Locations">Managing Locations</a> in the <em>Content Management Guide</em>.</p>
</div>
</div>
<div class="sect2">
<h3 id="setting-the-provisioning-context_provisioning">2.2. Setting the Provisioning Context</h3>
<div class="paragraph">
<p>When you set a provisioning context, you define which organization and location to use for provisioning hosts.</p>
</div>
<div class="paragraph">
<p>The organization and location menus are located in the menu bar, on the upper left of the Foreman web UI.
If you have not selected an organization and location to use, the menu displays: <strong>Any Organization</strong> and <strong>Any Location</strong>.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Click <strong>Any Organization</strong> and select the organization.</p>
</li>
<li>
<p>Click <strong>Any Location</strong> and select the location to use.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Each user can set their default provisioning context in their account settings.
Click the user name in the upper right of the Foreman web UI and select <strong>My account</strong> to edit your user account settings.</p>
</div>
<div class="ulist">
<div class="title">CLI procedure</div>
<ul>
<li>
<p>When using the CLI, include either <code>--organization</code> or <code>--organization-label</code> and <code>--location</code> or <code>--location-id</code> as an option.
For example:</p>
<div class="listingblock">
<div class="content">
<pre># hammer host list --organization "Default_Organization" --location "Default_Location"</pre>
</div>
</div>
<div class="paragraph">
<p>This command outputs hosts allocated for the Default_Organization and Default_Location.</p>
</div>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="creating-operating-systems_provisioning">2.3. Creating Operating Systems</h3>
<div class="paragraph">
<p>An operating system is a collection of resources that define how Foreman&#160;server installs a base operating system on a host.
Operating system entries combine previously defined resources, such as installation media, partition tables, provisioning templates, and others.</p>
</div>
<div class="paragraph">
<p>Importing operating systems from Red Hat&#8217;s CDN creates new entries on the <strong>Hosts</strong> &gt; <strong>Operating Systems</strong> page.
Importing operating systems from Red Hat&#8217;s CDN is only possible when Katello is installed.</p>
</div>
<div class="paragraph">
<p>You can also add custom operating systems using the following procedure.
To use the CLI instead of the web UI, see the <a href="#cli-creating-operating-systems_provisioning">CLI procedure</a>.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>In the Foreman web UI, navigate to <strong>Hosts</strong> &gt; <strong>Operating systems</strong> and click <strong>New Operating</strong> system.</p>
</li>
<li>
<p>In the <strong>Name</strong> field, enter a name to represent the operating system entry.</p>
</li>
<li>
<p>In the <strong>Major</strong> field, enter the number that corresponds to the major version of the operating system.</p>
</li>
<li>
<p>In the <strong>Minor</strong> field, enter the number that corresponds to the minor version of the operating system.</p>
</li>
<li>
<p>In the <strong>Description</strong> field, enter a description of the operating system.</p>
</li>
<li>
<p>From the <strong>Family</strong> list, select the operating system&#8217;s family.</p>
</li>
<li>
<p>From the <strong>Root Password Hash</strong> list, select the encoding method for the root password.</p>
</li>
<li>
<p>From the <strong>Architectures</strong> list, select the architectures that the operating system uses.</p>
</li>
<li>
<p>Click the <strong>Partition table</strong> tab and select the possible partition tables that apply to this operating system.</p>
</li>
<li>
<p>Click the Installation Media tab and enter the information for the installation media source.
For more information, see <a href="https://docs.theforeman.org/2.5/Provisioning_Guide/index-foreman-el.html#adding-installation-media_provisioning">Adding Installation Media to Foreman</a>.</p>
</li>
<li>
<p>Click the <strong>Templates</strong> tab and select a <strong>PXELinux template</strong>, a <strong>Provisioning template</strong>, and a <strong>Finish template</strong> for your operating system to use.
You can select other templates, for example an <strong>iPXE template</strong>, if you plan to use iPXE for provisioning.</p>
</li>
<li>
<p>Click <strong>Submit</strong> to save your provisioning template.</p>
</li>
</ol>
</div>
<div id="cli-creating-operating-systems_provisioning" class="ulist">
<div class="title">CLI procedure</div>
<ul>
<li>
<p>Create the operating system using the <code>hammer os create</code> command:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># hammer os create --name "<em>MyOS</em>" \
--description "<em>My_custom_operating_system</em>" \
--major 7 --minor 3 --family "Redhat" --architectures "x86_64" \
--partition-tables "<em>My_Partition</em>" --media "<em>Red_Hat</em>" \
--provisioning-templates "<em>My_Provisioning_Template</em>"</pre>
</div>
</div>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="updating-the-details-of-multiple-operating-systems_provisioning">2.4. Updating the Details of Multiple Operating Systems</h3>
<div class="paragraph">
<p>Use this procedure to update the details of multiple operating systems.
This example shows you how to assign each operating system a partition table called <code>Kickstart default</code>, a configuration template called <code>Kickstart default PXELinux</code>, and a provisioning template called <code>Kickstart Default</code>.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>On Foreman&#160;server, run the following Bash script:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-Bash" data-lang="Bash">PARTID=$(hammer --csv partition-table list | grep "Kickstart default," | cut -d, -f1)
PXEID=$(hammer --csv template list --per-page=1000 | grep "Kickstart default PXELinux" | cut -d, -f1)
SATID=$(hammer --csv template list --per-page=1000 | grep "provision" | grep ",Kickstart default" | cut -d, -f1)

for i in $(hammer --no-headers --csv os list | awk -F, {'print $1'})
do
   hammer partition-table add-operatingsystem --id="${PARTID}" --operatingsystem-id="${i}"
   hammer template add-operatingsystem --id="${PXEID}" --operatingsystem-id="${i}"
   hammer os set-default-template --id="${i}" --config-template-id=${PXEID}
   hammer os add-config-template --id="${i}" --config-template-id=${SATID}
   hammer os set-default-template --id="${i}" --config-template-id=${SATID}
done</code></pre>
</div>
</div>
</li>
<li>
<p>Display information about the updated operating system to verify that the operating system is updated correctly:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># hammer os info --id <em>1</em></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="creating-architectures_provisioning">2.5. Creating Architectures</h3>
<div class="paragraph">
<p>An architecture in Foreman represents a logical grouping of hosts and operating systems.
Architectures are created by Foreman automatically when hosts check in with Puppet.
Basic i386 and x86_64 architectures are already preset in Foreman.</p>
</div>
<div class="paragraph">
<p>Use this procedure to create an architecture in Foreman.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>In the Foreman web UI, navigate to <strong>Hosts</strong> &gt; <strong>Architectures</strong> and click <strong>Create Architecture</strong>.</p>
</li>
<li>
<p>In the <strong>Name</strong> field, enter a name for the architecture.</p>
</li>
<li>
<p>From the <strong>Operating Systems</strong> list, select an operating system.
If none are available, you can create and assign them under <strong>Hosts</strong> &gt; <strong>Operating Systems</strong>.</p>
</li>
<li>
<p>Click <strong>Submit</strong>.</p>
</li>
</ol>
</div>
<div class="ulist">
<div class="title">CLI procedure</div>
<ul>
<li>
<p>Enter the <code>hammer architecture create</code> command to create an architecture.
Specify its name and operating systems that include this architecture:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># hammer architecture create --name "<em>Architecture_Name</em>" \
--operatingsystems "<em>os</em>"</pre>
</div>
</div>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="creating-hardware-models_provisioning">2.6. Creating Hardware Models</h3>
<div class="paragraph">
<p>Use this procedure to create a hardware model in Foreman so that you can specify which hardware model a host uses.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>In the Foreman web UI, navigate to <strong>Hosts</strong> &gt; <strong>Hardware Models</strong> and click <strong>Create Model</strong>.</p>
</li>
<li>
<p>In the <strong>Name</strong> field, enter a name for the hardware model.</p>
</li>
<li>
<p>Optionally, in the <strong>Hardware Model</strong> and <strong>Vendor Class</strong> fields, you can enter corresponding information for your system.</p>
</li>
<li>
<p>In the <strong>Info</strong> field, enter a description of the hardware model.</p>
</li>
<li>
<p>Click <strong>Submit</strong> to save your hardware model.</p>
</li>
</ol>
</div>
<div class="ulist">
<div class="title">CLI procedure</div>
<ul>
<li>
<p>Create a hardware model using the <code>hammer model create</code> command.
The only required parameter is <code>--name</code>.
Optionally, enter the hardware model with the <code>--hardware-model</code> option, a vendor class with the <code>--vendor-class</code> option, and a description with the <code>--info</code> option:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># hammer model create --name "<em>model_name</em>" --info "<em>description</em>" \
--hardware-model "<em>hardware_model</em>" --vendor-class "<em>vendor_class</em>"</pre>
</div>
</div>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="using-a-synced-kickstart-repository_provisioning">2.7. Using a Synced Kickstart Repository for a Host&#8217;s Operating System</h3>
<div class="paragraph">
<p>The following feature is provided by the Katello plug-in.</p>
</div>
<div class="paragraph">
<p>Foreman contains a set of synchronized kickstart repositories that you use to install the provisioned host&#8217;s operating system.
For more information about adding repositories, see <a href="https://docs.theforeman.org/2.5/Content_Management_Guide/index-foreman-el.html#Importing_Content-Synchronizing_Repositories">Syncing Repositories</a> in the <em>Content Management Guide</em>.</p>
</div>
<div class="paragraph">
<p>Use this procedure to set up a kickstart repository.</p>
</div>
<div class="paragraph">
<div class="title">Prerequisites</div>
<p>You must enable both <strong>BaseOS</strong> and <strong>Appstream Kickstart</strong> before provisioning.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Add the synchronized kickstart repository that you want to use to the existing Content View, or create a new Content View and add the kickstart repository.</p>
<div class="paragraph">
<p>For Red&#160;Hat Enterprise Linux 8, ensure that you add both <strong>Red&#160;Hat Enterprise Linux 8 for x86_64 - AppStream Kickstart x86_64 8</strong> and <strong>Red&#160;Hat Enterprise Linux 8 for x86_64 - BaseOS Kickstart x86_64 8</strong> repositories.</p>
</div>
</li>
<li>
<p>Publish a new version of the Content View where the kickstart repository is added and promote it to a required lifecycle environment.
For more information, see <a href="https://docs.theforeman.org/2.5/Content_Management_Guide/index-foreman-el.html#Managing_Content_Views">Managing Content Views</a> in the <em>Content Management Guide</em>.</p>
</li>
<li>
<p>When you create a host, in the <strong>Operating System</strong> tab, for <strong>Media Selection</strong>, select the <strong>Synced Content</strong> check box.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>To view the kickstart tree, enter the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre># hammer medium list --organization "<em>your_organization</em>"</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="adding-installation-media_provisioning">2.8. Adding Installation Media to Foreman</h3>
<div class="paragraph">
<p>Installation media are sources of packages that Foreman&#160;server uses to install a base operating system on a machine from an external repository.
When you install the Katello plug-in, you can download packages from a Pulp mirror.
In this case, installation media are ignored.</p>
</div>
<div class="paragraph">
<p>Installation media must be in the format of an operating system installation tree, and must be accessible to the machine hosting the installer through an HTTP URL.
You can view installation media by navigating to <strong>Hosts</strong> &gt; <strong>Installation Media</strong> menu.</p>
</div>
<div class="paragraph">
<p>By default, Foreman includes installation media for some official Linux distributions.
Note that some of those installation media are targeted for a specific version of an operating system.
For example <strong>CentOS mirror (7.x)</strong> must be used for CentOS 7 or earlier, and <strong>CentOS mirror (8.x)</strong> must be used for CentOS 8 or later.</p>
</div>
<div class="paragraph">
<p>If you want to improve download performance when using installation media to install operating systems on multiple host, you must modify the installation medium&#8217;s <strong>Path</strong> to point to the closest mirror or a local copy.</p>
</div>
<div class="paragraph">
<p>To use the CLI instead of the web UI, see the <a href="#cli-adding-installation-media_provisioning">CLI procedure</a>.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>In the Foreman web UI, navigate to <strong>Hosts</strong> &gt; <strong>Installation Media</strong> and click <strong>Create Medium</strong>.</p>
</li>
<li>
<p>In the <strong>Name</strong> field, enter a name to represent the installation media entry.</p>
</li>
<li>
<p>In the <strong>Path</strong> enter the URL or NFS share that contains the installation tree.
You can use following variables in the path to represent multiple different system architectures and versions:</p>
<div class="ulist">
<ul>
<li>
<p><code>$arch</code> - The system architecture.</p>
</li>
<li>
<p><code>$version</code> - The operating system version.</p>
</li>
<li>
<p><code>$major</code> - The operating system major version.</p>
</li>
<li>
<p><code>$minor</code> - The operating system minor version.</p>
<div class="paragraph">
<p>Example HTTP path:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>http://download.example.com/centos/$version/Server/$arch/os/</pre>
</div>
</div>
<div class="paragraph">
<p>Example NFS path:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>nfs://download.example.com:/centos/$version/Server/$arch/os/</pre>
</div>
</div>
<div class="paragraph">
<p>Synchronized content on Smart&#160;Proxy&#160;servers always uses an HTTP path.
Smart&#160;Proxy&#160;server managed content does not support NFS paths.</p>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>From the <strong>Operating system family</strong> list, select the distribution or family of the installation medium.
For example, CentOS and Fedora are in the <code>Red Hat</code> family.
Debian and Ubuntu belong to the <code>Debian</code> family.</p>
</li>
<li>
<p>Click the <strong>Organizations</strong> and <strong>Locations</strong> tabs, to change the provisioning context.
Foreman&#160;server adds the installation medium to the set provisioning context.</p>
</li>
<li>
<p>Click <strong>Submit</strong> to save your installation medium.</p>
</li>
</ol>
</div>
<div id="cli-adding-installation-media_provisioning" class="ulist">
<div class="title">CLI procedure</div>
<ul>
<li>
<p>Create the installation medium using the <code>hammer medium create</code> command:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># hammer medium create --name "CustomOS" --os-family "Redhat" \
--path 'http://download.example.com/centos/$version/Server/$arch/os/' \
--organizations "<em>My_Organization</em>" --locations "<em>My_Location</em>"</pre>
</div>
</div>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="creating-partition-tables_provisioning">2.9. Creating Partition Tables</h3>
<div class="paragraph">
<p>A partition table is a type of template that defines the way Foreman&#160;server configures the disks available on a new host.
A Partition table uses the same ERB syntax as provisioning templates.
Foreman contains a set of default partition tables to use, including a <code>Kickstart default</code>.
You can also edit partition table entries to configure the preferred partitioning scheme, or create a partition table entry and add it to the operating system entry.</p>
</div>
<div class="paragraph">
<p>To use the CLI instead of the web UI, see the <a href="#cli-creating-partition-tables_provisioning">CLI procedure</a>.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>In the Foreman web UI, navigate to <strong>Hosts</strong> &gt; <strong>Partition Tables</strong> and click <strong>Create Partition Table</strong>.</p>
</li>
<li>
<p>In the <strong>Name</strong> field, enter a name for the partition table.</p>
</li>
<li>
<p>Select the <strong>Default</strong> check box if you want to set the template to automatically associate with new organizations or locations.</p>
</li>
<li>
<p>Select the <strong>Snippet</strong> check box if you want to identify the template as a reusable snippet for other partition tables.</p>
</li>
<li>
<p>From the <strong>Operating System Family</strong> list, select the distribution or family of the partitioning layout.
For example, Red Hat Enterprise Linux, CentOS, and Fedora are in the Red Hat family.</p>
</li>
<li>
<p>In the <strong>Template editor</strong> field, enter the layout for the disk partition.
For example:</p>
<div class="listingblock">
<div class="content">
<pre>zerombr
clearpart --all --initlabel
autopart</pre>
</div>
</div>
<div class="paragraph">
<p>You can also use the <strong>Template</strong> file browser to upload a template file.</p>
</div>
<div class="paragraph">
<p>The format of the layout must match that for the intended operating system.
For example, Red Hat Enterprise Linux 7.2 requires a layout that matches a kickstart file.</p>
</div>
</li>
<li>
<p>In the <strong>Audit Comment</strong> field, add a summary of changes to the partition layout.</p>
</li>
<li>
<p>Click the <strong>Organizations</strong> and <strong>Locations</strong> tabs to add any other provisioning contexts that you want to associate with the partition table.
Foreman adds the partition table to the current provisioning context.</p>
</li>
<li>
<p>Click <strong>Submit</strong> to save your partition table.</p>
</li>
</ol>
</div>
<div id="cli-creating-partition-tables_provisioning" class="olist arabic">
<div class="title">CLI procedure</div>
<ol class="arabic">
<li>
<p>Before you create a partition table with the CLI, create a plain text file that contains the partition layout.
This example uses the <code>~/my-partition</code> file.</p>
</li>
<li>
<p>Create the installation medium using the <code>hammer partition-table create</code> command:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># hammer partition-table create --name "My Partition" --snippet false \
--os-family Redhat --file ~/my-partition --organizations "<em>My_Organization</em>" \
--locations "<em>My_Location</em>"</pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="dynamic-partition-example_provisioning">2.10. Dynamic Partition Example</h3>
<div class="paragraph">
<p>Using an Anaconda kickstart template, the following section instructs Anaconda to erase the whole disk, automatically partition, enlarge one partition to maximum size, and then proceed to the next sequence of events in the provisioning process:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>zerombr
clearpart --all --initlabel
autopart &lt;%= host_param('autopart_options') %&gt;</pre>
</div>
</div>
<div class="paragraph">
<p>Dynamic partitioning is executed by the installation program.
Therefore, you can write your own rules to specify how you want to partition disks according to runtime information from the node, for example, disk sizes, number of drives, vendor, or manufacturer.</p>
</div>
<div class="paragraph">
<p>If you want to provision servers and use dynamic partitioning, add the following example as a template.
When the <code>#Dynamic</code> entry is included, the content of the template loads into a <code>%pre</code> shell scriplet and creates a <code>/tmp/diskpart.cfg</code> that is then included into the Kickstart partitioning section.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>#Dynamic (do not remove this line)

MEMORY=$((`grep MemTotal: /proc/meminfo | sed 's/^MemTotal: *//'|sed 's/ .*//'` / 1024))
if [ "$MEMORY" -lt 2048 ]; then
    SWAP_MEMORY=$(($MEMORY * 2))
elif [ "$MEMORY" -lt 8192 ]; then
    SWAP_MEMORY=$MEMORY
elif [ "$MEMORY" -lt 65536 ]; then
    SWAP_MEMORY=$(($MEMORY / 2))
else
    SWAP_MEMORY=32768
fi

cat &lt;&lt;EOF &gt; /tmp/diskpart.cfg
zerombr yes
clearpart --all --initlabel
part /boot --fstype ext4 --size 200 --asprimary
part swap --size "$SWAP_MEMORY"
part / --fstype ext4 --size 1024 --grow
EOF</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="provisioning-templates_provisioning">2.11. Provisioning Templates</h3>
<div class="paragraph">
<p>A provisioning template defines the way Foreman&#160;server installs an operating system on a host.</p>
</div>
<div class="paragraph">
<p>Foreman includes many template examples.
In the Foreman web UI, navigate to <strong>Hosts</strong> &gt; <strong>Provisioning templates</strong> to view them.
You can create a template or clone a template and edit the clone.
For help with templates, navigate to <strong>Hosts</strong> &gt; <strong>Provisioning templates</strong> &gt; <strong>Create Template</strong> &gt; <strong>Help</strong>.</p>
</div>
<div class="paragraph">
<p>Templates accept the Embedded Ruby (ERB) syntax.
For more information, see <a href="https://docs.theforeman.org/2.5/Managing_Hosts/index-foreman-el.html#appe-Red_Hat_Satellite-Managing_Hosts-Template_Writing_Reference">Template Writing Reference</a> in <em>Managing Hosts</em>.</p>
</div>
<div class="paragraph">
<p>You can download provisioning templates.
Before you can download the template, you must create a debug certificate.
For more information, see <a href="https://docs.theforeman.org/2.5/Content_Management_Guide/index-foreman-el.html#Managing_Organizations-Creating_an_Organization_Debug_Certificate">Creating an Organization Debug Certificate</a> in the <em>Content Management Guide</em>.</p>
</div>
<div class="paragraph">
<p>You can synchronize templates between Foreman&#160;server and a Git repository or a local directory.
For more information, see <a href="https://docs.theforeman.org/2.5/Managing_Hosts/index-foreman-el.html#Synchronizing_Templates_Repositories">Synchronizing Templates Repositories</a> in the <em>Managing Hosts</em> guide.</p>
</div>
<div class="paragraph">
<p>To view the history of changes applied to a template, navigate to <strong>Hosts</strong> &gt; <strong>Provisioning templates</strong>, select one of the templates, and click <strong>History</strong>.
Click <strong>Revert</strong> to override the content with the previous version.
You can also revert to an earlier change.
Click <strong>Show Diff</strong> to see information about a specific change:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The <strong>Template Diff</strong> tab displays changes in the body of a provisioning template.</p>
</li>
<li>
<p>The <strong>Details</strong> tab displays changes in the template description.</p>
</li>
<li>
<p>The <strong>History</strong> tab displays the user who made a change to the template and date of the change.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="types-of-provisioning-templates_provisioning">2.12. Types of Provisioning Templates</h3>
<div class="paragraph">
<p>There are various types of provisioning templates:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Provision</dt>
<dd>
<p>The main template for the provisioning process.
For example, a kickstart template.
For more information about kickstart template syntax, see the <a href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/7/html/installation_guide/sect-kickstart-syntax">Kickstart Syntax Reference</a> in the <em>Red Hat Enterprise Linux 7 Installation Guide</em>.</p>
</dd>
<dt class="hdlist1">PXELinux, PXEGrub, PXEGrub2</dt>
<dd>
<p>PXE-based templates that deploy to the template Smart&#160;Proxy associated with a subnet to ensure that the host uses the installer with the correct kernel options.
For BIOS provisioning, select <strong>PXELinux</strong> template.
For UEFI provisioning, select <strong>PXEGrub2</strong>.</p>
</dd>
<dt class="hdlist1">Finish</dt>
<dd>
<p>Post-configuration scripts to execute using an SSH connection when the main provisioning process completes.
You can use Finishing templates only for imaged-based provisioning in virtual or cloud environments that do not support user_data.
Do not confuse an image with a foreman discovery ISO, which is sometimes called a Foreman discovery image.
An image in this context is an install image in a virtualized environment for easy deployment.</p>
<div class="paragraph">
<p>When a finish script successfully exits with the return code <code>0</code>, Foreman treats the code as a success and the host exits the build mode.
Note that there are a few finish scripts with a build mode that uses a <em>call back</em> HTTP call.
These scripts are not used for image-based provisioning, but for post configuration of operating-system installations such as Debian, Ubuntu, and BSD.</p>
</div>
</dd>
<dt class="hdlist1">user_data</dt>
<dd>
<p>Post-configuration scripts for providers that accept custom data, also known as seed data.
You can use the user_data template to provision virtual machines in cloud or virtualised environments only.
This template does not require Foreman to be able to reach the host; the cloud or virtualization platform is responsible for delivering the data to the image.</p>
<div class="paragraph">
<p>Ensure that the image that you want to provision has the software to read the data installed and set to start during boot.
For example, <code>cloud-init</code>, which expects YAML input, or <code>ignition</code>, which expects JSON input.</p>
</div>
</dd>
<dt class="hdlist1">cloud_init</dt>
<dd>
<p>Some environments, such as VMWare, either do not support custom data or have their own data format that limits what can be done during customization.
In this case, you can configure a cloud-init client with the <code>foreman</code> plug-in, which attempts to download the template directly from Foreman over HTTP or HTTPS.
This technique can be used in any environment, preferably virtualized.</p>
<div class="paragraph">
<p>Ensure that you meet the following requirements to use the <code>cloud_init</code> template:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Ensure that the image that you want to provision has the software to read the data installed and set to start during boot.</p>
</li>
<li>
<p>A provisioned host is able to reach Foreman from the IP address that matches the host&#8217;s provisioning interface IP.</p>
<div class="paragraph">
<p>Note that cloud-init does not work behind NAT.</p>
</div>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Bootdisk</dt>
<dd>
<p>Templates for PXE-less boot methods.</p>
</dd>
<dt class="hdlist1">Kernel Execution (kexec)</dt>
<dd>
<p>Kernel execution templates for PXE-less boot methods.</p>
</dd>
<dt class="hdlist1">Script</dt>
<dd>
<p>An arbitrary script not used by default but useful for custom tasks.</p>
</dd>
<dt class="hdlist1">ZTP</dt>
<dd>
<p>Zero Touch Provisioning templates.</p>
</dd>
<dt class="hdlist1">POAP</dt>
<dd>
<p>PowerOn Auto Provisioning templates.</p>
</dd>
<dt class="hdlist1">iPXE</dt>
<dd>
<p>Templates for <code>iPXE</code> or <code>gPXE</code> environments to use instead of PXELinux.</p>
</dd>
</dl>
</div>
</div>
<div class="sect2">
<h3 id="creating-provisioning-templates_provisioning">2.13. Creating Provisioning Templates</h3>
<div class="paragraph">
<p>A provisioning template defines the way Foreman&#160;server installs an operating system on a host.
Use this procedure to create a new provisioning template.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>In the Foreman web UI, navigate to <strong>Hosts</strong> &gt; <strong>Provisioning Templates</strong> and click <strong>Create Template</strong>.</p>
</li>
<li>
<p>In the <strong>Name</strong> field, enter a name for the provisioning template.</p>
</li>
<li>
<p>Fill in the rest of the fields as required.
The <strong>Help</strong> tab provides information about the template syntax and details the available functions, variables, and methods that can be called on different types of objects within the template.</p>
</li>
</ol>
</div>
<div class="olist arabic">
<div class="title">CLI procedure</div>
<ol class="arabic">
<li>
<p>Before you create a template with the CLI, create a plain text file that contains the template.
This example uses the <code>~/my-template</code> file.</p>
</li>
<li>
<p>Create the template using the <code>hammer template create</code> command and specify the type with the <code>--type</code> option:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># hammer template create --name "My Provisioning Template" \
--file ~/my-template --type provision --organizations "<em>My_Organization</em>" \
--locations "<em>My_Location</em>"</pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="cloning-provisioning-templates_provisioning">2.14. Cloning Provisioning Templates</h3>
<div class="paragraph">
<p>A provisioning template defines the way Foreman&#160;server installs an operating system on a host.
Use this procedure to clone a template and add your updates to the clone.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>In the Foreman web UI, navigate to <strong>Hosts</strong> &gt; <strong>Provisioning Templates</strong> and search for the template that you want to use.</p>
</li>
<li>
<p>Click <strong>Clone</strong> to duplicate the template.</p>
</li>
<li>
<p>In the <strong>Name</strong> field, enter a name for the provisioning template.</p>
</li>
<li>
<p>Select the <strong>Default</strong> check box to set the template to associate automatically with new organizations or locations.</p>
</li>
<li>
<p>In the <strong>Template editor</strong> field, enter the body of the provisioning template.
You can also use the <strong>Template</strong> file browser to upload a template file.</p>
</li>
<li>
<p>In the <strong>Audit Comment</strong> field, enter a summary of changes to the provisioning template for auditing purposes.</p>
</li>
<li>
<p>Click the <strong>Type</strong> tab and if your template is a snippet, select the <strong>Snippet</strong> check box.
A snippet is not a standalone provisioning template, but a part of a provisioning template that can be inserted into other provisioning templates.</p>
</li>
<li>
<p>From the <strong>Type</strong> list, select the type of the template.
For example, <strong>Provisioning template</strong>.</p>
</li>
<li>
<p>Click the <strong>Association</strong> tab and from the <strong>Applicable Operating Systems</strong> list, select the names of the operating systems that you want to associate with the provisioning template.</p>
</li>
<li>
<p>Optionally, click <strong>Add combination</strong> and select a host group from the <strong>Host Group</strong> list or an environment from the <strong>Environment</strong> list to associate provisioning template with the host groups and environments.</p>
</li>
<li>
<p>Click the <strong>Organizations</strong> and <strong>Locations</strong> tabs to add any additional contexts to the template.</p>
</li>
<li>
<p>Click <strong>Submit</strong> to save your provisioning template.</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="creating-compute-profiles_provisioning">2.15. Creating Compute Profiles</h3>
<div class="paragraph">
<p>You can use compute profiles to predefine virtual machine hardware details such as CPUs, memory, and storage.
A default installation of Foreman contains three predefined profiles:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>1-Small</code></p>
</li>
<li>
<p><code>2-Medium</code></p>
</li>
<li>
<p><code>3-Large</code></p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>In the Foreman web UI, navigate to <strong>Infrastructure</strong> &gt; <strong>Compute Profiles</strong> and click <strong>Create Compute Profile</strong>.</p>
</li>
<li>
<p>In the <strong>Name</strong> field, enter a name for the profile.</p>
</li>
<li>
<p>Click <strong>Submit</strong>.
A new window opens with the name of the compute profile.</p>
</li>
<li>
<p>In the new window, click the name of each compute resource and edit the attributes you want to set for this compute profile.</p>
</li>
</ol>
</div>
<div class="paragraph">
<div class="title">CLI procedure</div>
<p>The compute profile CLI commands are not yet implemented in Foreman 6.10.</p>
</div>
</div>
<div class="sect2">
<h3 id="setting-a-default-encrypted-root-password_provisioning">2.16. Setting a Default Encrypted Root Password for Hosts</h3>
<div class="paragraph">
<p>If you do not want to set a plain text default root password for the hosts that you provision, you can use a default encrypted password.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Generate an encrypted password:</p>
<div class="listingblock">
<div class="content">
<pre># python -c 'import crypt,getpass;pw=getpass.getpass(); print(crypt.crypt(pw)) if (pw==getpass.getpass("Confirm: ")) else exit()'</pre>
</div>
</div>
</li>
<li>
<p>Copy the password for later use.</p>
</li>
<li>
<p>In the Foreman web UI, navigate to <strong>Administer</strong> &gt; <strong>Settings</strong>.</p>
</li>
<li>
<p>On the <strong>Settings</strong> page, select the <strong>Provisioning</strong> tab.</p>
</li>
<li>
<p>In the <strong>Name</strong> column, navigate to <strong>Root password</strong>, and click <strong>Click to edit</strong>.</p>
</li>
<li>
<p>Paste the encrypted password, and click <strong>Save</strong>.</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="using-novnc-to-access-virtual-machines_provisioning">2.17. Using noVNC to Access Virtual Machines</h3>
<div class="paragraph">
<p>You can use your browser to access the VNC console of VMs created by Foreman.</p>
</div>
<div class="paragraph">
<p>Foreman supports using noVNC on the following virtualization platforms:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>VMware</p>
</li>
<li>
<p>Libvirt</p>
</li>
<li>
<p>oVirt</p>
</li>
</ul>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>You must have a virtual machine created by Foreman.</p>
</li>
<li>
<p>For existing virtual machines, ensure that the <strong>Display type</strong> in the <strong>Compute Resource</strong> settings is <strong>VNC</strong>.</p>
</li>
<li>
<p>You must import the Katello root CA certificate into your Foreman&#160;server.
Adding a security exception in the browser is not enough for using noVNC.
For more information, see the <a href="https://docs.theforeman.org/2.5/Administering_Red_Hat_Satellite/index-foreman-el.html#sect-Administering-Installing_the_Katello_Root_CA_Certificate">Installing the Katello Root CA Certificate</a> section in the <em>Administering Foreman</em> guide.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>On the VM host system, configure the firewall to allow VNC service on ports 5900 to 5930:</p>
<div class="ulist">
<ul>
<li>
<p>On operating systems with the <code>iptables</code> command:</p>
<div class="listingblock">
<div class="content">
<pre># iptables -A INPUT -p tcp --dport 5900:5930 -j ACCEPT
# service iptables save</pre>
</div>
</div>
</li>
<li>
<p>On operating systems with the <code>firewalld</code> service:</p>
<div class="listingblock">
<div class="content">
<pre># firewall-cmd --add-port=5900-5930/tcp
# firewall-cmd --add-port=5900-5930/tcp --permanent</pre>
</div>
</div>
<div class="paragraph">
<p>If you do not use <code>firewall-cmd</code> to configure the Linux firewall, implement using the command of your choice.</p>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>In the Foreman web UI, navigate to <strong>Infrastructure</strong> &gt; <strong>Compute Resources</strong> and select the name of a compute resource.</p>
</li>
<li>
<p>In the <strong>Virtual Machines</strong> tab, select the name of a VM host.
Ensure the machine is powered on and then select <strong>Console</strong>.</p>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="Configuring_Networking">3. Configuring Networking</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Each provisioning type requires some network configuration.
Use this chapter to configure network services in your integrated Smart&#160;Proxy on Foreman&#160;server.</p>
</div>
<div class="paragraph">
<p>New hosts must have access to your Smart&#160;Proxy&#160;server.
Smart&#160;Proxy&#160;server can be either your integrated Smart&#160;Proxy on Foreman&#160;server or an external Smart&#160;Proxy&#160;server.
You might want to provision hosts from an external Smart&#160;Proxy&#160;server when the hosts are on isolated networks and cannot connect to Foreman&#160;server directly, or when the content is synchronized with Smart&#160;Proxy&#160;server.
Provisioning using the external Smart&#160;Proxy&#160;server can save on network bandwidth.</p>
</div>
<div class="paragraph">
<p>Configuring Smart&#160;Proxy&#160;server has two basic requirements:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Configuring network services.
This includes:</p>
<div class="ulist">
<ul>
<li>
<p>Content delivery services</p>
</li>
<li>
<p>Network services (DHCP, DNS, and TFTP)</p>
</li>
<li>
<p>Puppet configuration</p>
</li>
</ul>
</div>
</li>
<li>
<p>Defining network resource data in Foreman&#160;server to help configure network interfaces on new hosts.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The following instructions have similar applications to configuring standalone Smart&#160;Proxies managing a specific network.
To configure Foreman to use external DHCP, DNS, and TFTP services, see <a href="https://docs.theforeman.org/2.5/Installing_Server_on_Red_Hat/index-foreman-el.html#configuring-external-services">Configuring External Services</a> in <em>Installing Foreman 2.5 server on Enterprise Linux</em>.</p>
</div>
<div class="sect2">
<h3 id="networking_resources">3.1. Network Resources</h3>
<div class="paragraph">
<p>Foreman contains networking resources that you must set up and configure to create a host.
Foreman includes the following networking resources:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Domain</dt>
<dd>
<p>You must assign every host that is managed by Foreman to a domain.
Using the domain, Foreman can manage A, AAAA, and PTR records.
Even if you do not want Foreman to manage your DNS servers, you still must create and associate at least one domain.
Domains are included in the naming conventions Foreman hosts, for example, a host with the name <code>test123</code> in the <code>example.com</code> domain has the fully qualified domain name <code>test123.example.com</code>.</p>
</dd>
<dt class="hdlist1">Subnet</dt>
<dd>
<p>You must assign every host managed by Foreman to a subnet.
Using subnets, Foreman can then manage IPv4 reservations.
If there are no reservation integrations, you still must create and associate at least one subnet.
When you manage a subnet in Foreman, you cannot create DHCP records for that subnet outside of Foreman.
In Foreman, you can use IP Address Management (IPAM) to manage IP addresses with one of the following options:</p>
<div class="ulist">
<ul>
<li>
<p><strong>DHCP</strong>: DHCP Smart&#160;Proxy manages the assignment of IP addresses by finding the next available IP address starting from the first address of the range and skipping all addresses that are reserved.
Before assigning an IP address, Smart&#160;Proxy sends an ICMP and TCP pings to check whether the IP address is in use.
Note that if a host is powered off, or has a firewall configured to disable connections, Foreman makes a false assumption that the IP address is available.
This check does not work for hosts that are turned off, therefore, the <strong>DHCP</strong> option can only be used with subnets that Foreman controls and that do not have any hosts created externally.</p>
<div class="paragraph">
<p>The Smart&#160;Proxy DHCP module retains the offered IP addresses for a short period of time to prevent collisions during concurrent access, so some IP addresses in the IP range might remain temporarily unused.</p>
</div>
</li>
<li>
<p><strong>Internal DB</strong>: Foreman finds the next available IP address from the Subnet range by excluding all IP addresses from the Foreman database in sequence.
The primary source of data is the database, not DHCP reservations.
This IPAM is not safe when multiple hosts are being created in parallel; in that case, use <strong>DHCP</strong> or <strong>Random DB</strong> IPAM instead.</p>
</li>
<li>
<p><strong>Random DB</strong>: Foreman finds the next available IP address from the Subnet range by excluding all IP addresses from the Foreman database randomly.
The primary source of data is the database, not DHCP reservations.
This IPAM is safe to use with concurrent host creation as IP addresses are returned in random order, minimizing the chance of a conflict.</p>
</li>
<li>
<p><strong>EUI-64</strong>: Extended Unique Identifier (EUI) 64bit IPv6 address generation, as per RFC2373, is obtained through the 48-bit MAC address.</p>
</li>
<li>
<p><strong>External IPAM</strong>: Delegates IPAM to an external system through Smart&#160;Proxy feature.
Foreman currently does not ship with any external IPAM implementations, but several plug-ins are in development.</p>
</li>
<li>
<p><strong>None</strong>: IP address for each host must be entered manually.</p>
<div class="paragraph">
<p>Options DHCP, Internal DB and Random DB can lead to DHCP conflicts on subnets with records created externally.
These subnets must be under exclusive Foreman control.</p>
</div>
<div class="paragraph">
<p>For more information about adding a subnet, see <a href="#Configuring_Networking-Adding_a_Subnet_to_the_Satellite_Server">Adding a Subnet to Foreman&#160;server</a>.</p>
</div>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">DHCP Ranges</dt>
<dd>
<p>You can define the same DHCP range in Foreman&#160;server for both discovered and provisioned systems, but use a separate range for each service within the same subnet.</p>
</dd>
</dl>
</div>
</div>
<div class="sect2">
<h3 id="_foreman_and_dhcp_options">3.2. Foreman and DHCP Options</h3>
<div class="paragraph">
<p>Foreman manages DHCP reservations through a DHCP Smart&#160;Proxy.
Foreman also sets the <code>next-server</code> and <code>filename</code> DHCP options.</p>
</div>
<div class="paragraph">
<div class="title">The next-server option</div>
<p>The <code>next-server</code> option provides the IP address of the TFTP server to boot from.
This option is not set by default and must be set for each TFTP Smart&#160;Proxy.
You can use the <code>foreman-installer</code> command with the <code>--foreman-proxy-tftp-servername</code> option to set the TFTP server in the <code>/etc/foreman-proxy/settings.d/tftp.yml</code> file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># foreman-installer --foreman-proxy-tftp-servername <em>1.2.3.4</em></pre>
</div>
</div>
<div class="paragraph">
<p>Each TFTP Smart&#160;Proxy then reports this setting through the API and Foreman can retrieve the configuration information when it creates the DHCP record.</p>
</div>
<div class="paragraph">
<p>When the PXE loader is set to <code>none</code>, Foreman does not populate the <code>next-server</code> option into the DHCP record.</p>
</div>
<div class="paragraph">
<p>If the <code>next-server</code> option remains undefined, Foreman uses reverse DNS search to find a TFTP server address to assign, but you might encounter the following problems:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>DNS timeouts during provisioning</p>
</li>
<li>
<p>Querying of incorrect DNS server.
For example, authoritative rather than caching</p>
</li>
<li>
<p>Errors about incorrect IP address for the TFTP server.
For example, <code>PTR record was invalid</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>If you encounter these problems, check the DNS setup on both Foreman and Smart&#160;Proxy, specifically the PTR record resolution.</p>
</div>
<div class="paragraph">
<div class="title">The filename option</div>
<p>The <code>filename</code> option contains the full path to the file that downloads and executes during provisioning.
The PXE loader that you select for the host or host group defines which <code>filename</code> option to use.
When the PXE loader is set to <code>none</code>, Foreman does not populate the <code>filename</code> option into the DHCP record.
Depending on the PXE loader option, the <code>filename</code> changes as follows:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">PXE loader option</th>
<th class="tableblock halign-left valign-top">filename entry</th>
<th class="tableblock halign-left valign-top">Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">PXELinux BIOS</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>pxelinux.0</code></p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">PXELinux UEFI</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>pxelinux.efi</code></p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">iPXE Chain BIOS</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>undionly.kpxe</code></p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">PXEGrub2 UEFI</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>grub2/grubx64.efi</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">x64 can differ depending on architecture</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">iPXE UEFI HTTP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>\http://<em>smartproxy.example.com</em>:8000/httpboot/ipxe-x64.efi</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Requires the <code>httpboot</code> feature and renders the <code>filename</code> as a full URL where <em>smartproxy.example.com</em> is a known host name of Smart&#160;Proxy in Foreman.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Grub2 UEFI HTTP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>\http://<em>smartproxy.example.com</em>:8000/httpboot/grub2/grubx64.efi</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Requires the <code>httpboot</code> feature and renders the <code>filename</code> as a full URL where <em>smartproxy.example.com</em> is a known host name of Smart&#160;Proxy in Foreman.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="_troubleshooting_dhcp_problems_in_foreman">3.3. Troubleshooting DHCP Problems in Foreman</h3>
<div class="paragraph">
<p>Foreman can manage an ISC DHCP server on internal or external DHCP Smart&#160;Proxy.
Foreman can list, create, and delete DHCP reservations and leases.
However, there are a number of problems that you might encounter on occasions.</p>
</div>
<div class="paragraph">
<div class="title">Out of sync DHCP records</div>
<p>When an error occurs during DHCP orchestration, DHCP records in the Foreman database and the DHCP server might not match.
To fix this, you must add missing DHCP records from the Foreman database to the DHCP server and then remove unwanted records from the DHCP server as per the following steps:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>To preview the DHCP records that are going to be added to the DHCP server, enter the following command:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># foreman-rake orchestration:dhcp:add_missing subnet_name=NAME</pre>
</div>
</div>
</li>
<li>
<p>If you are satisfied by the preview changes in the previous step, apply them by entering the above command with the <code>perform=1</code> argument:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># foreman-rake orchestration:dhcp:add_missing subnet_name=NAME perform=1</pre>
</div>
</div>
</li>
<li>
<p>To keep DHCP records in Foreman and in the DHCP server synchronized, you can remove unwanted DHCP records from the DHCP server.
Note that Foreman assumes that all managed DHCP servers do not contain third-party records, therefore, this step might delete those unexpected records.
To preview what records are going to be removed from the DHCP server, enter the following command:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># foreman-rake orchestration:dhcp:remove_offending subnet_name=NAME</pre>
</div>
</div>
</li>
<li>
<p>If you are satisfied by the preview changes in the previous step, apply them by entering the above command with the <code>perform=1</code> argument:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># foreman-rake orchestration:dhcp:remove_offending subnet_name=NAME perform=1</pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<div class="title">PXE loader option change</div>
<p>When the PXE loader option is changed for an existing host, this causes a DHCP conflict.
The only workaround is to overwrite the DHCP entry.</p>
</div>
<div class="paragraph">
<p>This is a known issue.
Until <a href="https://projects.theforeman.org/issues/27877">Issue 27877</a> is fixed, the only workaround is to overwrite the DHCP entry.</p>
</div>
<div class="paragraph">
<div class="title">Incorrect permissions on DHCP files</div>
<p>An operating system update can update the <code>dhcpd</code> package.
This causes the permissions of important directories and files to reset so that the DHCP Smart&#160;Proxy cannot read the required information.</p>
</div>
<div class="paragraph">
<p>For more information, see <a href="https://projects.theforeman.org/projects/foreman/wiki/ERF12-6899">ERF12-6899 - Unable to set DHCP entry</a>.</p>
</div>
<div class="paragraph">
<div class="title">Changing the DHCP Smart&#160;Proxy entry</div>
<p>Foreman manages DHCP records only for hosts that are assigned to subnets with a DHCP Smart&#160;Proxy set.
If you create a host and then clear or change the DHCP Smart&#160;Proxy, when you attempt to delete the host, the action fails.</p>
</div>
<div class="paragraph">
<p>If you create a host without setting the DHCP Smart&#160;Proxy and then try to set the DHCP Smart&#160;Proxy, this causes DHCP conflicts.</p>
</div>
<div class="paragraph">
<div class="title">Deleted hosts entries in the dhcpd.leases file</div>
<p>Any changes to a DHCP lease are appended to the end of the <code>dhcpd.leases</code> file.
Because entries are appended to the file, it is possible that two or more entries of the same lease can exist in the <code>dhcpd.leases</code> file at the same time.
When there are two or more entries of the same lease, the last entry in the file takes precedence.
Group, subgroup and host declarations in the lease file are processed in the same manner.
If a lease is deleted, <code>{ deleted; }</code> is appended to the declaration.</p>
</div>
</div>
<div class="sect2">
<h3 id="_prerequisites_for_image_based_provisioning">3.4. Prerequisites for Image Based Provisioning</h3>
<div class="paragraph">
<div class="title">Post-Boot Configuration Method</div>
<p>Images that use the <code>finish</code> post-boot configuration scripts require a managed DHCP server, such as Foreman&#8217;s integrated Smart&#160;Proxy or an external Smart&#160;Proxy.
The host must be created with a subnet associated with a DHCP Smart&#160;Proxy, and the IP address of the host must be a valid IP address from the DHCP range.</p>
</div>
<div class="paragraph">
<p>It is possible to use an external DHCP service, but IP addresses must be entered manually.
The SSH credentials corresponding to the configuration in the image must be configured in Foreman to enable the post-boot configuration to be made.</p>
</div>
<div class="paragraph">
<p>Check the following items when troubleshooting a virtual machine booted from an image that depends on post-configuration scripts:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The host has a subnet assigned in Foreman&#160;server.</p>
</li>
<li>
<p>The subnet has a DHCP Smart&#160;Proxy assigned in Foreman&#160;server.</p>
</li>
<li>
<p>The host has a valid IP address assigned in Foreman&#160;server.</p>
</li>
<li>
<p>The IP address acquired by the virtual machine using DHCP matches the address configured in Foreman&#160;server.</p>
</li>
<li>
<p>The virtual machine created from an image responds to SSH requests.</p>
</li>
<li>
<p>The virtual machine created from an image authorizes the user and password, over SSH, which is associated with the image being deployed.</p>
</li>
<li>
<p>Foreman&#160;server has access to the virtual machine via SSH keys.
This is required for the virtual machine to receive post-configuration scripts from Foreman&#160;server.</p>
</li>
</ul>
</div>
<div class="paragraph">
<div class="title">Pre-Boot Initialization Configuration Method</div>
<p>Images that use the <code>cloud-init</code> scripts require a DHCP server to avoid having to include the IP address in the image.
A managed DHCP Smart&#160;Proxy is preferred.
The image must have the <code>cloud-init</code> service configured to start when the system boots and fetch a script or configuration data to use in completing the configuration.</p>
</div>
<div class="paragraph">
<p>Check the following items when troubleshooting a virtual machine booted from an image that depends on initialization scripts included in the image:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>There is a DHCP server on the subnet.</p>
</li>
<li>
<p>The virtual machine has the <code>cloud-init</code> service installed and enabled.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="Configuring_Networking-Configuring_Network_Services_for_PXE_Boot">3.5. Configuring Network Services</h3>
<div class="paragraph">
<p>Some provisioning methods use Smart&#160;Proxy&#160;server services.
For example, a network might require Smart&#160;Proxy&#160;server to act as a DHCP server.
A network can also use PXE boot services to install the operating system on new hosts.
This requires configuring Smart&#160;Proxy&#160;server to use the main PXE boot services: DHCP, DNS, and TFTP.</p>
</div>
<div class="paragraph">
<p>Use the <code>foreman-installer</code> command with the options to configure these services on Foreman&#160;server.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
While performing a Katello deployment, to configure these services on an external Smart&#160;Proxy&#160;server, run <code>foreman-installer --scenario foreman-proxy-content</code>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Foreman&#160;server uses <code>eth0</code> for external communication, such as connecting to Red Hat&#8217;s CDN.</p>
</div>
<div class="paragraph">
<div class="title">Procedure</div>
<p>To configure network services on Foreman&#8217;s integrated Smart&#160;Proxy, complete the following steps:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Enter the <code>foreman-installer</code> command to configure the required network services:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># foreman-installer --foreman-proxy-dhcp true \
--foreman-proxy-dhcp-managed true \
--foreman-proxy-dhcp-gateway "<em>192.168.140.1</em>" \
--foreman-proxy-dhcp-interface "eth1" \
--foreman-proxy-dhcp-nameservers "<em>192.168.140.2</em>" \
--foreman-proxy-dhcp-range "<em>192.168.140.10</em> <em>192.168.140.110</em>" \
--foreman-proxy-dhcp-server "<em>192.168.140.2</em>" \
--foreman-proxy-dns true \
--foreman-proxy-dns-managed true \
--foreman-proxy-dns-forwarders "<em>8.8.8.8</em>; <em>8.8.4.4</em>" \
--foreman-proxy-dns-interface "eth1" \
--foreman-proxy-dns-reverse "<em>140.168.192.in-addr.arpa</em>" \
--foreman-proxy-dns-server "<em>127.0.0.1</em>" \
--foreman-proxy-dns-zone "<em>example.com</em>" \
--foreman-proxy-tftp true \
--foreman-proxy-tftp-managed true</pre>
</div>
</div>
</li>
<li>
<p>Find Smart&#160;Proxy&#160;server that you configure:</p>
<div class="listingblock">
<div class="content">
<pre># hammer proxy list</pre>
</div>
</div>
</li>
<li>
<p>Refresh features of Smart&#160;Proxy&#160;server to view the changes:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># hammer proxy refresh-features --name "<em>foreman.example.com</em>"</pre>
</div>
</div>
</li>
<li>
<p>Verify the services configured on Smart&#160;Proxy&#160;server:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># hammer proxy info --name "<em>foreman.example.com</em>"</pre>
</div>
</div>
</li>
</ol>
</div>
<div class="sect3">
<h4 id="Configuring_Networking-Multiple_Subnets_or_Domains_via_Installer">3.5.1. Multiple Subnets or Domains via Installer</h4>
<div class="paragraph">
<p>The foreman-installer options allow only for a single DHCP subnet or DNS domain.
One way to define more than one subnet is by using a custom configuration file.</p>
</div>
<div class="paragraph">
<p>For every additional subnet or domain, create an entry in <code>/etc/foreman-installer/custom-hiera.yaml</code> file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>dhcp::pools:
 isolated.lan:
   network: 192.168.99.0
   mask: 255.255.255.0
   gateway: 192.168.99.1
   range: 192.168.99.5 192.168.99.49

dns::zones:
  # creates @ SOA $::fqdn root.example.com.
  # creates $::fqdn A $::ipaddress
  example.com: {}

  # creates @ SOA test.example.net. hostmaster.example.com.
  # creates test.example.net A 192.0.2.100
  example.net:
    soa: test.example.net
    soaip: 192.0.2.100
    contact: hostmaster.example.com.

  # creates @ SOA $::fqdn root.example.org.
  # does NOT create an A record
  example.org:
    reverse: true

  # creates @ SOA $::fqdn hostmaster.example.com.
  2.0.192.in-addr.arpa:
    reverse: true
    contact: hostmaster.example.com.</pre>
</div>
</div>
<div class="paragraph">
<p>Execute foreman-installer to perform the changes and verify that the <code>/etc/dhcp/dhcpd.conf</code> contains appropriate entries.
Subnets must be then defined in Foreman database.</p>
</div>
</div>
<div class="sect3">
<h4 id="_dhcp_dns_and_tftp_options_for_network_configuration">3.5.2. DHCP, DNS, and TFTP Options for Network Configuration</h4>
<div class="dlist">
<div class="title">DHCP Options</div>
<dl>
<dt class="hdlist1">--foreman-proxy-dhcp</dt>
<dd>
<p>  Enables the DHCP service.
You can set this option to <code>true</code> or <code>false</code>.</p>
</dd>
<dt class="hdlist1">--foreman-proxy-dhcp-managed</dt>
<dd>
<p>  Enables Foreman to manage the DHCP service.
You can set this option to <code>true</code> or <code>false</code>.</p>
</dd>
<dt class="hdlist1">--foreman-proxy-dhcp-gateway</dt>
<dd>
<p>  The DHCP pool gateway.
Set this to the address of the external gateway for hosts on your private network.</p>
</dd>
<dt class="hdlist1">--foreman-proxy-dhcp-interface</dt>
<dd>
<p>  Sets the interface for the DHCP service to listen for requests.
Set this to <code>eth1</code>.</p>
</dd>
<dt class="hdlist1">--foreman-proxy-dhcp-nameservers</dt>
<dd>
<p>  Sets the addresses of the nameservers provided to clients through DHCP.
Set this to the address for Foreman&#160;server on <code>eth1</code>.</p>
</dd>
<dt class="hdlist1">--foreman-proxy-dhcp-range</dt>
<dd>
<p>A space-separated DHCP pool range for Discovered and Unmanaged services.</p>
</dd>
<dt class="hdlist1">--foreman-proxy-dhcp-server</dt>
<dd>
<p>Sets the address of the DHCP server to manage.</p>
</dd>
</dl>
</div>
<div class="dlist">
<div class="title">DNS Options</div>
<dl>
<dt class="hdlist1">--foreman-proxy-dns</dt>
<dd>
<p>  Enables DNS service.
You can set this option to <code>true</code> or <code>false</code>.</p>
</dd>
<dt class="hdlist1">--foreman-proxy-dns-managed</dt>
<dd>
<p>  Enables Foreman to manage the DNS service.
You can set this option to <code>true</code> or <code>false</code>.</p>
</dd>
<dt class="hdlist1">--foreman-proxy-dns-forwarders</dt>
<dd>
<p>  Sets the DNS forwarders.
Set this to your DNS servers.</p>
</dd>
<dt class="hdlist1">--foreman-proxy-dns-interface</dt>
<dd>
<p>  Sets the interface to listen for DNS requests.
Set this to <code>eth1</code>.</p>
</dd>
<dt class="hdlist1">--foreman-proxy-dns-reverse</dt>
<dd>
<p>The DNS reverse zone name.</p>
</dd>
<dt class="hdlist1">--foreman-proxy-dns-server</dt>
<dd>
<p>Sets the address of the DNS server to manage.</p>
</dd>
<dt class="hdlist1">--foreman-proxy-dns-zone</dt>
<dd>
<p>Sets the DNS zone name.</p>
</dd>
</dl>
</div>
<div class="dlist">
<div class="title">TFTP Options</div>
<dl>
<dt class="hdlist1">--foreman-proxy-tftp</dt>
<dd>
<p>  Enables TFTP service.
You can set this option to <code>true</code> or <code>false</code>.</p>
</dd>
<dt class="hdlist1">--foreman-proxy-tftp-managed</dt>
<dd>
<p>  Enables Foreman to manage the TFTP service.
You can set this option to <code>true</code> or <code>false</code>.</p>
</dd>
<dt class="hdlist1">--foreman-proxy-tftp-servername</dt>
<dd>
<p>  Sets the TFTP server to use.
Ensure that you use Smart&#160;Proxy&#8217;s IP address.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>Run <code>foreman-installer --help</code> to view more options related to DHCP, DNS, TFTP, and other Foreman Smart&#160;Proxy services</p>
</div>
</div>
<div class="sect3">
<h4 id="Configuring_Networking-Using_TFTP_Services_through_NAT">3.5.3. Using TFTP Services through NAT</h4>
<div class="paragraph">
<p>You can use Foreman TFTP services through NAT.
To do this, on all NAT routers or firewalls, you must enable a TFTP service on UDP port 69 and enable the TFTP state tracking feature.
For more information, see the documentation for your NAT device.</p>
</div>
<div class="paragraph">
<div class="title">Using NAT on Linux with <code>firewalld</code>:</div>
<p>Use the following command to allow TFTP service on UDP port 69, load the kernel TFTP state tracking module, and make the changes persistent:</p>
</div>
<div class="listingblock">
<div class="content">
<pre># firewall-cmd --add-service=tftp &amp;&amp; firewall-cmd --runtime-to-permanent</pre>
</div>
</div>
<div class="olist arabic">
<div class="title">For a NAT running on linux with iptables command:</div>
<ol class="arabic">
<li>
<p>Configure the firewall to allow TFTP service UDP on port 69.</p>
<div class="listingblock">
<div class="content">
<pre># iptables -A OUTPUT -i eth0 -p udp --sport 69 -m state \
--state ESTABLISHED -j ACCEPT
# service iptables save</pre>
</div>
</div>
</li>
<li>
<p>Load the <code>ip_conntrack_tftp</code> kernel TFTP state module.
In the <code>/etc/sysconfig/iptables-config</code> file, locate <code>IPTABLES_MODULES</code> and add <code>ip_conntrack_tftp</code> as follows:</p>
<div class="listingblock">
<div class="content">
<pre>IPTABLES_MODULES="ip_conntrack_tftp"</pre>
</div>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="sect2">
<h3 id="Configuring_Networking-Adding_a_Domain_to_the_Satellite_Server">3.6. Adding a Domain to Foreman&#160;server</h3>
<div class="paragraph">
<p>Foreman&#160;server defines domain names for each host on the network.
Foreman&#160;server must have information about the domain and Smart&#160;Proxy&#160;server responsible for domain name assignment.</p>
</div>
<div class="paragraph">
<div class="title">Checking for Existing Domains</div>
<p>Foreman&#160;server might already have the relevant domain created as part of Foreman&#160;server installation.
Switch the context to <code>Any Organization</code> and <code>Any Location</code> then check the domain list to see if it exists.</p>
</div>
<div class="paragraph">
<div class="title">DNS Server Configuration Considerations</div>
<p>During the DNS record creation, Foreman performs conflict DNS lookups to verify that the host name is not in active use.
This check runs against one of the following DNS servers:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The system-wide resolver if <strong>Administer</strong> &gt; <strong>Settings</strong> &gt; <strong>Query local nameservers</strong> is set to <strong>true</strong>.</p>
</li>
<li>
<p>The nameservers that are defined in the subnet associated with the host.</p>
</li>
<li>
<p>The authoritative NS-Records that are queried from the SOA from the domain name associated with the host.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>If you experience timeouts during DNS conflict resolution, check the following settings:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The subnet nameservers must be reachable from Foreman&#160;server.</p>
</li>
<li>
<p>The domain name must have a Start of Authority (SOA) record available from Foreman&#160;server.</p>
</li>
<li>
<p>The system resolver in the <code>/etc/resolv.conf</code> file must have a valid and working configuration.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>To use the CLI instead of the web UI, see the <a href="#cli-adding-a-domain_provisioning">CLI procedure</a>.</p>
</div>
<div class="paragraph">
<div class="title">Procedure</div>
<p>To add a domain to Foreman, complete the following steps:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>In the Foreman web UI, navigate to <strong>Infrastructure</strong> &gt; <strong>Domains</strong> and click <strong>Create Domain</strong>.</p>
</li>
<li>
<p>In the <strong>DNS Domain</strong> field, enter the full DNS domain name.</p>
</li>
<li>
<p>In the <strong>Fullname</strong> field, enter the plain text name of the domain.</p>
</li>
<li>
<p>Click the <strong>Parameters</strong> tab and configure any domain level parameters to apply to hosts attached to this domain.
For example, user defined Boolean or string parameters to use in templates.</p>
</li>
<li>
<p>Click <strong>Add Parameter</strong> and fill in the <strong>Name</strong> and <strong>Value</strong> fields.</p>
</li>
<li>
<p>Click the <strong>Locations</strong> tab, and add the location where the domain resides.</p>
</li>
<li>
<p>Click the <strong>Organizations</strong> tab, and add the organization that the domain belongs to.</p>
</li>
<li>
<p>Click <strong>Submit</strong> to save the changes.</p>
</li>
</ol>
</div>
<div id="cli-adding-a-domain_provisioning" class="ulist">
<div class="title">CLI procedure</div>
<ul>
<li>
<p>Use the <code>hammer domain create</code> command to create a domain:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># hammer domain create --name "<em>domain_name.com</em>" \
--description "<em>My example domain</em>" --dns-id 1 \
--locations "<em>My_Location</em>" --organizations "<em>My_Organization</em>"</pre>
</div>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>In this example, the <code>--dns-id</code> option uses <code>1</code>, which is the ID of your integrated Smart&#160;Proxy on Foreman&#160;server.</p>
</div>
</div>
<div class="sect2">
<h3 id="Configuring_Networking-Adding_a_Subnet_to_the_Satellite_Server">3.7. Adding a Subnet to Foreman&#160;server</h3>
<div class="paragraph">
<p>You must add information for each of your subnets to Foreman&#160;server because Foreman configures interfaces for new hosts.
To configure interfaces, Foreman&#160;server must have all the information about the network that connects these interfaces.</p>
</div>
<div class="paragraph">
<p>To use the CLI instead of the web UI, see the <a href="#cli-adding-a-subnet_provisioning">CLI procedure</a>.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>In the Foreman web UI, navigate to <strong>Infrastructure</strong> &gt; <strong>Subnets</strong>, and in the Subnets window, click <strong>Create Subnet</strong>.</p>
</li>
<li>
<p>In the <strong>Name</strong> field, enter a name for the subnet.</p>
</li>
<li>
<p>In the <strong>Description</strong> field, enter a description for the subnet.</p>
</li>
<li>
<p>In the <strong>Network address</strong> field, enter the network address for the subnet.</p>
</li>
<li>
<p>In the <strong>Network prefix</strong> field, enter the network prefix for the subnet.</p>
</li>
<li>
<p>In the <strong>Network mask</strong> field, enter the network mask for the subnet.</p>
</li>
<li>
<p>In the <strong>Gateway address</strong> field, enter the external gateway for the subnet.</p>
</li>
<li>
<p>In the <strong>Primary DNS server</strong> field, enter a primary DNS for the subnet.</p>
</li>
<li>
<p>In the <strong>Secondary DNS server</strong>, enter a secondary DNS for the subnet.</p>
</li>
<li>
<p>From the <strong>IPAM</strong> list, select the method that you want to use for IP address management (IPAM).
For more information about IPAM, see <a href="#networking_resources">Network Resources</a>.</p>
</li>
<li>
<p>Enter the information for the IPAM method that you select.</p>
</li>
<li>
<p>If you use the remote execution plugin, click the <strong>Remote Execution</strong> tab and select the Smart&#160;Proxy that controls the remote execution.</p>
</li>
<li>
<p>Click the <strong>Domains</strong> tab and select the domains that apply to this subnet.</p>
</li>
<li>
<p>Click the <strong>Smart&#160;Proxies</strong> tab and select the Smart&#160;Proxy that applies to each service in the subnet, including DHCP, TFTP, and reverse DNS services.</p>
</li>
<li>
<p>Click the <strong>Parameters</strong> tab and configure any subnet level parameters to apply to hosts attached to this subnet.
For example, user defined Boolean or string parameters to use in templates.</p>
</li>
<li>
<p>Click the <strong>Locations</strong> tab and select the locations that use this Smart&#160;Proxy.</p>
</li>
<li>
<p>Click the <strong>Organizations</strong> tab and select the organizations that use this Smart&#160;Proxy.</p>
</li>
<li>
<p>Click <strong>Submit</strong> to save the subnet information.</p>
</li>
</ol>
</div>
<div id="cli-adding-a-subnet_provisioning" class="ulist">
<div class="title">CLI procedure</div>
<ul>
<li>
<p>Create the subnet with the following command:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># hammer subnet create --name "<em>My_Network</em>" \
--description "<em>your_description</em>" \
--network "192.168.140.0" --mask "255.255.255.0" \
--gateway "192.168.140.1" --dns-primary "192.168.140.2" \
--dns-secondary "8.8.8.8" --ipam "DHCP" \
--from "192.168.140.111" --to "192.168.140.250" --boot-mode "DHCP" \
--domains "<em>example.com</em>" --dhcp-id 1 --dns-id 1 --tftp-id 1 \
--locations "<em>My_Location</em>" --organizations "<em>My_Organization</em>"</pre>
</div>
</div>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
In this example, the <code>--dhcp-id</code>, <code>--dns-id</code>, and <code>--tftp-id</code> options use 1, which is the ID of the integrated Smart&#160;Proxy in Foreman&#160;server.
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="chap-Infoblox-Integration">4. Using Infoblox as DHCP and DNS Providers</h2>
<div class="sectionbody">
<div class="paragraph">
<p>You can use Smart&#160;Proxy&#160;server to connect to your Infoblox application to create and manage DHCP and DNS records, and to reserve IP addresses.</p>
</div>
<div class="sect2">
<h3 id="_limitations">4.1. Limitations</h3>
<div class="paragraph">
<p>All DHCP and DNS records can be managed only in a single Network or DNS view.
After you install the Infoblox modules on Smart&#160;Proxy and set up the view using the <code>foreman-installer</code> command, you cannot edit the view.</p>
</div>
<div class="paragraph">
<p>Smart&#160;Proxy&#160;server communicates with a single Infoblox node using the standard HTTPS web API.
If you want to configure clustering and High Availability, make the configurations in Infoblox.</p>
</div>
<div class="paragraph">
<p>Hosting PXE-related files using Infoblox&#8217;s TFTP functionality is not supported.
You must use Smart&#160;Proxy as a TFTP server for PXE provisioning.
For more information, see <a href="#Configuring_Networking">Configuring Networking</a>.</p>
</div>
<div class="paragraph">
<p>Foreman IPAM feature cannot be integrated with Infoblox.</p>
</div>
</div>
<div class="sect2">
<h3 id="_prerequisites">4.2. Prerequisites</h3>
<div class="paragraph">
<p>You must have Infoblox account credentials to manage DHCP and DNS entries in Foreman.</p>
</div>
<div class="paragraph">
<p>Ensure that you have Infoblox administration roles with the names: <code>DHCP Admin</code> and <code>DNS Admin</code>.</p>
</div>
<div class="paragraph">
<p>The administration roles must have permissions or belong to an admin group that permits the accounts to perform tasks through the Infoblox API.</p>
</div>
</div>
<div class="sect2">
<h3 id="_installing_the_infoblox_ca_certificate_on_smartproxyserver">4.3. Installing the Infoblox CA Certificate on Smart&#160;Proxy&#160;server</h3>
<div class="paragraph">
<p>You must install Infoblox HTTPS CA certificate on the base system for all Smart&#160;Proxies that you want to integrate with Infoblox applications.</p>
</div>
<div class="paragraph">
<p>You can download the certificate from the Infoblox web UI, or you can use the following OpenSSL commands to download the certificate:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># update-ca-trust enable
# openssl s_client -showcerts -connect <em>infoblox.example.com</em>:443 &lt;/dev/null | \
openssl x509 -text &gt;/etc/pki/ca-trust/source/anchors/infoblox.crt
# update-ca-trust extract</pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>The <code><em>infoblox.example.com</em></code> entry must match the host name for the Infoblox application in the X509 certificate.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>To test the CA certificate, use a CURL query:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># curl -u admin:password https://<em>infoblox.example.com</em>/wapi/v2.0/network</pre>
</div>
</div>
<div class="paragraph">
<p>Example positive response:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">[
    {
        "_ref": "network/ZG5zLm5ldHdvcmskMTkyLjE2OC4yMDIuMC8yNC8w:<em>infoblox.example.com</em>/24/default",
        "network": "192.168.202.0/24",
        "network_view": "default"
    }
]</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="Infoblox-Integration-Installing_the_DHCP_Infoblox_Module">4.4. Installing the DHCP Infoblox module</h3>
<div class="paragraph">
<p>Use this procedure to install the DHCP Infoblox module on Smart&#160;Proxy.
Note that you cannot manage records in separate views.</p>
</div>
<div class="paragraph">
<p>You can also install DHCP and DNS Infoblox modules simultaneously by combining this procedure and <a href="#Infoblox-Integration-Installing_the_DNS_Infoblox_Module">Installing the DNS Infoblox Module</a></p>
</div>
<div class="paragraph">
<div class="title">DHCP Infoblox Record Type Considerations</div>
<p>Use only the <code>--foreman-proxy-plugin-dhcp-infoblox-record-type fixedaddress</code> option to configure the DHCP and DNS modules.</p>
</div>
<div class="paragraph">
<p>Configuring both DHCP and DNS Infoblox modules with the <code>host</code> record type setting causes DNS conflicts and is not supported.
If you install the Infoblox module on Smart&#160;Proxy&#160;server with the <code>--foreman-proxy-plugin-dhcp-infoblox-record-type</code> option set to <code>host</code>, you must unset both DNS Smart&#160;Proxy and Reverse DNS Smart&#160;Proxy options because Infoblox does the DNS management itself.
You cannot use the <code>host</code> option without creating conflicts and, for example, being unable to rename hosts in Foreman.</p>
</div>
<div class="paragraph">
<div class="title">Procedure</div>
<p>To install the Infoblox module for DHCP, complete the following steps:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>On Smart&#160;Proxy, enter the following command:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># foreman-installer --enable-foreman-proxy-plugin-dhcp-infoblox \
--foreman-proxy-dhcp true \
--foreman-proxy-dhcp-managed false \
--foreman-proxy-dhcp-provider infoblox \
--foreman-proxy-plugin-dhcp-infoblox-record-type fixedaddress \
--foreman-proxy-dhcp-server <em>infoblox.example.com</em> \
--foreman-proxy-plugin-dhcp-infoblox-username admin \
--foreman-proxy-plugin-dhcp-infoblox-password infoblox \
--foreman-proxy-plugin-dhcp-infoblox-network-view default \
--foreman-proxy-plugin-dhcp-infoblox-dns-view default</pre>
</div>
</div>
</li>
<li>
<p>In the Foreman web UI, navigate to <strong>Infrastructure</strong> &gt; <strong>Smart&#160;Proxies</strong> and select the Smart&#160;Proxy with the Infoblox DHCP module and click <strong>Refresh</strong>.</p>
</li>
<li>
<p>Ensure that the <strong>dhcp</strong> features are listed.</p>
</li>
<li>
<p>For all domains managed through Infoblox, ensure that the DNS Smart&#160;Proxy is set for that domain.
To verify, in the Foreman web UI, navigate to <strong>Infrastructure</strong> &gt; <strong>Domains</strong>, and inspect the settings of each domain.</p>
</li>
<li>
<p>For all subnets managed through Infoblox, ensure that DHCP Smart&#160;Proxy and Reverse DNS Smart&#160;Proxy is set.
To verify, in the Foreman web UI, navigate to <strong>Infrastructure</strong> &gt; <strong>Subnets</strong>, and inspect the settings of each subnet.</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="Infoblox-Integration-Installing_the_DNS_Infoblox_Module">4.5. Installing the DNS Infoblox Module</h3>
<div class="paragraph">
<p>Use this procedure to install the DNS Infoblox module on Smart&#160;Proxy.
You can also install DHCP and DNS Infoblox modules simultaneously by combining this procedure and <a href="#Infoblox-Integration-Installing_the_DHCP_Infoblox_Module">Installing the DHCP Infoblox module</a>.</p>
</div>
<div class="paragraph">
<p>DNS records are managed only in the default DNS view, it&#8217;s not possible to specify which DNS view to use.</p>
</div>
<div class="paragraph">
<p>To install the DNS Infoblox module, complete the following steps:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>On Smart&#160;Proxy, enter the following command to configure the Infoblox module:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># foreman-installer --enable-foreman-proxy-plugin-dns-infoblox \
--foreman-proxy-dns true \
--foreman-proxy-dns-managed false \
--foreman-proxy-dns-provider infoblox \
--foreman-proxy-plugin-dns-infoblox-dns-server <em>infoblox.example.com</em> \
--foreman-proxy-plugin-dns-infoblox-username admin \
--foreman-proxy-plugin-dns-infoblox-password infoblox \
--foreman-proxy-plugin-dns-infoblox-dns-view default</pre>
</div>
</div>
<div class="paragraph">
<p>Optionally, you can change the value of the <code>--foreman-proxy-plugin-dns-infoblox-dns-view</code> option to specify a DNS Infoblox view other than the default view.</p>
</div>
</li>
<li>
<p>In the Foreman web UI, navigate to <strong>Infrastructure</strong> &gt; <strong>Smart&#160;Proxies</strong> and select the Smart&#160;Proxy with the Infoblox DNS module and click <strong>Refresh</strong>.</p>
</li>
<li>
<p>Ensure that the <strong>dns</strong> features are listed.</p>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="Configuring_Networking-Configuring_gPXE_to_Reduce_Provisioning_Times">5. Configuring iPXE to Reduce Provisioning Times</h2>
<div class="sectionbody">
<div class="paragraph">
<p>You can use Foreman to configure PXELinux to chainboot iPXE in BIOS mode and boot using the HTTP protocol if you have the following restrictions that prevent you from using PXE:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A network with unmanaged DHCP servers.</p>
</li>
<li>
<p>A PXE service that is blacklisted on your network or restricted by a firewall.</p>
</li>
<li>
<p>An unreliable TFTP UDP-based protocol because of, for example, a low-bandwidth network.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Only BIOS systems are known to work reliably.
For configuring iPXE with <strong>some</strong> EFI hosts, read a <a href="https://community.theforeman.org/t/discovery-ipxe-efi-workflow-in-foreman-1-20/13026">separate tutorial</a>.</p>
</div>
<div class="paragraph">
<div class="title">iPXE Overview</div>
<p>iPXE is an open source network boot firmware.
It provides a full PXE implementation enhanced with additional features, including booting from HTTP server.
For more information, see <a href="https://ipxe.org">ipxe.org</a>.</p>
</div>
<div class="paragraph">
<p>There are three methods of using iPXE with Foreman:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Booting virtual machines using hypervisors that use iPXE as primary firmware.</p>
</li>
<li>
<p>Using PXELinux through TFTP to chainload iPXE directly on bare metal hosts.</p>
</li>
<li>
<p>Using PXELinux through UNDI, which uses HTTP to transfer the kernel and the initial RAM disk on bare-metal hosts.</p>
</li>
</ol>
</div>
<div class="paragraph">
<div class="title">Security Information</div>
<p>The iPXE binary in Red&#160;Hat Enterprise Linux is built without any security features.
For this reason, you can only use HTTP, and cannot use HTTPS.</p>
</div>
<div class="paragraph">
<p>Recompile iPXE from source to use security features like HTTPS.</p>
</div>
<div class="paragraph">
<div class="title">Prerequisites</div>
<p>Before you begin, ensure that the following conditions are met:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A host exists on Foreman to use.</p>
</li>
<li>
<p>The MAC address of the provisioning interface matches the host configuration.</p>
</li>
<li>
<p>The provisioning interface of the host has a valid DHCP reservation.</p>
</li>
<li>
<p>The NIC is capable of PXE booting.
For more information, see <a href="https://ipxe.org/appnote/hardware_drivers">supported hardware on ipxe.org</a> for a list of hardware drivers expected to work with an iPXE-based boot disk.</p>
</li>
<li>
<p>The NIC is compatible with iPXE.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>To prepare iPXE environment, you must perform this procedure on all Smart&#160;Proxies.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Enable the <strong>tftp</strong> and <strong>httpboot</strong> services:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># foreman-installer --foreman-proxy-httpboot true --foreman-proxy-tftp true</pre>
</div>
</div>
</li>
<li>
<p>Install the <code>ipxe-bootimgs</code> RPM package:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># yum install ipxe-bootimgs</pre>
</div>
</div>
</li>
<li>
<p>On Debian/Ubuntu, install the <code>ipxe</code> .deb package:</p>
<div class="listingblock">
<div class="content">
<pre># {package-install} ipxe</pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Copy the iPXE firmware with the Linux kernel header to the TFTP directory:</p>
<div class="listingblock">
<div class="content">
<pre># cp /usr/share/ipxe/ipxe.lkrn /var/lib/tftpboot/</pre>
</div>
</div>
</li>
<li>
<p>Copy the UNDI iPXE firmware to the TFTP directory:</p>
<div class="listingblock">
<div class="content">
<pre># cp /usr/share/ipxe/undionly.kpxe /var/lib/tftpboot/undionly-ipxe.0</pre>
</div>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>On systems with SELinux, correct the file contexts:</p>
<div class="listingblock">
<div class="content">
<pre># restorecon -RvF /var/lib/tftpboot/</pre>
</div>
</div>
</li>
<li>
<p>Optionally, configure Foreman discovery. For more information, see <a href="#configuring-the-discovery-service">Configuring the Discovery Service</a>.</p>
<div class="ulist">
<ul>
<li>
<p>In the Foreman web UI, navigate to <strong>Administer</strong> &gt; <strong>Settings</strong>, and click the <strong>Provisioning</strong> tab.</p>
</li>
<li>
<p>Locate the <strong>Default PXE global template entry</strong> row and, in the <strong>Value</strong> column, change the value to <strong>discovery</strong>.</p>
</li>
</ul>
</div>
</li>
</ol>
</div>
<div class="sect2">
<h3 id="_booting_virtual_machines">5.1. Booting virtual machines</h3>
<div class="paragraph">
<p>Some virtualization hypervisors use iPXE as primary firmware for PXE booting.
Because of this, you can boot virtual machines without TFTP and PXELinux.</p>
</div>
<div class="paragraph">
<div class="title">Chainbooting virtual machine workflow</div>
<p>Using virtualization hypervisors removes the need for TFTP and PXELinux.
It has the following workflow:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Virtual machine starts</p>
</li>
<li>
<p>iPXE retrieves the network credentials using DHCP</p>
</li>
<li>
<p>iPXE retrieves the HTTP address using DHCP</p>
</li>
<li>
<p>iPXE loads the iPXE bootstrap template from Smart&#160;Proxy</p>
</li>
<li>
<p>iPXE loads the iPXE template with MAC as a URL parameter from Smart&#160;Proxy</p>
</li>
<li>
<p>iPXE loads the kernel and initial RAM disk of the installer</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Ensure that the hypervisor that you want to use supports iPXE.
The following virtualization hypervisors support iPXE:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>libvirt</p>
</li>
<li>
<p>oVirt</p>
</li>
<li>
<p>RHEV</p>
</li>
<li>
<p>VMWare (<a href="https://ipxe.org/howto/vmware">via custom firmware</a>)</p>
</li>
</ul>
</div>
<div class="paragraph">
<div class="title">Configuring Foreman&#160;server to use iPXE</div>
<p>You can use the default template to configure iPXE booting for hosts.
If you want to change the default values in the template, clone the template and edit the clone.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>In the Foreman web UI, navigate to <strong>Hosts</strong> &gt; <strong>Provisioning Templates</strong>, enter <code>Kickstart default iPXE</code> and click <strong>Search</strong>.</p>
</li>
<li>
<p>Optional: If you want to change the template, click <strong>Clone</strong>, enter a unique name, and click <strong>Submit</strong>.</p>
</li>
<li>
<p>Click the name of the template you want to use.</p>
</li>
<li>
<p>If you clone the template, you can make changes you require on the <strong>Template</strong> tab.</p>
</li>
<li>
<p>Click the <strong>Association</strong> tab and select the operating systems that your host uses.</p>
</li>
<li>
<p>Click the <strong>Locations</strong> tab and add the location where the host resides.</p>
</li>
<li>
<p>Click the <strong>Organizations</strong> tab and add the organization that the host belongs to.</p>
</li>
<li>
<p>Click <strong>Submit</strong> to save the changes.</p>
</li>
<li>
<p>Navigate to <strong>Hosts</strong> &gt; <strong>Operating systems</strong> and select the operating system of your host.</p>
</li>
<li>
<p>Click the <strong>Templates</strong> tab.</p>
</li>
<li>
<p>From the <strong>iPXE Template</strong> list, select the template you want to use.</p>
</li>
<li>
<p>Click <strong>Submit</strong> to save the changes.</p>
</li>
<li>
<p>Navigate to <strong>Hosts</strong> &gt; <strong>All Hosts</strong>.</p>
</li>
<li>
<p>In the <strong>Hosts</strong> page, select the host that you want to use.</p>
</li>
<li>
<p>Select the <strong>Operating System</strong> tab.</p>
</li>
<li>
<p>Set <strong>PXE Loader</strong> to <strong>iPXE Embedded</strong> or <strong>None</strong>.</p>
</li>
<li>
<p>Select the <strong>Templates</strong> tab.</p>
</li>
<li>
<p>From the <strong>iPXE template</strong> list, select <strong>Review</strong> to verify that the <strong>Kickstart default iPXE</strong> template is the correct template.</p>
</li>
<li>
<p>Configure the <code>dhcpd.conf</code> file as follows:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">if exists user-class and option user-class = "iPXE" {
  filename "http://smartproxy.example.com:8000/unattended/iPXE?bootstrap=1";
} # elseif existing statements if non-iPXE environment should be preserved</pre>
</div>
</div>
<div class="paragraph">
<p>If you use an isolated network, use a Smart&#160;Proxy&#160;server URL with TCP port <code>8000</code>, instead of the URL of Foreman&#160;server.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
If you have changed the port using the <code>--foreman-proxy-http-port installer</code> option, use your custom port.
You must update the <code>/etc/dhcp/dhcpd.conf</code> file after every upgrade.
</td>
</tr>
</table>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_chainbooting_ipxe_from_pxelinux">5.2. Chainbooting iPXE from PXELinux</h3>
<div class="paragraph">
<p>Use this procedure to set up iPXE to use a built-in driver for network communication or UNDI interface.
To use HTTP with iPXE, use iPXE build with built-in drivers (<code>ipxe.lkrn</code>).
Universal Network Device Interface (UNDI) is a minimalistic UDP/IP stack that implements TFTP client, however, cannot support other protocols like HTTP (<code>undionly-ipxe.0</code>).
You can choose to either load <code>ipxe.lkrn</code> or <code>undionly-ipxe.0</code> file depending on the networking hardware capabilities and iPXE driver availablity.</p>
</div>
<div class="olist arabic">
<div class="title">Chainbooting iPXE directly or with UNDI workflow</div>
<ol class="arabic">
<li>
<p>Host powers on</p>
</li>
<li>
<p>PXE driver retrieves the network credentials using DHCP</p>
</li>
<li>
<p>PXE driver retrieves the PXELinux firmware <code>pxelinux.0</code> using TFTP</p>
</li>
<li>
<p>PXELinux searches for the configuration file on the TFTP server</p>
</li>
<li>
<p>PXELinux chainloads iPXE <code>ipxe.lkrn</code> or <code>undionly-ipxe.0</code></p>
</li>
<li>
<p>iPXE retrieves the network credentials using DHCP again</p>
</li>
<li>
<p>iPXE retrieves HTTP address using DHCP</p>
</li>
<li>
<p>iPXE chainloads the iPXE template from the template Smart&#160;Proxy</p>
</li>
<li>
<p>iPXE loads the kernel and initial RAM disk of the installer</p>
</li>
</ol>
</div>
<div class="paragraph">
<div class="title">Configuring Foreman Server to use iPXE</div>
<p>You can use the default template to configure iPXE booting for hosts.
If you want to change the default values in the template, clone the template and edit the clone.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>In the Foreman web UI, navigate to <strong>Hosts</strong> &gt; <strong>Provisioning Templates</strong>.</p>
</li>
<li>
<p>Enter <code>PXELinux chain iPXE</code> to use <code>ipxe.lkrn</code> or, for BIOS systems, enter <code>PXELinux chain iPXE UNDI</code> to use <code>undionly-ipxe.0</code>, and click <strong>Search</strong>.</p>
</li>
<li>
<p>Optional: If you want to change the template, click <strong>Clone</strong>, enter a unique name, and click <strong>Submit</strong>.</p>
</li>
<li>
<p>Click the name of the template you want to use.</p>
</li>
<li>
<p>If you clone the template, you can make changes you require on the <strong>Template</strong> tab.</p>
</li>
<li>
<p>Click the <strong>Association</strong> tab and select the operating systems that your host uses.</p>
</li>
<li>
<p>Click the <strong>Locations</strong> tab and add the location where the host resides.</p>
</li>
<li>
<p>Click the <strong>Organizations</strong> tab and add the organization that the host belongs to.</p>
</li>
<li>
<p>Click <strong>Submit</strong> to save the changes.</p>
</li>
<li>
<p>In the <strong>Provisioning Templates</strong> page, enter <code>Kickstart default iPXE</code> into the search field and click <strong>Search</strong>.</p>
</li>
<li>
<p>Optional: If you want to change the template, click <strong>Clone</strong>, enter a unique name, and click <strong>Submit</strong>.</p>
</li>
<li>
<p>Click the name of the template you want to use.</p>
</li>
<li>
<p>If you clone the template, you can make changes you require on the <strong>Template</strong> tab.</p>
</li>
<li>
<p>Click the <strong>Association</strong> tab and associate the template with the operating system that your host uses.</p>
</li>
<li>
<p>Click the <strong>Locations</strong> tab and add the location where the host resides.</p>
</li>
<li>
<p>Click the <strong>Organizations</strong> tab and add the organization that the host belongs to.</p>
</li>
<li>
<p>Click <strong>Submit</strong> to save the changes.</p>
</li>
<li>
<p>Navigate to <strong>Hosts</strong> &gt; <strong>Operating systems</strong> and select the operating system of your host.</p>
</li>
<li>
<p>Click the <strong>Templates</strong> tab.</p>
</li>
<li>
<p>From the <strong>PXELinux template</strong> list, select the template you want to use.</p>
</li>
<li>
<p>From the <strong>iPXE template</strong> list, select the template you want to use.</p>
</li>
<li>
<p>Click <strong>Submit</strong> to save the changes.</p>
</li>
<li>
<p>Navigate to <strong>Hosts</strong> &gt; <strong>All Hosts</strong>, and select the host you want to use.</p>
</li>
<li>
<p>Select the <strong>Operating System</strong> tab.</p>
</li>
<li>
<p>Set <strong>PXE Loader</strong> to <strong>PXELinux BIOS</strong> to chainboot iPXE via PXELinux, or to <strong>iPXE Chain BIOS</strong> to load <code>undionly-ipxe.0</code> directly.</p>
</li>
<li>
<p>Select the <strong>Templates</strong> tab, and from the <strong>PXELinux template</strong> list, select <strong>Review</strong> to verify the template is the correct template.</p>
</li>
<li>
<p>From the <strong>iPXE template</strong> list, select <strong>Review</strong> to verify the template is the correct template.
If there is no PXELinux entry, or you cannot find the new template, navigate to <strong>Hosts</strong> &gt; <strong>All Hosts</strong>, and on your host, click <strong>Edit</strong>.
Click the <strong>Operating system</strong> tab and click the Provisioning Template <strong>Resolve</strong> button to refresh the list of templates.</p>
</li>
<li>
<p>Configure the <code>dhcpd.conf</code> file as follows:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">if exists user-class and option user-class = "iPXE" {
  filename "http://smartproxy.example.com:8000/unattended/iPXE?bootstrap=1";
} # elseif existing statements if non-iPXE environment should be preserved</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
If you have changed the port using the <code>--foreman-proxy-http-port</code> installer option, use your custom port.
You must update the <code>/etc/dhcp/dhcpd.conf</code> file after every upgrade.
</td>
</tr>
</table>
</div>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="Using_PXE_to_Provision_Hosts">6. Using PXE to Provision Hosts</h2>
<div class="sectionbody">
<div class="paragraph">
<p>There are four main ways to provision bare metal instances with Foreman 6.10:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Unattended Provisioning</dt>
<dd>
<p>New hosts are identified by a MAC address and Foreman&#160;server provisions the host using a PXE boot process.</p>
</dd>
<dt class="hdlist1">Unattended Provisioning with Discovery</dt>
<dd>
<p>New hosts use PXE boot to load the Foreman Discovery service.
This service identifies hardware information about the host and lists it as an available host to provision.
For more information, see <a href="#configuring-the-discovery-service">Configuring the Discovery Service</a>.</p>
</dd>
<dt class="hdlist1">PXE-less Provisioning</dt>
<dd>
<p>New hosts are provisioned with a boot disk or PXE-less discovery image that Foreman&#160;server generates.</p>
</dd>
<dt class="hdlist1">PXE-less Provisioning with Discovery</dt>
<dd>
<p>New hosts use an ISO boot disk that loads the Foreman Discovery service.
This service identifies hardware information about the host and lists it as an available host to provision.
For more information, see <a href="#implementing-pxe-less-discovery">Implementing PXE-less Discovery</a>.</p>
</dd>
</dl>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
Discovery workflows are only available when the Discovery plug-in is installed.
For more information, see <a href="#configuring-the-discovery-service">Configuring the Discovery Service</a>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<div class="title">BIOS and UEFI Support</div>
<p>With Foreman, you can perform both BIOS and UEFI based PXE provisioning.</p>
</div>
<div class="paragraph">
<p>Both BIOS and UEFI interfaces work as interpreters between the computer&#8217;s operating system and firmware, initializing the hardware components and starting the operating system at boot time.</p>
</div>
<div class="paragraph">
<p>In Foreman provisioning, the PXE loader option defines the DHCP <code>filename</code> option to use during provisioning.
For BIOS systems, use the <strong>PXELinux BIOS</strong> option to enable a provisioned node to download the <code>pxelinux.0</code> file over TFTP.
For UEFI systems, use the <strong>PXEGrub2 UEFI</strong> option to enable a TFTP client to download <code>grub2/grubx64.efi</code> file.</p>
</div>
<div class="paragraph">
<p>For BIOS provisioning, you must associate a PXELinux template with the operating system.</p>
</div>
<div class="paragraph">
<p>For UEFI provisioning, you must associate a PXEGrub2 template with the operating system.</p>
</div>
<div class="paragraph">
<p>If you associate both PXELinux and PXEGrub2 templates, Foreman can deploy configuration files for both on a TFTP server, so that you can switch between PXE loaders easily.</p>
</div>
<div class="sect2">
<h3 id="Provisioning_Bare_Metal_Hosts-Prerequisites_for_Bare_Metal_Provisioning">6.1. Prerequisites for Bare Metal Provisioning</h3>
<div class="paragraph">
<p>The requirements for bare metal provisioning include:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A Smart&#160;Proxy&#160;server managing the network for bare metal hosts.
For unattended provisioning and discovery-based provisioning, Foreman&#160;server requires PXE server settings.</p>
<div class="paragraph">
<p>For more information about networking requirements, see <a href="#Configuring_Networking">Configuring Networking</a>.</p>
</div>
<div class="paragraph">
<p>For more information about the Discovery service, <a href="#configuring-the-discovery-service">Configuring the Discovery Service</a>.</p>
</div>
</li>
<li>
<p>A bare metal host or a blank VM.</p>
</li>
<li>
<p>The installation media for the operating systems that you want to use to provision hosts.
If the Katello plug-in is installed, you can use synchronized content repositories for Red&#160;Hat Enterprise Linux.
For more information, see <a href="https://docs.theforeman.org/2.5/Content_Management_Guide/index-foreman-el.html#Importing_Content-Synchronizing_Repositories">Syncing Repositories</a> in the <em>Content Management Guide</em>.</p>
</li>
<li>
<p>If the Katello plug-in is installed, an activation key for host registration.
For more information, see <a href="https://docs.theforeman.org/2.5/Content_Management_Guide/index-foreman-el.html#Managing_Activation_Keys-Creating_an_Activation_Key">Creating An Activation Key</a> in the <em>Content Management</em> guide.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For information about the security token for unattended and PXE-less provisioning, see <a href="#Provisioning_Bare_Metal_Hosts-Security_Token_in_the_Boot_Process">Configuring the Security Token Validity Duration</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="Provisioning_Bare_Metal_Hosts-Security_Token_in_the_Boot_Process">6.2. Configuring the Security Token Validity Duration</h3>
<div class="paragraph">
<p>When performing unattended and PXE-less provisioning, as a security measure, Foreman automatically generates a unique token and adds this token to the OS installer recipe URL in the PXE configuration file (PXELinux, Grub2).
By default, the token is valid for 360 minutes.
When you provision a host, ensure that you reboot the host within this time frame.
If the token expires, it is no longer valid and you receive a 404 error and the operating system installer download fails.
To adjust the token&#8217;s duration of validity, in the Foreman web UI, navigate to <strong>Administer</strong> &gt; <strong>Settings</strong>, and click the <strong>Provisioning</strong> tab.
Find the <strong>Token duration</strong> option, and click the edit icon and edit the duration, or enter <code>0</code> to disable token generation.</p>
</div>
<div class="paragraph">
<p>If token generation is disabled, an attacker can spoof client IP address and download OS installer recipe from Foreman&#160;server, including the encrypted root password.</p>
</div>
</div>
<div class="sect2">
<h3 id="Provisioning_Bare_Metal_Hosts-Creating_New_Hosts_with_Unattended_Provisioning">6.3. Creating Hosts with Unattended Provisioning</h3>
<div class="paragraph">
<p>Unattended provisioning is the simplest form of host provisioning.
You enter the host details on Foreman&#160;server and boot your host.
Foreman&#160;server automatically manages the PXE configuration, organizes networking services, and provides the operating system and configuration for the host.</p>
</div>
<div class="paragraph">
<p>This method of provisioning hosts uses minimal interaction during the process.</p>
</div>
<div class="paragraph">
<p>To use the CLI instead of the web UI, see the <a href="#cli-creating-hosts-with-unattended-provisioning_provisioning">CLI procedure</a>.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>In the Foreman web UI, navigate to <strong>Hosts</strong> &gt; <strong>Create Host</strong>.</p>
</li>
<li>
<p>In the <strong>Name</strong> field, enter a name for the host.</p>
</li>
<li>
<p>Click the <strong>Organization</strong> and <strong>Location</strong> tabs and change the context to match your requirements.</p>
</li>
<li>
<p>From the <strong>Host Group</strong> list, select a host group that you want to use to populate the form.</p>
</li>
<li>
<p>Click the <strong>Interface</strong> tab, and on the host&#8217;s interface, click <strong>Edit</strong>.</p>
</li>
<li>
<p>Verify that the fields are populated with values.
Note in particular:</p>
<div class="ulist">
<ul>
<li>
<p>The <strong>Name</strong> from the <strong>Host</strong> tab becomes the <strong>DNS name</strong>.</p>
</li>
<li>
<p>Foreman&#160;server automatically assigns an IP address for the new host.</p>
</li>
</ul>
</div>
</li>
<li>
<p>In the <strong>MAC address</strong> field, enter a MAC address for the host.
This ensures the identification of the host during the PXE boot process.</p>
</li>
<li>
<p>Ensure that Foreman&#160;server automatically selects the <strong>Managed</strong>, <strong>Primary</strong>, and <strong>Provision</strong> options for the first interface on the host.
If not, select them.</p>
</li>
<li>
<p>In the <strong>MAC address</strong> field, enter a MAC address of the host&#8217;s provisioning interface.
This ensures the identification of the host during the PXE boot process.</p>
</li>
<li>
<p>Click <strong>OK</strong> to save.
To add another interface, click <strong>Add Interface</strong>.
You can select only one interface for <strong>Provision</strong> and <strong>Primary</strong>.</p>
</li>
<li>
<p>Click the <strong>Operating System</strong> tab, and verify that all fields contain values.
Confirm each aspect of the operating system.</p>
</li>
<li>
<p>Optional: Click <strong>Resolve</strong> in <strong>Provisioning template</strong> to check the new host can identify the right provisioning templates to use.</p>
<div class="paragraph">
<p>For more information about associating provisioning templates, see <a href="#provisioning-templates_provisioning">Provisioning Templates</a>.</p>
</div>
</li>
<li>
<p>If you use the Katello plugin, click the <strong>Parameters</strong> tab, and ensure that a parameter exists that provides an activation key.
If not, add an activation key.</p>
</li>
<li>
<p>Click <strong>Submit</strong> to save the host details.</p>
<div class="paragraph">
<p>For more information about network interfaces, see <a href="https://docs.theforeman.org/2.5/Managing_Hosts/index-foreman-el.html#Adding_Network_Interfaces">Adding network interfaces</a>.</p>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>This creates the host entry and the relevant provisioning settings.
This also includes creating the necessary directories and files for PXE booting the bare metal host.
If you start the physical host and set its boot mode to PXE, the host detects the DHCP service of Foreman&#160;server&#8217;s integrated Smart&#160;Proxy, receives HTTP endpoint of the Kickstart tree and installs the operating system.</p>
</div>
<div class="paragraph">
<p>If you use the Katello plug-in, when the installation completes, the host also registers to Foreman&#160;server using the activation key and installs the necessary configuration and management tools from the <a href="https://yum.theforeman.org/client/2.5/" class="bare">https://yum.theforeman.org/client/2.5/</a> repository.</p>
</div>
<div id="cli-creating-hosts-with-unattended-provisioning_provisioning" class="olist arabic">
<div class="title">CLI procedure</div>
<ol class="arabic">
<li>
<p>Create the host with the <code>hammer host create</code> command.</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># hammer host create --name "<em>My_Unattended_Host</em>" --organization "<em>My_Organization</em>" \
--location "<em>My_Location</em>" --hostgroup "<em>My_Host_Group</em>" --mac "<em>aa:aa:aa:aa:aa:aa</em>" \
--build true --enabled true --managed true</pre>
</div>
</div>
</li>
<li>
<p>Ensure the network interface options are set using the <code>hammer host interface update</code> command.</p>
<div class="listingblock">
<div class="content">
<pre># hammer host interface update --host "test1" --managed true \
--primary true --provision true</pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="Provisioning_Bare_Metal_Hosts-Creating_New_Hosts_with_PXE-less_Provisioning">6.4. Creating Hosts with PXE-less Provisioning</h3>
<div class="paragraph">
<p>Some hardware does not provide a PXE boot interface.
In Foreman, you can provision a host without PXE boot.
This is also known as PXE-less provisioning and involves generating a boot ISO that hosts can use.
Using this ISO, the host can connect to Foreman&#160;server, boot the installation media, and install the operating system.</p>
</div>
<div class="paragraph">
<p>Foreman also provides a PXE-less discovery service that operates without PXE-based services, such as DHCP and TFTP.
For more information, see <a href="#implementing-pxe-less-discovery">Implementing PXE-less Discovery</a>.</p>
</div>
<div class="paragraph">
<div class="title">Boot ISO Types</div>
<p>There are four types of boot ISOs:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Host image</dt>
<dd>
<p>A boot ISO for the specific host.
This image contains only the boot files that are necessary to access the installation media on Foreman&#160;server.
The user defines the subnet data in Foreman and the image is created with static networking.</p>
</dd>
<dt class="hdlist1">Full host image</dt>
<dd>
<p>A boot ISO that contains the kernel and initial RAM disk image for the specific host.
This image is useful if the host fails to chainload correctly.
The provisioning template still downloads from Foreman&#160;server.</p>
</dd>
<dt class="hdlist1">Generic image</dt>
<dd>
<p>A boot ISO that is not associated with a specific host.
The ISO sends the host&#8217;s MAC address to Foreman&#160;server, which matches it against the host entry.
The image does not store IP address details, and requires access to a DHCP server on the network to bootstrap.
This image is also available from the <code>/bootdisk/disks/generic</code> URL on your Foreman&#160;server, for example, <code>https://foreman.example.com/bootdisk/disks/generic</code>.</p>
</dd>
<dt class="hdlist1">Subnet image</dt>
<dd>
<p>A boot ISO that is similar to the generic image but is configured with the address of a Smart&#160;Proxy&#160;server.
This image is generic to all hosts with a provisioning NIC on the same subnet.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p><strong>Host image</strong> and <strong>Full host image</strong> contain provisioning tokens, therefore the generated image has limited lifespan.
For more information about configuring security tokens, read <a href="#Provisioning_Bare_Metal_Hosts-Security_Token_in_the_Boot_Process">Configuring the Security Token Validity Duration</a>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
The <strong>Full host image</strong> is based on SYSLINUX and Grub and works with most hardware.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>When using a <strong>Host image</strong>, <strong>Generic image</strong>, or <strong>Subnet image</strong>, see <a href="https://ipxe.org/appnote/hardware_drivers">supported hardware on ipxe.org</a> for a list of hardware drivers expected to work with an iPXE-based boot disk.</p>
</div>
<div class="paragraph">
<p>To use the CLI instead of the web UI, see the <a href="#cli-creating-hosts-with-pxe-less-provisioning_provisioning">CLI procedure</a>.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>In the Foreman web UI, navigate to <strong>Hosts</strong> &gt; <strong>Create Host</strong>.</p>
</li>
<li>
<p>In the <strong>Name</strong> field, enter a name that you want to become the provisioned system&#8217;s host name.</p>
</li>
<li>
<p>Click the <strong>Organization</strong> and <strong>Location</strong> tabs and change the context to match your requirements.</p>
</li>
<li>
<p>From the <strong>Host Group</strong> list, select a host group that you want to use to populate the form.</p>
</li>
<li>
<p>Click the <strong>Interface</strong> tab, and on the host&#8217;s interface, click <strong>Edit</strong>.</p>
</li>
<li>
<p>Verify that the fields are populated with values.
Note in particular:</p>
<div class="ulist">
<ul>
<li>
<p>The <strong>Name</strong> from the <strong>Host</strong> tab becomes the <strong>DNS name</strong>.</p>
</li>
<li>
<p>Foreman&#160;server automatically assigns an IP address for the new host.</p>
</li>
</ul>
</div>
</li>
<li>
<p>In the <strong>MAC address</strong> field, enter a MAC address for the host.</p>
</li>
<li>
<p>Ensure that Foreman&#160;server automatically selects the <strong>Managed</strong>, <strong>Primary</strong>, and <strong>Provision</strong> options for the first interface on the host.
If not, select them.</p>
</li>
<li>
<p>Click the <strong>Operating System</strong> tab, and verify that all fields contain values.
Confirm each aspect of the operating system.</p>
</li>
<li>
<p>Click <strong>Resolve</strong> in <strong>Provisioning template</strong> to check the new host can identify the right provisioning templates to use.</p>
<div class="paragraph">
<p>For more information about associating provisioning templates, see <a href="#provisioning-templates_provisioning">Provisioning Templates</a>.</p>
</div>
</li>
<li>
<p>If you use the Katello plug-in, click the <strong>Parameters</strong> tab, and ensure that a parameter exists that provides an activation key.
If not, add an activation key.</p>
</li>
<li>
<p>Click <strong>Submit</strong> to save the host details.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>This creates a host entry and the host details page appears.</p>
</div>
<div class="paragraph">
<p>The options on the upper-right of the window are the <strong>Boot disk</strong> menu.
From this menu, one of the following images is available for download: <strong>Host image</strong>, <strong>Full host image</strong>, <strong>Generic image</strong>, and <strong>Subnet image</strong>.</p>
</div>
<div id="cli-creating-hosts-with-pxe-less-provisioning_provisioning" class="olist arabic">
<div class="title">CLI procedure</div>
<ol class="arabic">
<li>
<p>Create the host with the <code>hammer host create</code> command.</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># hammer host create --name "<em>My_Bare_Metal</em>" --organization "<em>My_Organization</em>" \
--location "<em>My_Location</em>" --hostgroup "<em>My_Host_Group</em>" --mac "aa:aa:aa:aa:aa:aa" \
--build true --enabled true --managed true</pre>
</div>
</div>
</li>
<li>
<p>Ensure that your network interface options are set using the <code>hammer host interface update</code> command.</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># hammer host interface update --host "test3" --managed true \
--primary true --provision true</pre>
</div>
</div>
</li>
<li>
<p>Download the boot disk from Foreman&#160;server with the <code>hammer bootdisk host</code> command:</p>
<div class="ulist">
<ul>
<li>
<p>For <strong>Host image</strong>:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># hammer bootdisk host --host <em>test3.example.com</em></pre>
</div>
</div>
</li>
<li>
<p>For <strong>Full host image</strong>:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># hammer bootdisk host --host <em>test3.example.com</em> --full true</pre>
</div>
</div>
</li>
<li>
<p>For <strong>Generic image</strong>:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># hammer bootdisk generic</pre>
</div>
</div>
</li>
<li>
<p>For <strong>Subnet image</strong>:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># hammer bootdisk subnet --subnet <em>subnetName</em></pre>
</div>
</div>
</li>
</ul>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>This creates a boot ISO for your host to use.</p>
</div>
<div class="paragraph">
<p>Write the ISO to a USB storage device using the <strong>dd</strong> utility or <strong>livecd-tools</strong> if required.</p>
</div>
<div class="paragraph">
<p>When you start the physical host and boot from the ISO or the USB storage device, the host connects to Foreman&#160;server and starts installing operating system from its kickstart tree.</p>
</div>
</div>
<div class="sect2">
<h3 id="creating-hosts-with-uefi-http-boot-provisioning_provisioning">6.5. Creating Hosts with UEFI HTTP Boot Provisioning</h3>
<div class="paragraph">
<p>You can provision hosts from Foreman using the UEFI HTTP Boot.
This is the only method with which you can provision hosts in IPv6 network.</p>
</div>
<div class="paragraph">
<p>To use the CLI instead of the web UI, see the <a href="#cli-creating-hosts-with-uefi-http-boot-provisioning_provisioning">CLI procedure</a>.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>Ensure that you meet the requirements for HTTP booting.
For more information, see <a href="https://docs.theforeman.org/2.5/Planning_Guide/index-foreman-el.html#http-booting-requirements">HTTP Booting Requirements</a> in <em>Planning for Foreman</em>.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>On Smart&#160;Proxy that you use for provisioning, update the <code>grub2-efi</code> package to the latest version:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># yum install grub2-efi</pre>
</div>
</div>
</li>
<li>
<p>Enable <code>foreman-proxy-http</code>, <code>foreman-proxy-httpboot</code>, and <code>foreman-proxy-tftp</code> features.</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># foreman-installer --scenario foreman \
--foreman-proxy-httpboot true \
--foreman-proxy-http true \
--foreman-proxy-tftp true</pre>
</div>
</div>
</li>
<li>
<p>In the Foreman web UI, navigate to <strong>Hosts</strong> &gt; <strong>Create Host</strong>.</p>
</li>
<li>
<p>In the <strong>Name</strong> field, enter a name for the host.</p>
</li>
<li>
<p>Click the <strong>Organization</strong> and <strong>Location</strong> tabs and change the context to match your requirements.</p>
</li>
<li>
<p>From the <strong>Host Group</strong> list, select a host group that you want to use to populate the form.</p>
</li>
<li>
<p>Click the <strong>Interface</strong> tab, and on the host&#8217;s interface, click <strong>Edit</strong>.</p>
</li>
<li>
<p>Verify that the fields are populated with values.
Note in particular:</p>
<div class="ulist">
<ul>
<li>
<p>The <strong>Name</strong> from the <strong>Host</strong> tab becomes the <strong>DNS name</strong>.</p>
</li>
<li>
<p>Foreman&#160;server automatically assigns an IP address for the new host.</p>
</li>
</ul>
</div>
</li>
<li>
<p>In the <strong>MAC address</strong> field, enter a MAC address of the host&#8217;s provisioning interface.
This ensures the identification of the host during the PXE boot process.</p>
</li>
<li>
<p>Ensure that Foreman&#160;server automatically selects the <strong>Managed</strong>, <strong>Primary</strong>, and <strong>Provision</strong> options for the first interface on the host.
If not, select them.</p>
</li>
<li>
<p>Click <strong>OK</strong> to save.
To add another interface, click <strong>Add Interface</strong>.
You can select only one interface for <strong>Provision</strong> and <strong>Primary</strong>.</p>
</li>
<li>
<p>Click the <strong>Operating System</strong> tab, and verify that all fields contain values.
Confirm each aspect of the operating system.</p>
</li>
<li>
<p>From the <strong>PXE Loader</strong> list, select <strong>Grub2 UEFI HTTP</strong>.</p>
</li>
<li>
<p>Optional: Click <strong>Resolve</strong> in <strong>Provisioning template</strong> to check the new host can identify the right provisioning templates to use.</p>
<div class="paragraph">
<p>For more information about associating provisioning templates, see <a href="#creating-provisioning-templates_provisioning">Creating Provisioning Templates</a>.</p>
</div>
</li>
<li>
<p>If you use the Katello plugin, click the <strong>Parameters</strong> tab, and ensure that a parameter exists that provides an activation key.
If not, add an activation key.</p>
</li>
<li>
<p>Click <strong>Submit</strong> to save the host details.</p>
<div class="paragraph">
<p>For more information about network interfaces, see <a href="https://docs.theforeman.org/2.5/Managing_Hosts/index-foreman-el.html#Adding_Network_Interfaces">Adding network interfaces</a>.</p>
</div>
</li>
<li>
<p>Set the host to boot in UEFI mode from network.</p>
</li>
<li>
<p>Start the host.</p>
</li>
<li>
<p>From the boot menu, select <strong>Kickstart default PXEGrub2</strong>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>This creates the host entry and the relevant provisioning settings.
This also includes creating the necessary directories and files for UEFI booting the bare metal host.
When you start the physical host and set its boot mode to UEFI HTTP, the host detects the defined DHCP service, receives HTTP endpoint of Smart&#160;Proxy with the Kickstart tree and installs the operating system.</p>
</div>
<div class="paragraph">
<p>If you use the Katello plug-in, when the installation completes, the host also registers to Foreman&#160;server using the activation key and installs the necessary configuration and management tools from the <a href="https://yum.theforeman.org/client/2.5/" class="bare">https://yum.theforeman.org/client/2.5/</a> repository.</p>
</div>
<div id="cli-creating-hosts-with-uefi-http-boot-provisioning_provisioning" class="olist arabic">
<div class="title">CLI procedure</div>
<ol class="arabic">
<li>
<p>On Smart&#160;Proxy that you use for provisioning, update the <code>grub2-efi</code> package to the latest version:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># yum install grub2-efi</pre>
</div>
</div>
</li>
<li>
<p>Enable <code>foreman-proxy-http</code>, <code>foreman-proxy-httpboot</code>, and <code>foreman-proxy-tftp true</code> features.</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># foreman-installer --scenario foreman \
--foreman-proxy-httpboot true \
--foreman-proxy-http true \
--foreman-proxy-tftp true</pre>
</div>
</div>
</li>
<li>
<p>Create the host with the <code>hammer host create</code> command.</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># hammer host create --name "<em>My_Host</em>" \
--organization "<em>My_Organization</em>" \
--location "<em>My_Location</em>" \
--hostgroup "<em>My_Host_Group</em>" \
--mac "<em>aa:aa:aa:aa:aa:aa</em>" \
--build true \
--enabled true \
--managed true \
--pxe-loader "Grub2 UEFI HTTP"</pre>
</div>
</div>
</li>
<li>
<p>Ensure the network interface options are set using the <code>hammer host interface update</code> command.</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># hammer host interface update --host "<em>My_Host</em>" \
--managed true \
--primary true \
--provision true</pre>
</div>
</div>
</li>
<li>
<p>Set the host to boot in UEFI mode from network.</p>
</li>
<li>
<p>Start the host.</p>
</li>
<li>
<p>From the boot menu, select <strong>Kickstart default PXEGrub2</strong>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>This creates the host entry and the relevant provisioning settings.
This also includes creating the necessary directories and files for UEFI booting the bare metal host.
When you start the physical host and set its boot mode to UEFI HTTP, the host detects the defined DHCP service, receives HTTP endpoint of Smart&#160;Proxy with the Kickstart tree and installs the operating system.</p>
</div>
<div class="paragraph">
<p>If you use the Katello plug-in, when the installation completes, the host also registers to Foreman&#160;server using the activation key and installs the necessary configuration and management tools from the <a href="https://yum.theforeman.org/client/2.5/" class="bare">https://yum.theforeman.org/client/2.5/</a> repository.</p>
</div>
</div>
<div class="sect2">
<h3 id="Configuring_Provisioning_Resources-Creating_Provisioning_Templates-Deploying_SSH_Keys_during_Provisioning">6.6. Deploying SSH Keys during Provisioning</h3>
<div class="paragraph">
<p>Use this procedure to deploy SSH keys added to a user during provisioning.
For information on adding SSH keys to a user, see <a href="https://docs.theforeman.org/2.5/Administering_Red_Hat_Satellite/index-foreman-el.html#managing-ssh-keys-for-a-user_admin">Managing SSH Keys for a User</a> in <em>Administering Foreman</em>.</p>
</div>
<div class="paragraph">
<div class="title">Procedure</div>
<p>To deploy SSH keys during provisioning, complete the following steps:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>In the Foreman web UI, navigate to <strong>Hosts</strong> &gt; <strong>Provisioning Templates</strong>.</p>
</li>
<li>
<p>Create a provisioning template, or clone and edit an existing template.
For more information, see <a href="#creating-provisioning-templates_provisioning">Creating Provisioning Templates</a>.</p>
</li>
<li>
<p>In the template, click the <strong>Template</strong> tab.</p>
</li>
<li>
<p>In the <strong>Template editor</strong> field, add the <code>create_users</code> snippet to the <code>%post</code> section:</p>
<div class="listingblock">
<div class="content">
<pre>&lt;%= snippet('create_users') %&gt;</pre>
</div>
</div>
</li>
<li>
<p>Select the <strong>Default</strong> check box.</p>
</li>
<li>
<p>Click the <strong>Association</strong> tab.</p>
</li>
<li>
<p>From the <strong>Application Operating Systems</strong> list, select an operating system.</p>
</li>
<li>
<p>Click <strong>Submit</strong> to save the provisioning template.</p>
</li>
<li>
<p>Create a host that is associated with the provisioning template or rebuild a host using the OS associated with the modified template.
For more information, see <a href="https://docs.theforeman.org/2.5/Managing_Hosts/index-foreman-el.html#creating-a-host-in-satellite">Creating a Host</a> in the <em>Managing Hosts</em> guide.</p>
<div class="paragraph">
<p>The SSH keys of the <strong>Owned by</strong> user are added automatically when the <code>create_users</code> snippet is executed during the provisioning process.
You can set <strong>Owned by</strong> to an individual user or a user group.
If you set <strong>Owned by</strong> to a user group, the SSH keys of all users in the user group are added automatically.</p>
</div>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="configuring-the-discovery-service">7. Configuring the Discovery Service</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Foreman can detect hosts on a network that are not in your Foreman inventory.
These hosts boot the discovery image that performs hardware detection and relays this information back to Foreman&#160;server.
This method creates a list of ready-to-provision hosts in Foreman&#160;server without needing to enter the MAC address of each host.</p>
</div>
<div class="paragraph">
<p>When you boot a blank bare-metal host, the boot menu has two options: <code>local</code> and <code>discovery</code>.
If you select <code>discovery</code> to boot the Discovery image, after a few minutes, the Discovery image completes booting and a status screen is displayed.</p>
</div>
<div class="paragraph">
<p>The Discovery service is enabled by default on Foreman&#160;server.
However, the default setting of the global templates is to boot from the local hard drive.
To change the default setting, in the Foreman web UI, navigate to <strong>Administer</strong> &gt; <strong>Settings</strong>, and click the <strong>Provisioning</strong> tab.
Locate the <strong>Default PXE global template entry</strong> row, and in the <strong>Value</strong> column, enter <strong>discovery</strong>.</p>
</div>
<div class="paragraph">
<p>The graphics in this section are Red Hat illustrations.
Non-Red Hat illustrations are welcome.
If you want to contribute alternative images, raise a pull request in the <a href="https://github.com/theforeman/foreman-documentation">Foreman Documentation</a> GitHub page.
Note that in Red Hat terminology, "Satellite" refers to Foreman and "Capsule" refers to Smart Proxy.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/PXE-mode.svg" alt="PXE mode">
</div>
</div>
<div class="paragraph">
<p>To use Foreman&#160;server to provide the Discovery image, install the following RPM packages:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>tfm-rubygem-foreman_discovery</code></p>
</li>
<li>
<p><code>tfm-rubygem-smart_proxy_discovery</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The <code>tfm-rubygem-foreman_discovery</code> package contains the Foreman plug-in to handle discovered nodes, connections, and necessary database structures, and API.</p>
</div>
<div class="paragraph">
<p>The <code>tfm-rubygem-smart_proxy_discovery</code> package configures Smart&#160;Proxy&#160;server, such as the integrated Smart&#160;Proxy of Foreman&#160;server, to act as a proxy for the Discovery service.</p>
</div>
<div class="paragraph">
<p>You can use the <code>foreman-installer</code> tool to install the packages and the Discovery image.</p>
</div>
<div class="paragraph">
<p>When the installation completes, you can view the new menu option by navigating to <strong>Hosts</strong> &gt; <strong>Discovered Hosts</strong>.</p>
</div>
<div class="sect2">
<h3 id="installing-the-discovery-service">7.1. Installing the Discovery Service</h3>
<div class="paragraph">
<p>Complete the following procedure to enable the Discovery service on Smart&#160;Proxy&#160;server.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Enter the following commands on Smart&#160;Proxy&#160;server:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># foreman-installer \
  --enable-foreman-proxy-plugin-discovery \
  --foreman-proxy-plugin-discovery-install-images=true \
  --foreman-proxy-plugin-discovery-source-url=http://downloads.theforeman.org/discovery/releases/3.5/</pre>
</div>
</div>
</li>
<li>
<p>Restart the foreman-maintain services:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># foreman-maintain service restart</pre>
</div>
</div>
</li>
<li>
<p>In the Foreman web UI, navigate to <strong>Infrastructure</strong> &gt; <strong>Smart&#160;Proxy</strong>.</p>
</li>
<li>
<p>Click Smart&#160;Proxy&#160;server and select <strong>Refresh</strong> from the <strong>Actions</strong> list.
Locate <strong>Discovery</strong> in the list of features to confirm the Discovery service is now running.</p>
</li>
</ol>
</div>
<div class="paragraph">
<div class="title">Subnets</div>
<p>All subnets with discoverable hosts require an appropriate Smart&#160;Proxy&#160;server selected to provide the Discovery service.</p>
</div>
<div class="paragraph">
<p>To check this, navigate to <strong>Infrastructure</strong> &gt; <strong>Smart&#160;Proxies</strong> and verify if Smart&#160;Proxy&#160;server that you want to use lists the Discovery feature.
If not, click <strong>Refresh features</strong>.</p>
</div>
<div class="paragraph">
<p>In the Foreman web UI, navigate to <strong>Infrastructure</strong> &gt; <strong>Subnets</strong>, select a subnet, click the Smart&#160;Proxies tab, and select the <strong>Discovery Proxy</strong> that you want to use.
Perform this for each subnet that you want to use.</p>
</div>
</div>
<div class="sect2">
<h3 id="the-provisioning-template-pxelinux-discovery-snippet">7.2. The Provisioning Template PXELinux Discovery Snippet</h3>
<div class="paragraph">
<p>For BIOS provisioning, the <code>PXELinux global default</code> template in the <strong>Hosts</strong> &gt; <strong>Provisioning Templates</strong> window contains the snippet <code>pxelinux_discovery</code>.
The snippet has the following lines:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">LABEL discovery
  MENU LABEL Foreman Discovery Image
  KERNEL boot/fdi-image/vmlinuz0
  APPEND initrd=boot/fdi-image/initrd0.img rootflags=loop root=live:/fdi.iso rootfstype=auto ro rd.live.image acpi=force rd.luks=0 rd.md=0 rd.dm=0 rd.lvm=0 rd.bootif=0 rd.neednet=0 nomodeset proxy.url=&lt;%= foreman_server_url %&gt; proxy.type=foreman
  IPAPPEND 2</pre>
</div>
</div>
<div class="paragraph">
<p>The <code>KERNEL</code> and <code>APPEND</code> options boot the Discovery image and ramdisk.
The <code>APPEND</code> option contains a <code>proxy.url</code> parameter, with the <code>foreman_server_url</code> macro as its argument.
This macro resolves to the full URL of Foreman&#160;server.</p>
</div>
<div class="paragraph">
<p>For UEFI provisioning, the <code>PXEgrub2 global default</code> template in the <strong>Hosts</strong> &gt; <strong>Provisioning Templates</strong> window contains the snippet <code>pxegrub2_discovery</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">menuentry 'Foreman Discovery Image' --id discovery {
  linuxefi boot/fdi-image/vmlinuz0 rootflags=loop root=live:/fdi.iso rootfstype=auto ro rd.live.image acpi=force rd.luks=0 rd.md=0 rd.dm=0 rd.lvm=0 rd.bootif=0 rd.neednet=0 nomodeset proxy.url=&lt;%= foreman_server_url %&gt; proxy.type=foreman BOOTIF=01-$mac
  initrdefi boot/fdi-image/initrd0.img
}</pre>
</div>
</div>
<div class="paragraph">
<p>To use Smart&#160;Proxy to proxy the discovery steps, edit <code>/var/lib/tftpboot/pxelinux.cfg/default</code> or <code>/var/lib/tftpboot/grub2/grub.cfg</code> and change the URL to Smart&#160;Proxy&#160;server FQDN you want to use.</p>
</div>
<div class="paragraph">
<p>The global template is available on Foreman&#160;server and all Smart&#160;Proxies that have the TFTP feature enabled.</p>
</div>
</div>
<div class="sect2">
<h3 id="automatic-contexts-for-discovered-hosts">7.3. Automatic Contexts for Discovered Hosts</h3>
<div class="paragraph">
<p>Foreman&#160;server assigns an organization and location to discovered hosts according to the following sequence of rules:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>If a discovered host uses a subnet defined in Foreman, the host uses the first organization and location associated with the subnet.</p>
</li>
<li>
<p>If the <code>discovery_organization</code> or <code>discovery_location</code> fact values are set, the discovered host uses these fact values as an organization and location.
To set these fact values, navigate to <strong>Administer</strong> &gt; <strong>Settings</strong> &gt; <strong>Discovered</strong>, and add these facts to the <strong>Default organization</strong> and <strong>Default location</strong> fields.
Ensure that the discovered host&#8217;s subnet also belongs to the organization and location set by the fact, otherwise  Foreman refuses to set it for security reasons.</p>
</li>
<li>
<p>If none of the previous conditions exists, Foreman assigns the first Organization and Location ordered by name.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>You can change the organization or location using the bulk actions menu of the <strong>Discovered hosts</strong> page.
Select the discovered hosts to modify and select <strong>Assign Organization</strong> or <strong>Assign Location</strong> from the <strong>Select Action</strong> menu.</p>
</div>
<div class="paragraph">
<p>Note that the <code>foreman_organization</code> and <code>foreman_location</code> facts are no longer valid values for assigning context for discovered hosts.
You still can use these facts to configure the host for Puppet runs.
To do this, navigate to <strong>Administer</strong> &gt; <strong>Settings</strong> &gt; <strong>Puppet</strong> section and add the <code>foreman_organization</code> and <code>foreman_location</code> facts to the <strong>Default organization</strong> and <strong>Default location</strong> fields.</p>
</div>
</div>
<div class="sect2">
<h3 id="discovery-templates-and-snippets-settings">7.4. Discovery Templates and Snippets Settings</h3>
<div class="paragraph">
<p>To use the Discovery service, you must configure provisioning settings to set Discovery as the default service and set the templates that you want to use.</p>
</div>
<div class="paragraph">
<div class="title">Setting Discovery Service as Default</div>
<p>For both BIOS and UEFI, to set the Discovery service as the default service that boots for hosts that are not present in your current Foreman inventory, complete the following steps:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>In the Foreman web UI, navigate to <strong>Administer</strong> &gt; <strong>Settings</strong> and click the <strong>Provisioning</strong> tab.</p>
</li>
<li>
<p>For the <strong>Default PXE global template entry</strong>, in the <strong>Value</strong> column, enter <code>discovery</code>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>To use a template, in the Foreman web UI, navigate to <strong>Administer</strong> &gt; <strong>Settings</strong> and click the <strong>Provisioning</strong> tab and set the templates that you want to use.</p>
</div>
<div class="paragraph">
<div class="title">Customizing Templates and Snippets</div>
<p>Templates and snippets are locked to prevent changes.
If you want to edit a template or snippet, clone it, save it with a unique name, and then edit the clone.</p>
</div>
<div class="paragraph">
<p>When you change the template or a snippet it includes, the changes must be propagated to Foreman&#160;server&#8217;s default PXE template.</p>
</div>
<div class="paragraph">
<p>In the Foreman web UI, navigate to <strong>Hosts</strong> &gt; <strong>Provisioning Templates</strong> and click <strong>Build PXE Default</strong>.</p>
</div>
<div class="paragraph">
<p>This refreshes the default PXE template on Foreman&#160;server.</p>
</div>
<div class="dlist">
<div class="title">Additional Settings</div>
<dl>
<dt class="hdlist1">The proxy.url argument</dt>
<dd>
<p>During the Foreman installation process, if you use the default option <code>--enable-foreman-plugin-discovery</code>, you can edit the <code>proxy.url</code> argument in the template to set the URL of Smart&#160;Proxy&#160;server that provides the discovery service.
You can change the <code>proxy.url</code> argument to the IP address or FQDN of another provisioning Smart&#160;Proxy that you want to use, but ensure that you append the port number, for example, <code>9090</code>.
If you use an alternative port number with the <code>--foreman-proxy-ssl-port</code> option during Foreman installation, you must add that port number.
You can also edit the <code>proxy.url</code> argument to use a Foreman IP address or FQDN so that the discovered hosts communicate directly with Foreman&#160;server.</p>
</dd>
<dt class="hdlist1">The proxy.type argument</dt>
<dd>
<p>If you use a Smart&#160;Proxy&#160;server FQDN for the <code>proxy.url</code> argument, ensure that you set the <code>proxy.type</code> argument to <code>proxy</code>.
If you use a Foreman FQDN, update the <code>proxy.type</code> argument to <code>foreman</code>.</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">proxy.url=https://<em>smartproxy.example.com</em>:8443 proxy.type=proxy</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
For katello scenario deployment, use port 9090.
</td>
</tr>
</table>
</div>
</dd>
</dl>
</div>
<div class="paragraph">
<div class="title">Rendering the Smart&#160;Proxy&#8217;s Host Name</div>
<p>Foreman deploys the same template to all TFTP Smart&#160;Proxies and there is no variable or macro available to render the Smart&#160;Proxy&#8217;s host name.
The hard-coded <code>proxy.url</code> does not not work with two or more TFTP Smart&#160;Proxies.
As a workaround, every time you click <strong>Build PXE Defaults</strong>, edit the configuration file in the TFTP directory using SSH, or use a common DNS alias for appropriate subnets.</p>
</div>
<div class="paragraph">
<div class="title">Tagged VLAN Provisioning</div>
<p>If you want to use tagged VLAN provisioning, and you want the discovery service to send a discovery request, add the following information to the <code>KERNEL</code> option in the discovery template:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">fdi.vlan.primary=<em>example_VLAN_ID</em></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="creating-hosts-from-discovered-hosts">7.5. Creating Hosts from Discovered Hosts</h3>
<div class="paragraph">
<p>Provisioning discovered hosts follows a provisioning process that is similar to PXE provisioning.
The main difference is that instead of manually entering the host&#8217;s MAC address, you can select the host to provision from the list of discovered hosts.</p>
</div>
<div class="paragraph">
<p>To use the CLI instead of the web UI, see the <a href="#cli-creating-hosts-from-discovered-hosts_provisioning">CLI procedure</a>.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>Configure a domain and subnet on Foreman.
For more information about networking requirements, see <a href="#Configuring_Networking">Configuring Networking</a>.</p>
</li>
<li>
<p>Configure the discovery service on Foreman.
For more information, see <a href="#installing-the-discovery-service">Installing the Discovery Service</a>.</p>
</li>
<li>
<p>A bare metal host or a blank VM.</p>
</li>
<li>
<p>The installation media for the operating systems that you want to use to provision hosts.
If the Katello plug-in is installed, you can use synchronized content repositories for Red&#160;Hat Enterprise Linux.
For more information, see <a href="https://docs.theforeman.org/2.5/Content_Management_Guide/index-foreman-el.html#Importing_Content-Synchronizing_Repositories">Syncing Repositories</a> in the <em>Content Management Guide</em>.</p>
</li>
<li>
<p>If the Katello plug-in is installed, an activation key for host registration.
For more information, see <a href="https://docs.theforeman.org/2.5/Content_Management_Guide/index-foreman-el.html#Managing_Activation_Keys-Creating_an_Activation_Key">Creating An Activation Key</a> in the <em>Content Management</em> guide.
For information about the security token for unattended and PXE-less provisioning, see <a href="#Provisioning_Bare_Metal_Hosts-Security_Token_in_the_Boot_Process">Configuring the Security Token Validity Duration</a>.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>In the Foreman web UI, navigate to <strong>Hosts</strong> &gt; <strong>Discovered host</strong>.
Select the host you want to use and click <strong>Provision</strong> to the right of the list.</p>
</li>
<li>
<p>Select from one of the two following options:</p>
<div class="ulist">
<ul>
<li>
<p>To provision a host from a host group, select a host group, organization, and location, and then click <strong>Create Host</strong>.</p>
</li>
<li>
<p>To provision a host with further customization, click <strong>Customize Host</strong> and enter the additional details you want to specify for the new host.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Verify that the fields are populated with values.
Note in particular:</p>
<div class="ulist">
<ul>
<li>
<p>The <strong>Name</strong> from the <strong>Host</strong> tab becomes the <strong>DNS name</strong>.</p>
</li>
<li>
<p>Foreman&#160;server automatically assigns an IP address for the new host.</p>
</li>
<li>
<p>Foreman&#160;server automatically populates the MAC address from the Discovery results.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Ensure that Foreman&#160;server automatically selects the <strong>Managed</strong>, <strong>Primary</strong>, and <strong>Provision</strong> options for the first interface on the host.
If not, select them.</p>
</li>
<li>
<p>Click the <strong>Operating System</strong> tab, and verify that all fields contain values.
Confirm each aspect of the operating system.</p>
</li>
<li>
<p>Click <strong>Resolve</strong> in <strong>Provisioning template</strong> to check the new host can identify the right provisioning templates to use.
The host must resolve to the following provisioning templates:</p>
<div class="ulist">
<ul>
<li>
<p><strong>kexec Template:</strong> <code>Discovery Red Hat kexec</code></p>
</li>
<li>
<p><strong>provision Template:</strong> <code>Foreman Kickstart Default</code></p>
<div class="paragraph">
<p>For more information about associating provisioning templates, see <a href="#provisioning-templates_provisioning">Provisioning Templates</a>.</p>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>Click <strong>Submit</strong> to save the host details.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>When the host provisioning is complete, the discovered host becomes a content host.
To view the host, navigate to <strong>Hosts</strong> &gt; <strong>Content Hosts</strong>.</p>
</div>
<div id="cli-creating-hosts-from-discovered-hosts_provisioning" class="olist arabic">
<div class="title">CLI procedure</div>
<ol class="arabic">
<li>
<p>Identify the discovered host to use for provisioning:</p>
<div class="listingblock">
<div class="content">
<pre># hammer discovery list</pre>
</div>
</div>
</li>
<li>
<p>Select a host and provision it using a host group.
Set a new host name with the <code>--new-name</code> option:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># hammer discovery provision --name "<em>host_name</em>" \
--new-name "<em>new_host_name</em>" --organization "<em>My_Organization</em>" \
--location "<em>My_Location</em>" --hostgroup "<em>My_Host_Group</em>" --build true \
--enabled true --managed true</pre>
</div>
</div>
<div class="paragraph">
<p>This removes the host from the discovered host listing and creates a host entry with the provisioning settings.
The Discovery image automatically resets the host so that it can boot to PXE.
The host detects the DHCP service on Foreman&#160;server&#8217;s integrated Smart&#160;Proxy and starts installing the operating system.
The rest of the process is identical to normal PXE workflow described in <a href="#Provisioning_Bare_Metal_Hosts-Creating_New_Hosts_with_Unattended_Provisioning">Creating Hosts with Unattended Provisioning</a>.</p>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="creating-discovery-rules">7.6. Creating Discovery Rules</h3>
<div class="paragraph">
<p>As a method of automating the provisioning process for discovered hosts, Foreman provides a feature to create discovery rules.
These rules define how discovered hosts automatically provision themselves, based on the assigned host group.
For example, you can automatically provision hosts with a high CPU count as hypervisors.
Likewise, you can provision hosts with large hard disks as storage servers.</p>
</div>
<div class="paragraph">
<p>To use the CLI instead of the web UI, see the <a href="#cli-creating-discovery-rules_provisioning">CLI procedure</a>.</p>
</div>
<div class="paragraph">
<div class="title">NIC Considerations</div>
<p>Auto provisioning does not currently allow configuring NICs; all systems are being provisioned with the NIC configuration that was detected during discovery.
However, you can set the NIC in the <code>OS installer recipe</code> scriplet, using a script, or using configuration management at a later stage.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>In the Foreman web UI, navigate to <strong>Configure</strong> &gt; <strong>Discovery rules</strong>, and select <strong>Create Rule</strong>.</p>
</li>
<li>
<p>In the <strong>Name</strong> field, enter a name for the rule.</p>
</li>
<li>
<p>In the <strong>Search</strong> field, enter the rules to determine whether to provision a host.
This field provides suggestions for values you enter and allows operators for multiple rules.
For example: <code>cpu_count  &gt; 8</code>.</p>
</li>
<li>
<p>From the <strong>Host Group</strong> list, select the host group to use as a template for this host.</p>
</li>
<li>
<p>In the <strong>Hostname</strong> field, enter the pattern to determine host names for multiple hosts.
This uses the same ERB syntax that provisioning templates use.
The host name can use the <code>@host</code> attribute for host-specific values and the <code>rand</code> macro for a random number or the <code>sequence_hostgroup_param_next</code> macro for incrementing the value.
For more information about provisioning templates, see <a href="#provisioning-templates_provisioning">Provisioning Templates</a> and the API documentation.</p>
<div class="ulist">
<ul>
<li>
<p><code>myhost-&lt;%= sequence_hostgroup_param_next("EL7/MyHostgroup", 10, "discovery_host") %&gt;</code></p>
</li>
<li>
<p><code>myhost-&lt;%= rand(99999) %&gt;</code></p>
</li>
<li>
<p><code>abc-&lt;%= @host.facts['bios_vendor'] %&gt;-&lt;%= rand(99999) %&gt;</code></p>
</li>
<li>
<p><code>xyz-&lt;%= @host.hostgroup.name %&gt;</code></p>
</li>
<li>
<p><code>srv-&lt;%= @host.discovery_rule.name %&gt;</code></p>
</li>
<li>
<p><code>server-&lt;%= @host.ip.gsub('.','-') +  '-' + @host.hostgroup.subnet.name %&gt;</code></p>
<div class="paragraph">
<p>When creating host name patterns, ensure that the resulting host names are unique, do not start with numbers, and do not contain underscores or dots.
A good approach is to use unique information provided by Facter, such as the MAC address, BIOS, or serial ID.</p>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>In the <strong>Hosts limit</strong> field, enter the maximum number of hosts that you can provision with the rule.
Enter <code>0</code> for unlimited.</p>
</li>
<li>
<p>In the <strong>Priority</strong> field, enter a number to set the precedence the rule has over other rules.
Rules with lower values have a higher priority.</p>
</li>
<li>
<p>From the <strong>Enabled</strong> list, select whether you want to enable the rule.</p>
</li>
<li>
<p>To set a different provisioning context for the rule, click the <strong>Organizations</strong> and <strong>Locations</strong> tabs and select the contexts you want to use.</p>
</li>
<li>
<p>Click <strong>Submit</strong> to save your rule.</p>
</li>
<li>
<p>Navigate to <strong>Hosts</strong> &gt; <strong>Discovered Host</strong> and select one of the following two options:</p>
<div class="ulist">
<ul>
<li>
<p>From the <strong>Discovered hosts</strong> list on the right, select <strong>Auto-Provision</strong> to automatically provisions a single host.</p>
</li>
<li>
<p>On the upper right of the window, click <strong>Auto-Provision All</strong> to automatically provisions all hosts.</p>
</li>
</ul>
</div>
</li>
</ol>
</div>
<div id="cli-creating-discovery-rules_provisioning" class="olist arabic">
<div class="title">CLI procedure</div>
<ol class="arabic">
<li>
<p>Create the rule with the <code>hammer discovery-rule create</code> command:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># hammer discovery-rule create --name "Hypervisor" \
--search "cpu_count  &gt; 8" --hostgroup "<em>My_Host_Group</em>" \
--hostname "hypervisor-&lt;%= rand(99999) %&gt;" \
--hosts-limit 5 --priority 5 --enabled true</pre>
</div>
</div>
</li>
<li>
<p>Automatically provision a host with the <code>hammer discovery auto-provision</code> command:</p>
<div class="listingblock">
<div class="content">
<pre># hammer discovery auto-provision --name "macabcdef123456"</pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="implementing-pxe-less-discovery">7.7. Implementing PXE-less Discovery</h3>
<div class="paragraph">
<p>Foreman provides a PXE-less Discovery service that operates without the need for PXE-based services (DHCP and TFTP).
You accomplish this using Foreman&#160;server&#8217;s Discovery image.
Once a discovered node is scheduled for installation, it uses <code>kexec</code> command to reload Linux kernel with OS installer without rebooting the node.</p>
</div>
<div class="paragraph">
<div class="title">Known Issues</div>
<p>The console might freeze during the process.
On some hardware, you might experience graphical hardware problems.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/PXEless-mode.svg" alt="PXEless mode">
</div>
</div>
<div class="paragraph">
<p>If you have not yet installed the Discovery service or image, see <a href="#building-a-discovery-image">Building a Discovery Image</a>.</p>
</div>
<div class="olist arabic">
<div class="title">Attended Use</div>
<ol class="arabic">
<li>
<p>Copy this media to either a CD, DVD, or a USB stick.
For example, to copy to a USB stick at <code>/dev/sdb</code>:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># dd bs=4M \
if=/usr/share/foreman-discovery-image/foreman-discovery-image-3.4.4-5.iso \
of=/dev/sdb</pre>
</div>
</div>
</li>
<li>
<p>Insert the Discovery boot media into a bare metal host, start the host, and boot from the media.
The Discovery Image displays an option for either <strong>Manual network setup</strong> or <strong>Discovery with DHCP</strong>:</p>
<div class="paragraph">
<p>If you select <strong>Manual network setup</strong>, the Discovery image requests a set of network options.
This includes the primary network interface that connects to Foreman&#160;server.
This Discovery image also asks for network interface configuration options, such as an <strong>IPv4 Address</strong>, <strong>IPv4 Gateway</strong>, and an <strong>IPv4 DNS</strong> server.</p>
</div>
</li>
<li>
<p>After entering these details, select <strong>Next</strong>.</p>
</li>
<li>
<p>If you select <strong>Discovery with DHCP</strong>, the Discovery image requests only the primary network interface that connects to Foreman&#160;server.
It attempts to automatically configure the network interface using a DHCP server, such as one that a Smart&#160;Proxy&#160;server provides.</p>
</li>
<li>
<p>After the primary interface configuration, the Discovery image requests the <strong>Server URL</strong>, which is the URL of Foreman&#160;server or Smart&#160;Proxy&#160;server offering the Discovery service.
For example, to use the integrated Smart&#160;Proxy on Foreman&#160;server, use the following URL:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">https://foreman.example.com:8443</pre>
</div>
</div>
</li>
<li>
<p>Set the <strong>Connection type</strong> to <code>Proxy</code>, then select <strong>Next</strong>.</p>
</li>
<li>
<p>Optional: The Discovery image also provides a set of fields to input <strong>Custom facts</strong> for the Facter tool to relay back to Foreman&#160;server.
These are entered in a <strong>name</strong>-<strong>value</strong> format.
Provide any custom facts you require and select <strong>Confirm</strong> to continue.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Foreman reports a successful communication with Foreman&#160;server&#8217;s Discovery service.
Navigate to <strong>Hosts</strong> &gt; <strong>Discovered Hosts</strong> and view the newly discovered host.</p>
</div>
<div class="paragraph">
<p>For more information about provisioning discovered hosts, see <a href="#creating-hosts-from-discovered-hosts">Creating Hosts from Discovered Hosts</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="building-a-discovery-image">7.8. Building a Discovery Image</h3>
<div class="paragraph">
<p>The Discovery image is a minimal operating system that is PXE-booted on hosts to acquire initial hardware information and to check in with Foreman.
Discovered hosts keep running the Discovery image until they are rebooted into Anaconda, which then initiates the provisioning process.</p>
</div>
<div class="paragraph">
<p>The operating system image is based on Cent OS.</p>
</div>
<div class="paragraph">
<p>Use this procedure to build a Foreman discovery image or rebuild an image if you change configuration files.</p>
</div>
<div class="paragraph">
<p>Do not use this procedure on your production Foreman or Smart&#160;Proxy.
Use either a dedicated environment or copy the synchronized repositories and a kickstart file to a separate server.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>Install the <code>livecd-tools</code> package:</p>
<div class="listingblock">
<div class="content">
<pre># yum install livecd-tools</pre>
</div>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<div class="title">Procedure</div>
<p>To build the Foreman discovery image, complete the following steps:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Open the <code>/usr/share/foreman-discovery-image/foreman-discovery-image.ks</code> file for editing:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># vim /usr/share/foreman-discovery-image/foreman-discovery-image.ks</pre>
</div>
</div>
</li>
<li>
<p>Replace the <code>repo</code> lines in the kickstart file with the repository URLs:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">repo --name=centos --mirrorlist=http://mirrorlist.centos.org/?release=7&arch=$basearch&repo=os
repo --name=centos-updates --mirrorlist=http://mirrorlist.centos.org/?release=7&arch=$basearch&repo=updates
repo --name=epel7 --mirrorlist=https://mirrors.fedoraproject.org/metalink?repo=epel-7&arch=$basearch
repo --name=centos-sclo-rh --mirrorlist=http://mirrorlist.centos.org/?release=7&arch=x86_64&repo=sclo-rh
repo --name=foreman-el7 --baseurl=http://yum.theforeman.org/6.10/el7/$basearch/
repo --name=foreman-plugins-el7 --baseurl=http://yum.theforeman.org/plugins/6.10/el7/$basearch/</pre>
</div>
</div>
</li>
<li>
<p>Run the <code>livecd-creator</code> tool:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># livecd-creator --title="Discovery-Image" \
--compression-type=xz \
--cache=var/cache/build-fdi \
--config /usr/share/foreman-discovery-image/foreman-discovery-image.ks \
--fslabel fdi \
--tmpdir /var/tmp</pre>
</div>
</div>
<div class="paragraph">
<p>If you change <code>fdi</code> in the <code>--fslabel</code> option, you must also change the root label on the kernel command line when loading the image.
<code>fdi</code> or the alternative name is appended to the <code>.iso</code> file that is created as part of this procedure.
The PXE Discovery tool uses this name when converting from <code>.iso</code> to PXE.</p>
</div>
<div class="paragraph">
<p>Use <code>/var/tmp</code> because this process requires close to 3GB of space and <code>/tmp</code> might have problems if the system is low on swap space.</p>
</div>
</li>
<li>
<p>Verify that your <code>fdi.iso</code> file is created:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># ls -h *.iso</pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>When you create the <code>.iso</code> file, you can boot the <code>.iso</code> file over a network or locally.
Complete one of the following procedures.</p>
</div>
<div class="olist arabic">
<div class="title">To boot the iso file over a network:</div>
<ol class="arabic">
<li>
<p>To extract the initial ramdisk and kernel files from the <code>.iso</code> file over a network, enter the following command:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># discovery-iso-to-pxe fdi.iso</pre>
</div>
</div>
</li>
<li>
<p>Create a directory to store your boot files:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># mkdir /var/lib/tftpboot/boot/<em>myimage</em></pre>
</div>
</div>
</li>
<li>
<p>Copy the <code>initrd0.img</code> and <code>vmlinuz0</code> files to your new directory.</p>
</li>
<li>
<p>Edit the <code>KERNEL</code> and <code>APPEND</code> entries in the <code>/var/lib/tftpboot/pxelinux.cfg</code> file to add the information about your own initial ramdisk and kernel files.</p>
</li>
</ol>
</div>
<div class="paragraph">
<div class="title">To boot the iso file locally:</div>
<p>If you want to create a hybrid <code>.iso</code> file for booting locally, complete the following steps:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>To convert the <code>.iso</code> file to an <code>.iso</code> hybrid file for PXE provisioning, enter the following command:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># isohybrid --partok fdi.iso</pre>
</div>
</div>
<div class="paragraph">
<p>If you have <code>grub2</code> packages installed, you can also use the following command to install a <code>grub2</code> bootloader:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># isohybrid --partok --uefi fdi.iso</pre>
</div>
</div>
</li>
<li>
<p>To add <code>md5</code> checksum to the <code>.iso</code> file so it can pass installation media validation tests in Foreman, enter the following command:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># implantisomd5 fdi.iso</pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="unattended-use-and-customization">7.9. Unattended Use, Customization, and Image Remastering</h3>
<div class="paragraph">
<p>You can create a customized Discovery ISO to automate the image configuration process after booting.
The Discovery image uses a Linux kernel for the operating system, which passes kernel parameters to configure the discovery service.
These kernel parameters include the following entries:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">proxy.url</dt>
<dd>
<p>The URL of Smart&#160;Proxy&#160;server or Foreman&#160;server providing the Discovery service.</p>
</dd>
<dt class="hdlist1">proxy.type</dt>
<dd>
<p>  The proxy type.
This is usually set to <code>proxy</code> to connect to Smart&#160;Proxy&#160;server.
This parameter also supports a legacy <code>foreman</code> option, where communication goes directly to Foreman&#160;server instead of a Smart&#160;Proxy&#160;server.</p>
</dd>
<dt class="hdlist1">fdi.pxmac</dt>
<dd>
<p>  The MAC address of the primary interface in the format of <code>AA:BB:CC:DD:EE:FF</code>.
This is the interface you aim to use for communicating with Smart&#160;Proxy&#160;server.
In automated mode, the first NIC (using network identifiers in alphabetical order) with a link is used.
In semi-automated mode, a screen appears and requests you to select the correct interface.</p>
</dd>
<dt class="hdlist1">fdi.pxip, fdi.pxgw, fdi.pxdns</dt>
<dd>
<p>  Manually configures IP address (<code>fdi.pxip</code>), the gateway (<code>fdi.pxgw</code>), and the DNS (<code>fdi.pxdns</code>) for the primary network interface.
If your omit these parameters, the image uses DHCP to configure the network interface.</p>
</dd>
<dt class="hdlist1">fdi.pxfactname1, fdi.pxfactname2 &#8230;&#8203; fdi.pxfactnameN</dt>
<dd>
<p>Use to specify custom fact names.</p>
</dd>
<dt class="hdlist1">fdi.pxfactvalue1, fdi.pxfactvalue2 &#8230;&#8203; fdi.pxfactvalueN</dt>
<dd>
<p>  The values for each custom fact.
Each value corresponds to a fact name.
For example, <code>fdi.pxfactvalue1</code> sets the value for the fact named with <code>fdi.pxfactname1</code>.</p>
</dd>
<dt class="hdlist1">fdi.pxauto</dt>
<dd>
<p>  To set automatic or semi-automatic mode.
If set to 0, the image uses semi-automatic mode, which allows you to confirm your choices through a set of dialog options.
If set to 1, the image uses automatic mode and proceeds without any confirmation.</p>
</dd>
<dt class="hdlist1">fdi.initnet</dt>
<dd>
<p>  By default, the image initializes all network interfaces (value <code>all</code>).
When this setting is set to <code>bootif</code>, only the network interface it was network-booted from will be initialized.</p>
</dd>
<dt class="hdlist1">fdi.rootpw</dt>
<dd>
<p>  By default, the <code>root</code> account is locked.
Use this option to set a root password.
You can enter both clear and encrypted passwords.</p>
</dd>
<dt class="hdlist1">fdi.ssh</dt>
<dd>
<p>  By default, the SSH service is disabled.
Set this to <code>1</code> or <code>true</code> to enable SSH access.</p>
</dd>
<dt class="hdlist1">fdi.ipv4.method</dt>
<dd>
<p>  By default, NetworkManager IPv4 method setting is set to <code>auto</code>.
This option overrides it, set it to <code>ignore</code> to disable the IPv4 stack.
This option works only in DHCP mode.</p>
</dd>
<dt class="hdlist1">fdi.ipv6.method</dt>
<dd>
<p>  By default, NetworkManager IPv6 method setting is set to <code>auto</code>.
This option overrides it, set it to <code>ignore</code> to disable the IPv6 stack.
This option only works in DHCP mode.</p>
</dd>
<dt class="hdlist1">fdi.zips</dt>
<dd>
<p>  Filenames with extensions to be downloaded and started during boot.
For more information, see see <a href="#Extending_the_Discovery_Image">Extending the Discovery Image</a>.</p>
</dd>
<dt class="hdlist1">fdi.zipserver</dt>
<dd>
<p>  TFTP server to use to download extensions from.
For more information, see see <a href="#Extending_the_Discovery_Image">Extending the Discovery Image</a>.</p>
</dd>
<dt class="hdlist1">fdi.countdown</dt>
<dd>
<p>  Number of seconds to wait until the text-user interface is refreshed after the initial discovery attempt.
This value defaults to 45 seconds.
Increase this value if the status page reports the IP address as <code>N/A</code>.</p>
</dd>
<dt class="hdlist1">fdi.dhcp_timeout</dt>
<dd>
<p>  NetworkManager DHCP timeout.
The default value is 300 seconds.</p>
</dd>
<dt class="hdlist1">fdi.vlan.primary</dt>
<dd>
<p>VLAN tagging ID to set for the primary interface.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<div class="title">Using the <code>discovery-remaster</code> Tool to Remaster an OS Image</div>
<p>Foreman&#160;server provides the <code>discovery-remaster</code> tool.
This tool remasters the image to include these kernel parameters.
To remaster the image, run the <code>discovery-remaster</code> tool.
For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># discovery-remaster ~/iso/foreman-discovery-image-3.4.4-5.iso \
"fdi.pxip=192.168.140.20/24 fdi.pxgw=192.168.140.1 \
fdi.pxdns=192.168.140.2 proxy.url=https://<em>foreman.example.com</em>:8443 \
proxy.type=proxy fdi.pxfactname1=<em>customhostname</em> fdi.pxfactvalue1=<em>myhost</em> fdi.pxmac=52:54:00:be:8e:8c fdi.pxauto=1"</pre>
</div>
</div>
<div class="paragraph">
<p>Copy this media to either a CD, DVD, or a USB stick.
For example, to copy to a USB stick at <code>/dev/sdb</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># dd bs=4M \
if=/usr/share/foreman-discovery-image/foreman-discovery-image-3.4.4-5.iso \
of=/dev/sdb</pre>
</div>
</div>
<div class="paragraph">
<p>Insert the Discovery boot media into a bare metal host, start the host, and boot from the media.</p>
</div>
<div class="paragraph">
<p>For more information about provisioning discovered hosts, see <a href="#creating-hosts-from-discovered-hosts">Creating Hosts from Discovered Hosts</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="Extending_the_Discovery_Image">7.10. Extending the Discovery Image</h3>
<div class="paragraph">
<p>You can extend the Foreman Discovery image with custom facts, software, or device drivers.
You can also provide a compressed archive file containing extra code for the image to use.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Create the following directory structure:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">.
├── autostart.d
│   └── 01_zip.sh
├── bin
│   └── ntpdate
├── facts
│   └── test.rb
└── lib
    ├── libcrypto.so.1.0.0
    └── ruby
        └── test.rb</pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>The <code>autostart.d</code> directory contains scripts that are executed in POSIX order by the image when it starts, but before the host is registered to Foreman.</p>
</li>
<li>
<p>The <code>bin</code> directory is added to the <code>$PATH</code> variable; you can place binary files in this directory and use them in the <code>autostart</code> scripts.</p>
</li>
<li>
<p>The <code>facts</code> directory is added to the <code>FACTERLIB</code> variable so that custom facts can be configured and sent to Foreman.</p>
</li>
<li>
<p>The <code>lib</code> directory is added to the <code>LD_LIBRARY_PATH</code> variable and <code>lib/ruby</code> is added to the <code>RUBYLIB</code> variable, so that binary files in <code>/bin</code> can be executed correctly.</p>
</li>
</ul>
</div>
</li>
<li>
<p>After creating the directory structure, create a <code>.zip</code> file archive with the following command:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">zip -r my_extension.zip .</pre>
</div>
</div>
</li>
<li>
<p>To inform the Discovery image of the extensions it must use, place your zip files on your TFTP server with the Discovery image, and then update the <code>APPEND</code> line of the PXELinux template with the <code>fdi.zips</code> option where the paths are relative to the TFTP root.
For example, if you have two archives at <code>$TFTP/zip1.zip</code> and <code>$TFTP/boot/zip2.zip</code>, use the following syntax:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">fdi.zips=zip1.zip,boot/zip2.zip</pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>You can append new directives and options to the existing environment variables (<code>PATH</code>, <code>LD_LIBRARY_PATH</code>, <code>RUBYLIB</code> and <code>FACTERLIB</code>).
If you want to specify the path explicitly in your scripts, the <code>.zip</code> file contents are extracted to the <code>/opt/extension</code> directory on the image.</p>
</div>
<div class="paragraph">
<p>You can create multiple <code>.zip</code> files but be aware that they are extracted to the same location on the Discovery image.
Files extracted from in later <code>.zip</code> files overwrite earlier versions if they have the same file name.</p>
</div>
</div>
<div class="sect2">
<h3 id="troubleshooting-discovery-problems">7.11. Troubleshooting Discovery</h3>
<div class="paragraph">
<p>If a machine is not listed in the Foreman web UI in <strong>Hosts</strong> &gt; <strong>Discovered Hosts</strong>, inspect the following configuration areas to help isolate the error:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Navigate to <strong>Hosts</strong> &gt; <strong>Provisioning Templates</strong> and redeploy the default PXELinux template using the <strong>Build PXE Default</strong> button.</p>
</li>
<li>
<p>Verify the <code>pxelinux.cfg/default</code> configuration file on the TFTP Smart&#160;Proxy.</p>
</li>
<li>
<p>Ensure adequate network connectivity between hosts, Smart&#160;Proxy&#160;server, and Foreman&#160;server.</p>
</li>
<li>
<p>Check the PXELinux template in use and determine the PXE discovery snippet it includes.
Snippets are named as follows: <code>pxelinux_discovery</code>, <code>pxegrub_discovery</code>, or <code>pxegrub2_discovery</code>.
Verify the <code>proxy.url</code> and <code>proxy.type</code> options in the PXE discovery snippet.</p>
</li>
<li>
<p>Ensure that DNS is working correctly for the discovered nodes, or use an IP address in the <code>proxy.url</code> option in the PXE discovery snippet included in the PXELinux template you are using.</p>
</li>
<li>
<p>Ensure that the DHCP server is delivering IP addresses to the booted image correctly.</p>
</li>
<li>
<p>Ensure the discovered host or virtual machine has at least 1200 MB of memory.
Less memory can lead to various random kernel panic errors because the image is extracted in-memory.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For gathering important system facts, use the <code>discovery-debug</code> command.
It prints out system logs, network configuration, list of facts, and other information on the standard output.
The typical use case is to redirect this output and copy it with the <code>scp</code> command for further investigation.</p>
</div>
<div class="paragraph">
<p>The first virtual console on the discovered host is reserved for <strong>systemd</strong> logs.
Particularly useful system logs are tagged as follows:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>discover-host</code> — initial facts upload</p>
</li>
<li>
<p><code>foreman-discovery</code> — facts refresh, reboot remote commands</p>
</li>
<li>
<p><code>nm-prepare</code> — boot script which pre-configures NetworkManager</p>
</li>
<li>
<p><code>NetworkManager</code> — networking information</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Use TTY2 or higher to log in to a discovered host.
The root account and SSH access are disabled by default, but you can enable SSH and set the root password using the following kernel command-line options in the Default PXELinux template on the APPEND line:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">fdi.ssh=1 fdi.rootpw=<em>My_Password</em></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="using-an-image-builder-image-for-provisioning">8. Using a Lorax Composer Image for Provisioning</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In Foreman, you can integrate with Cockpit to perform actions and monitor your hosts.
Using Cockpit, you can access Lorax Composer and build images that you can then upload to a HTTP server and use this image to provision hosts.
When you configure Foreman for image provisioning, Anaconda installer partitions disks, downloads and mounts the image and copies files over to a host.
The preferred image type is TAR.</p>
</div>
<div class="paragraph">
<p>For more information about integrating Cockpit with Foreman, see <a href="https://theforeman.org/plugins/foreman_remote_execution/1.7/index.html#3.6Cockpitintegration">Cockpit integration</a>.</p>
</div>
<div class="olist arabic">
<div class="title">Prerequisites</div>
<ol class="arabic">
<li>
<p>An existing TAR image created via Lorax Composer.</p>
</li>
</ol>
</div>
<div class="paragraph">
<div class="title">Procedure</div>
<p>To use the Lorax Composer image with Anaconda Kickstart in Foreman, complete the following steps:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>If you use the Katello plug-in, on Foreman, create a custom product, add a custom file repository to this product, and upload the image to the repository.
For more information, see <a href="https://docs.theforeman.org/2.5/Content_Management_Guide/index-foreman-el.html#importing_individual_iso_images_and_files">Importing Individual ISO Images and Files</a> in the <em>Content Management Guide</em>.</p>
</li>
<li>
<p>Copy the TAR image to an existing HTTP server which installed hosts can reach.</p>
</li>
<li>
<p>In the Foreman web UI, navigate to <strong>Configure</strong> &gt; <strong>Host Groups</strong>, and select the host group that you want to use.</p>
</li>
<li>
<p>Click the <strong>Parameters</strong> tab, and then click <strong>Add Parameter</strong>.</p>
</li>
<li>
<p>In the <strong>Name</strong> field, enter <code>kickstart_liveimg</code>.</p>
</li>
<li>
<p>From the <strong>Type</strong> list, select <strong>string</strong>.</p>
</li>
<li>
<p>In the <strong>Value</strong> field, enter the absolute path or a relative path in the following format <code>custom/<em>product</em>/<em>repository</em>/<em>image_name</em></code> that points to the exact location where you store the image.</p>
</li>
<li>
<p>Click <strong>Submit</strong> to save your changes.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>You can use this image for bare metal provisioning and provisioning using a compute resource.
For more information about bare metal provisioning, see <a href="#Using_PXE_to_Provision_Hosts">Using PXE to Provision Hosts</a>.
For more information about provisioning with different compute resources, see the relevant chapter for the compute resource that you want to use.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="provisioning-virtual-machines-kvm_provisioning">9. Provisioning Virtual Machines on KVM (libvirt)</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Kernel-based Virtual Machines (KVMs) use an open source virtualization daemon and API called <code>libvirt</code> running on Red&#160;Hat Enterprise Linux.
Foreman can connect to the <code>libvirt</code> API on a KVM server, provision hosts on the hypervisor, and control certain virtualization functions.</p>
</div>
<div class="paragraph">
<p>You can use KVM provisioning to create hosts over a network connection or from an existing image.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>The installation media for the operating systems that you want to use to provision hosts.
If the Katello plug-in is installed, you can use synchronized content repositories for Red&#160;Hat Enterprise Linux.
For more information, see <a href="https://docs.theforeman.org/2.5/Content_Management_Guide/index-foreman-el.html#Importing_Content-Synchronizing_Repositories">Syncing Repositories</a> in the <em>Content Management Guide</em>.</p>
</li>
<li>
<p>If the Katello plug-in is installed, an activation key for host registration.
For more information, see <a href="https://docs.theforeman.org/2.5/Content_Management_Guide/index-foreman-el.html#Managing_Activation_Keys-Creating_an_Activation_Key">Creating An Activation Key</a> in the <em>Content Management</em> guide.</p>
</li>
<li>
<p>A Smart&#160;Proxy&#160;server managing a network on the KVM server.
Ensure no other DHCP services run on this network to avoid conflicts with Smart&#160;Proxy&#160;server.
For more information about network service configuration for Smart&#160;Proxy&#160;servers, see <a href="https://docs.theforeman.org/2.5/Provisioning_Guide/index-foreman-el.html#Configuring_Networking">Configuring Networking</a>.</p>
</li>
<li>
<p>A server running KVM virtualization tools (libvirt daemon).</p>
</li>
<li>
<p>A virtual network running on the libvirt server.
Only NAT and isolated virtual networks can be managed through Foreman.</p>
</li>
<li>
<p>An existing virtual machine image if you want to use image-based provisioning.
Ensure that this image exists in a storage pool on the KVM host.
The <code>default</code> storage pool is usually located in <code>/var/lib/libvirt/images</code>.
Only directory pool storage types can be managed through Foreman.</p>
</li>
<li>
<p>Optional: The examples in these procedures use the root user for KVM.
If you want to use a non-root user on the KVM server, you must add the user to the <code>libvirt</code> group on the KVM server:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">useradd -a -G libvirt <em>non_root_user</em></pre>
</div>
</div>
</li>
<li>
<p>A Foreman user account with the following roles:</p>
<div class="ulist">
<ul>
<li>
<p><strong>Edit hosts</strong></p>
</li>
<li>
<p><strong>View hosts</strong></p>
<div class="paragraph">
<p>For more information, see <a href="https://docs.theforeman.org/2.5/Administering_Red_Hat_Satellite/index-foreman-el.html#assigning-roles-to-a-user_admin">Assigning Roles to a User</a> in the <em>Administering Foreman</em> guide.</p>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>A custom role in Foreman with the following permissions:</p>
<div class="ulist">
<ul>
<li>
<p><strong>view_compute_resources</strong></p>
</li>
<li>
<p><strong>destroy_compute_resources_vms</strong></p>
</li>
<li>
<p><strong>power_compute_resources_vms</strong></p>
</li>
<li>
<p><strong>create_compute_resources_vms</strong></p>
</li>
<li>
<p><strong>view_compute_resources_vms</strong></p>
</li>
<li>
<p><strong>view_locations</strong></p>
</li>
<li>
<p><strong>view_subnets</strong></p>
<div class="paragraph">
<p>For more information about creating roles, see <a href="https://docs.theforeman.org/2.5/Administering_Red_Hat_Satellite/index-foreman-el.html#creating-a-role_admin">Creating a Role</a> in the <em>Administering Foreman</em> guide.
For more information about adding permissions to a role, see <a href="https://docs.theforeman.org/2.5/Administering_Red_Hat_Satellite/index-foreman-el.html#adding-permissions-to-a-role_admin">Adding Permissions to a Role</a> in the <em>Administering Foreman</em> guide.</p>
</div>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure Overview</div>
<ol class="arabic">
<li>
<p><a href="#configuring-server-for-kvm-connections_kvm-provisioning">Configuring Foreman&#160;server for KVM Connections</a>.</p>
</li>
<li>
<p><a href="#adding-kvm-connection_kvm-provisioning">Adding a KVM Connection to Foreman&#160;server</a>.</p>
</li>
<li>
<p>Optional: <a href="#adding-images-to-server_kvm-provisioning">Adding KVM Images to Foreman&#160;server</a>.
Use this procedure if you want to use image-based provisioning.</p>
</li>
<li>
<p><a href="#adding-kvm-details-to-a-compute-profile_kvm-provisioning">Adding KVM Details to a Compute Profile</a>.</p>
</li>
<li>
<p><a href="#creating-network-or-image-based-hosts_kvm-provisioning">Creating Hosts on KVM</a>.</p>
</li>
</ol>
</div>
<div class="sect2">
<h3 id="configuring-server-for-kvm-connections_kvm-provisioning">9.1. Configuring Foreman&#160;server for KVM Connections</h3>
<div class="paragraph">
<p>Before adding the KVM connection, create an SSH key pair for the <code>foreman</code> user to ensure a secure connection between Foreman&#160;server and KVM.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>On Foreman&#160;server, switch to the <code>foreman</code> user:</p>
<div class="listingblock">
<div class="content">
<pre># su foreman -s /bin/bash</pre>
</div>
</div>
</li>
<li>
<p>Generate the key pair:</p>
<div class="listingblock">
<div class="content">
<pre>$ ssh-keygen</pre>
</div>
</div>
</li>
<li>
<p>Copy the public key to the KVM server:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ ssh-copy-id <em>root@kvm.example.com</em></pre>
</div>
</div>
</li>
<li>
<p>Exit the bash shell for the <code>foreman</code> user:</p>
<div class="listingblock">
<div class="content">
<pre>$ exit</pre>
</div>
</div>
</li>
<li>
<p>Install the <code>libvirt-client</code> package:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># yum install libvirt-client</pre>
</div>
</div>
</li>
<li>
<p>Use the following command to test the connection to the KVM server:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># su foreman -s /bin/bash -c 'virsh -c qemu+ssh://root@kvm.example.com/system list'</pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="adding-kvm-connection_kvm-provisioning">9.2. Adding a KVM Connection to Foreman&#160;server</h3>
<div class="paragraph">
<p>Use this procedure to add KVM as a compute resource in Foreman.
To use the CLI instead of the web UI, see the <a href="#cli-adding-kvm-connection_kvm-provisioning">CLI procedure</a>.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>In the Foreman web UI, navigate to <strong>Infrastructure</strong> &gt; <strong>Compute Resources</strong> and click <strong>Create Compute Resource</strong>.</p>
</li>
<li>
<p>In the <strong>Name</strong> field, enter a name for the new compute resource.</p>
</li>
<li>
<p>From the <strong>Provider</strong> list, select <strong>Libvirt</strong>.</p>
</li>
<li>
<p>In the <strong>Description</strong> field, enter a description for the compute resource.</p>
</li>
<li>
<p>In the <strong>URL</strong> field, enter the connection URL to the KVM server.
For example:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"> qemu+ssh://<em>root@kvm.example.com</em>/system</pre>
</div>
</div>
</li>
<li>
<p>From the <strong>Display type</strong> list, select either <strong>VNC</strong> or <strong>Spice</strong>.</p>
</li>
<li>
<p>Optional: To secure console access for new hosts with a randomly generated password, select the <strong>Set a randomly generated password on the display connection</strong> check box.
You can retrieve the password for the VNC console to access the guest virtual machine console from the output of the following command executed on the KVM server:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># virsh edit <em>your_VM_name</em>
&lt;graphics type='vnc' port='-1' autoport='yes' listen='0.0.0.0' passwd='<em>your_randomly_generated_password</em>'&gt;</pre>
</div>
</div>
<div class="paragraph">
<p>The password is randomly generated every time the console for the virtual machine is opened, for example, with virt-manager.</p>
</div>
</li>
<li>
<p>Click <strong>Test Connection</strong> to ensure that Foreman&#160;server connects to the KVM server without fault.</p>
</li>
<li>
<p>Verify that the <strong>Locations</strong> and <strong>Organizations</strong> tabs are automatically set to your current context.
If you want, add additional contexts to these tabs.</p>
</li>
<li>
<p>Click <strong>Submit</strong> to save the KVM connection.</p>
</li>
</ol>
</div>
<div id="cli-adding-kvm-connection_kvm-provisioning" class="ulist">
<div class="title">CLI procedure</div>
<ul>
<li>
<p>To create a compute resource, enter the <code>hammer compute-resource create</code> command:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># hammer compute-resource create --name "<em>My_KVM_Server</em>" \
--provider "Libvirt" --description "KVM server at <em>kvm.example.com</em>" \
--url "qemu+ssh://root@<em>kvm.example.com/system</em>" --locations "New York" \
--organizations "<em>My_Organization</em>"</pre>
</div>
</div>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="adding-images-to-server_kvm-provisioning">9.3. Adding KVM Images to Foreman&#160;server</h3>
<div class="paragraph">
<p>To create hosts using image-based provisioning, you must add information about the image, such as access details and the image location, to your Foreman&#160;server.</p>
</div>
<div class="paragraph">
<p>Note that you can manage only directory pool storage types through Foreman.</p>
</div>
<div class="paragraph">
<p>To use the CLI instead of the web UI, see the <a href="#cli-adding-images-to-server_kvm-provisioning">CLI procedure</a>.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>In the Foreman web UI, navigate to <strong>Infrastructure</strong> &gt; <strong>Compute Resources</strong> and click the name of the KVM connection.</p>
</li>
<li>
<p>Click <strong>Create Image</strong>.</p>
</li>
<li>
<p>In the <strong>Name</strong> field, enter a name for the image.</p>
</li>
<li>
<p>From the <strong>Operating System</strong> list, select the image&#8217;s base operating system.</p>
</li>
<li>
<p>From the <strong>Architecture</strong> list, select the operating system architecture.</p>
</li>
<li>
<p>In the <strong>Username</strong> field, enter the SSH user name for image access.
This is normally the <code>root</code> user.</p>
</li>
<li>
<p>In the <strong>Password</strong> field, enter the SSH password for image access.</p>
</li>
<li>
<p>In the <strong>Image path</strong> field, enter the full path that points to the image on the KVM server.
For example:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"> /var/lib/libvirt/images/TestImage.qcow2</pre>
</div>
</div>
</li>
<li>
<p>Optional: Select the <strong>User Data</strong> check box if the image supports user data input, such as <code>cloud-init</code> data.</p>
</li>
<li>
<p>Click <strong>Submit</strong> to save the image details.</p>
</li>
</ol>
</div>
<div id="cli-adding-images-to-server_kvm-provisioning" class="ulist">
<div class="title">CLI procedure</div>
<ul>
<li>
<p>Create the image with the <code>hammer compute-resource image create</code> command.
Use the <code>--uuid</code> field to store the full path of the image location on the KVM server.</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># hammer compute-resource image create \
--name "<em>KVM Image</em>" \
--compute-resource "<em>My_KVM_Server</em>"
--operatingsystem "RedHat <em>version</em>" \
--architecture "x86_64" \
--username root \
--user-data false \
--uuid "/var/lib/libvirt/images/<em>KVMimage</em>.qcow2" \</pre>
</div>
</div>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="adding-kvm-details-to-a-compute-profile_kvm-provisioning">9.4. Adding KVM Details to a Compute Profile</h3>
<div class="paragraph">
<p>Use this procedure to add KVM hardware settings to a compute profile.
When you create a host on KVM using this compute profile, these settings are automatically populated.</p>
</div>
<div class="paragraph">
<p>To use the CLI instead of the web UI, see the <a href="#cli-adding-kvm-details-to-a-compute-profile_kvm-provisioning">CLI procedure</a>.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>In the Foreman web UI, navigate to <strong>Infrastructure</strong> &gt; <strong>Compute Profiles</strong>.</p>
</li>
<li>
<p>In the Compute Profiles window, click the name of an existing compute profile, or click <strong>Create Compute Profile</strong>, enter a <strong>Name</strong>, and click <strong>Submit</strong>.</p>
</li>
<li>
<p>Click the name of the KVM compute resource.</p>
</li>
<li>
<p>In the <strong>CPUs</strong> field, enter the number of CPUs to allocate to the new host.</p>
</li>
<li>
<p>In the <strong>Memory</strong> field, enter the amount of memory to allocate to the new host.</p>
</li>
<li>
<p>From the <strong>Image</strong> list, select the image to use if performing image-based provisioning.</p>
</li>
<li>
<p>From the <strong>Network Interfaces</strong> list, select the network parameters for the host&#8217;s network interface.
You can create multiple network interfaces.
However, at least one interface must point to a Smart&#160;Proxy-managed network.</p>
</li>
<li>
<p>In the <strong>Storage</strong> area, enter the storage parameters for the host.
You can create multiple volumes for the host.</p>
</li>
<li>
<p>Click <strong>Submit</strong> to save the settings to the compute profile.</p>
</li>
</ol>
</div>
<div id="cli-adding-kvm-details-to-a-compute-profile_kvm-provisioning" class="olist arabic">
<div class="title">CLI procedure</div>
<ol class="arabic">
<li>
<p>To create a compute profile, enter the following command:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># hammer compute-profile create --name "Libvirt CP"</pre>
</div>
</div>
</li>
<li>
<p>To add the values for the compute profile, enter the following command:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># hammer compute-profile values create --compute-profile "Libvirt CP" \
--compute-resource "<em>My_KVM_Server</em>" \
--interface "compute_type=network,compute_model=virtio,compute_network=<em>examplenetwork</em>" \
--volume "pool_name=default,capacity=20G,format_type=qcow2" \
--compute-attributes "cpus=1,memory=1073741824"</pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="creating-network-or-image-based-hosts_kvm-provisioning">9.5. Creating Hosts on KVM</h3>
<div class="paragraph">
<p>In Foreman, you can use KVM provisioning to create hosts over a network connection or from an existing image:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>If you want to create a host over a network connection, the new host must be able to access either Foreman&#160;server&#8217;s integrated Smart&#160;Proxy or an external Smart&#160;Proxy&#160;server on a KVM virtual network, so that the host has access to PXE provisioning services.
This new host entry triggers the KVM server to create and start a virtual machine.
If the virtual machine detects the defined Smart&#160;Proxy&#160;server through the virtual network, the virtual machine boots to PXE and begins to install the chosen operating system.</p>
</li>
<li>
<p>If you want to create a host with an existing image, the new host entry triggers the KVM server to create the virtual machine using a pre-existing image as a basis for the new volume.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>To use the CLI instead of the web UI, see the <a href="#cli-creating-network-or-image-based-hosts_kvm-provisioning">CLI procedure</a>.</p>
</div>
<div class="paragraph">
<div class="title">DHCP Conflicts</div>
<p>For network-based provisioning, if you use a virtual network on the KVM server for provisioning, select a network that does not provide DHCP assignments.
This causes DHCP conflicts with Foreman&#160;server when booting new hosts.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>In the Foreman web UI, navigate to <strong>Hosts</strong> &gt; <strong>Create Host</strong>.</p>
</li>
<li>
<p>In the <strong>Name</strong> field, enter a name for the host.</p>
</li>
<li>
<p>Click the <strong>Organization</strong> and <strong>Location</strong> tabs to ensure that the provisioning context is automatically set to the current context.</p>
</li>
<li>
<p>From the <strong>Host Group</strong> list, select the host group that you want to use to populate the form.</p>
</li>
<li>
<p>From the <strong>Deploy on</strong> list, select the KVM connection.</p>
</li>
<li>
<p>From the <strong>Compute Profile</strong> list, select a profile to use to automatically populate virtual machine settings.</p>
</li>
<li>
<p>Click the <strong>Interface</strong> tab and click <strong>Edit</strong> on the host&#8217;s interface.</p>
</li>
<li>
<p>Verify that the fields are automatically populated, particularly the following items:</p>
<div class="ulist">
<ul>
<li>
<p>The <strong>Name</strong> from the <strong>Host</strong> tab becomes the <strong>DNS name</strong>.</p>
</li>
<li>
<p>Foreman&#160;server automatically assigns an IP address for the new host.</p>
</li>
<li>
<p>The <strong>MAC address</strong> field is blank.
The KVM server assigns a MAC address to the host.</p>
</li>
<li>
<p>The <strong>Managed</strong>, <strong>Primary</strong>, and <strong>Provision</strong> options are automatically selected for the first interface on the host.
If not, select them.</p>
</li>
<li>
<p>The KVM-specific fields are populated with settings from your compute profile.
Modify these settings if required.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Click the <strong>Operating System</strong> tab, and confirm that all fields automatically contain values.</p>
</li>
<li>
<p>Select the <strong>Provisioning Method</strong> that you want to use:</p>
<div class="ulist">
<ul>
<li>
<p>For network-based provisioning, click <strong>Network Based</strong>.</p>
</li>
<li>
<p>For image-based provisioning, click <strong>Image Based</strong>.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Click <strong>Resolve</strong> in <strong>Provisioning templates</strong> to check the new host can identify the right provisioning templates to use.</p>
</li>
<li>
<p>Click the <strong>Virtual Machine</strong> tab and confirm that these settings are populated with details from the host group and compute profile.
Modify these settings to suit your needs.</p>
</li>
<li>
<p>If you use the Katello plugin, click the <strong>Parameters</strong> tab, and ensure that a parameter exists that provides an activation key.
If not, add an activation key.</p>
</li>
<li>
<p>Click <strong>Submit</strong> to save the host entry.</p>
</li>
</ol>
</div>
<div id="cli-creating-network-or-image-based-hosts_kvm-provisioning" class="ulist">
<div class="title">CLI procedure</div>
<ul>
<li>
<p>To use network-based provisioning, create the host with the <code>hammer host create</code> command and include <code>--provision-method build</code>.
Replace the values in the following example with the appropriate values for your environment.</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># hammer host create \
--name "kvm-host1" \
--organization "<em>My_Organization</em>" \
--location "New York" \
--hostgroup "Base" \
--compute-resource "<em>My_KVM_Server</em>" \
--provision-method build \
--build true \
--enabled true \
--managed true \
--interface "managed=true,primary=true,provision=true,compute_type=network,compute_network=<em>examplenetwork</em>" \
--compute-attributes="cpus=1,memory=1073741824" \
--volume="pool_name=default,capacity=20G,format_type=qcow2" \
--root-password "<em>password</em>"</pre>
</div>
</div>
</li>
<li>
<p>To use image-based provisioning, create the host with the <code>hammer host create</code> command and include <code>--provision-method image</code>.
Replace the values in the following example with the appropriate values for your environment.</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># hammer host create \
--name "kvm-host2" \
--organization "<em>My_Organization</em>" \
--location "New York" \
--hostgroup "Base" \
--compute-resource "<em>My_KVM_Server</em>" \
--provision-method image \
--image "<em>KVM Image</em>" \
--enabled true \
--managed true \
--interface "managed=true,primary=true,provision=true,compute_type=network,compute_network=examplenetwork" \
--compute-attributes="cpus=1,memory=1073741824" \
--volume="pool_name=default,capacity=20G,format_type=qcow2"</pre>
</div>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>For more information about additional host creation parameters for this compute resource, enter the <code>hammer host create --help</code> command.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="provisioning-virtual-machines-rhv_provisioning">10. Provisioning Virtual Machines on oVirt</h2>
<div class="sectionbody">
<div class="paragraph">
<p>oVirt is an enterprise-grade server and desktop virtualization platform.
In Foreman, you can manage virtualization functions through oVirt&#8217;s REST API.
This includes creating virtual machines and controlling their power states.</p>
</div>
<div class="paragraph">
<p>You can use oVirt provisioning to create virtual machines over a network connection or from an existing image.</p>
</div>
<div class="paragraph">
<p>You can use <code>cloud-init</code> to configure the virtual machines that you provision.
Using <code>cloud-init</code> avoids any special configuration on the network, such as a managed DHCP and TFTP, to finish the installation of the virtual machine.
This method does not require Foreman to connect to the provisioned virtual machine using SSH to run the finish script.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>The installation media for the operating systems that you want to use to provision hosts.
If the Katello plug-in is installed, you can use synchronized content repositories for Red&#160;Hat Enterprise Linux.
For more information, see <a href="https://docs.theforeman.org/2.5/Content_Management_Guide/index-foreman-el.html#Importing_Content-Synchronizing_Repositories">Syncing Repositories</a> in the <em>Content Management Guide</em>.</p>
</li>
<li>
<p>If the Katello plug-in is installed, an activation key for host registration.
For more information, see <a href="https://docs.theforeman.org/2.5/Content_Management_Guide/index-foreman-el.html#Managing_Activation_Keys-Creating_an_Activation_Key">Creating An Activation Key</a> in the <em>Content Management</em> guide.</p>
</li>
<li>
<p>A Smart&#160;Proxy&#160;server managing a logical network on the oVirt environment.
Ensure no other DHCP services run on this network to avoid conflicts with Smart&#160;Proxy&#160;server.
For more information, see <a href="https://docs.theforeman.org/2.5/Provisioning_Guide/index-foreman-el.html#Configuring_Networking">Configuring Networking</a>.</p>
</li>
<li>
<p>An existing template, other than the <code>blank</code> template, if you want to use image-based provisioning.
For more information about creating templates for virtual machines, see
<a href="https://www.ovirt.org/documentation/virtual_machine_management_guide/#chap-Templates">Templates</a> in the oVirt documentation.</p>
</li>
<li>
<p>An administration-like user on oVirt for communication with Foreman&#160;server.
Do not use the <code>admin@internal</code> user for this communication.
Instead, create a new oVirt user with the following permissions:</p>
<div class="ulist">
<ul>
<li>
<p><strong>System</strong> &gt; <strong>Configure System</strong> &gt; <strong>Login Permissions</strong></p>
</li>
<li>
<p><strong>Network</strong> &gt; <strong>Configure vNIC Profile</strong> &gt; <strong>Create</strong></p>
</li>
<li>
<p><strong>Network</strong> &gt; <strong>Configure vNIC Profile</strong> &gt; <strong>Edit Properties</strong></p>
</li>
<li>
<p><strong>Network</strong> &gt; <strong>Configure vNIC Profile</strong> &gt; <strong>Delete</strong></p>
</li>
<li>
<p><strong>Network</strong> &gt; <strong>Configure vNIC Profile</strong> &gt; <strong>Assign vNIC Profile to VM</strong></p>
</li>
<li>
<p><strong>Network</strong> &gt; <strong>Configure vNIC Profile</strong> &gt; <strong>Assign vNIC Profile to Template</strong></p>
</li>
<li>
<p><strong>Template</strong> &gt; <strong>Provisioning Operations</strong> &gt; <strong>Import/Export</strong></p>
</li>
<li>
<p><strong>VM</strong> &gt; <strong>Provisioning Operations</strong> &gt; <strong>Create</strong></p>
</li>
<li>
<p><strong>VM</strong> &gt; <strong>Provisioning Operations</strong> &gt; <strong>Delete</strong></p>
</li>
<li>
<p><strong>VM</strong> &gt; <strong>Provisioning Operations</strong> &gt; <strong>Import/Export</strong></p>
</li>
<li>
<p><strong>VM</strong> &gt; <strong>Provisioning Operations</strong> &gt; <strong>Edit Storage</strong></p>
</li>
<li>
<p><strong>Disk</strong> &gt; <strong>Provisioning Operations</strong> &gt; <strong>Create</strong></p>
</li>
<li>
<p><strong>Disk</strong> &gt; <strong>Disk Profile</strong> &gt; <strong>Attach Disk Profile</strong></p>
<div class="paragraph">
<p>For more information about how to create a user and add permissions in oVirt, see <a href="https://www.ovirt.org/documentation/administration_guide/#chap-Users_and_Roles">Users and Roles</a> in the oVirt documentation.</p>
</div>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure Overview</div>
<ol class="arabic">
<li>
<p><a href="#adding-rhv-connection_rhv-provisioning">Adding the oVirt Connection to Foreman&#160;server</a>.</p>
</li>
<li>
<p>Optional: <a href="#preparing-cloud-init-images-in-rhv_rhv-provisioning">Preparing Cloud-init Images in oVirt</a>.
Use this procedure if you want to use <code>cloud-init</code> to configure an image-based virtual machine.</p>
</li>
<li>
<p>Optional: <a href="#adding-images-to-server_rhv-provisioning">Adding oVirt Images to Foreman&#160;server</a>.
Use this procedure if you want to use image-based provisioning.</p>
</li>
<li>
<p>Optional: <a href="#preparing-a-cloud-init-template_rhv-provisioning">Preparing a Cloud-init Template</a>.
Use this procedure if you want to use <code>cloud-init</code> to configure an image-based virtual machine.</p>
</li>
<li>
<p><a href="#adding-rhv-details-to-a-compute-profile_rhv-provisioning">Adding oVirt Details to a Compute Profile</a>.</p>
</li>
<li>
<p><a href="#creating-network-or-image-based-hosts_rhv-provisioning">Creating Hosts on oVirt</a>.</p>
</li>
</ol>
</div>
<div class="sect2">
<h3 id="adding-rhv-connection_rhv-provisioning">10.1. Adding the oVirt Connection to Foreman&#160;server</h3>
<div class="paragraph">
<p>Use this procedure to add oVirt as a compute resource in Foreman.
To use the CLI instead of the web UI, see the <a href="#cli-adding-rhv-connection_rhv-provisioning">CLI procedure</a>.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>In the Foreman web UI, navigate to <strong>Infrastructure</strong> &gt; <strong>Compute Resources</strong> and click <strong>Create Compute Resource</strong>.</p>
</li>
<li>
<p>In the <strong>Name</strong> field, enter a name for the new compute resource.</p>
</li>
<li>
<p>From the <strong>Provider</strong> list, select <strong>oVirt</strong>.</p>
</li>
<li>
<p>In the <strong>Description</strong> field, enter a description for the compute resource.</p>
</li>
<li>
<p>In the <strong>URL</strong> field, enter the connection URL for the oVirt Engine&#8217;s API in the following form: <code>https://ovirt.example.com/ovirt-engine/api/v4</code>.</p>
</li>
<li>
<p>In the <strong>User</strong> field, enter the name of a user with permissions to access oVirt Engine&#8217;s resources.</p>
</li>
<li>
<p>In the <strong>Password</strong> field, enter the password of the user.</p>
</li>
<li>
<p>Click <strong>Load Datacenters</strong> to populate the <strong>Datacenter</strong> list with data centers from your oVirt environment.</p>
</li>
<li>
<p>From the <strong>Datacenter</strong> list, select a data center.</p>
</li>
<li>
<p>From the <strong>Quota ID</strong> list, select a quota to limit resources available to Foreman.</p>
</li>
<li>
<p>In the <strong>X509 Certification Authorities</strong> field, enter the certificate authority for SSL/TLS access.
Alternatively, if you leave the field blank, a self-signed certificate is generated on the first API request by the server.</p>
</li>
<li>
<p>Click the <strong>Locations</strong> tab and select the location you want to use.</p>
</li>
<li>
<p>Click the <strong>Organizations</strong> tab and select the organization you want to use.</p>
</li>
<li>
<p>Click <strong>Submit</strong> to save the compute resource.</p>
</li>
</ol>
</div>
<div id="cli-adding-rhv-connection_rhv-provisioning" class="ulist">
<div class="title">CLI procedure</div>
<ul>
<li>
<p>Enter the <code>hammer compute-resource create</code> command with <code>Ovirt</code> for <code>--provider</code> and the name of the data center you want to use for <code>--datacenter</code>.</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># hammer compute-resource create \
--name "<em>My_oVirt</em>" --provider "Ovirt" \
--description "oVirt server at <em>ovirt.example.com</em>" \
--url "<em>https://ovirt.example.com/ovirt-engine/api</em>" \
--user "<em>Foreman_User</em>" --password "<em>My_Password</em>" \
--locations "New York" --organizations "<em>My_Organization</em>" \
--datacenter "<em>My_Datacenter</em>"</pre>
</div>
</div>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="preparing-cloud-init-images-in-rhv_rhv-provisioning">10.2. Preparing Cloud-init Images in oVirt</h3>
<div class="paragraph">
<p>To use <code>cloud-init</code> during provisioning, you must prepare an image with <code>cloud-init</code> installed in oVirt, and then import the image to Foreman to use for provisioning.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>In oVirt, create a virtual machine to use for image-based provisioning in Foreman.</p>
</li>
<li>
<p>On the virtual machine, install <code>cloud-init</code>:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">yum install cloud-init</pre>
</div>
</div>
</li>
<li>
<p>To the <code>/etc/cloud/cloud.cfg</code> file, add the following information:</p>
<div class="listingblock">
<div class="content">
<pre>datasource_list: ["NoCloud", "ConfigDrive"]</pre>
</div>
</div>
</li>
<li>
<p>In oVirt, create an image from this virtual machine.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>When you add this image to Foreman, ensure that you select the <strong>User Data</strong> check box.</p>
</div>
</div>
<div class="sect2">
<h3 id="adding-images-to-server_rhv-provisioning">10.3. Adding oVirt Images to Foreman&#160;server</h3>
<div class="paragraph">
<p>To create hosts using image-based provisioning, you must add information about the image, such as access details and the image location, to your Foreman&#160;server.</p>
</div>
<div class="paragraph">
<p>To use the CLI instead of the web UI, see the <a href="#cli-adding-images-to-server_rhv-provisioning">CLI procedure</a>.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>In the Foreman web UI, navigate to <strong>Infrastructure</strong> &gt; <strong>Compute Resources</strong> and click the name of the oVirt connection.</p>
</li>
<li>
<p>Click <strong>Create Image</strong>.</p>
</li>
<li>
<p>In the <strong>Name</strong> field, enter a name for the image.</p>
</li>
<li>
<p>From the <strong>Operating System</strong> list, select the image&#8217;s base operating system.</p>
</li>
<li>
<p>From the <strong>Architecture</strong> list, select the operating system architecture.</p>
</li>
<li>
<p>In the <strong>Username</strong> field, enter the SSH user name for image access.
This is normally the <code>root</code> user.</p>
</li>
<li>
<p>In the <strong>Password</strong> field, enter the SSH password for image access.</p>
</li>
<li>
<p>From the <strong>Image</strong> list, select an image from the oVirt compute resource.</p>
</li>
<li>
<p>Optional: Select the <strong>User Data</strong> check box if the image supports user data input, such as <code>cloud-init</code> data.</p>
</li>
<li>
<p>Click <strong>Submit</strong> to save the image details.</p>
</li>
</ol>
</div>
<div id="cli-adding-images-to-server_rhv-provisioning" class="ulist">
<div class="title">CLI procedure</div>
<ul>
<li>
<p>Create the image with the <code>hammer compute-resource image create</code> command.
Use the <code>--uuid</code> option to store the template UUID on the oVirt server.</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># hammer compute-resource image create \
--name "<em>oVirt_Image</em>" \
--compute-resource "<em>My_oVirt</em>"
--operatingsystem "RedHat <em>version</em>" \
--architecture "x86_64" \
--username root \
--uuid "9788910c-4030-4ae0-bad7-603375dd72b1" \</pre>
</div>
</div>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="preparing-a-cloud-init-template_rhv-provisioning">10.4. Preparing a Cloud-init Template</h3>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>You must enable the remote execution plug-in to use a 'cloud-init' template.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>In the Foreman web UI, navigate to <strong>Hosts</strong> &gt; <strong>Provisioning Templates</strong>, and click <strong>Create Template</strong>.</p>
</li>
<li>
<p>In the <strong>Name</strong> field, enter a name for the template.</p>
</li>
<li>
<p>In the <strong>Editor</strong> field, enter the following template details:</p>
<div class="listingblock">
<div class="content">
<pre>&lt;%#
kind: user_data
name: Cloud-init
-%&gt;
#cloud-config
hostname: &lt;%= @host.shortname %&gt;

&lt;%# Allow user to specify additional SSH key as host paramter -%&gt;
&lt;% if @host.params['sshkey'].present? || @host.params['remote_execution_ssh_keys'].present? -%&gt;
ssh_authorized_keys:
&lt;% if @host.params['sshkey'].present? -%&gt;
  - &lt;%= @host.params['sshkey'] %&gt;
&lt;% end -%&gt;
&lt;% if @host.params['remote_execution_ssh_keys'].present? -%&gt;
&lt;% @host.params['remote_execution_ssh_keys'].each do |key| -%&gt;
  - &lt;%= key %&gt;
&lt;% end -%&gt;
&lt;% end -%&gt;
&lt;% end -%&gt;
runcmd:
  - |
    #!/bin/bash
&lt;%= indent 4 do
    snippet 'subscription_manager_registration'
end %&gt;
&lt;% if @host.info['parameters']['realm'] &amp;&amp; @host.realm &amp;&amp; @host.realm.realm_type == 'Red Hat Identity Management' -%&gt;
  &lt;%= indent 4 do
    snippet 'idm_register'
  end %&gt;
&lt;% end -%&gt;
&lt;% unless @host.operatingsystem.atomic? -%&gt;
    # update all the base packages from the updates repository
    yum -t -y -e 0 update
&lt;% end -%&gt;
&lt;%
    # safemode renderer does not support unary negation
    non_atomic = @host.operatingsystem.atomic? ? false : true
    pm_set = @host.puppetmaster.empty? ? false : true
    puppet_enabled = non_atomic &amp;&amp; (pm_set || @host.params['force-puppet'])
%&gt;
&lt;% if puppet_enabled %&gt;
    yum install -y puppet
    cat &gt; /etc/puppet/puppet.conf &lt;&lt; EOF
  &lt;%= indent 4 do
    snippet 'puppet.conf'
  end %&gt;
    EOF
    # Setup puppet to run on system reboot
    /sbin/chkconfig --level 345 puppet on

    /usr/bin/puppet agent --config /etc/puppet/puppet.conf --onetime --tags no_such_tag &lt;%= @host.puppetmaster.blank? ? '' : "--server #{@host.puppetmaster}" %&gt; --no-daemonize
    /sbin/service puppet start
&lt;% end -%&gt;
phone_home:
 url: &lt;%= foreman_url('built') %&gt;
 post: []
 tries: 10pp</pre>
</div>
</div>
</li>
<li>
<p>Click the <strong>Type</strong> tab and from the <strong>Type</strong> list, select <strong>User data template</strong>.</p>
</li>
<li>
<p>Click the <strong>Association</strong> tab, and from the <strong>Applicable Operating Systems</strong> list, select the operating system that you want associate with the template.</p>
</li>
<li>
<p>Click the <strong>Locations</strong> tab, and from the <strong>Locations</strong> list, select the location that you want to associate with the template.</p>
</li>
<li>
<p>Click the <strong>Organizations</strong> tab, and from the <strong>Organization</strong> list, select the organization that you want to associate with the template.</p>
</li>
<li>
<p>Click <strong>Submit</strong>.</p>
</li>
<li>
<p>Navigate to <strong>Hosts</strong> &gt; <strong>Operating Systems</strong>, and select the operating system you want to associate with the template.</p>
</li>
<li>
<p>Click the <strong>Templates</strong> tab, and from the <strong>User data template</strong> list, select the name of the new template.</p>
</li>
<li>
<p>Click <strong>Submit</strong>.</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="adding-rhv-details-to-a-compute-profile_rhv-provisioning">10.5. Adding oVirt Details to a Compute Profile</h3>
<div class="paragraph">
<p>Use this procedure to add oVirt hardware settings to a compute profile.
When you create a host on KVM using this compute profile, these settings are automatically populated.</p>
</div>
<div class="paragraph">
<p>To use the CLI instead of the web UI, see the <a href="#cli-adding-rhv-details-to-a-compute-profile_rhv-provisioning">CLI procedure</a>.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>In the Foreman web UI, navigate to <strong>Infrastructure</strong> &gt; <strong>Compute Profiles</strong>.</p>
</li>
<li>
<p>In the Compute Profiles window, click the name of an existing compute profile, or click <strong>Create Compute Profile</strong>, enter a <strong>Name</strong>, and click <strong>Submit</strong>.</p>
</li>
<li>
<p>Click the name of the oVirt compute resource.</p>
</li>
<li>
<p>From the <strong>Cluster</strong> list, select the target host cluster in the oVirt environment.</p>
</li>
<li>
<p>From the <strong>Template</strong> list, select the oVirt template to use for the <strong>Cores</strong> and <strong>Memory</strong> settings.</p>
</li>
<li>
<p>In the <strong>Cores</strong> field, enter the number of CPU cores to allocate to the new host.</p>
</li>
<li>
<p>In the <strong>Memory</strong> field, enter the amount of memory to allocate to the new host.</p>
</li>
<li>
<p>From the <strong>Image</strong> list, select image to use for image-based provisioning.</p>
</li>
<li>
<p>In the <strong>Network Interfaces</strong> area, enter the network parameters for the host&#8217;s network interface.
You can create multiple network interfaces.
However, at least one interface must point to a Smart&#160;Proxy-managed network.
For each network interface, enter the following details:</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>In the <strong>Name</strong> field, enter the name of the network interface.</p>
</li>
<li>
<p>From the <strong>Network</strong> list, select The logical network that you want to use.</p>
</li>
</ol>
</div>
</li>
<li>
<p>In the <strong>Storage</strong> area, enter the storage parameters for the host.
You can create multiple volumes for the host.
For each volume, enter the following details:</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>In the <strong>Size (GB)</strong> enter the size, in GB, for the new volume.</p>
</li>
<li>
<p>From the <strong>Storage domain</strong> list, select the storage domain for the volume.</p>
</li>
<li>
<p>From the <strong>Preallocate disk</strong>, select either thin provisioning or preallocation of the full disk.</p>
</li>
<li>
<p>From the <strong>Bootable</strong> list, select whether you want a bootable or non-bootable volume.</p>
</li>
</ol>
</div>
</li>
<li>
<p>Click <strong>Submit</strong> to save the compute profile.</p>
</li>
</ol>
</div>
<div id="cli-adding-rhv-details-to-a-compute-profile_rhv-provisioning" class="olist arabic">
<div class="title">CLI procedure</div>
<ol class="arabic">
<li>
<p>To create a compute profile, enter the following command:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># hammer compute-profile create --name "oVirt CP"</pre>
</div>
</div>
</li>
<li>
<p>To set the values for the compute profile, enter the following command:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># hammer compute-profile values create --compute-profile "oVirt CP" \
--compute-resource "<em>My_oVirt</em>" \
--interface "compute_interface=<em>Interface_Type</em>,compute_name=eth0,compute_network=satnetwork" \
--volume "size_gb=20G,storage_domain=Data,bootable=true" \
--compute-attributes "cluster=Default,cores=1,memory=1073741824,start=true""</pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="creating-network-or-image-based-hosts_rhv-provisioning">10.6. Creating Hosts on oVirt</h3>
<div class="paragraph">
<p>In Foreman, you can use oVirt provisioning to create hosts over a network connection or from an existing image:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>If you want to create a host over a network connection, the new host must be able to access either Foreman&#160;server&#8217;s integrated Smart&#160;Proxy or an external Smart&#160;Proxy&#160;server on a oVirt virtual network, so that the host has access to PXE provisioning services.
This new host entry triggers the oVirt server to create and start a virtual machine.
If the virtual machine detects the defined Smart&#160;Proxy&#160;server through the virtual network, the virtual machine boots to PXE and begins to install the chosen operating system.</p>
</li>
<li>
<p>If you want to create a host with an existing image, the new host entry triggers the oVirt server to create the virtual machine using a pre-existing image as a basis for the new volume.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>To use the CLI instead of the web UI, see the <a href="#cli-creating-network-or-image-based-hosts_rhv-provisioning">CLI procedure</a>.</p>
</div>
<div class="paragraph">
<div class="title">DHCP Conflicts</div>
<p>For network-based provisioning, if you use a virtual network on the oVirt server for provisioning, select a network that does not provide DHCP assignments.
This causes DHCP conflicts with Foreman&#160;server when booting new hosts.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>In the Foreman web UI, navigate to <strong>Hosts</strong> &gt; <strong>Create Host</strong>.</p>
</li>
<li>
<p>In the <strong>Name</strong> field, enter a name for the host.</p>
</li>
<li>
<p>Click the <strong>Organization</strong> and <strong>Location</strong> tabs to ensure that the provisioning context is automatically set to the current context.</p>
</li>
<li>
<p>From the <strong>Host Group</strong> list, select the host group that you want to use to populate the form.</p>
</li>
<li>
<p>From the <strong>Deploy on</strong> list, select the oVirt connection.</p>
</li>
<li>
<p>From the <strong>Compute Profile</strong> list, select a profile to use to automatically populate virtual machine settings.</p>
</li>
<li>
<p>Click the <strong>Interface</strong> tab and click <strong>Edit</strong> on the host&#8217;s interface.</p>
</li>
<li>
<p>Verify that the fields are automatically populated, particularly the following items:</p>
<div class="ulist">
<ul>
<li>
<p>The <strong>Name</strong> from the <strong>Host</strong> tab becomes the <strong>DNS name</strong>.</p>
</li>
<li>
<p>Foreman&#160;server automatically assigns an IP address for the new host.</p>
</li>
<li>
<p>The <strong>MAC address</strong> field is blank.
The oVirt server assigns a MAC address to the host.</p>
</li>
<li>
<p>The <strong>Managed</strong>, <strong>Primary</strong>, and <strong>Provision</strong> options are automatically selected for the first interface on the host.
If not, select them.</p>
</li>
<li>
<p>The oVirt-specific fields are populated with settings from your compute profile.
Modify these settings if required.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Click the <strong>Operating System</strong> tab, and confirm that all fields automatically contain values.</p>
</li>
<li>
<p>Select the <strong>Provisioning Method</strong> that you want to use:</p>
<div class="ulist">
<ul>
<li>
<p>For network-based provisioning, click <strong>Network Based</strong>.</p>
</li>
<li>
<p>For image-based provisioning, click <strong>Image Based</strong>.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Click <strong>Resolve</strong> in <strong>Provisioning templates</strong> to check the new host can identify the right provisioning templates to use.</p>
</li>
<li>
<p>Click the <strong>Virtual Machine</strong> tab and confirm that these settings are populated with details from the host group and compute profile.
Modify these settings to suit your needs.</p>
</li>
<li>
<p>If you use the Katello plugin, click the <strong>Parameters</strong> tab, and ensure that a parameter exists that provides an activation key.
If not, add an activation key.</p>
</li>
<li>
<p>Click <strong>Submit</strong> to save the host entry.</p>
</li>
</ol>
</div>
<div id="cli-creating-network-or-image-based-hosts_rhv-provisioning" class="ulist">
<div class="title">CLI procedure</div>
<ul>
<li>
<p>To use network-based provisioning, create the host with the <code>hammer host create</code> command and include <code>--provision-method build</code>.
Replace the values in the following example with the appropriate values for your environment.</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># hammer host create \
--name "oVirt-vm1" \
--organization "<em>My_Organization</em>" \
--location "New York" \
--hostgroup "Base" \
--compute-resource "<em>My_oVirt</em>" \
--provision-method build \
--build true \
--enabled true \
--managed true \
--interface "managed=true,primary=true,provision=true,compute_name=eth0,compute_network=satnetwork" \
--compute-attributes="cluster=Default,cores=1,memory=1073741824,start=true" \
--volume="size_gb=20G,storage_domain=Data,bootable=true"</pre>
</div>
</div>
</li>
<li>
<p>To use image-based provisioning, create the host with the <code>hammer host create</code> command and include <code>--provision-method image</code>.
Replace the values in the following example with the appropriate values for your environment.</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># hammer host create \
--name "oVirt-vm2" \
--organization "<em>My_Organization</em>" \
--location "New York" \
--hostgroup "Base" \
--compute-resource "<em>My_oVirt</em>" \
--provision-method image \
--image "<em>oVirt_Image</em>" \
--enabled true \
--managed true \
--interface "managed=true,primary=true,provision=true,compute_name=eth0,compute_network=satnetwork" \
--compute-attributes="cluster=Default,cores=1,memory=1073741824,start=true" \
--volume="size_gb=20G,storage_domain=Data,bootable=true"</pre>
</div>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>For more information about additional host creation parameters for this compute resource, enter the <code>hammer host create --help</code> command.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="Provisioning_Virtual_Machines_in_VMware_vSphere">11. Provisioning Virtual Machines in VMware vSphere</h2>
<div class="sectionbody">
<div class="paragraph">
<p>VMware vSphere is an enterprise-level virtualization platform from VMware.
Foreman can interact with the vSphere platform, including creating new virtual machines and controlling their power management states.</p>
</div>
<div class="sect2">
<h3 id="Provisioning_Virtual_Machines_in_VMware_vSphere-Prerequisites_for_VMware_vSphere_Provisioning">11.1. Prerequisites for VMware vSphere Provisioning</h3>
<div class="paragraph">
<p>The requirements for VMware vSphere provisioning include:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A Smart&#160;Proxy&#160;server managing a network on the vSphere environment.
Ensure no other DHCP services run on this network to avoid conflicts with Smart&#160;Proxy&#160;server.
For more information, see <a href="#Configuring_Networking">Configuring Networking</a>.</p>
</li>
<li>
<p>An existing VMware template if you want to use image-based provisioning.</p>
</li>
<li>
<p>The installation media for the operating systems that you want to use to provision hosts.
If the Katello plug-in is installed, you can use synchronized content repositories for Red&#160;Hat Enterprise Linux.
For more information, see <a href="https://docs.theforeman.org/2.5/Content_Management_Guide/index-foreman-el.html#Importing_Content-Synchronizing_Repositories">Syncing Repositories</a> in the <em>Content Management Guide</em>.</p>
</li>
<li>
<p>If the Katello plug-in is installed, an activation key for host registration.
For more information, see <a href="https://docs.theforeman.org/2.5/Content_Management_Guide/index-foreman-el.html#Managing_Activation_Keys-Creating_an_Activation_Key">Creating An Activation Key</a> in the <em>Content Management</em> guide.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="Provisioning_Virtual_Machines_in_VMware_vSphere-Creating_a_VMware_vSphere_User">11.2. Creating a VMware vSphere User</h3>
<div class="paragraph">
<p>The VMware vSphere server requires an administration-like user for Foreman&#160;server communication.
For security reasons, do not use the <code>administrator</code> user for such communication.
Instead, create a user with the following permissions:</p>
</div>
<div class="paragraph">
<p>For VMware vCenter Server version 6.10, set the following permissions:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>All Privileges &#8594; Datastore &#8594; Allocate Space, Browse datastore, Update Virtual Machine files, Low level file operations</p>
</li>
<li>
<p>All Privileges &#8594; Network &#8594; Assign Network</p>
</li>
<li>
<p>All Privileges &#8594; Resource &#8594; Assign virtual machine to resource pool</p>
</li>
<li>
<p>All Privileges &#8594; Virtual Machine &#8594; Change Config (All)</p>
</li>
<li>
<p>All Privileges &#8594; Virtual Machine &#8594; Interaction (All)</p>
</li>
<li>
<p>All Privileges &#8594; Virtual Machine &#8594; Edit Inventory (All)</p>
</li>
<li>
<p>All Privileges &#8594; Virtual Machine &#8594; Provisioning (All)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Note that the same steps also apply to VMware vCenter Server version 7.0.</p>
</div>
<div class="paragraph">
<p>For VMware vCenter Server version 6.5, set the following permissions:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>All Privileges &#8594; Datastore &#8594; Allocate Space, Browse datastore, Update Virtual Machine files, Low level file operations</p>
</li>
<li>
<p>All Privileges &#8594; Network &#8594; Assign Network</p>
</li>
<li>
<p>All Privileges &#8594; Resource &#8594; Assign virtual machine to resource pool</p>
</li>
<li>
<p>All Privileges &#8594; Virtual Machine &#8594; Configuration (All)</p>
</li>
<li>
<p>All Privileges &#8594; Virtual Machine &#8594; Interaction (All)</p>
</li>
<li>
<p>All Privileges &#8594; Virtual Machine &#8594; Inventory (All)</p>
</li>
<li>
<p>All Privileges &#8594; Virtual Machine &#8594; Provisioning (All)</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="Provisioning_Virtual_Machines_in_VMware_vSphere-Adding_a_VMware_vSphere_Connection_to_the_Satellite_Server">11.3. Adding a VMware vSphere Connection to Foreman&#160;server</h3>
<div class="paragraph">
<p>Use this procedure to add a VMware vSphere connection in Foreman&#160;server&#8217;s compute resources.
To use the CLI instead of the web UI, see the <a href="#cli-adding-vmware-vsphere-connection_provisioning">CLI procedure</a>.</p>
</div>
<div class="paragraph">
<p>Ensure that the host and network-based firewalls are configured to allow Foreman to vCenter communication on TCP port 443.
Verify that Foreman is able to resolve the host name of vCenter and vCenter is able to resolve Foreman&#160;server&#8217;s host name.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>In the Foreman web UI, navigate to <strong>Infrastructure</strong> &gt; <strong>Compute Resources</strong>, and in the Compute Resources window, click <strong>Create Compute Resource</strong>.</p>
</li>
<li>
<p>In the <strong>Name</strong> field, enter a name for the resource.</p>
</li>
<li>
<p>From the <strong>Provider</strong> list, select <strong>VMware</strong>.</p>
</li>
<li>
<p>In the <strong>Description</strong> field, enter a description for the resource.</p>
</li>
<li>
<p>In the <strong>VCenter/Server</strong> field, enter the IP address or host name of the vCenter server.</p>
</li>
<li>
<p>In the <strong>User</strong> field, enter the user name with permission to access the vCenter&#8217;s resources.</p>
</li>
<li>
<p>In the <strong>Password</strong> field, enter the password for the user.</p>
</li>
<li>
<p>Click <strong>Load Datacenters</strong> to populate the list of data centers from your VMware vSphere environment.</p>
</li>
<li>
<p>From the <strong>Datacenter</strong> list, select a specific data center to manage from this list.</p>
</li>
<li>
<p>In the <strong>Fingerprint</strong> field, ensure that this field is populated with the fingerprint from the data center.</p>
</li>
<li>
<p>From the <strong>Display Type</strong> list, select a console type, for example, <strong>VNC</strong> or <strong>VMRC</strong>.
Note that VNC consoles are unsupported on VMware ESXi 6.5 and later.</p>
</li>
<li>
<p>Optional: In the <strong>VNC Console Passwords</strong> field, select the <strong>Set a randomly generated password on the display connection</strong> check box to secure console access for new hosts with a randomly generated password.
You can retrieve the password for the VNC console to access guest virtual machine console from the <code>libvirtd</code> host from the output of the following command:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># virsh edit <em>your_VM_name</em>
&lt;graphics type='vnc' port='-1' autoport='yes' listen='0.0.0.0' passwd='<em>your_randomly_generated_password</em>'&gt;</pre>
</div>
</div>
<div class="paragraph">
<p>The password randomly generates every time the console for the virtual machine opens, for example, with virt-manager.</p>
</div>
</li>
<li>
<p>From the <strong>Enable Caching</strong> list, you can select whether to enable caching of compute resources.
For more information, see <a href="#Provisioning_Virtual_Machines_in_VMware_vSphere-Caching_of_Compute_resources">Caching of Compute Resources</a>.</p>
</li>
<li>
<p>Click the <strong>Locations</strong> and <strong>Organizations</strong> tabs and verify that the values are automatically set to your current context.
You can also add additional contexts.</p>
</li>
<li>
<p>Click <strong>Submit</strong> to save the connection.</p>
</li>
</ol>
</div>
<div id="cli-adding-vmware-vsphere-connection_provisioning" class="ulist">
<div class="title">CLI procedure</div>
<ul>
<li>
<p>Create the connection with the <code>hammer compute-resource create</code> command.
Select <code>Vmware</code> as the <code>--provider</code> and set the instance UUID of the data center as the <code>--uuid</code>:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># hammer compute-resource create --name "My_vSphere" \
--provider "Vmware" \
--description "vSphere server at <em>vsphere.example.com</em>" \
--server "<em>vsphere.example.com</em>" --user "<em>My_User</em>" \
--password "<em>My_Password</em>" --locations "<em>My_Location</em>" --organizations "<em>My_Organization</em>" \
--datacenter "<em>My_Datacenter</em>"</pre>
</div>
</div>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="Provisioning_Virtual_Machines_in_VMware_vSphere-Adding_VMware_vSphere_Images_on_the_Satellite_Server">11.4. Adding VMware vSphere Images to Foreman&#160;server</h3>
<div class="paragraph">
<p>VMware vSphere uses templates as images for creating new virtual machines.
If using image-based provisioning to create new hosts, you need to add VMware template details to your Foreman&#160;server.
This includes access details and the template name.</p>
</div>
<div class="paragraph">
<p>To use the CLI instead of the web UI, see the <a href="#cli-adding-vmware-vsphere-images-to-server_provisioning">CLI procedure</a>.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>In the Foreman web UI, navigate to <strong>Infrastructure</strong> &gt; <strong>Compute Resources</strong> and in the Compute Resources window, click the VMware vSphere connection.</p>
</li>
<li>
<p>In the <strong>Name</strong> field, enter a name for the image.</p>
</li>
<li>
<p>From the <strong>Operatingsystem</strong> list, select the image&#8217;s base operating system.</p>
</li>
<li>
<p>From the <strong>Architecture</strong> list, select the operating system architecture.</p>
</li>
<li>
<p>In the <strong>User</strong> field, enter the SSH user name for image access.
This is normally the <code>root</code> user.</p>
</li>
<li>
<p>In the <strong>Password</strong> field, enter the SSH password for image access.</p>
</li>
<li>
<p>From the <strong>User data</strong> list, select whether you want the images to support user data input, such as <code>cloud-init</code> data.</p>
</li>
<li>
<p>In the <strong>Image</strong> field, enter the relative path and name of the template on the vSphere environment.
Do not include the data center in the relative path.</p>
</li>
<li>
<p>Click <strong>Submit</strong> to save the image details.</p>
</li>
</ol>
</div>
<div id="cli-adding-vmware-vsphere-images-to-server_provisioning" class="ulist">
<div class="title">CLI procedure</div>
<ul>
<li>
<p>Create the image with the <code>hammer compute-resource image create</code> command.
Use the <code>--uuid</code> field to store the relative template path on the vSphere environment.</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># hammer compute-resource image create --name "<em>Test_vSphere_Image</em>" \
--operatingsystem "RedHat 7.2" --architecture "x86_64" \
--username root --uuid "Templates/RHEL72" \
--compute-resource "<em>My_vSphere</em>"</pre>
</div>
</div>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="Provisioning_Virtual_Machines_in_VMware_vSphere-Adding_VMware_vSphere_Details_to_a_Compute_Profile">11.5. Adding VMware vSphere Details to a Compute Profile</h3>
<div class="paragraph">
<p>You can predefine certain hardware settings for virtual machines on VMware vSphere.
You achieve this through adding these hardware settings to a compute profile.
To use the CLI instead of the web UI, see the <a href="#cli-adding-vmware-vsphere-details-to-a-compute-profile_provisioning">CLI procedure</a>.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>In the Foreman web UI, navigate to <strong>Infrastructure</strong> &gt; <strong>Compute Profiles</strong> and, in the Compute Profiles window, click the name of the compute profile, and then click the vSphere connection.</p>
</li>
<li>
<p>In the <strong>CPUs</strong> field, enter the number of CPUs to allocate to the new host.</p>
</li>
<li>
<p>In the <strong>Cores per socket</strong> field, enter the number of cores to allocate to each CPU.</p>
</li>
<li>
<p>In the <strong>Memory</strong> field, enter the amount of memory to allocate to the new host.</p>
</li>
<li>
<p>In the <strong>Cluster</strong> field, enter the name of the target host cluster on the VMware environment.</p>
</li>
<li>
<p>From the <strong>Resource pool</strong> list, select an available resource allocations for the host.</p>
</li>
<li>
<p>In the <strong>Folder</strong> field, enter the folder to organize the host.</p>
</li>
<li>
<p>From the <strong>Guest OS</strong> list, select the operating system you want to use in VMware vSphere.</p>
</li>
<li>
<p>From the <strong>SCSI controller</strong> list, select the disk access method for the host.</p>
</li>
<li>
<p>From the <strong>Virtual H/W version</strong> list, select the underlying VMware hardware abstraction to use for virtual machines.</p>
</li>
<li>
<p>You can select the <strong>Memory hot add</strong> or <strong>CPU hot add</strong> check boxes if you want to add more resources while the virtual machine is powered.</p>
</li>
<li>
<p>From the <strong>Image</strong> list, select the image to use if performing image-based provisioning.</p>
</li>
<li>
<p>From the <strong>Network Interfaces</strong> list, select the network parameters for the host&#8217;s network interface.
You can create multiple network interfaces.
However, at least one interface must point to a Smart&#160;Proxy-managed network.</p>
</li>
<li>
<p>Select the <strong>Eager zero</strong> check box if you want to use eager zero thick provisioning.
If unchecked, the disk uses lazy zero thick provisioning.</p>
</li>
<li>
<p>Click <strong>Submit</strong> to save the compute profile.</p>
</li>
</ol>
</div>
<div id="cli-adding-vmware-vsphere-details-to-a-compute-profile_provisioning" class="olist arabic">
<div class="title">CLI procedure</div>
<ol class="arabic">
<li>
<p>To create the compute profile, enter the following command:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># hammer compute-profile create --name "VMWare CP"</pre>
</div>
</div>
</li>
<li>
<p>To add the values for the compute profile, enter the following command:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># hammer compute-profile values create --compute-profile "<em>VMWare CP</em>" \
--compute-resource "<em>My_vSphere</em>" \
--interface "compute_type=VirtualE1000,compute_network=mynetwork \
--volume "size_gb=20G,datastore=Data,name=myharddisk,thin=true" \
--compute-attributes "cpus=1,corespersocket=2,memory_mb=1024,cluster=MyCluster,path=MyVMs,start=true"</pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="Provisioning_Virtual_Machines_in_VMware_vSphere-Creating_Hosts_on_a_VMware_vSphere_Server">11.6. Creating Hosts on a VMware vSphere Server</h3>
<div class="paragraph">
<p>The VMware vSphere provisioning process provides the option to create hosts over a network connection or using an existing image.</p>
</div>
<div class="paragraph">
<p>For network-based provisioning, you must create a host to access either Foreman&#160;server&#8217;s integrated Smart&#160;Proxy or an external Smart&#160;Proxy&#160;server on a VMware vSphere virtual network, so that the host has access to PXE provisioning services.
The new host entry triggers the VMware vSphere server to create the virtual machine.
If the virtual machine detects the defined Smart&#160;Proxy&#160;server through the virtual network, the virtual machine boots to PXE and begins to install the chosen operating system.</p>
</div>
<div class="paragraph">
<div class="title">DHCP Conflicts</div>
<p>If you use a virtual network on the VMware vSphere server for provisioning, ensure that you select a virtual network that does not provide DHCP assignments.
This causes DHCP conflicts with Foreman&#160;server when booting new hosts.</p>
</div>
<div class="paragraph">
<p>For image-based provisioning, use the pre-existing image as a basis for the new volume.</p>
</div>
<div class="paragraph">
<p>To use the CLI instead of the web UI, see the <a href="#cli-creating-hosts-on-vmware-vsphere_provisioning">CLI procedure</a>.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>In the Foreman web UI, navigate to <strong>Hosts</strong> &gt; <strong>Create Host</strong>.</p>
</li>
<li>
<p>In the <strong>Name</strong> field, enter the name that you want to become the provisioned system&#8217;s host name.</p>
</li>
<li>
<p>Click the <strong>Organization</strong> and <strong>Location</strong> tabs to ensure that the provisioning context is automatically set to the current context.</p>
</li>
<li>
<p>From the <strong>Host Group</strong> list, select the host group that you want to use to populate the form.</p>
</li>
<li>
<p>From the <strong>Deploy on</strong> list, select the VMware vSphere connection.</p>
</li>
<li>
<p>From the <strong>Compute Profile</strong> list, select a profile to use to automatically populate virtual machine-based settings.</p>
</li>
<li>
<p>Click the <strong>Interface</strong> tab and click <strong>Edit</strong> on the host&#8217;s interface.</p>
</li>
<li>
<p>Verify that the fields are automatically populated with values.
Note in particular:</p>
<div class="ulist">
<ul>
<li>
<p>The <strong>Name</strong> from the <strong>Host</strong> tab becomes the <strong>DNS name</strong>.</p>
</li>
<li>
<p>Foreman&#160;server automatically assigns an IP address for the new host.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Ensure that the <strong>MAC address</strong> field is blank.
The VMware vSphere server assigns one to the host.</p>
</li>
<li>
<p>Verify that the <strong>Managed</strong>, <strong>Primary</strong>, and <strong>Provision</strong> options are automatically selected for the first interface on the host.
If not, select them.</p>
</li>
<li>
<p>In the interface window, review the VMware vSphere-specific fields that are populated with settings from our compute profile.
Modify these settings to suit your needs.</p>
</li>
<li>
<p>Click the <strong>Operating System</strong> tab, and confirm that all fields automatically contain values.</p>
</li>
<li>
<p>Select the Provisioning Method that you want:</p>
<div class="ulist">
<ul>
<li>
<p>For network-based provisioning, click <strong>Network Based</strong>.</p>
</li>
<li>
<p>For image-based provisioning, click <strong>Image Based</strong>.</p>
</li>
<li>
<p>If the <code>foreman_bootdisk</code> plug-in is installed, and you want to use boot-disk provisioning, click <strong>Boot disk based</strong>.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Click <strong>Resolve</strong> in <strong>Provisioning templates</strong> to check the new host can identify the right provisioning templates to use.</p>
</li>
<li>
<p>Click the <strong>Virtual Machine</strong> tab and confirm that these settings are populated with details from the host group and compute profile.
Modify these settings to suit your requirements.</p>
</li>
<li>
<p>If you use the Katello plugin, click the <strong>Parameters</strong> tab and ensure that a parameter exists that provides an activation key.
If not, add an activation key.</p>
</li>
<li>
<p>Click <strong>Submit</strong> to save the host entry.</p>
</li>
</ol>
</div>
<div id="cli-creating-hosts-on-vmware-vsphere_provisioning" class="ulist">
<div class="title">CLI procedure</div>
<ul>
<li>
<p>Create the host from a network with the <code>hammer host create</code> command and include <code>--provision-method build</code> to use network-based provisioning.</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># hammer host create --name "vmware-test1" --organization "<em>My_Organization</em>" \
--location "New York" --hostgroup "Base" \
--compute-resource "<em>My_vSphere</em>" --provision-method build \
--build true --enabled true --managed true \
--interface "managed=true,primary=true,provision=true,compute_type=VirtualE1000,compute_network=mynetwork" \
--compute-attributes="cpus=1,corespersocket=2,memory_mb=1024,cluster=MyCluster,path=MyVMs,start=true" \
--volume="size_gb=20G,datastore=Data,name=myharddisk,thin=true"</pre>
</div>
</div>
</li>
<li>
<p>Create the host from an image with the <code>hammer host create</code> command and include <code>--provision-method image</code> to use image-based provisioning.</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># hammer host create --name "vmware-test2" --organization "<em>My_Organization</em>" \
--location "New York" --hostgroup "Base" \
--compute-resource "<em>My_VMware</em>" --provision-method image \
--image "<em>Test VMware Image</em>" --enabled true --managed true \
--interface "managed=true,primary=true,provision=true,compute_type=VirtualE1000,compute_network=mynetwork" \
--compute-attributes="cpus=1,corespersocket=2,memory_mb=1024,cluster=MyCluster,path=MyVMs,start=true" \
--volume="size_gb=20G,datastore=Data,name=myharddisk,thin=true"</pre>
</div>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>For more information about additional host creation parameters for this compute resource, enter the <code>hammer host create --help</code> command.</p>
</div>
</div>
<div class="sect2">
<h3 id="Provisioning_Virtual_Machines_in_VMware_vSphere-Provisioning_with_cloudinit_and_userdata_templates">11.7. Using the VMware vSphere Cloud-init and Userdata Templates for Provisioning</h3>
<div class="paragraph">
<p>You can use VMware with the <code>Cloud-init</code> and <code>Userdata</code> templates to insert user data into the new virtual machine, to make further VMware customization, and to enable the VMware-hosted virtual machine to call back to Foreman.</p>
</div>
<div class="paragraph">
<p>You can use the same procedures to set up a VMware compute resource within Foreman, with a few modifications to the work flow.</p>
</div>
<div class="paragraph">
<div class="title">VMware cloud-init Provisioning Overview</div>
<p><span class="image"><img src="images/user-data-sequence-foreman.svg" alt="user data sequence foreman"></span></p>
</div>
<div class="paragraph">
<p>When you set up the compute resource and images for VMware provisioning in Foreman, the following sequence of provisioning events occur:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The user provisions one or more virtual machines using the Foreman web UI, API, or hammer</p>
</li>
<li>
<p>Foreman calls the VMware vCenter to clone the virtual machine template</p>
</li>
<li>
<p>Foreman <code>userdata</code> provisioning template adds customized identity information</p>
</li>
<li>
<p>When provisioning completes, the <code>Cloud-init</code> provisioning template instructs the virtual machine to call back to Smart&#160;Proxy when <code>cloud-init</code> runs</p>
</li>
<li>
<p>VMware vCenter clones the template to the virtual machine</p>
</li>
<li>
<p>VMware vCenter applies customization for the virtual machine&#8217;s identity, including the host name, IP, and DNS</p>
</li>
<li>
<p>The virtual machine builds, <code>cloud-init</code> is invoked and calls back Foreman on port <code>80</code>, which then redirects to <code>443</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<div class="title">Port and Firewall Requirements</div>
<p>Because of the <code>cloud-init</code> service, the virtual machine always calls back to Foreman even if you register the virtual machine to Smart&#160;Proxy.
Ensure that you configure port and firewall settings to open any necessary connections.</p>
</div>
<div class="paragraph">
<p>For more information about port and firewall requirements, see <a href="https://docs.theforeman.org/2.5/Installing_Server_on_Red_Hat/index-foreman-el.html#satellite-ports-and-firewalls-requirements_foreman">Port and Firewall Requirements</a> in the <em>Installing Foreman</em> and <a href="https://docs.theforeman.org/2.5/Installing_Proxy_on_Red_Hat/index-foreman-el.html#capsule-ports-and-firewalls-requirements_smart-proxy">Ports and Firewalls Requirements</a> in <em>Installing Smart&#160;Proxy&#160;server</em>.</p>
</div>
<div class="olist arabic">
<div class="title">Associating the <code>userdata</code> and <code>Cloud-init</code> Templates with the Operating System</div>
<ol class="arabic">
<li>
<p>In the Foreman web UI, navigate to <strong>Hosts</strong> &gt; <strong>Operating Systems</strong>, and select the operating system that you want to use for provisioning.</p>
</li>
<li>
<p>Click the <strong>Template</strong> tab.</p>
</li>
<li>
<p>From the <strong>Cloud-init template</strong> list, select <strong>Cloudinit default</strong>.</p>
</li>
<li>
<p>From the <strong>User data template</strong> list, select <strong>UserData open-vm-tools</strong>.</p>
</li>
<li>
<p>Click <strong>Submit</strong> to save the changes.</p>
</li>
</ol>
</div>
<div class="paragraph">
<div class="title">Preparing an Image to use the cloud-init Template</div>
<p>To prepare an image, you must first configure the settings that you require on a virtual machine that you can then save as an image to use in Foreman.</p>
</div>
<div class="paragraph">
<p>To use the <code>cloud-init</code> template for provisioning, you must configure a virtual machine so that <code>cloud-init</code> is installed, enabled, and configured to call back to Foreman&#160;server.</p>
</div>
<div class="paragraph">
<p>For security purposes, you must install a CA certificate to use HTTPs for all communication.
This procedure includes steps to clean the virtual machine so that no unwanted information transfers to the image you use for provisioning.</p>
</div>
<div class="paragraph">
<p>If you have an image with <code>cloud-init</code>, you must still follow this procedure to enable <code>cloud-init</code> to communicate with Foreman because <code>cloud-init</code> is disabled by default.</p>
</div>
<div class="paragraph">
<p>These instructions are for Red Hat Enterprise Linux or Fedora OS, follow similar steps for other Linux distributions.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>On the virtual machine that you use to create the image, install <code>cloud-init</code>, <code>open-vm-tools</code>, and <code>perl</code>:</p>
<div class="listingblock">
<div class="content">
<pre># yum -y install cloud-init open-vm-tools perl</pre>
</div>
</div>
</li>
<li>
<p>Disable network configuration by <code>cloud-init</code>:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># cat &lt;&lt; EOM &gt; /etc/cloud/cloud.cfg.d/01_network.cfg
network:
  config: disabled
EOM</pre>
</div>
</div>
</li>
<li>
<p>Configure <code>cloud-init</code> to fetch data from Foreman:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># cat &lt;&lt; EOM &gt; /etc/cloud/cloud.cfg.d/10_datasource.cfg
datasource_list: [NoCloud]
datasource:
  NoCloud:
    seedfrom: https://foreman.example.com/userdata/
EOM</pre>
</div>
</div>
</li>
<li>
<p>Configure modules to use in <code>cloud-init</code>:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># cat &lt;&lt; EOM &gt; /etc/cloud/cloud.cfg
cloud_init_modules:
 - bootcmd

cloud_config_modules:
 - runcmd

cloud_final_modules:
 - scripts-per-once
 - scripts-per-boot
 - scripts-per-instance
 - scripts-user
 - phone-home

system_info:
  distro: rhel
  paths:
    cloud_dir: /var/lib/cloud
    templates_dir: /etc/cloud/templates
  ssh_svcname: sshd
EOM</pre>
</div>
</div>
</li>
<li>
<p>Enable the CA certificates for the image:</p>
<div class="listingblock">
<div class="content">
<pre># update-ca-trust enable</pre>
</div>
</div>
</li>
<li>
<p>Download the <code>katello-server-ca.crt</code> file from Foreman&#160;server:
You must have the Katello plugin installed to complete this step.
For Foreman&#160;server deployments, copy the CA certificate from the Apache configuration.</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># wget -O /etc/pki/ca-trust/source/anchors/cloud-init-ca.crt http://<em>foreman.example.com</em>/pub/katello-server-ca.crt</pre>
</div>
</div>
</li>
<li>
<p>To update the record of certificates, enter the following command:</p>
<div class="listingblock">
<div class="content">
<pre># update-ca-trust extract</pre>
</div>
</div>
</li>
<li>
<p>Use the following commands to clean the image:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># systemctl stop rsyslog
# systemctl stop auditd
# package-cleanup --oldkernels --count=1
# yum clean all</pre>
</div>
</div>
</li>
<li>
<p>Use the following commands to reduce logspace, remove old logs, and truncate logs:</p>
<div class="listingblock">
<div class="content">
<pre># logrotate -f /etc/logrotate.conf
# rm -f /var/log/*-???????? /var/log/*.gz
# rm -f /var/log/dmesg.old
# rm -rf /var/log/anaconda
# cat /dev/null &gt; /var/log/audit/audit.log
# cat /dev/null &gt; /var/log/wtmp
# cat /dev/null &gt; /var/log/lastlog
# cat /dev/null &gt; /var/log/grubby</pre>
</div>
</div>
</li>
<li>
<p>Remove <code>udev</code> hardware rules:</p>
<div class="listingblock">
<div class="content">
<pre># rm -f /etc/udev/rules.d/70*</pre>
</div>
</div>
</li>
<li>
<p>Remove the <code>ifcfg</code> scripts related to existing network configurations:</p>
<div class="listingblock">
<div class="content">
<pre># rm -f /etc/sysconfig/network-scripts/ifcfg-ens*
# rm -f /etc/sysconfig/network-scripts/ifcfg-eth*</pre>
</div>
</div>
</li>
<li>
<p>Remove the SSH host keys:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># rm -f /etc/ssh/<em>SSH_keys</em></pre>
</div>
</div>
</li>
<li>
<p>Remove root user&#8217;s SSH history:</p>
<div class="listingblock">
<div class="content">
<pre># rm -rf ~root/.ssh/known_hosts</pre>
</div>
</div>
</li>
<li>
<p>Remove root user&#8217;s shell history:</p>
<div class="listingblock">
<div class="content">
<pre># rm -f ~root/.bash_history
# unset HISTFILE</pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>You can now create an image from this virtual machine.</p>
</div>
<div class="paragraph">
<p>You can use the <a href="#Provisioning_Virtual_Machines_in_VMware_vSphere-Adding_VMware_vSphere_Images_on_the_Satellite_Server">Adding VMware vSphere Images to Foreman&#160;server</a> section to add the image to Foreman.</p>
</div>
<div class="paragraph">
<div class="title">Configuring Smart&#160;Proxy to Forward the user data Template</div>
<p>If you deploy Foreman with the Smart&#160;Proxy templates feature, you must configure Foreman to recognize hosts' IP addresses forwarded over the X-Forwarded-For HTTP header to serve correct template payload.</p>
</div>
<div class="paragraph">
<p>For security reasons, Foreman recognizes this HTTP header only from localhost.
For each individual Smart&#160;Proxy, you must configure a regular expression to recognize hosts' IP addresses.
From the web UI, you can do this by navigating to <strong>Administer</strong> &gt; <strong>Settings</strong> &gt; <strong>Provisioning</strong>, and changing the <strong>Remote address</strong> setting.
From the CLI, you can do this by entering the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># hammer settings set --name remote_addr --value '(localhost(4|6|4to6)?|192.168.122.(1|2|3))'</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="Provisioning_Virtual_Machines_in_VMware_vSphere-Caching_of_Compute_resources">11.8. Caching of Compute Resources</h3>
<div class="paragraph">
<p>Caching of compute resources speeds up rendering of VMware information.</p>
</div>
<div class="sect3">
<h4 id="_enabling_caching_of_compute_resources">11.8.1. Enabling Caching of Compute Resources</h4>
<div class="paragraph">
<p>To enable or disable caching of compute resources:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>In the Foreman web UI, navigate to <strong>Infrastructure</strong> &gt; <strong>Compute Resources</strong>.</p>
</li>
<li>
<p>Click the <strong>Edit</strong> button to the right of the VMware server you want to update.</p>
</li>
<li>
<p>Select the <strong>Enable caching</strong> check box.</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_refreshing_the_compute_resources_cache">11.8.2. Refreshing the Compute Resources Cache</h4>
<div class="paragraph">
<p>To refresh the cache of compute resources to update compute resources information:</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>In the Foreman web UI, navigate to <strong>Infrastructure</strong> &gt; <strong>Compute Resources</strong>.</p>
</li>
<li>
<p>Select a VMware server you want to refresh the compute resources cache for and click the <strong>Refresh Cache</strong> button.</p>
</li>
</ol>
</div>
<div class="paragraph">
<div class="title">CLI procedure</div>
<p>Use this API call to refresh the compute resources cache:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># curl -H "Accept:application/json,version=2" \
-H "Content-Type:application/json" -X PUT \
-u <em>username</em>:<em>password</em> -k \
https://<em>foreman.example.com</em>/api/compute_resources/<em>compute_resource_id</em>/refresh_cache</pre>
</div>
</div>
<div class="paragraph">
<p>Use the <code>hammer compute-resource list</code> command to determine the ID of the VMware server you want to refresh the compute resources cache for.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="provisioning-virtual-machines-kubevirt_provisioning">12. Provisioning Virtual Machines on KubeVirt</h2>
<div class="sectionbody">
<div class="paragraph">
<p>KubeVirt addresses the needs of development teams that have adopted or want to adopt Kubernetes but possess existing virtual machine (VM)-based workloads that cannot be easily containerized.
This technology provides a unified development platform where developers can build, modify, and deploy applications residing in application containers and VMs in a shared environment.
These capabilities support rapid application modernization across the open hybrid cloud.</p>
</div>
<div class="paragraph">
<p>With Foreman, you can create a compute resource for KubeVirt so that you can provision and manage Kubernetes virtual machines using Foreman.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>The installation media for the operating systems that you want to use to provision hosts.
If the Katello plug-in is installed, you can use synchronized content repositories for Red&#160;Hat Enterprise Linux.
For more information, see <a href="https://docs.theforeman.org/2.5/Content_Management_Guide/index-foreman-el.html#Importing_Content-Synchronizing_Repositories">Syncing Repositories</a> in the <em>Content Management Guide</em>.</p>
</li>
<li>
<p>If the Katello plug-in is installed, an activation key for host registration.
For more information, see <a href="https://docs.theforeman.org/2.5/Content_Management_Guide/index-foreman-el.html#Managing_Activation_Keys-Creating_an_Activation_Key">Creating An Activation Key</a> in the <em>Content Management</em> guide.</p>
</li>
<li>
<p>A KubeVirt user that has the <code>cluster-admin</code> permissions for the Openshift Container Platform virtual cluster.
For more information, see <a href="https://access.redhat.com/documentation/en-us/openshift_container_platform/4.1/html/authentication/using-rbac">Using RBAC to Define and Apply Permissions</a> in the <em>Authentication</em> guide of the Openshift Container Platform documentation.</p>
</li>
<li>
<p>A Smart&#160;Proxy&#160;server managing a network on the KubeVirt server.
Ensure that no other DHCP services run on this network to avoid conflicts with Smart&#160;Proxy&#160;server.
For more information about network service configuration for Smart&#160;Proxy&#160;servers, see <a href="https://docs.theforeman.org/2.5/Provisioning_Guide/index-foreman-el.html#Configuring_Networking">Configuring Networking</a>.</p>
</li>
<li>
<p>A Foreman user account with the following roles:</p>
<div class="ulist">
<ul>
<li>
<p><strong>Edit hosts</strong></p>
</li>
<li>
<p><strong>View hosts</strong></p>
<div class="paragraph">
<p>For more information, see <a href="https://docs.theforeman.org/2.5/Administering_Red_Hat_Satellite/index-foreman-el.html#assigning-roles-to-a-user_admin">Assigning Roles to a User</a> in the <em>Administering Foreman</em> guide.</p>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>A custom role in Foreman with the following permissions:</p>
<div class="ulist">
<ul>
<li>
<p><strong>view_compute_resources</strong></p>
</li>
<li>
<p><strong>destroy_compute_resources_vms</strong></p>
</li>
<li>
<p><strong>power_compute_resources_vms</strong></p>
</li>
<li>
<p><strong>create_compute_resources_vms</strong></p>
</li>
<li>
<p><strong>view_compute_resources_vms</strong></p>
</li>
<li>
<p><strong>view_locations</strong></p>
</li>
<li>
<p><strong>view_subnets</strong></p>
<div class="paragraph">
<p>For more information about creating roles, see <a href="https://docs.theforeman.org/2.5/Administering_Red_Hat_Satellite/index-foreman-el.html#creating-a-role_admin">Creating a Role</a> in the <em>Administering Foreman</em> guide.
For more information about adding permissions to a role, see <a href="https://docs.theforeman.org/2.5/Administering_Red_Hat_Satellite/index-foreman-el.html#adding-permissions-to-a-role_admin">Adding Permissions to a Role</a> in the <em>Administering Foreman</em> guide.</p>
</div>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="adding-kubevirt-connection_kubevirt-provisioning">12.1. Adding a KubeVirt Connection to Foreman&#160;server</h3>
<div class="paragraph">
<p>Use this procedure to add KubeVirt as a compute resource in Foreman.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Enter the following <code>foreman-installer</code> command to enable the KubeVirt plugin for Foreman:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># foreman-installer --enable-foreman-plugin-kubevirt</pre>
</div>
</div>
</li>
<li>
<p>Generate a bearer token to use for HTTP and HTTPs authentication.
On the KubeVirt server, list the secrets that contain tokens:</p>
<div class="listingblock">
<div class="content">
<pre># kubectl get secrets</pre>
</div>
</div>
</li>
<li>
<p>List the token for your secret:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># kubectl get secrets <em>YOUR_SECRET</em> -o jsonpath='{.data.token}' | base64 -d | xargs</pre>
</div>
</div>
<div class="paragraph">
<p>Make a note of this token to use later in this procedure.</p>
</div>
</li>
<li>
<p>In the Foreman web UI, navigate to <strong>Infrastructure</strong> &gt; <strong>Compute Resources</strong>, and click <strong>Create Compute Resource</strong>.</p>
</li>
<li>
<p>In the <strong>Name</strong> field, enter a name for the new compute resource.</p>
</li>
<li>
<p>From the <strong>Provider</strong> list, select <strong>KubeVirt</strong>.</p>
</li>
<li>
<p>In the <strong>Description</strong> field, enter a description for the compute resource.</p>
</li>
<li>
<p>In the <strong>Hostname</strong> field, enter the address of the KubeVirt server that you want to use.</p>
</li>
<li>
<p>In the <strong>API Port</strong> field, enter the port number that you want to use for provisioning requests from Foreman to KubeVirt.</p>
</li>
<li>
<p>In the <strong>Namespace</strong> field, enter the user name of the KubeVirt virtual cluster that you want to use.</p>
</li>
<li>
<p>In the <strong>Token</strong> field, enter the bearer token for HTTP and HTTPs authentication.</p>
</li>
<li>
<p>Optional: In the <strong>X509 Certification Authorities</strong> field, enter a certificate to enable client certificate authentication for API server calls.</p>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="provisioning-cloud-instances-openstack_provisioning">13. Provisioning Cloud Instances on OpenStack</h2>
<div class="sectionbody">
<div class="paragraph">
<p>OpenStack provides the foundation to build a private or public Infrastructure-as-a-Service (IaaS) cloud.
It offers a massively scalable, fault-tolerant platform for the development of cloud-enabled workloads.
In Foreman, you can interact with OpenStack REST API to create cloud instances and control their power management states.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>The installation media for the operating systems that you want to use to provision hosts.
If the Katello plug-in is installed, you can use synchronized content repositories for Red&#160;Hat Enterprise Linux.
For more information, see <a href="https://docs.theforeman.org/2.5/Content_Management_Guide/index-foreman-el.html#Importing_Content-Synchronizing_Repositories">Syncing Repositories</a> in the <em>Content Management Guide</em>.</p>
</li>
<li>
<p>If the Katello plug-in is installed, an activation key for host registration.
For more information, see <a href="https://docs.theforeman.org/2.5/Content_Management_Guide/index-foreman-el.html#Managing_Activation_Keys-Creating_an_Activation_Key">Creating An Activation Key</a> in the <em>Content Management</em> guide.</p>
</li>
<li>
<p>A Smart&#160;Proxy&#160;server managing a network in your OpenStack environment.
For more information, see <a href="https://docs.theforeman.org/2.5/Provisioning_Guide/index-foreman-el.html#Configuring_Networking">Configuring Networking</a>.</p>
</li>
<li>
<p>An image added to OpenStack Image Storage (glance) service for image-based provisioning.
For more information, see the <a href="https://access.redhat.com/documentation/en-us/red_hat_openstack_platform/16.0/html/instances_and_images_guide/index">OpenStack <em>Instances and Images Guide</em></a>.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure Overview</div>
<ol class="arabic">
<li>
<p><a href="#adding-openstack-connection_openstack-provisioning">Adding the OpenStack Connection to Foreman&#160;server</a>.</p>
</li>
<li>
<p><a href="#adding-images-to-server_openstack-provisioning">Adding OpenStack Images to Foreman&#160;server</a>.</p>
</li>
<li>
<p><a href="#adding-openstack-details-to-a-compute-profile_openstack-provisioning">Adding OpenStack Details to a Compute Profile</a>.</p>
</li>
<li>
<p><a href="#creating-image-only-hosts_openstack-provisioning">Creating Image-based Hosts on OpenStack</a>.</p>
</li>
</ol>
</div>
<div class="sect2">
<h3 id="adding-openstack-connection_openstack-provisioning">13.1. Adding the OpenStack Connection to Foreman&#160;server</h3>
<div class="paragraph">
<p>Use this procedure to add OpenStack as a compute resource in Foreman.
To use the CLI instead of the web UI, see the <a href="#cli-adding-openstack-connection_openstack-provisioning">CLI procedure</a>.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>In the Foreman web UI, navigate to <strong>Infrastructure</strong> &gt; <strong>Compute Resources</strong> and click <strong>Create Compute Resource</strong>.</p>
</li>
<li>
<p>In the <strong>Name</strong> field, enter a name for the new compute resource.</p>
</li>
<li>
<p>From the <strong>Provider</strong> list, select <strong>RHEL OpenStack Platform</strong>.</p>
</li>
<li>
<p>In the <strong>Description</strong> field, enter a description for the compute resource.</p>
</li>
<li>
<p>In the <strong>URL</strong> field, enter the URL for the OpenStack Authentication keystone service&#8217;s API at the <code>tokens</code> resource.
Use the following format: <code>http://openstack.example.com:5000/v3.0/tokens</code>.</p>
</li>
<li>
<p>In the <strong>User</strong> and <strong>Password</strong> fields, enter the authentication user and password for Foreman to access the environment.</p>
</li>
<li>
<p>In the <strong>Domain</strong> field, enter the domain for V3 authentication.</p>
</li>
<li>
<p>From the <strong>Tenant</strong> list, select the tenant or project for Foreman&#160;server to manage.</p>
</li>
<li>
<p>To use external networks as primary networks for hosts, select the <strong>Allow external network as main network</strong> check box.</p>
</li>
<li>
<p>Click the <strong>Locations</strong> and <strong>Organizations</strong> tabs and verify that the location and organization that you want to use are set to your current context.
Add any additional contexts that you want to these tabs.</p>
</li>
<li>
<p>Click <strong>Submit</strong> to save the OpenStack connection.</p>
</li>
</ol>
</div>
<div id="cli-adding-openstack-connection_openstack-provisioning" class="ulist">
<div class="title">CLI procedure</div>
<ul>
<li>
<p>To create a compute resource, enter the <code>hammer compute-resource create</code> command:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># hammer compute-resource create --name "<em>My_OpenStack</em>" \
--provider "OpenStack" \
--description "My OpenStack environment at <em>openstack.example.com</em>" \
--url "<em>http://openstack.example.com</em>:5000/v3.0/tokens" --user "<em>My_Username</em>" \
--password "<em>My_Password</em>" --tenant "openstack" --locations "New York" \
--organizations "<em>My_Organization</em>"</pre>
</div>
</div>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="adding-images-to-server_openstack-provisioning">13.2. Adding OpenStack Images to Foreman&#160;server</h3>
<div class="paragraph">
<p>To create hosts using image-based provisioning, you must add information about the image, such as access details and the image location, to your Foreman&#160;server.</p>
</div>
<div class="paragraph">
<p>To use the CLI instead of the web UI, see the <a href="#cli-adding-images-to-server_openstack-provisioning">CLI procedure</a>.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>In the Foreman web UI, navigate to <strong>Infrastructure</strong> &gt; <strong>Compute Resources</strong> and click the name of the OpenStack connection.</p>
</li>
<li>
<p>Click <strong>Create Image</strong>.</p>
</li>
<li>
<p>In the <strong>Name</strong> field, enter a name for the image.</p>
</li>
<li>
<p>From the <strong>Operating System</strong> list, select the image&#8217;s base operating system.</p>
</li>
<li>
<p>From the <strong>Architecture</strong> list, select the operating system architecture.</p>
</li>
<li>
<p>In the <strong>Username</strong> field, enter the SSH user name for image access.
This is normally the <code>root</code> user.</p>
</li>
<li>
<p>In the <strong>Password</strong> field, enter the SSH password for image access.</p>
</li>
<li>
<p>From the <strong>Image</strong> list, select an image from the OpenStack compute resource.</p>
</li>
<li>
<p>Optional: Select the <strong>User Data</strong> check box if the image supports user data input, such as <code>cloud-init</code> data.</p>
</li>
<li>
<p>Click <strong>Submit</strong> to save the image details.</p>
</li>
</ol>
</div>
<div id="cli-adding-images-to-server_openstack-provisioning" class="ulist">
<div class="title">CLI procedure</div>
<ul>
<li>
<p>Create the image with the <code>hammer compute-resource image create</code> command.
Use the <code>--uuid</code> field to store the full path of the image location on the OpenStack server.</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># hammer compute-resource image create \
--name "OpenStack Image" \
--compute-resource "<em>My_OpenStack_Platform</em>"
--operatingsystem "RedHat <em>version</em>" \
--architecture "x86_64" \
--username root \
--user-data true \
--uuid "<em>/path/to/OpenstackImage.qcow2</em>"</pre>
</div>
</div>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="adding-openstack-details-to-a-compute-profile_openstack-provisioning">13.3. Adding OpenStack Details to a Compute Profile</h3>
<div class="paragraph">
<p>Use this procedure to add OpenStack hardware settings to a compute profile.
When you create a host on OpenStack using this compute profile, these settings are automatically populated.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>In the Foreman web UI, navigate to <strong>Infrastructure</strong> &gt; <strong>Compute Profiles</strong>.</p>
</li>
<li>
<p>In the Compute Profiles window, click the name of an existing compute profile, or click <strong>Create Compute Profile</strong>, enter a <strong>Name</strong>, and click <strong>Submit</strong>.</p>
</li>
<li>
<p>Click the name of the OpenStack compute resource.</p>
</li>
<li>
<p>From the <strong>Flavor</strong> list, select the hardware profile on OpenStack to use for the host.</p>
</li>
<li>
<p>From the <strong>Availability zone</strong> list, select the target cluster to use within the OpenStack environment.</p>
</li>
<li>
<p>From the <strong>Image</strong> list, select the image to use for image-based provisioning.</p>
</li>
<li>
<p>From the <strong>Tenant</strong> list, select the tenant or project for the OpenStack instance.</p>
</li>
<li>
<p>From the <strong>Security Group</strong> list, select the cloud-based access rules for ports and IP addresses.</p>
</li>
<li>
<p>From the <strong>Internal network</strong>, select the private networks for the host to join.</p>
</li>
<li>
<p>From the <strong>Floating IP network</strong>, select the external networks for the host to join and assign a floating IP address.</p>
</li>
<li>
<p>From the <strong>Boot from volume</strong>, select whether a volume is created from the image.
If not selected, the instance boots the image directly.</p>
</li>
<li>
<p>In the <strong>New boot volume size (GB)</strong> field, enter the size, in GB, of the new boot volume.</p>
</li>
<li>
<p>Click <strong>Submit</strong> to save the compute profile.</p>
</li>
</ol>
</div>
<div class="paragraph">
<div class="title">CLI procedure</div>
<p>The compute profile CLI commands are not yet implemented in Foreman 6.10.
As an alternative, you can include the same settings directly during the host creation process.</p>
</div>
</div>
<div class="sect2">
<h3 id="creating-image-only-hosts_openstack-provisioning">13.4. Creating Image-based Hosts on OpenStack</h3>
<div class="paragraph">
<p>In Foreman, you can use OpenStack provisioning to create hosts from an existing image.
The new host entry triggers the OpenStack server to create the instance using the pre-existing image as a basis for the new volume.</p>
</div>
<div class="paragraph">
<p>To use the CLI instead of the web UI, see the <a href="#cli-creating-image-only-hosts_openstack-provisioning">CLI procedure</a>.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>In the Foreman web UI, navigate to <strong>Hosts</strong> &gt; <strong>Create Host</strong>.</p>
</li>
<li>
<p>In the <strong>Name</strong> field, enter a name for the host.</p>
</li>
<li>
<p>Click the <strong>Organization</strong> and <strong>Location</strong> tabs to ensure that the provisioning context is automatically set to the current context.</p>
</li>
<li>
<p>From the <strong>Host Group</strong> list, select the host group that you want to use to populate the form.</p>
</li>
<li>
<p>From the <strong>Deploy on</strong> list, select the OpenStack connection.</p>
</li>
<li>
<p>From the <strong>Compute Profile</strong> list, select a profile to use to automatically populate virtual machine settings.</p>
</li>
<li>
<p>From the <strong>Lifecycle Environment</strong> list, select the environment.</p>
</li>
<li>
<p>Click the <strong>Interfaces</strong> tab and click <strong>Edit</strong> on the host&#8217;s interface.</p>
</li>
<li>
<p>Verify that the fields are automatically populated, particularly the following items:</p>
<div class="ulist">
<ul>
<li>
<p>The <strong>Name</strong> from the <strong>Host</strong> tab becomes the <strong>DNS name</strong>.</p>
</li>
<li>
<p>The <strong>MAC address</strong> field is blank.
OpenStack assigns a MAC address to the host during provisioning.</p>
</li>
<li>
<p>Foreman&#160;server automatically assigns an IP address for the new host.</p>
</li>
<li>
<p>The <strong>Managed</strong>, <strong>Primary</strong>, and <strong>Provision</strong> options are automatically selected for the first interface on the host.
If not, select them.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Click the <strong>Operating System</strong> tab, and confirm that all fields automatically contain values.</p>
</li>
<li>
<p>If you want to change the image that populates automatically from your compute profile, from the <strong>Images</strong> list, select a different image to base the new host&#8217;s root volume on.</p>
</li>
<li>
<p>Click <strong>Resolve</strong> in <strong>Provisioning templates</strong> to check the new host can identify the right provisioning templates to use.</p>
</li>
<li>
<p>Click the <strong>Virtual Machine</strong> tab and confirm that these settings are populated with details from the host group and compute profile.
Modify these settings to suit your needs.</p>
</li>
<li>
<p>If you use the Katello plugin, click the <strong>Parameters</strong> tab, and ensure that a parameter exists that provides an activation key.
If not, add an activation key.</p>
</li>
<li>
<p>Click <strong>Submit</strong> to save the host entry.</p>
</li>
</ol>
</div>
<div id="cli-creating-image-only-hosts_openstack-provisioning" class="ulist">
<div class="title">CLI procedure</div>
<ul>
<li>
<p>Create the host with the <code>hammer host create</code> command and include <code>--provision-method image</code>.
Replace the values in the following example with the appropriate values for your environment.</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># hammer host create \
--name "openstack-host1" \
--organization "<em>My_Organization</em>" \
--location "New York" \
--hostgroup "<em>Base</em>" \
--compute-resource "<em>My_OpenStack_Platform</em>" \
--provision-method image \
--image "<em>OpenStack Image</em>" \
--enabled true \
--managed true \
--interface "managed=true,primary=true,provision=true" \
--compute-attributes="flavor_ref=m1.small,tenant_id=openstack,security_groups=default,network=mynetwork"</pre>
</div>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>For more information about additional host creation parameters for this compute resource, enter the <code>hammer host create --help</code> command.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="Provisioning_Cloud_Instances_in_Amazon_EC2">14. Provisioning Cloud Instances in Amazon EC2</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Amazon Elastic Compute Cloud (Amazon EC2) is a web service that provides public cloud compute resources.
Using Foreman, you can interact with Amazon EC2&#8217;s public API to create cloud instances and control their power management states.
Use the procedures in this chapter to add a connection to an Amazon EC2 account and provision a cloud instance.</p>
</div>
<div class="sect2">
<h3 id="Provisioning_Cloud_Instances_in_Amazon_EC2-Prerequisites_for_Amazon_EC2_Provisioning">14.1. Prerequisites for Amazon EC2 Provisioning</h3>
<div class="paragraph">
<p>The requirements for Amazon EC2 provisioning include:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A Smart&#160;Proxy&#160;server managing a network in your EC2 environment.
Use a Virtual Private Cloud (VPC) to ensure a secure network between the hosts and Smart&#160;Proxy&#160;server.</p>
</li>
<li>
<p>An Amazon Machine Image (AMI) for image-based provisioning.</p>
</li>
<li>
<p>The installation media for the operating systems that you want to use to provision hosts.
If the Katello plug-in is installed, you can use synchronized content repositories for Red&#160;Hat Enterprise Linux.
For more information, see <a href="https://docs.theforeman.org/2.5/Content_Management_Guide/index-foreman-el.html#Importing_Content-Synchronizing_Repositories">Syncing Repositories</a> in the <em>Content Management Guide</em>.</p>
</li>
<li>
<p>If the Katello plug-in is installed, an activation key for host registration.
For more information, see <a href="https://docs.theforeman.org/2.5/Content_Management_Guide/index-foreman-el.html#Managing_Activation_Keys-Creating_an_Activation_Key">Creating An Activation Key</a> in the <em>Content Management</em> guide.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="Provisioning_Cloud_Instances_in_Amazon_EC2-Adding_a_Amazon_EC2_Connection_to_the_Satellite_Server">14.2. Adding an Amazon EC2 Connection to the Foreman&#160;server</h3>
<div class="paragraph">
<p>Use this procedure to add the Amazon EC2 connection in Foreman&#160;server&#8217;s compute resources.
To use the CLI instead of the web UI, see the <a href="#cli-adding-amazon-ec2-connection_provisioning">CLI procedure</a>.</p>
</div>
<div class="paragraph">
<div class="title">Time Settings and Amazon Web Services</div>
<p>Amazon Web Services uses time settings as part of the authentication process.
Ensure that Foreman&#160;server&#8217;s time is correctly synchronized.
Ensure that an NTP service, such as <code>ntpd</code> or <code>chronyd</code>, is running properly on Foreman&#160;server.
Failure to provide the correct time to Amazon Web Services can lead to authentication failures.</p>
</div>
<div class="paragraph">
<p>For more information about synchronizing time in Foreman, see <a href="https://docs.theforeman.org/2.5/Installing_Server_on_Red_Hat/index-foreman-el.html#synchronizing-the-system-clock-with-chronyd_foreman">Synchronizing Time</a> in <em>Installing Foreman 2.5 server on Enterprise Linux</em>.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>In the Foreman web UI, navigate to <strong>Infrastructure</strong> &gt; <strong>Compute Resources</strong> and in the Compute Resources window, click <strong>Create Compute Resource</strong>.</p>
</li>
<li>
<p>In the <strong>Name</strong> field, enter a name to identify the Amazon EC2 compute resource.</p>
</li>
<li>
<p>From the <strong>Provider</strong> list, select <strong>EC2</strong>.</p>
</li>
<li>
<p>In the <strong>Description</strong> field, enter information that helps distinguish the resource for future use.</p>
</li>
<li>
<p>Optional: From the <strong>HTTP proxy</strong> list, select an HTTP proxy to connect to external API services.
You must add HTTP proxies to Foreman before you can select a proxy from this list.
For more information, see <a href="#Provisioning_Cloud_Instances_in_Amazon_EC2-Using-an-HTTP-Smart-Proxy">Using an HTTP Proxy with Compute Resources</a>.</p>
</li>
<li>
<p>In the <strong>Access Key</strong> and <strong>Secret Key</strong> fields, enter the access keys for your Amazon EC2 account.
For more information, see <a href="http://docs.aws.amazon.com/general/latest/gr/managing-aws-access-keys.html">Managing Access Keys for your AWS Account</a> on the Amazon documentation website.</p>
</li>
<li>
<p>Optional: Click the <strong>Load Regions</strong> button to populate the <strong>Regions</strong> list.</p>
</li>
<li>
<p>From the <strong>Region</strong> list, select the Amazon EC2 region or data center to use.</p>
</li>
<li>
<p>Click the <strong>Locations</strong> tab and ensure that the location you want to use is selected, or add a different location.</p>
</li>
<li>
<p>Click the <strong>Organizations</strong> tab and ensure that the organization you want to use is selected, or add a different organization.</p>
</li>
<li>
<p>Click <strong>Submit</strong> to save the Amazon EC2 connection.</p>
</li>
<li>
<p>Select the new compute resource and then click the <strong>SSH keys</strong> tab, and click <strong>Download</strong> to save a copy of the SSH keys to use for SSH authentication.
Until <a href="https://bugzilla.redhat.com/show_bug.cgi?id=1793138">BZ1793138</a> is resolved, you can download a copy of the SSH keys only immediately after creating the Amazon EC2 compute resource.
If you require SSH keys at a later stage, follow the procedure in <a href="#connecting_to_an_Amazon_EC2_instance_using_SSH">Connecting to an Amazon EC2 instance using SSH</a>.</p>
</li>
</ol>
</div>
<div id="cli-adding-amazon-ec2-connection_provisioning" class="ulist">
<div class="title">CLI procedure</div>
<ul>
<li>
<p>Create the connection with the <code>hammer compute-resource create</code> command.
Use <code>--user</code> and <code>--password</code> options to add the access key and secret key respectively.</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># hammer compute-resource create --name "<em>My_EC2</em>" --provider "EC2" \
--description "Amazon EC2 Public Cloud` --user "<em>user_name</em>" \
--password "<em>secret_key</em>" --region "us-east-1" --locations "New York" \
--organizations "<em>My_Organization</em>"</pre>
</div>
</div>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="Provisioning_Cloud_Instances_in_Amazon_EC2-Using-an-HTTP-Smart-Proxy">14.3. Using an HTTP Proxy with Compute Resources</h3>
<div class="paragraph">
<p>In some cases, the EC2 compute resource that you use might require a specific HTTP proxy to communicate with Foreman.
In Foreman, you can create an HTTP proxy and then assign the HTTP proxy to your EC2 compute resource.</p>
</div>
<div class="paragraph">
<p>However, if you configure an HTTP proxy for Foreman in <strong>Administer</strong> &gt; <strong>Settings</strong>, and then add another HTTP proxy for your compute resource, the HTTP proxy that you define in <strong>Administer</strong> &gt; <strong>Settings</strong> takes precedence.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>In the Foreman web UI, navigate to <strong>Infrastructure</strong> &gt; <strong>HTTP Proxies</strong>, and select <strong>New HTTP Proxy</strong>.</p>
</li>
<li>
<p>In the <strong>Name</strong> field, enter a name for the HTTP proxy.</p>
</li>
<li>
<p>In the <strong>URL</strong> field, enter the URL for the HTTP proxy, including the port number.</p>
</li>
<li>
<p>Optional: Enter a username and password to authenticate to the HTTP proxy, if your HTTP proxy requires authentication.</p>
</li>
<li>
<p>Click <strong>Test Connection</strong> to ensure that you can connect to the HTTP proxy from Foreman.</p>
</li>
<li>
<p>Click the <strong>Locations</strong> tab and add a location.</p>
</li>
<li>
<p>Click the <strong>Organization</strong> tab and add an organization.</p>
</li>
<li>
<p>Click <strong>Submit</strong>.</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="Provisioning_Cloud_Instances_in_Amazon_EC2-Adding_Amazon_EC2_Images_on_the_Satellite_Server">14.4. Adding Amazon EC2 Images to Foreman&#160;server</h3>
<div class="paragraph">
<p>Amazon EC2 uses image-based provisioning to create hosts.
You must add image details to your Foreman&#160;server.
This includes access details and image location.</p>
</div>
<div class="paragraph">
<p>To use the CLI instead of the web UI, see the <a href="#cli-adding-amazon-ec2-images_provisioning">CLI procedure</a>.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>In the Foreman web UI, navigate to <strong>Infrastructure</strong> &gt; <strong>Compute Resources</strong> and select an Amazon EC2 connection.</p>
</li>
<li>
<p>Click the <strong>Images</strong> tab, and then click <strong>New Image</strong>.</p>
</li>
<li>
<p>In the <strong>Name</strong> field, enter a name to identify the image for future use.</p>
</li>
<li>
<p>From the <strong>Operating System</strong> list, select the operating system that corresponds with the image you want to add.</p>
</li>
<li>
<p>From the <strong>Architecture</strong> list, select the operating system&#8217;s architecture.</p>
</li>
<li>
<p>In the <strong>Username</strong> field, enter the SSH user name for image access.
This is normally the <code>root</code> user.</p>
</li>
<li>
<p>In the <strong>Password</strong> field, enter the SSH password for image access.</p>
</li>
<li>
<p>In the <strong>Image ID</strong> field, enter the Amazon Machine Image (AMI) ID for the image.
This is usually in the following format: <code>ami-xxxxxxxx</code>.</p>
</li>
<li>
<p>Optional: Select the <strong>User Data</strong> check box if the images support user data input, such as <code>cloud-init</code> data.
If you enable user data, the Finish scripts are automatically disabled.
This also applies in reverse: if you enable the Finish scripts, this disables user data.</p>
</li>
<li>
<p>Optional: In the <strong>IAM role</strong> field, enter the Amazon security role used for creating the image.</p>
</li>
<li>
<p>Click <strong>Submit</strong> to save the image details.</p>
</li>
</ol>
</div>
<div id="cli-adding-amazon-ec2-images_provisioning" class="ulist">
<div class="title">CLI procedure</div>
<ul>
<li>
<p>Create the image with the <code>hammer compute-resource image create</code> command.
Use the <code>--uuid</code> field to store the full path of the image location on the Amazon EC2 server.</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># hammer compute-resource image create --name "Test Amazon EC2 Image" \
--operatingsystem "RedHat 7.2" --architecture "x86_64" --username root \
--user-data true --uuid "ami-<em>my_ami_id</em>" --compute-resource "<em>My_EC2</em>"</pre>
</div>
</div>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="Provisioning_Cloud_Instances_in_Amazon_EC2-Adding_Amazon_EC2_Details_to_a_Compute_Profile">14.5. Adding Amazon EC2 Details to a Compute Profile</h3>
<div class="paragraph">
<p>You can add hardware settings for instances on Amazon EC2 to a compute profile.</p>
</div>
<div class="paragraph">
<div class="title">Procedure</div>
<p>To add hardware settings, complete the following steps:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>In the Foreman web UI, navigate to <strong>Infrastructure</strong> &gt; <strong>Compute Profiles</strong> and click the name of your profile, then click an EC2 connection.</p>
</li>
<li>
<p>From the <strong>Flavor</strong> list, select the hardware profile on EC2 to use for the host.</p>
</li>
<li>
<p>From the <strong>Image</strong> list, select the image to use for image-based provisioning.</p>
</li>
<li>
<p>From the <strong>Availability zone</strong> list, select the target cluster to use within the chosen EC2 region.</p>
</li>
<li>
<p>From the <strong>Subnet</strong> list, add the subnet for the EC2 instance.
If you have a VPC for provisioning new hosts, use its subnet.</p>
</li>
<li>
<p>From the <strong>Security Groups</strong> list, select the cloud-based access rules for ports and IP addresses to apply to the host.</p>
</li>
<li>
<p>From the <strong>Managed IP</strong> list, select either a <code>Public</code> IP or a <code>Private</code> IP.</p>
</li>
<li>
<p>Click <strong>Submit</strong> to save the compute profile.</p>
</li>
</ol>
</div>
<div class="paragraph">
<div class="title">CLI procedure</div>
<p>The compute profile CLI commands are not yet implemented in Foreman.
As an alternative, you can include the same settings directly during the host creation process.</p>
</div>
</div>
<div class="sect2">
<h3 id="Provisioning_Cloud_Instances_in_Amazon_EC2-Creating_Image_Based_Hosts_on_Amazon_EC2">14.6. Creating Image-Based Hosts on Amazon EC2</h3>
<div class="paragraph">
<p>The Amazon EC2 provisioning process creates hosts from existing images on the Amazon EC2 server.
To use the CLI instead of the web UI, see the <a href="#cli-creating-hosts-on-amazon-ec2_provisioning">CLI procedure</a>.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>In the Foreman web UI, navigate to <strong>Hosts</strong> &gt; <strong>Create Host</strong>.</p>
</li>
<li>
<p>In the <strong>Name</strong> field, enter a name for the host.</p>
</li>
<li>
<p>From the <strong>Host Group</strong> list, you can select a host group to populate most of the new host&#8217;s fields.</p>
</li>
<li>
<p>From the <strong>Deploy on</strong> list, select the EC2 connection.</p>
</li>
<li>
<p>From the <strong>Compute Profile</strong> list, select a profile to use to automatically populate virtual machine-based settings.</p>
</li>
<li>
<p>Click the <strong>Interface</strong> tab, and then click <strong>Edit</strong> on the host&#8217;s interface, and verify that the fields are populated with values.
Leave the <strong>Mac Address</strong> field blank.
Foreman&#160;server automatically selects and IP address and the <strong>Managed</strong>, <strong>Primary</strong>, and <strong>Provision</strong> options for the first interface on the host.</p>
</li>
<li>
<p>Click the <strong>Operating System</strong> tab and confirm that all fields are populated with values.</p>
</li>
<li>
<p>Click the <strong>Virtual Machine</strong> tab and confirm that all fields are populated with values.</p>
</li>
<li>
<p>If you use the Katello plugin, click the <strong>Parameters</strong> tab, and ensure that a parameter exists that provides an activation key.
If not, add an activation key.</p>
</li>
<li>
<p>Click <strong>Submit</strong> to save your changes.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>This new host entry triggers the Amazon EC2 server to create the instance, using the pre-existing image as a basis for the new volume.</p>
</div>
<div id="cli-creating-hosts-on-amazon-ec2_provisioning" class="ulist">
<div class="title">CLI procedure</div>
<ul>
<li>
<p>Create the host with the <code>hammer host create</code> command and include <code>--provision-method image</code> to use image-based provisioning.</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># hammer host create --name "ec2-test1" --organization "<em>My_Organization</em>" \
--location "New York" --hostgroup "Base" \
--compute-resource "<em>My_EC2</em>" --provision-method image \
--image "Test Amazon EC2 Image" --enabled true --managed true \
--interface "managed=true,primary=true,provision=true,subnet_id=EC2" \
--compute-attributes="flavor_id=m1.small,image_id=TestImage,availability_zones=us-east-1a,security_group_ids=Default,managed_ip=Public"</pre>
</div>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>For more information about additional host creation parameters for this compute resource, enter the <code>hammer host create --help</code> command.</p>
</div>
</div>
<div class="sect2">
<h3 id="connecting_to_an_Amazon_EC2_instance_using_SSH">14.7. Connecting to an Amazon EC2 instance using SSH</h3>
<div class="paragraph">
<p>You can connect remotely to an Amazon EC2 instance from Foreman&#160;server using SSH.
However, to connect to any Amazon Web Services EC2 instance that you provision through Foreman, you must first access the private key that is associated with the compute resource in the Foreman database, and use this key for authentication.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>To locate the compute resource list, on your Foreman&#160;server base system, enter the following command, and note the ID of the compute resource that you want to use:</p>
<div class="listingblock">
<div class="content">
<pre># hammer compute-resource list</pre>
</div>
</div>
</li>
<li>
<p>Switch user to the <code>postgres</code> user:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># su - postgres</pre>
</div>
</div>
</li>
<li>
<p>Initiate the <code>postgres</code> shell:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ psql</pre>
</div>
</div>
</li>
<li>
<p>Connect to the Foreman database as the user <code>postgres</code>:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># postgres=# \c foreman</pre>
</div>
</div>
</li>
<li>
<p>Select the secret from <code>key_pairs</code> where <code>compute_resource_id = 3</code>:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># select secret from key_pairs where compute_resource_id = 3; secret</pre>
</div>
</div>
</li>
<li>
<p>Copy the key from after <code>-----BEGIN RSA PRIVATE KEY-----</code> until <code>-----END RSA PRIVATE KEY-----</code>.</p>
</li>
<li>
<p>Create a <code>.pem</code> file and paste your key into the file:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># vim <em>Keyname</em>.pem</pre>
</div>
</div>
</li>
<li>
<p>Ensure that you restrict access to the <code>.pem</code> file:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># chmod 600 <em>Keyname</em>.pem</pre>
</div>
</div>
</li>
<li>
<p>To connect to the Amazon EC2 instance, enter the following command:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">ssh -i <em>Keyname</em>.pem   ec2-user@<em>example.aws.com</em></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_configuring_a_finish_template_for_an_amazon_web_service_ec2_environment">14.8. Configuring a Finish Template for an Amazon Web Service EC2 Environment</h3>
<div class="paragraph">
<p>You can use Foreman finish templates during the provisioning of Linux instances in an Amazon EC2 environment.</p>
</div>
<div class="paragraph">
<p>If you want to use a Finish template with SSH, Foreman must reside within the EC2 environment and in the correct security group.
Foreman currently performs SSH finish provisioning directly, not using Smart&#160;Proxy&#160;server.
If Foreman&#160;server does not reside within EC2, the EC2 virtual machine reports an internal IP rather than the necessary external IP with which it can be reached.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>In the Foreman web UI, navigate to <strong>Hosts</strong> &gt; <strong>Provisioning Templates</strong>.</p>
</li>
<li>
<p>In the <strong>Provisioning Templates</strong> page, enter <code>Kickstart default finish</code> into the search field and click <strong>Search</strong>.</p>
</li>
<li>
<p>On the <strong>Kickstart default finish</strong> template, select <strong>Clone</strong>.</p>
</li>
<li>
<p>In the <strong>Name</strong> field, enter a unique name for the template.</p>
</li>
<li>
<p>In the template, prefix each command that requires root privileges with <code>sudo</code>, except for <code>yum</code> or equivalent commands, or add the following line to run the entire template as the <code>sudo</code> user:</p>
<div class="listingblock">
<div class="content">
<pre>sudo -s &lt;&lt; EOS
_Template_ _Body_
EOS</pre>
</div>
</div>
</li>
<li>
<p>Click the <strong>Association</strong> tab, and associate the template with a Red&#160;Hat Enterprise Linux operating system that you want to use.</p>
</li>
<li>
<p>Click the <strong>Locations</strong> tab, and add the the location where the host resides.</p>
</li>
<li>
<p>Click the <strong>Organizations</strong> tab, and add the organization that the host belongs to.</p>
</li>
<li>
<p>Make any additional customizations or changes that you require, then click <strong>Submit</strong> to save your template.</p>
</li>
<li>
<p>Navigate to <strong>Hosts</strong> &gt; <strong>Operating systems</strong> and select the operating system that you want for your host.</p>
</li>
<li>
<p>Click the <strong>Templates</strong> tab, and from the <strong>Finish Template</strong> list, select your finish template.</p>
</li>
<li>
<p>Navigate to <strong>Hosts</strong> &gt; <strong>Create Host</strong> and enter the information about the host that you want to create.</p>
</li>
<li>
<p>Click the <strong>Parameters</strong> tab and navigate to <strong>Host parameters</strong>.</p>
</li>
<li>
<p>If you have the Remote Execution plugin installed, in <strong>Host parameters</strong>, click the <strong>Add Parameter</strong> button two times to add two new parameter fields.
If you use the Katello plugin, add a third parameter field.
Add the following parameters:</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>In the <strong>Name</strong> field, enter <code>remote_execution_ssh_keys</code>.
In the corresponding <strong>Value</strong> field, enter the output of <code>cat /usr/share/foreman-proxy/.ssh/id_rsa_foreman_proxy.pub</code>.</p>
</li>
<li>
<p>In the <strong>Name</strong> field, enter <code>remote_execution_ssh_user</code>.
In the corresponding <strong>Value</strong> field, enter <code>ec2-user</code>.</p>
</li>
<li>
<p>If you use the Katello plugin, in the <strong>Name</strong> field, enter <code>activation_keys</code>.
In the corresponding <strong>Value</strong> field, enter your activation key.</p>
</li>
</ol>
</div>
</li>
<li>
<p>Click <strong>Submit</strong> to save the changes.</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_more_information_about_amazon_web_services_and_foreman">14.9. More Information about Amazon Web Services and Foreman</h3>
<div class="paragraph">
<p>For information about how to locate Red&#160;Hat Gold Images on Amazon Web Services EC2, see <a href="https://access.redhat.com/articles/2962171">How to Locate Red&#160;Hat Cloud Access Gold Images on AWS EC2</a>.</p>
</div>
<div class="paragraph">
<p>For information about how to install and use the Amazon Web Service Client on Linux, see <a href="https://docs.aws.amazon.com/cli/latest/userguide/awscli-install-linux.html">Install the AWS Command Line Interface on Linux</a> in the Amazon Web Services documentation.</p>
</div>
<div class="paragraph">
<p>For information about importing and exporting virtual machines in Amazon Web Services, see <a href="https://aws.amazon.com/ec2/vm-import/">VM Import/Export</a> in the Amazon Web Services documentation.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="provisioning-cloud-instances-gce_provisioning">15. Provisioning Cloud Instances on Google Compute Engine</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Foreman can interact with Google Compute Engine (GCE), including creating new virtual machines and controlling their power management states.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>The installation media for the operating systems that you want to use to provision hosts.
If the Katello plug-in is installed, you can use synchronized content repositories for Red&#160;Hat Enterprise Linux.
For more information, see <a href="https://docs.theforeman.org/2.5/Content_Management_Guide/index-foreman-el.html#Importing_Content-Synchronizing_Repositories">Syncing Repositories</a> in the <em>Content Management Guide</em>.</p>
</li>
<li>
<p>If the Katello plug-in is installed, an activation key for host registration.
For more information, see <a href="https://docs.theforeman.org/2.5/Content_Management_Guide/index-foreman-el.html#Managing_Activation_Keys-Creating_an_Activation_Key">Creating An Activation Key</a> in the <em>Content Management</em> guide.</p>
</li>
<li>
<p>In your GCE project, configure a service account with the necessary IAM Compute role.
For more information, see <a href="https://cloud.google.com/compute/docs/access/iam">Compute Engine IAM roles</a> in the GCE documentation.</p>
</li>
<li>
<p>In your GCE project-wise metadata, set the <code>enable-oslogin</code> to <code>FALSE</code>.
For more information, see <a href="https://cloud.google.com/compute/docs/instances/managing-instance-access#enable_oslogin">Enabling or disabling OS Login</a> in the GCE documentation.</p>
</li>
<li>
<p>Optional: If you want to use Puppet with GCE hosts, navigate to <strong>Administer</strong> &gt; <strong>Settings</strong> &gt; <strong>Puppet</strong> and enable the <code>Use UUID for certificates</code> setting to configure Puppet to use consistent Puppet certificate IDs.</p>
</li>
<li>
<p>Based on your needs, associate a <code>finish</code> or <code>user_data</code> provisioning template with the operating system you want to use. For more information about provisioning templates, see <a href="https://docs.theforeman.org/2.5/Provisioning_Guide/index-foreman-el.html#provisioning-templates_provisioning">Provisioning Templates</a>.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure Overview</div>
<ol class="arabic">
<li>
<p><a href="#adding-gce-connection_gce-provisioning">Adding a Google Compute Engine Connection to Foreman&#160;server</a>.</p>
</li>
<li>
<p><a href="#adding-images-to-server_gce-provisioning">Adding Google Compute Engine Images to Foreman&#160;server</a>.</p>
</li>
<li>
<p><a href="#adding-gce-details-to-a-compute-profile_gce-provisioning">Adding Google Compute Engine Details to a Compute Profile</a>.</p>
</li>
<li>
<p><a href="#creating-image-only-hosts_gce-provisioning">Creating Image-based Hosts on Google Compute Engine</a>.</p>
</li>
</ol>
</div>
<div class="sect2">
<h3 id="adding-gce-connection_gce-provisioning">15.1. Adding a Google Compute Engine Connection to Foreman&#160;server</h3>
<div class="paragraph">
<p>Use this procedure to add Google Compute Engine (GCE) as a compute resource in Foreman.
To use the CLI instead of the web UI, see the <a href="#cli-adding-gce-connection_gce-provisioning">CLI procedure</a>.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>In GCE, generate a service account key in JSON format and upload this file to the <code>/usr/share/foreman/</code> directory on Foreman&#160;server.</p>
</li>
<li>
<p>On Foreman&#160;server, change the owner for the service account key to the <code>foreman</code> user:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># chown foreman /usr/share/foreman/<em>gce_key</em>.json</pre>
</div>
</div>
</li>
<li>
<p>Configure permissions for the service account key to ensure that the file is readable:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># chmod 0600 /usr/share/foreman/<em>gce_key</em>.json</pre>
</div>
</div>
</li>
<li>
<p>Restore SELinux context for the service account key:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># restorecon -vv /usr/share/foreman/<em>gce_key</em>.json</pre>
</div>
</div>
</li>
<li>
<p>In the Foreman web UI, navigate to <strong>Infrastructure</strong> &gt; <strong>Compute Resources</strong> and click <strong>Create Compute Resource</strong>.</p>
</li>
<li>
<p>In the <strong>Name</strong> field, enter a name for the compute resource.</p>
</li>
<li>
<p>From the <strong>Provider</strong> list, select <strong>Google</strong>.</p>
</li>
<li>
<p>Optional: In the <strong>Description</strong> field, enter a description for the resource.</p>
</li>
<li>
<p>In the <strong>Google Project ID</strong> field, enter the project ID.</p>
</li>
<li>
<p>In the <strong>Client Email</strong> field, enter the client email.</p>
</li>
<li>
<p>In the <strong>Certificate Path</strong> field, enter the path to the service account key.
For example, <code>/usr/share/foreman/<em>gce_key</em>.json</code>.</p>
</li>
<li>
<p>Click <strong>Load Zones</strong> to populate the list of zones from your GCE environment.</p>
</li>
<li>
<p>From the <strong>Zone</strong> list, select the GCE zone to use.</p>
</li>
<li>
<p>Click <strong>Submit</strong>.</p>
</li>
</ol>
</div>
<div id="cli-adding-gce-connection_gce-provisioning" class="olist arabic">
<div class="title">CLI procedure</div>
<ol class="arabic">
<li>
<p>In GCE, generate a service account key in JSON format and upload this file to the <code>/usr/share/foreman/</code> directory on Foreman&#160;server.</p>
</li>
<li>
<p>On Foreman&#160;server, change the owner for the service account key to the <code>foreman</code> user:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># chown foreman /usr/share/foreman/<em>gce_key</em>.json</pre>
</div>
</div>
</li>
<li>
<p>Configure permissions for the service account key to ensure that the file is readable:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># chmod 0600 /usr/share/foreman/<em>gce_key</em>.json</pre>
</div>
</div>
</li>
<li>
<p>Restore SELinux context for the service account key:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># restorecon -vv /usr/share/foreman/<em>gce_key</em>.json</pre>
</div>
</div>
</li>
<li>
<p>Use the <code>hammer compute-resource create</code> command to add a GCE compute resource to Foreman:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># hammer compute-resource create --name '<em>gce_cr</em>' \
--provider 'gce' \
--project '<em>gce_project_id</em>' \
--key-path '<em>gce_key</em>.json' \
--zone '<em>us-west1-b</em>' \
--email '<em>gce_email</em>'</pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="adding-images-to-server_gce-provisioning">15.2. Adding Google Compute Engine Images to Foreman&#160;server</h3>
<div class="paragraph">
<p>To create hosts using image-based provisioning, you must add information about the image, such as access details and the image location, to your Foreman&#160;server.</p>
</div>
<div class="paragraph">
<p>To use the CLI instead of the web UI, see the <a href="#cli-adding-images-to-server_gce-provisioning">CLI procedure</a>.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>In the Foreman web UI, navigate to <strong>Infrastructure</strong> &gt; <strong>Compute Resources</strong> and click the name of the Google Compute Engine connection.</p>
</li>
<li>
<p>Click <strong>Create Image</strong>.</p>
</li>
<li>
<p>In the <strong>Name</strong> field, enter a name for the image.</p>
</li>
<li>
<p>From the <strong>Operating System</strong> list, select the image&#8217;s base operating system.</p>
</li>
<li>
<p>From the <strong>Architecture</strong> list, select the operating system architecture.</p>
</li>
<li>
<p>In the <strong>Username</strong> field, enter the SSH user name for image access.
Specify a user other than <code>root</code>, because the <code>root</code> user cannot connect to a GCE instance using SSH keys. The username must begin with a letter and consist of lowercase letters and numbers.</p>
</li>
<li>
<p>From the <strong>Image</strong> list, select an image from the Google Compute Engine compute resource.</p>
</li>
<li>
<p>Optional: Select the <strong>User Data</strong> check box if the image supports user data input, such as <code>cloud-init</code> data.</p>
</li>
<li>
<p>Click <strong>Submit</strong> to save the image details.</p>
</li>
</ol>
</div>
<div id="cli-adding-images-to-server_gce-provisioning" class="ulist">
<div class="title">CLI procedure</div>
<ul>
<li>
<p>Create the image with the <code>hammer compute-resource image create</code> command.
With the <code>--username</code> option, specify a user other than <code>root</code>, because the <code>root</code> user cannot connect to a GCE instance using SSH keys.
The username must begin with a letter and consist of lowercase letters and numbers.</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># hammer compute-resource image create \
--name '<em>gce_image_name</em>' \
--compute-resource '<em>gce_cr</em>' \
--operatingsystem-id 1 \
--architecture-id 1 \
--uuid '<em>3780108136525169178</em>' \
--username '<em>admin</em>'</pre>
</div>
</div>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="adding-gce-details-to-a-compute-profile_gce-provisioning">15.3. Adding Google Compute Engine Details to a Compute Profile</h3>
<div class="paragraph">
<p>Use this procedure to add GCE hardware settings to a compute profile.
When you create a host on GCE using this compute profile, these settings are automatically populated.</p>
</div>
<div class="paragraph">
<p>To use the CLI instead of the web UI, see the <a href="#cli-adding-gce-details-to-a-compute-profile_gce-provisioning">CLI procedure</a>.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>In the Foreman web UI, navigate to <strong>Infrastructure</strong> &gt; <strong>Compute Profiles</strong>.</p>
</li>
<li>
<p>In the Compute Profiles window, click the name of an existing compute profile, or click <strong>Create Compute Profile</strong>, enter a <strong>Name</strong>, and click <strong>Submit</strong>.</p>
</li>
<li>
<p>Click the name of the GCE compute resource.</p>
</li>
<li>
<p>From the <strong>Machine Type</strong> list, select the machine type to use for provisioning.</p>
</li>
<li>
<p>From the <strong>Image</strong> list, select the image to use for provisioning.</p>
</li>
<li>
<p>From the <strong>Network</strong> list, select the GCE network to use for provisioning.</p>
</li>
<li>
<p>Optional: Select the <strong>Associate Ephemeral External IP</strong> check box to assign a dynamic ephemeral IP address that Foreman uses to communicate with the host.
This public IP address changes when you reboot the host.
If you need a permanent IP address, reserve a static public IP address on GCE and attach it to the host.</p>
</li>
<li>
<p>In the <strong>Size (GB)</strong> field, enter the size of the storage to create on the host.</p>
</li>
<li>
<p>Click <strong>Submit</strong> to save the compute profile.</p>
</li>
</ol>
</div>
<div id="cli-adding-gce-details-to-a-compute-profile_gce-provisioning" class="olist arabic">
<div class="title">CLI procedure</div>
<ol class="arabic">
<li>
<p>Create a compute profile to use with the GCE compute resource:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># hammer compute-profile create --name <em>gce_profile</em></pre>
</div>
</div>
</li>
<li>
<p>Add GCE details to the compute profile.</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># hammer compute-profile values create --compute-profile <em>gce_profile</em> \
--compute-resource '<em>gce_cr</em>' \
--volume "<em>size_gb=20</em>" \
--compute-attributes "machine_type=f1-micro,associate_external_ip=true,network=default"</pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="creating-image-only-hosts_gce-provisioning">15.4. Creating Image-based Hosts on Google Compute Engine</h3>
<div class="paragraph">
<p>In Foreman, you can use Google Compute Engine provisioning to create hosts from an existing image.
The new host entry triggers the Google Compute Engine server to create the instance using the pre-existing image as a basis for the new volume.</p>
</div>
<div class="paragraph">
<p>To use the CLI instead of the web UI, see the <a href="#cli-creating-image-only-hosts_gce-provisioning">CLI procedure</a>.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>In the Foreman web UI, navigate to <strong>Hosts</strong> &gt; <strong>Create Host</strong>.</p>
</li>
<li>
<p>In the <strong>Name</strong> field, enter a name for the host.</p>
</li>
<li>
<p>Click the <strong>Organization</strong> and <strong>Location</strong> tabs to ensure that the provisioning context is automatically set to the current context.</p>
</li>
<li>
<p>From the <strong>Host Group</strong> list, select the host group that you want to use to populate the form.</p>
</li>
<li>
<p>From the <strong>Deploy on</strong> list, select the Google Compute Engine connection.</p>
</li>
<li>
<p>From the <strong>Compute Profile</strong> list, select a profile to use to automatically populate virtual machine settings.</p>
</li>
<li>
<p>From the <strong>Lifecycle Environment</strong> list, select the environment.</p>
</li>
<li>
<p>Click the <strong>Interfaces</strong> tab and click <strong>Edit</strong> on the host&#8217;s interface.</p>
</li>
<li>
<p>Verify that the fields are automatically populated, particularly the following items:</p>
<div class="ulist">
<ul>
<li>
<p>The <strong>Name</strong> from the <strong>Host</strong> tab becomes the <strong>DNS name</strong>.</p>
</li>
<li>
<p>The <strong>MAC address</strong> field is blank.
Google Compute Engine assigns a MAC address to the host during provisioning.</p>
</li>
<li>
<p>Foreman&#160;server automatically assigns an IP address for the new host.</p>
</li>
<li>
<p>The <strong>Domain</strong> field is populated with the required domain.</p>
</li>
<li>
<p>The <strong>Managed</strong>, <strong>Primary</strong>, and <strong>Provision</strong> options are automatically selected for the first interface on the host.
If not, select them.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Click the <strong>Operating System</strong> tab, and confirm that all fields automatically contain values.</p>
</li>
<li>
<p>Click <strong>Resolve</strong> in <strong>Provisioning templates</strong> to check the new host can identify the right provisioning templates to use.</p>
</li>
<li>
<p>Click the <strong>Virtual Machine</strong> tab and confirm that these settings are populated with details from the host group and compute profile.
Modify these settings to suit your needs.</p>
</li>
<li>
<p>If you use the Katello plugin, click the <strong>Parameters</strong> tab, and ensure that a parameter exists that provides an activation key.
If not, add an activation key.</p>
</li>
<li>
<p>Click <strong>Submit</strong> to save the host entry.</p>
</li>
</ol>
</div>
<div id="cli-creating-image-only-hosts_gce-provisioning" class="ulist">
<div class="title">CLI procedure</div>
<ul>
<li>
<p>Create the host with the <code>hammer host create</code> command and include <code>--provision-method image</code>.
Replace the values in the following example with the appropriate values for your environment.</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># hammer host create \
--name "<em>GCE_VM</em>" \
--organization "<em>Your_Organization</em>" \
--location "<em>Your_Location</em>" \
--compute-resource <em>gce_cr_name</em>
--compute-profile "<em>gce_profile_name</em>" \
--provision-method 'image' \
--image <em>gce_image_name</em> \
--root-password "<em>your_root_password</em>" \
--interface "type=interface,domain_id=1,managed=true,primary=true,provision=true" \
--puppet-environment-id <em>1</em> \
--puppet-ca-proxy-id <em>1</em> \
--puppet-proxy-id <em>1</em> \
--architecture <em>x86_64</em> \
--operatingsystem "<em>operating_system_name</em>"</pre>
</div>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>For more information about additional host creation parameters for this compute resource, enter the <code>hammer host create --help</code> command.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="provisioning-cloud-instances-azure_provisioning">16. Provisioning Cloud Instances on Microsoft Azure Resource Manager</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Foreman can interact with Microsoft Azure Resource Manager, including creating new virtual machines and controlling their power management states.
Only image-based provisioning is supported for creating Azure hosts.
This includes provisioning using Marketplace images, custom images, and shared image gallery.</p>
</div>
<div class="paragraph">
<p>For more information about Azure Resource Manager concepts, see <a href="https://docs.microsoft.com/en-us/azure/azure-resource-manager/">Azure Resource Manager documentation</a>.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>The installation media for the operating systems that you want to use to provision hosts.
If the Katello plug-in is installed, you can use synchronized content repositories for Red&#160;Hat Enterprise Linux.
For more information, see <a href="https://docs.theforeman.org/2.5/Content_Management_Guide/index-foreman-el.html#Importing_Content-Synchronizing_Repositories">Syncing Repositories</a> in the <em>Content Management Guide</em>.</p>
</li>
<li>
<p>If the Katello plug-in is installed, an activation key for host registration.
For more information, see <a href="https://docs.theforeman.org/2.5/Content_Management_Guide/index-foreman-el.html#Managing_Activation_Keys-Creating_an_Activation_Key">Creating An Activation Key</a> in the <em>Content Management</em> guide.</p>
</li>
<li>
<p>Ensure that you have the correct permissions to create an Azure Active Directory application.
For more information, see <a href="https://docs.microsoft.com/en-us/azure/active-directory/develop/howto-create-service-principal-portal#required-permissions">Check Azure AD permissions</a> in the <em>Microsoft identity platform (Azure Active Directory for developers)</em> documentation.</p>
</li>
<li>
<p>You must create and configure an Azure Active Directory application and service principle to obtain Application or <em>client</em> ID, Directory or <em>tenant</em> ID, and Client Secret.
For more information, see <a href="https://docs.microsoft.com/en-us/azure/active-directory/develop/howto-create-service-principal-portal">Use the portal to create an Azure AD application and service principal that can access resources</a> in the <em>Microsoft identity platform (Azure Active Directory for developers)</em> documentation.</p>
</li>
<li>
<p>Optional: If you want to use Puppet with Azure hosts, navigate to <strong>Administer</strong> &gt; <strong>Settings</strong> &gt; <strong>Puppet</strong> and enable the <code>Use UUID for certificates</code> setting to configure Puppet to use consistent Puppet certificate IDs.</p>
</li>
<li>
<p>Based on your needs, associate a <code>finish</code> or <code>user_data</code> provisioning template with the operating system you want to use.
For more information about provisioning templates, see <a href="https://docs.theforeman.org/2.5/Provisioning_Guide/index-foreman-el.html#provisioning-templates_provisioning">Provisioning Templates</a>.</p>
</li>
<li>
<p>Optional: If you want the virtual machine to use a static private IP address, create a subnet in Foreman with the <strong>Network Address</strong> field matching the Azure subnet address.</p>
</li>
<li>
<p>Before creating RHEL BYOS images, you must accept the image terms either in the Azure CLI or Portal so that the image can be used to create and manage virtual machines for your subscription.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure Overview</div>
<ol class="arabic">
<li>
<p><a href="#installing-the-azurerm-plugin_azure-provisioning">Installing the Foreman AzureRm Plug-in</a>.</p>
</li>
<li>
<p><a href="#adding-azure-connection_azure-provisioning">Adding a Microsoft Azure Resource Manager Connection to Foreman&#160;server</a>.</p>
</li>
<li>
<p><a href="#adding-images-to-server_azure-provisioning">Adding Microsoft Azure Resource Manager Images to Foreman&#160;server</a>.</p>
</li>
<li>
<p><a href="#adding-azure-details-to-a-compute-profile_azure-provisioning">Adding Microsoft Azure Resource Manager Details to a Compute Profile</a>.</p>
</li>
<li>
<p><a href="#creating-image-only-hosts_azure-provisioning">Creating Image-based Hosts on Microsoft Azure Resource Manager</a>.</p>
</li>
</ol>
</div>
<div class="sect2">
<h3 id="installing-the-azurerm-plugin_azure-provisioning">16.1. Installing the Foreman AzureRm Plug-in</h3>
<div class="paragraph">
<p>Use this procedure to install the AzureRm plug-in in Foreman.
Note that this plug-in is version 2.0.x and does not depend on the previous foreman_azure 1.x as they refer to different Azure APIs.
This AzureRm plug-in is compatible with Foreman 1.17 and later.</p>
</div>
<div class="olist arabic">
<div class="title">Installing with Bundle (Gem)</div>
<ol class="arabic">
<li>
<p>Append the following line to the <code>Gemfile.local.rb</code> file in your Foreman installation directory <code>/usr/share/foreman/bundler.d/Gemfile.local.rb</code>:</p>
<div class="listingblock">
<div class="content">
<pre>$ gem 'foreman_azure_rm'</pre>
</div>
</div>
</li>
<li>
<p>Change to the <code>~/usr/share/foreman/bundler.d/</code> directory:</p>
<div class="listingblock">
<div class="content">
<pre>cd ~/usr/share/foreman/bundler.d/</pre>
</div>
</div>
</li>
<li>
<p>Run the <code>bundle install</code> command.</p>
</li>
<li>
<p>Enable the <code>foreman_azure_rm</code> plug-in:</p>
<div class="listingblock">
<div class="content">
<pre># foreman-installer --enable-foreman-plugin-azure --enable-foreman-cli-azure</pre>
</div>
</div>
</li>
<li>
<p>Reload the Apipie cache:</p>
<div class="listingblock">
<div class="content">
<pre># hammer -r</pre>
</div>
</div>
</li>
</ol>
</div>
<div class="olist arabic">
<div class="title">Installing with a Package-Management Utility</div>
<ol class="arabic">
<li>
<p>Install the AzureRm plug-in using yum:</p>
<div class="listingblock">
<div class="content">
<pre># yum install tfm-rubygem-foreman_azure_rm</pre>
</div>
</div>
</li>
<li>
<p>Enable the <code>foreman_azure_rm</code> plug-in:</p>
<div class="listingblock">
<div class="content">
<pre># foreman-installer --enable-foreman-plugin-azure --enable-foreman-cli-azure</pre>
</div>
</div>
</li>
<li>
<p>Reload the Apipie cache:</p>
<div class="listingblock">
<div class="content">
<pre># hammer -r</pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="adding-azure-connection_azure-provisioning">16.2. Adding a Microsoft Azure Resource Manager Connection to Foreman&#160;server</h3>
<div class="paragraph">
<p>Use this procedure to add Microsoft Azure Resource Manager as a compute resource in Foreman.
Note that you must add a separate compute resource for each Azure Resource Manager region that you want to use.</p>
</div>
<div class="paragraph">
<p>To use the CLI instead of the web UI, see the <a href="#cli-adding-azure-connection_azure-provisioning">CLI procedure</a>.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>In the Foreman web UI, navigate to <strong>Infrastructure</strong> &gt; <strong>Compute Resources</strong> and click <strong>Create Compute Resource</strong>.</p>
</li>
<li>
<p>In the <strong>Name</strong> field, enter a name for the compute resource.</p>
</li>
<li>
<p>From the <strong>Provider</strong> list, select <strong>Azure Resource Manager</strong>.</p>
</li>
<li>
<p>Optional: In the <strong>Description</strong> field, enter a description for the resource.</p>
</li>
<li>
<p>By default, the <strong>Cloud</strong> is set to Public/Standard.
Azure Government Cloud supports the following regions:</p>
<div class="ulist">
<ul>
<li>
<p>US Government</p>
</li>
<li>
<p>China</p>
</li>
<li>
<p>Germany</p>
</li>
</ul>
</div>
</li>
<li>
<p>In the <strong>Client ID</strong> field, enter the Application or <em>client</em> ID.</p>
</li>
<li>
<p>In the <strong>Client Secret</strong> field, enter the client secret.</p>
</li>
<li>
<p>In the <strong>Subscription ID</strong> field, enter the subscription ID.</p>
</li>
<li>
<p>In the <strong>Tenant ID</strong> field, enter the Directory or <em>tenant</em> ID.</p>
</li>
<li>
<p>Click <strong>Load Regions</strong>.
This tests if your connection to Azure Resource Manager is successful and loads the regions available in your subscription.</p>
</li>
<li>
<p>From the <strong>Azure Region</strong> list, select the Azure region to use.</p>
</li>
<li>
<p>Click <strong>Submit</strong>.</p>
</li>
</ol>
</div>
<div id="cli-adding-azure-connection_azure-provisioning" class="ulist">
<div class="title">CLI procedure</div>
<ul>
<li>
<p>Use the <code>hammer compute-resource create</code> command to add an Azure compute resource to Foreman.
Note that the value for the <code>--region</code> option must be in lowercase and must not contain special characters.</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># hammer compute-resource create --name <em>azure_cr_name</em> \
--provider azurerm \
--tenant <em>tenant-id</em> \
--app-ident <em>client-id</em> \
--secret-key <em>client-secret</em> \
--sub-id <em>subscription-id</em> \
--region '<em>region</em>'</pre>
</div>
</div>
</li>
</ul>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
If you are using Azure Government Cloud then you must pass in the <code>--cloud</code> parameter.
The values for the <code>cloud</code> parameter are:
</td>
</tr>
</table>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Name of Azure Government Cloud</th>
<th class="tableblock halign-left valign-top">Value for hammer --cloud</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">US Goverment</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">azureusgovernment</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">China</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">azurechina</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Germany</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">azuregermancloud</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="adding-images-to-server_azure-provisioning">16.3. Adding Microsoft Azure Resource Manager Images to Foreman&#160;server</h3>
<div class="paragraph">
<p>To create hosts using image-based provisioning, you must add information about the image, such as access details and the image location, to your Foreman&#160;server.</p>
</div>
<div class="paragraph">
<p>To use the CLI instead of the web UI, see the <a href="#cli-adding-images-to-server_azure-provisioning">CLI procedure</a>.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>In the Foreman web UI, navigate to <strong>Infrastructure</strong> &gt; <strong>Compute Resources</strong> and click the name of the Microsoft Azure Resource Manager connection.</p>
</li>
<li>
<p>Click <strong>Create Image</strong>.</p>
</li>
<li>
<p>In the <strong>Name</strong> field, enter a name for the image.</p>
</li>
<li>
<p>From the <strong>Operating System</strong> list, select the image&#8217;s base operating system.</p>
</li>
<li>
<p>From the <strong>Architecture</strong> list, select the operating system architecture.</p>
</li>
<li>
<p>In the <strong>Username</strong> field, enter the SSH user name for image access.
You cannot use the <code>root</code> user.</p>
</li>
<li>
<p>Optional: In the <strong>Password</strong> field, enter a password to authenticate with.</p>
</li>
<li>
<p>In the <strong>Azure Image Name</strong> field, enter an image name in the format <code><em>prefix://UUID</em></code>.</p>
<div class="ulist">
<ul>
<li>
<p>For a custom image, use the prefix <code>custom</code>.
For example, <strong>custom://image-name</strong>.</p>
</li>
<li>
<p>For a shared gallery image, use the prefix <code>gallery</code>.
For example, <strong>gallery://image-name</strong>.</p>
</li>
<li>
<p>For public and RHEL Bring Your Own Subscription (BYOS) images, use the prefix <code>marketplace</code>.
For example, <strong>marketplace://OpenLogicCentOS:7.5:latest</strong>.</p>
<div class="paragraph">
<p>For more information, see <a href="https://docs.microsoft.com/en-us/azure/virtual-machines/linux/cli-ps-findimage">Find Linux VM images in the Azure Marketplace with the Azure CLI</a>.</p>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>Optional: Select the <strong>User Data</strong> check box if the image supports user data input, such as <code>cloud-init</code> data.</p>
</li>
<li>
<p>Click <strong>Submit</strong> to save the image details.</p>
</li>
</ol>
</div>
<div id="cli-adding-images-to-server_azure-provisioning" class="ulist">
<div class="title">CLI procedure</div>
<ul>
<li>
<p>Create the image with the <code>hammer compute-resource image create</code> command.
Note that the username that you enter for the image must be the same that you use when you create a host with this image.
The <code>--password</code> option is optional when creating an image.
You cannot use the <code>root</code> user.</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># hammer compute-resource image create \
--name <em>Azure_image_name</em> \
--compute-resource <em>azure_cr_name</em> \
--uuid '<em>marketplace://RedHat:RHEL:7-RAW:latest</em>' \
--username '<em>azure_username</em>' \
--user-data <em>no</em></pre>
</div>
</div>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="adding-azure-details-to-a-compute-profile_azure-provisioning">16.4. Adding Microsoft Azure Resource Manager Details to a Compute Profile</h3>
<div class="paragraph">
<p>Use this procedure to add Azure hardware settings to a compute profile.
When you create a host on Azure using this compute profile, these settings are automatically populated.</p>
</div>
<div class="paragraph">
<p>To use the CLI instead of the web UI, see the <a href="#cli-adding-azure-details-to-a-compute-profile_azure-provisioning">CLI procedure</a>.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>In the Foreman web UI, navigate to <strong>Infrastructure</strong> &gt; <strong>Compute Profiles</strong>.</p>
</li>
<li>
<p>In the Compute Profiles window, click the name of an existing compute profile, or click <strong>Create Compute Profile</strong>, enter a <strong>Name</strong>, and click <strong>Submit</strong>.</p>
</li>
<li>
<p>Click the name of the Azure compute resource.</p>
</li>
<li>
<p>From the <strong>Resource group</strong> list, select the resource group to provision to.</p>
</li>
<li>
<p>From the <strong>VM Size</strong> list, select a size of a virtual machine to provision.</p>
</li>
<li>
<p>From the <strong>Platform</strong> list, select <strong>Linux</strong>.</p>
</li>
<li>
<p>In the <strong>Username</strong> field, enter a user name to authenticate with.
Note that the username that you enter for compute profile must be the same that you use when creating an image.</p>
</li>
<li>
<p>To authenticate the user, use one of the following options:</p>
<div class="ulist">
<ul>
<li>
<p>To authenticate using a password, enter a password in the <strong>Password</strong> field.</p>
</li>
<li>
<p>To authenticate using an SSH key, enter an SSH key in the <strong>SSH Key</strong> field.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Optional: If you want the virtual machine to use a premium virtual machine disk, select the <strong>Premium OS Disk</strong> check box.</p>
</li>
<li>
<p>From the <strong>OS Disk Caching</strong> list, select the disc caching setting.</p>
</li>
<li>
<p>Optional: In the <strong>Custom Script Command</strong> field, enter commands to perform on the virtual machine when the virtual machine is provisioned.</p>
</li>
<li>
<p>Optional: If you want to run custom scripts when provisioning finishes, in the <strong>Comma separated file URIs</strong> field, enter comma-separated file URIs of scripts to use.
The scripts must contain <code>sudo</code> at the beginning because Foreman downloads files to the <code>/var/lib/waagent/custom-script/download/0/</code> directory on the host and scripts require sudo privileges to be executed.</p>
</li>
<li>
<p>Optional: You can add a <strong>NVIDIA Driver</strong> by selecting the <strong>NVIDIA driver / CUDA</strong> checkbox.
For more information, refer to the following Microsoft Azure documentation:</p>
<div class="ulist">
<ul>
<li>
<p><a href="https://docs.microsoft.com/en-us/azure/virtual-machines/extensions/hpccompute-gpu-linux">NVIDIA GPU Driver Extension for Linux</a></p>
</li>
<li>
<p><a href="https://docs.microsoft.com/en-us/azure/virtual-machines/extensions/hpccompute-gpu-windows">NVIDIA GPU Driver Extension for Windows</a></p>
</li>
</ul>
</div>
</li>
<li>
<p>Optional: If you want to create an additional volume on the VM, click the <strong>Add Volume</strong> button, enter the <strong>Size</strong> in GB and select the <strong>Data Disk Caching</strong> method.</p>
<div class="ulist">
<ul>
<li>
<p>Note that the maximum number of these disks depends on the VM Size selected.
For more information on Microsoft Azure VM storage requirements, see the <a href="https://docs.microsoft.com/en-us/azure/virtual-machines">Microsoft Azure documentation</a>.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Click <strong>Add Interface</strong>.</p>
</li>
</ol>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
<div class="paragraph">
<p>The maximum number of interfaces depends on the VM Size selected.
For more information, see the Microsoft Azure documentation link above.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>From the <strong>Azure Subnet</strong> list, select the Azure subnet to provision to.</p>
</li>
<li>
<p>From the <strong>Public IP</strong> list, select the public IP setting.</p>
</li>
<li>
<p>Optional: If you want the virtual machine to use a static private IP, select the <strong>Static Private IP</strong> check box.</p>
</li>
<li>
<p>Click <strong>Submit</strong>.</p>
</li>
</ol>
</div>
<div id="cli-adding-azure-details-to-a-compute-profile_azure-provisioning" class="olist arabic">
<div class="title">CLI procedure</div>
<ol class="arabic">
<li>
<p>Create a compute profile to use with the Azure Resource Manager compute resource:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># hammer compute-profile create --name <em>compute_profile_name</em></pre>
</div>
</div>
</li>
<li>
<p>Add Azure details to the compute profile.
With the <code>username</code> setting, enter the SSH user name for image access.
Note that the username that you enter for compute profile must be the same that you use when creating an image.</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># hammer compute-profile values create \
--compute-profile "<em>compute_profile_name</em>" \
--compute-resource <em>azure_cr_name</em> \
--compute-attributes="resource_group=<em>resource_group</em>,vm_size=<em>Standard_B1s</em>,username=<em>azure_user</em>,password=<em>azure_password</em>,platform=Linux,script_command=touch /var/tmp/text.txt" \
--interface="compute_public_ip=Dynamic,compute_network=mysubnetID,compute_private_ip=false"
--volume="disk_size_gb=<em>5</em>,data_disk_caching=<em>None</em>"</pre>
</div>
</div>
<div class="paragraph">
<p>Optional: If you want to run scripts on the virtual machine after provisioning, specify the following settings:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>To enter the script directly, with the <code>script_command</code> setting, enter a command to be executed on the provisioned virtual machine.</p>
</li>
<li>
<p>To run a script from a URI, with the <code>script_uris</code> setting, enter comma-separated file URIs of scripts to use.
The scripts must contain <code>sudo</code> at the beginning because Foreman downloads files to the <code>/var/lib/waagent/custom-script/download/0/</code> directory on the host and therefore scripts require sudo privileges to be executed.</p>
</li>
</ul>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="creating-image-only-hosts_azure-provisioning">16.5. Creating Image-based Hosts on Microsoft Azure Resource Manager</h3>
<div class="paragraph">
<p>In Foreman, you can use Microsoft Azure Resource Manager provisioning to create hosts from an existing image.
The new host entry triggers the Microsoft Azure Resource Manager server to create the instance using the pre-existing image as a basis for the new volume.</p>
</div>
<div class="paragraph">
<p>To use the CLI instead of the web UI, see the <a href="#cli-creating-image-only-hosts_azure-provisioning">CLI procedure</a>.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>In the Foreman web UI, navigate to <strong>Hosts</strong> &gt; <strong>Create Host</strong>.</p>
</li>
<li>
<p>In the <strong>Name</strong> field, enter a name for the host.</p>
</li>
<li>
<p>Click the <strong>Organization</strong> and <strong>Location</strong> tabs to ensure that the provisioning context is automatically set to the current context.</p>
</li>
<li>
<p>From the <strong>Host Group</strong> list, select the host group that you want to use to populate the form.</p>
</li>
<li>
<p>From the <strong>Deploy on</strong> list, select the Microsoft Azure Resource Manager connection.</p>
</li>
<li>
<p>From the <strong>Compute Profile</strong> list, select a profile to use to automatically populate virtual machine settings.</p>
</li>
<li>
<p>From the <strong>Lifecycle Environment</strong> list, select the environment.</p>
</li>
<li>
<p>Click the <strong>Interfaces</strong> tab and click <strong>Edit</strong> on the host&#8217;s interface.</p>
</li>
<li>
<p>Verify that the fields are automatically populated, particularly the following items:</p>
<div class="ulist">
<ul>
<li>
<p>The <strong>Name</strong> from the <strong>Host</strong> tab becomes the <strong>DNS name</strong>.</p>
</li>
<li>
<p>The <strong>MAC address</strong> field is blank.
Microsoft Azure Resource Manager assigns a MAC address to the host during provisioning.</p>
</li>
<li>
<p>The <strong>Azure Subnet</strong> field is populated with the required Azure subnet.</p>
</li>
<li>
<p>The <strong>Managed</strong>, <strong>Primary</strong>, and <strong>Provision</strong> options are automatically selected for the first interface on the host.
If not, select them.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Optional: If you want to use a static private IP address, from the <strong>IPv4 Subnet</strong> list select the Foreman subnet with the <strong>Network Address</strong> field matching the Azure subnet address. In the <strong>IPv4 Address</strong> field, enter an IPv4 address within the range of your Azure subnet.</p>
</li>
<li>
<p>Click the <strong>Operating System</strong> tab, and confirm that all fields automatically contain values.</p>
</li>
<li>
<p>For <strong>Provisioning Method</strong>, ensure <strong>Image Based</strong> is selected.</p>
</li>
<li>
<p>From the <strong>Image</strong> list, select the Azure Resource Manager image that you want to use for provisioning.</p>
</li>
<li>
<p>In the <strong>Root Password</strong> field, enter the root password to authenticate with.</p>
</li>
<li>
<p>Click <strong>Resolve</strong> in <strong>Provisioning templates</strong> to check the new host can identify the right provisioning templates to use.</p>
</li>
<li>
<p>Click the <strong>Virtual Machine</strong> tab and confirm that these settings are populated with details from the host group and compute profile.
Modify these settings to suit your needs.</p>
</li>
<li>
<p>If you use the Katello plugin, click the <strong>Parameters</strong> tab, and ensure that a parameter exists that provides an activation key.
If not, add an activation key.</p>
</li>
<li>
<p>Click <strong>Submit</strong> to save the host entry.</p>
</li>
</ol>
</div>
<div id="cli-creating-image-only-hosts_azure-provisioning" class="ulist">
<div class="title">CLI procedure</div>
<ul>
<li>
<p>Create the host with the <code>hammer host create</code> command and include <code>--provision-method image</code>.
Replace the values in the following example with the appropriate values for your environment.</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># hammer host create \
--name="<em>Azure_VM</em>" \
--organization "<em>Your_Organization</em>" \
--location "<em>Your_Location</em>" \
--compute-resource <em>azure_cr_name</em> \
--compute-profile "<em>compute_profile_name</em>" \
--provision-method 'image' \
--image <em>Azure_image_name</em> \
--domain <em>domain_name</em> \
--architecture <em>x86_64</em> \
--operatingsystem "<em>operating_system_name</em>"</pre>
</div>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>For more information about additional host creation parameters for this compute resource, enter the <code>hammer host create --help</code> command.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="Initialization_Script_for_Provisioning_Examples">Appendix A: Initialization Script for Provisioning Examples</h2>
<div class="sectionbody">
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
The following chapter describes Red Hat content management provided by Katello plugin.
Deployments without the plugin use Installation Media to fetch content from remote or local mirrors.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>If you have not followed the examples in the Foreman Content Management Guide, you can use the following initialization script to create an environment for provisioning examples.</p>
</div>
<div class="paragraph">
<p>Create a script file (<code>content-init.sh</code>) and include the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">#!/bin/bash

MANIFEST=$1

# Import the content from Red Hat CDN
hammer organization create --name "ACME" --label "ACME" \
--description "Our example organization for managing content."
hammer subscription upload --file ~/$MANIFEST --organization "ACME"
hammer repository-set enable \
--name "Red Hat Enterprise Linux 7 Server (RPMs)" \
--releasever "7Server" --basearch "x86_64" \
--product "Red Hat Enterprise Linux Server" --organization "ACME"
hammer repository-set enable \
--name "Red Hat Enterprise Linux 7 Server (Kickstart)" \
--releasever "7Server" --basearch "x86_64" \
--product "Red Hat Enterprise Linux Server" --organization "ACME"
hammer repository-set enable \
--name "Red Hat https://yum.theforeman.org/client/2.5/ (for RHEL 7 Server) (RPMs)" \
--basearch "x86_64" --product "Red Hat Enterprise Linux Server" \
--organization "ACME"
hammer product synchronize --name "Red Hat Enterprise Linux Server" \
--organization "ACME"

# Create our application life cycle
hammer lifecycle-environment create --name "Development" \
--description "Environment for ACME's Development Team" \
--prior "Library" --organization "ACME"
hammer lifecycle-environment create --name "Testing" \
--description "Environment for ACME's Quality Engineering Team" \
--prior "Development" --organization "ACME"
hammer lifecycle-environment create --name "Production" \
--description "Environment for ACME's Product Releases" \
--prior "Testing" --organization "ACME"

# Create and publish our Content View
hammer content-view create --name "Base" \
--description "Base operating system" \
--repositories "Red Hat Enterprise Linux 7 Server RPMs x86_64 7Server,Red Hat https://yum.theforeman.org/client/2.5/ for RHEL 7 Server RPMs x86_64" \
--organization "ACME"
hammer content-view publish --name "Base" \
--description "Initial content view for our operating system" \
--organization "ACME"
hammer content-view version promote --content-view "Base" --version 1 \
--to-lifecycle-environment "Development" --organization "ACME"
hammer content-view version promote --content-view "Base" --version 1 \
--to-lifecycle-environment "Testing" --organization "ACME"
hammer content-view version promote --content-view "Base" --version 1 \
--to-lifecycle-environment "Production" --organization "ACME"</pre>
</div>
</div>
<div class="paragraph">
<p>Set executable permissions on the script:</p>
</div>
<div class="listingblock">
<div class="content">
<pre># chmod +x content-init.sh</pre>
</div>
</div>
<div class="paragraph">
<p>Download a copy of your Subscription Manifest from the Red Hat Customer Portal and run the script on the manifest:</p>
</div>
<div class="listingblock">
<div class="content">
<pre># ./content-init.sh manifest_98f4290e-6c0b-4f37-ba79-3a3ec6e405ba.zip</pre>
</div>
</div>
<div class="paragraph">
<p>This imports the necessary Red Hat content for the provisioning examples in this guide.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="Provision_FIPS_Hosts">Appendix B: Provisioning FIPS-Compliant Hosts</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Foreman supports provisioning hosts that comply with the National Institute of Standards and Technology&#8217;s <a href="https://csrc.nist.gov/publications/detail/fips/140/2/final">Security Requirements for Cryptographic Modules</a> standard, reference number FIPS 140-2, referred to here as FIPS.</p>
</div>
<div class="paragraph">
<p>To enable the provisioning of hosts that are FIPS-compliant, complete the following tasks:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Change the provisioning password hashing algorithm for the operating system</p>
</li>
<li>
<p>Create a host group and set a host group parameter to enable FIPS</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For more information about creating host groups, see <a href="https://docs.theforeman.org/2.5/Managing_Hosts/index-foreman-el.html#creating-a-host-group">Creating a Host Group</a> in the <em>Managing Hosts</em> guide.</p>
</div>
<div class="paragraph">
<p>The provisioned hosts have the FIPS-compliant settings applied.
To confirm that these settings are enabled, complete the steps in <a href="#verifying_fips_mode_enabled">Verifying FIPS Mode is Enabled</a>.</p>
</div>
<div class="sect2">
<h3 id="_change_the_provisioning_password_hashing_algorithm">B.1. Change the Provisioning Password Hashing Algorithm</h3>
<div class="paragraph">
<p>To provision FIPS-compliant hosts, you must first set the password hashing algorithm that you use in provisioning to SHA256.
This configuration setting must be applied for each operating system you want to deploy as FIPS-compliant.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Identify the Operating System IDs.</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ hammer os list</pre>
</div>
</div>
</li>
<li>
<p>Update each operating system&#8217;s password hash value.</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ hammer os update --title <em>Operating_System</em> \
  --password-hash SHA256</pre>
</div>
</div>
</li>
<li>
<p>Repeat this command for each of the operating systems, using the matching value in the <code>TITLE</code> column:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ hammer os update --title "RedHat <em>version_number</em>" \
  --password-hash SHA256</pre>
</div>
</div>
<div class="paragraph">
<p>Note that you cannot use a comma-separated list of values.</p>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_setting_the_fips_enabled_parameter">B.2. Setting the FIPS-Enabled Parameter</h3>
<div class="paragraph">
<p>To provision a FIPS-compliant host, you must create a host group and set the host group parameter <code>fips_enabled</code> to <code>true</code>.
If this is not set to <code>true</code>, or is absent, the FIPS-specific changes do not apply to the system.
You can set this parameter when you provision a host or for a host group.</p>
</div>
<div class="paragraph">
<p>To set this parameter when provisioning a host, append <code>--parameters fips_enabled=true</code> to the Hammer command.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ hammer hostgroup set-parameter --name fips_enabled \
 --value 'true' \
 --hostgroup <em>prod_servers</em></pre>
</div>
</div>
<div class="paragraph">
<p>For more information, see the output of the command <code>hammer hostgroup set-parameter --help</code>.</p>
</div>
</div>
<div class="sect2">
<h3 id="verifying_fips_mode_enabled">B.3. Verifying FIPS Mode is Enabled</h3>
<div class="paragraph">
<p>To verify these FIPS compliance changes have been successful, you must provision a host and check its configuration.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Log on to the host as <code>root</code> or with an admin-level account.</p>
</li>
<li>
<p>Enter the following command:</p>
<div class="listingblock">
<div class="content">
<pre>$ cat /proc/sys/crypto/fips_enabled</pre>
</div>
</div>
<div class="paragraph">
<p>A value of <code>1</code> confirms that FIPS mode is enabled.</p>
</div>
</li>
</ol>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Version 2.5 (unsupported)<br>
Last updated Feb 2023
</div>
</div>
</body>
</html>