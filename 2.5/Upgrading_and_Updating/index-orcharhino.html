<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.18">
<title>Upgrading and Updating orcharhino</title>
<link rel="stylesheet" href="./orcharhino.css">
<!-- docinfo -->
</head>
<body class="book">
    <div id="wrap">
      <script src="/js/versions.js"></script>
      <script src="/js/nav.js"></script>
      <script>
        document.open();
        document.write(buildNavigation());
        addNavbarListeners();
        document.close();
      </script>
    </div>
<div id="header">
<h1>Upgrading and Updating orcharhino</h1>
</div>
<div id="content">
<div class="sect1">
<h2 id="upgrading_process_overview">1. Upgrade Overview</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This chapter details the prerequisites and available upgrade paths to orcharhino 2.1.3. Review this information before upgrading your current orcharhino installation.</p>
</div>
<div class="paragraph">
<p>In this guide, the terms update, upgrade, and migrate have the following meanings:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Upgrading</dt>
<dd>
<p>The process of advancing your orcharhino server and orcharhino Proxy installations from a y-stream release to the next, for example orcharhino 2.4 to orcharhino 2.1.3.</p>
</dd>
<dt class="hdlist1">Updating</dt>
<dd>
<p>The process of advancing your orcharhino server and orcharhino Proxy installations from a z-stream release to the next, for example orcharhino 2.1.3.0 to orcharhino 2.1.3.1.</p>
</dd>
<dt class="hdlist1">Migrating</dt>
<dd>
<p>The process of moving an existing orcharhino installation to another Red&#160;Hat Enterprise&#160;Linux server.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>For interactive upgrade instructions, you can also use the orcharhino Upgrade Helper on the Red&#160;Hat Customer Portal. This application provides you with an exact guide to match your current version number. You can find instructions that are specific to your upgrade path, as well as steps to prevent known issues. For more information, see <a href="https://access.redhat.com/labs/satelliteupgradehelper/">orcharhino Upgrade Helper</a> on the customer portal.</p>
</div>
<div class="paragraph">
<p>Note that you can upgrade orcharhino Proxies separately from orcharhino. For more information, see <a href="#upgrading_capsules-separately-from-satellite_upgrade-guide">Upgrading orcharhino Proxies Separately from orcharhino</a>.</p>
</div>
<div class="sect2">
<h3 id="upgrading_prerequisites">1.1. Prerequisites</h3>
<div class="paragraph">
<p>Upgrading to orcharhino 2.1.3 affects your entire orcharhino infrastructure. Before proceeding, complete the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Read the orcharhino 2.1.3 Release Notes.</p>
</li>
<li>
<p>Review this guide so that you are aware of the upgrade process and its impact.</p>
</li>
<li>
<p>Plan your upgrade path. For more information, see <a href="#upgrade_paths">Upgrade Paths</a>.</p>
</li>
<li>
<p>Plan for the required downtime. orcharhino services are shut down during the upgrade. The upgrade process duration might vary depending on your hardware configuration, network speed, and the amount of data that is stored on the server.</p>
<div class="paragraph">
<p>Upgrading orcharhino takes approximately 1 - 2 hours.</p>
</div>
<div class="paragraph">
<p>Upgrading orcharhino Proxy takes approximately 10 - 30 minutes.</p>
</div>
<div class="paragraph">
<p>However, upgrading from 2.4 to 2.1.3 also migrates Pulp content, this step can take some considerable time.
For more information on preparing for Pulp migration and the upgrade process, see <a href="#Upgrading_Server_upgrade-guide">Upgrading orcharhino server</a>.</p>
</div>
</li>
<li>
<p>Ensure that you have sufficient storage space on your server. For more information, see <a href="sources/installation_and_maintenance/orcharhino_installation_guide.html#preparing-environment-for-satellite-installation">Preparing your Environment for Installation</a> in <em>Installing orcharhino server from a Connected Network</em> and <a href="sources/installation_and_maintenance/orcharhino_proxy_installation_guide.html#preparing-environment-for-capsule-installation">Preparing your Environment for Installation</a> in <em>Installing orcharhino Proxy</em>.</p>
</li>
<li>
<p>Back up your orcharhino server and all orcharhino Proxys. For more information, see <a href="sources/management_ui/the_administer_menu.html##backing-up-satellite-server-and-capsule-server">Backing Up orcharhino server and orcharhino Proxy</a> in the <em>Administering orcharhino 5.6</em> guide.</p>
</li>
<li>
<p>Plan for updating any scripts you use that contain orcharhino API commands because some API commands differ between versions of orcharhino.</p>
</li>
</ul>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
If you customize configuration files, manually or use a tool such as Hiera, these customizations are overwritten when the installation script runs during upgrading or updating. You can use the <code>--noop</code> option with the foreman-installer script to test for changes. For more information, see the Red Hat Knowledgebase solution <a href="https://access.redhat.com/solutions/3351311">How to use the noop option to check for changes in orcharhino config files during an upgrade.</a>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="upgrade_paths">1.2. Upgrade Paths</h3>
<div class="paragraph">
<p>You can upgrade to orcharhino 2.1.3 from orcharhino 2.4. orcharhino servers and orcharhino Proxys on earlier versions must first be upgraded to orcharhino 2.4. For more details, see the orcharhino 2.4 Upgrade documentation.</p>
</div>
<div class="paragraph">
<div class="title">Overview of orcharhino 2.1.3 Upgrade Paths</div>
<p>The high level steps in upgrading to orcharhino 2.1.3 are as follows.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Upgrade orcharhino server and all orcharhino Proxys to orcharhino 2.1.3. For more information, see <a href="#Upgrading_Server_upgrade-guide">Upgrading orcharhino server</a>.</p>
</li>
<li>
<p>Upgrade to orcharhino client on all orcharhino clients. For more information, see <a href="#upgrading_clients">[upgrading_clients]</a>.</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="following_the_progress_of_the_upgrade">1.3. Following the Progress of the Upgrade</h3>
<div class="paragraph">
<p>Because of the lengthy upgrade time, use a utility such as <code>screen</code> to suspend and reattach a communication session. You can then check the upgrade progress without staying connected to the command shell continuously. For more information about using the screen command, see <a href="https://access.redhat.com/articles/5247">How do I use the screen command?</a> article in the <em>Red&#160;Hat Knowledge&#160;Base</em>. You can also see the <code>screen</code> manual page for more information.</p>
</div>
<div class="paragraph">
<p>If you lose connection to the command shell where the upgrade command is running you can see the logs in <code>/var/log/foreman-installer/foreman.log</code> to check if the process completed successfully.</p>
</div>
</div>
<div class="sect2">
<h3 id="upgrading_capsules-separately-from-satellite_upgrade-guide">1.4. Upgrading orcharhino Proxies Separately from orcharhino</h3>
<div class="paragraph">
<p>You can upgrade orcharhino to version 2.1.3 and keep orcharhino Proxies at version 2.4 until you have the capacity to upgrade them too.</p>
</div>
<div class="paragraph">
<p>All the functionality that worked previously works on 2.4 orcharhino Proxies. However, the functionality added in the 2.1.3 release will not work until you upgrade orcharhino Proxies to 2.1.3.</p>
</div>
<div class="paragraph">
<p>Upgrading orcharhino Proxies after upgrading orcharhino can be useful in the following example scenarios:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>If you want to have several smaller outage windows instead of one larger window.</p>
</li>
<li>
<p>If orcharhino Proxies in your organization are managed by several teams and are located in different locations.</p>
</li>
<li>
<p>If you use a load-balanced configuration, you can upgrade one load-balanced orcharhino Proxy and keep other load-balanced orcharhino Proxies at 1 version lower. This allows you to upgrade all orcharhino Proxies one after another without any outage.</p>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_upgrading_orcharhino">2. Upgrading orcharhino</h2>
<div class="sectionbody">
<div id="introduction_upgrading_satellite" class="paragraph">
<p>Use the following procedures to upgrade your existing orcharhino to orcharhino 2.1.3:</p>
</div>
<div class="paragraph">
<p>Before upgrading, see <a href="#upgrading_prerequisites">Prerequisites</a>.</p>
</div>
<div class="sect2">
<h3 id="Upgrading_Server_upgrade-guide">2.1. Upgrading orcharhino server</h3>
<div class="paragraph">
<p>This section describes how to upgrade orcharhino server from 2.4 to 2.1.3.</p>
</div>
<div id="upgrading_satellite_server_prerequisites" class="ulist">
<div class="title">Before You Begin</div>
<ul>
<li>
<p>Note that you can upgrade orcharhino Proxies separately from orcharhino.
For more information, see <a href="#upgrading_capsules-separately-from-satellite_upgrade-guide">Upgrading orcharhino Proxies Separately from orcharhino</a>.</p>
</li>
<li>
<p>Review and update your firewall configuration prior to upgrading your orcharhino server.
For more information, see <a href="sources/installation_and_maintenance/orcharhino_installation_guide.html#preparing-environment-for-satellite-installation">Preparing your environment for installation</a> in <em>Installing orcharhino server</em>.</p>
</li>
<li>
<p>Ensure that you do not delete the manifest from the Customer Portal or in the orcharhino management UI because this removes all the entitlements of your content hosts.</p>
</li>
<li>
<p>Back up and remove all Foreman hooks before upgrading.
Restore any hooks only after orcharhino is known to be working after the upgrade is complete.</p>
</li>
<li>
<p>If you have edited any of the default templates, back up the files either by cloning or exporting them.
Cloning is the recommended method because that prevents them being overwritten in future updates or upgrades.
To confirm if a template has been edited, you can view its <strong>History</strong> before you upgrade or view the changes in the audit log after an upgrade.
In the orcharhino management UI, navigate to <strong>Monitor</strong> &gt; <strong>Audits</strong> and search for the template to see a record of changes made.
If you use the export method, restore your changes by comparing the exported template and the default template, manually applying your changes.</p>
</li>
</ul>
</div>
<div class="ulist">
<div class="title">orcharhino Proxy Considerations</div>
<ul>
<li>
<p>If you use Content Views to control updates to a orcharhino Proxy’s base operating system, or for orcharhino Proxy repository, you must publish updated versions of those Content Views.</p>
</li>
<li>
<p>Note that orcharhino server upgraded from 2.4 to 2.1.3 can use orcharhino Proxys still at 2.4.</p>
</li>
</ul>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
<div class="paragraph">
<p>If you implemented custom certificates, you must retain the content of both the <code>/root/ssl-build</code> directory and the directory in which you created any source files associated with your custom
certificates.</p>
</div>
<div class="paragraph">
<p>Failure to retain these files during an upgrade causes the upgrade to fail.
If these files have been deleted, they must be restored from a backup in order for the upgrade to proceed.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<div class="title">FIPS mode</div>
<p>You cannot upgrade orcharhino server from a RHEL base system that is not operating in FIPS mode to a RHEL base system that is operating in FIPS mode.</p>
</div>
<div class="paragraph">
<p>To run orcharhino server on a Red Hat Enterprise Linux base system operating in FIPS mode, you must install orcharhino on a freshly provisioned RHEL base system operating in FIPS mode.
For more information, see <a href="sources/installation_and_maintenance/orcharhino_installation_guide.html#preparing-environment-for-satellite-installation">Preparing your environment for installation</a> in <em>Installing orcharhino server</em>.</p>
</div>
<div class="sect3">
<h4 id="preparing_to_migrate_pulp_content">2.1.1. Preparing to Migrate Content to Pulp 3</h4>
<div class="paragraph">
<p>The time to prepare content for Pulp 3 depends on the amount of content and the number of Content Views.
For large systems, this can mean several days of downtime.
To prevent this, pre-migrate Pulp content while running the latest version of orcharhino server 2.4.
This reduces the overall upgrade downtime.</p>
</div>
<div class="paragraph">
<p>During migration to Pulp3, the amount of data stored in the <code>/var/lib/pulp/published/</code> directory can double in size.
Ensure that there is enough space on the <code>/var/lib/pulp</code> volume.
If the user runs <code>foreman-maintain prep-6.10-upgrade</code>, the content in <code>/var/lib/pulp/content</code> does not need to be duplicated.
After Pulp2 is removed, the extra space can be claimed back, however, shrinking of XFS volumes is not possible and copying data to a different partition might be necessary in order to bring volume size down to the previous value.</p>
</div>
<div class="paragraph">
<p>During migration to Pulp 3, the amount of data stored in the PostgreSQL data directory can grow significantly.
Ensure that you have enough space for the migration.
A rough estimation of the space you require is 2-3 times the size of the MongoDB Pulp 2 database.</p>
</div>
<div class="paragraph">
<div class="title">Pre-Migration Checks</div>
<p>The sequence should always be if you have any Composite Content Views, take action on those first, and then work on the Content Views.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Ensure that all enabled repositories complete the synchronization process.</p>
</li>
<li>
<p>If any repositories are synced with a <strong>Warning</strong> or <strong>Error</strong> state, fix the underlying problem and resync the repository.</p>
</li>
<li>
<p>Ensure that no paused tasks in the system are related to any repositories or Content Views.</p>
</li>
<li>
<p>If some Content View or Composite Content View versions are not required anymore, please consider performing a cleanup of them.</p>
</li>
<li>
<p>For more information about how to perform the cleanup of older Content View or Composite Content View versions using <code>hammer_cli</code>, see <a href="https://access.redhat.com/solutions/2760531">How to remove old content view versions in Red Hat Satellite 6 using CLI/hammer?</a>.</p>
</li>
<li>
<p>If you no longer require or use certain repositories, disable those specific repositories.</p>
</li>
<li>
<p>When the cleanup process finishes, ensure that you clean up the orphan data by following the steps in <a href="https://access.redhat.com/solutions/2639291">How to delete orphaned content in /var/lib/pulp on Capsule?</a>.</p>
</li>
<li>
<p>Ensure that you can enter the following command on orcharhino without error:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># foreman-rake katello:correct_repositories COMMIT=true --trace</pre>
</div>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>Use this procedure to begin migrating content from Pulp 2 to Pulp 3.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Update the file permissions before upgrading orcharhino server using the following command:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># foreman-maintain prep-5.5-upgrade</pre>
</div>
</div>
<div class="paragraph">
<p>This might take some time on high latency systems.</p>
</div>
</li>
<li>
<p>View details of the content you are pre-migrating using the following command:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># foreman-maintain content migration-stats</pre>
</div>
</div>
<div class="paragraph">
<p>Use this command as often as necessary during the migration process to determine how long the process will take.
It also identifies corrupted or missing content that might cause the migration to fail.
Output is similar to the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">Running Retrieve Pulp 2 to Pulp 3 migration statistics
============================================
Retrieve Pulp 2 to Pulp 3 migration statistics:
============Migration Summary================
Migrated/Total RPMs: 0/367633
Migrated/Total errata: 0/20780140
Migrated/Total repositories: 0/33924
Estimated migration time based on yum content: 47 hours, 23 minutes
Note: ensure there is sufficient storage space for /var/lib/pulp/published to
double in size before starting the migration process.
Check the size of /var/lib/pulp/published with 'du -sh /var/lib/pulp/published/'
Note: ensure there is sufficient storage space for postgresql.
You will need additional space for your postgresql database.
The partition holding '/var/opt/rh/rh-postgresql12/lib/pgsql/data/' will need
additional free space equivalent to the size of your Mongo db database (/var/lib/mongodb/).
[OK]</pre>
</div>
</div>
</li>
<li>
<p>Prepare your content for Pulp migration using the following command:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># foreman-maintain content prepare</pre>
</div>
</div>
<div class="paragraph">
<p>As part of its final step, <code>foreman-maintain content prepare</code> checks whether any content units are unmigrated.
If it identifies corrupted or missing content, you might see something similar to the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">============Missing/Corrupted Content Summary================
  WARNING: MISSING OR CORRUPTED CONTENT DETECTED
  Corrupted or Missing Rpm: 1000/104583
  Corrupted or missing content has been detected, you can examine the list of content in /tmp/unmigratable_content-20211025-74422-16cxfae and take action by either:
  1. Performing a 'Verify Checksum' sync under Advanced Sync Options, let it complete, and re-running the migration
  2. Deleting/disabling the affected repositories and running orphan cleanup (foreman-rake katello:delete_orphaned_content) and re-running the migration.
  3. Manually correcting files on the filesystem in /var/lib/pulp/content/ and re-running the migration
  4. Mark currently corrupted or missing content as skipped (foreman-rake katello:approve_corrupted_migration_content). This will skip migration of missing or corrupted content.</pre>
</div>
</div>
<div class="paragraph">
<p>There are several causes of corrupted or missing content:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A Repository synchronization or Content View publish or promotion occurred during the migration.</p>
</li>
<li>
<p>Files on disk in <code>/var/lib/pulp/content/</code> became corrupted due to disk rot.</p>
</li>
<li>
<p>Files in <code>/var/lib/pulp/content/</code> are missing due to past events such as disk loss with a partial restore.</p>
</li>
<li>
<p>There is some mismatch between subsystems in orcharhino such as Katello and Pulp.
This can happen if a repository or content view is improperly deleted by skipping steps in a paused orcharhino Task.
Running <code>foreman-rake katello:correct_repositories COMMIT=true</code> can correct this.</p>
<div class="paragraph">
<p>You can review the list of corrupt or missing RPMs written to disk as part of the <code>foreman-maintain content migration-stats command</code>, <code>/tmp/unmigratable_content-20211025-74422-16cxfae20211120-2149-1j4pmfae</code> in the example above.</p>
</div>
<div class="paragraph">
<p>For more information about determining which repository the unmigratable contents belong to, see <a href="https://access.redhat.com/solutions/6629271">How to determine the repository to run Verify Checksum on for reported corrupted RPMs</a>.</p>
</div>
<div class="paragraph">
<p>In most cases, where repositories with unmigratable contents are configured on orcharhino with the <strong>On-demand</strong> download policy and the number of missing or corrupt RPMs are low, you can mark these as skipped using the command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># foreman-rake katello:approve_corrupted_migration_content</pre>
</div>
</div>
<div class="paragraph">
<p>If you approve corrupted or missing content and proceed with the upgrade, that content will not appear in the repositories or content view versions after upgrade.</p>
</div>
<div class="paragraph">
<p>If these packages exist in the upstream repositories, they are added again when you re-synchronize the repositories after upgrade.
They are not restored to the Content Views unless you republish those Content Views.
As these packages are likely unusable, the upgrade process only detects that fact.</p>
</div>
<div class="paragraph">
<p>If you suspect a Repository synchronization or Content View publish or promotion occurred during the migration, re-running <code>foreman-maintain content prepare</code> migrates the remaining content.
If this is the first time you have run <code>foreman-maintain content prepare</code>, ATIX AG recommends running it as often as necessary to try to reduce the number of corrupt or missing RPMs.
Migrating the remaining content then takes less time.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>You cannot use <strong><code>Ctrl</code> + <code>C</code></strong> to terminate the <code>foreman-maintain content prepare</code> process.
If you attempt to halt the process using <strong><code>Ctrl</code> + <code>C</code></strong> or by disconnecting your SSH session, the process does not terminate but continues in the background.
You can use the following command to terminate the process gracefully, whenever necessary, so that you can continue later.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># foreman-maintain content prepare-abort</pre>
</div>
</div>
<div class="paragraph">
<p>Note that <code>foreman-maintain content prepare-abort</code> can take several minutes to terminate the process.
You can continue the migration process using <code>foreman-maintain content prepare</code> whenever it is convenient.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>The process does not confirm that migration is complete.
You can determine how near to completion the process is by using the following command:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># foreman-maintain content migration-stats</pre>
</div>
</div>
<div class="paragraph">
<p>at intervals until the indicated migration time is at or near zero.</p>
</div>
</li>
<li>
<p>The final steps of Pulp content migration are completed when upgrading orcharhino server from 2.4 to 2.1.3.</p>
</li>
</ol>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>If problems occur, you can restart the pre-migration process from the beginning using the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># foreman-maintain content migration-reset</pre>
</div>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>+
. The final steps of Pulp content migration are completed when upgrading orcharhino server from 2.4 to 2.1.3.</p>
</div>
</div>
<div class="sect3">
<h4 id="upgrading_a_connected_satellite_server">2.1.2. Upgrading a Connected orcharhino server</h4>
<div class="paragraph">
<p>Use this procedure for a orcharhino server with access to the public internet</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
If you customize configuration files, manually or using a tool such as Hiera, these changes are overwritten when the installation script runs during upgrading or updating. You can use the <code>--noop</code> option with the foreman-installer script to test for changes. For more information, see the Red Hat Knowledgebase solution <a href="https://access.redhat.com/solutions/3351311">How to use the noop option to check for changes in orcharhino config files during an upgrade.</a>
</td>
</tr>
</table>
</div>
<div class="olist arabic">
<div class="title">Upgrade orcharhino server</div>
<ol class="arabic">
<li>
<p>Create a backup.</p>
<div class="ulist">
<ul>
<li>
<p>On a virtual machine, take a snapshot.</p>
</li>
<li>
<p>On a physical machine, create a backup.</p>
</li>
</ul>
</div>
</li>
</ol>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated Apr 2023
</div>
</div>
</body>
</html>