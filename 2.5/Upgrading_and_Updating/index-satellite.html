<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.17">
<title>Upgrading and Updating Red&#160;Hat Satellite</title>
<link rel="stylesheet" href="./satellite.css">
<!-- docinfo -->
</head>
<body class="book">
    <div id="wrap">
      <script src="/js/versions.js"></script>
      <script src="/js/nav.js"></script>
      <script>
        document.open();
        document.write(buildNavigation());
        addNavbarListeners();
        document.close();
      </script>
    </div>
<div id="header">
<h1>Upgrading and Updating Red&#160;Hat Satellite</h1>
</div>
<div id="content">
<div class="sect1">
<h2 id="upgrading_process_overview">1. Upgrade Overview</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This chapter details the prerequisites and available upgrade paths to Red&#160;Hat Satellite 6.10. Review this information before upgrading your current Red&#160;Hat Satellite&#160;6 installation.</p>
</div>
<div class="paragraph">
<p>In this guide, the terms update, upgrade, and migrate have the following meanings:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Upgrading</dt>
<dd>
<p>The process of advancing your Satellite&#160;Server and Capsule&#160;Server installations from a y-stream release to the next, for example Satellite 6.9 to Satellite 6.10.</p>
</dd>
<dt class="hdlist1">Updating</dt>
<dd>
<p>The process of advancing your Satellite&#160;Server and Capsule&#160;Server installations from a z-stream release to the next, for example Satellite 6.10.0 to Satellite 6.10.1.</p>
</dd>
<dt class="hdlist1">Migrating</dt>
<dd>
<p>The process of moving an existing Satellite installation to another Red&#160;Hat Enterprise&#160;Linux server.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>For interactive upgrade instructions, you can also use the Red&#160;Hat Satellite Upgrade Helper on the Red&#160;Hat Customer Portal. This application provides you with an exact guide to match your current version number. You can find instructions that are specific to your upgrade path, as well as steps to prevent known issues. For more information, see <a href="https://access.redhat.com/labs/satelliteupgradehelper/">Satellite Upgrade Helper</a> on the customer portal.</p>
</div>
<div class="paragraph">
<p>Note that you can upgrade Capsules separately from Satellite. For more information, see <a href="#upgrading_capsules-separately-from-satellite_upgrade-guide">Upgrading Capsules Separately from Satellite</a>.</p>
</div>
<div class="sect2">
<h3 id="upgrading_prerequisites">1.1. Prerequisites</h3>
<div class="paragraph">
<p>Upgrading to Satellite 6.10 affects your entire Satellite infrastructure. Before proceeding, complete the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Read the <a href="https://access.redhat.com/documentation/en-us/red_hat_satellite/6.10/html/release_notes/index">Release Notes</a>.</p>
</li>
<li>
<p>Review this guide so that you are aware of the upgrade process and its impact.</p>
</li>
<li>
<p>Plan your upgrade path. For more information, see <a href="#upgrade_paths">Upgrade Paths</a>.</p>
</li>
<li>
<p>Plan for the required downtime. Satellite services are shut down during the upgrade. The upgrade process duration might vary depending on your hardware configuration, network speed, and the amount of data that is stored on the server.</p>
<div class="paragraph">
<p>Upgrading Satellite takes approximately 1 - 2 hours.</p>
</div>
<div class="paragraph">
<p>Upgrading Capsule takes approximately 10 - 30 minutes.</p>
</div>
<div class="paragraph">
<p>However, upgrading from 6.9 to 6.10 also migrates Pulp content, this step can take some considerable time.
For more information on preparing for Pulp migration and the upgrade process, see <a href="#Upgrading_Server_upgrade-guide">Upgrading Satellite&#160;Server</a>.</p>
</div>
</li>
<li>
<p>Ensure that you have sufficient storage space on your server. For more information, see <a href="https://access.redhat.com/documentation/en-us/red_hat_satellite/6.10/html-single/installing_satellite_server_from_a_connected_network/index#preparing-environment-for-satellite-installation">Preparing your Environment for Installation</a> in <em>Installing Satellite&#160;Server from a Connected Network</em> and <a href="https://access.redhat.com/documentation/en-us/red_hat_satellite/6.10/html-single/installing_capsule_server/index#preparing-environment-for-capsule-installation">Preparing your Environment for Installation</a> in <em>Installing Capsule&#160;Server</em>.</p>
</li>
<li>
<p>Back up your Satellite&#160;Server and all Capsule&#160;Servers. For more information, see <a href="https://access.redhat.com/documentation/en-us/red_hat_satellite/6.10/html-single/administering_red_hat_satellite/index##backing-up-satellite-server-and-capsule-server">Backing Up Satellite&#160;Server and Capsule&#160;Server</a> in the <em>Administering Red&#160;Hat Satellite 6.9</em> guide.</p>
</li>
<li>
<p>Plan for updating any scripts you use that contain Satellite API commands because some API commands differ between versions of Satellite. For more information about changes in the API, see the Knowledgebase article <a href="https://access.redhat.com/articles/4396911">API Changes Between Satellite Versions</a> on the Red&#160;Hat Customer Portal.</p>
</li>
</ul>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
If you customize configuration files, manually or use a tool such as Hiera, these customizations are overwritten when the installation script runs during upgrading or updating. You can use the <code>--noop</code> option with the satellite-installer script to test for changes. For more information, see the Red Hat Knowledgebase solution <a href="https://access.redhat.com/solutions/3351311">How to use the noop option to check for changes in Satellite config files during an upgrade.</a>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="upgrade_paths">1.2. Upgrade Paths</h3>
<div class="paragraph">
<p>You can upgrade to Red&#160;Hat Satellite 6.10 from Red&#160;Hat Satellite 6.9. Satellite&#160;Servers and Capsule&#160;Servers on earlier versions must first be upgraded to Satellite 6.9. For more details, see the Satellite 6.9 <a href="https://access.redhat.com/documentation/en-us/red_hat_satellite/6.9/html/upgrading_and_updating_red_hat_satellite/">Upgrading and Updating Red&#160;Hat Satellite</a> guide.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/satellite_6.4_upgrade_paths.png" alt="Overview of Satellite 6.10 Upgrade Paths">
</div>
<div class="title">Figure 1. Overview of Satellite 6.10 Upgrade Paths</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
Upgrading from the Beta to GA version is not supported.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The high level steps in upgrading to Satellite 6.10 are as follows.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Clone your existing Satellite&#160;Servers. For more information, see <a href="#cloning_satellite_server">Cloning Satellite&#160;Server</a>.</p>
</li>
<li>
<p>Upgrade Satellite&#160;Server and all Capsule&#160;Servers to Satellite 6.10. For more information, see <a href="#Upgrading_Server_upgrade-guide">Upgrading Satellite&#160;Server</a>.</p>
</li>
<li>
<p>Upgrade to Satellite Tools 6.10 on all Satellite clients. For more information, see <a href="#upgrading_clients">Upgrading Satellite Clients</a>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<div class="title">Considerations for Upgrades of Satellite to Future Versions</div>
<p>Before you begin the upgrade to Satellite 6.10, which includes an upgrade to Pulp 3 on Satellite&#160;Servers, it is highly recommended that you complete pre-migration of Pulp content.
If you perform no migrations on 6.9, they will all be performed during the upgrade to 6.10.
For smaller content setups, or if you can afford longer downtimes, you can proceed without the pre-migration.</p>
</div>
<div class="paragraph">
<p>For Capsules, you can choose to deploy new 6.10 Capsules rather than to upgrade.</p>
</div>
<div class="paragraph">
<p>For future upgrades following Satellite 6.11, you will be required to upgrade the operating system from RHEL 7 to RHEL 8 on your Satellite&#160;Servers and Capsules.
You can upgrade the operating system in-place or through a cloning process. The latter includes migration of all data, configuration, and synced content.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>If you are planning to avoid the upgrade from Pulp 2 to Pulp 3 and deploy a new Satellite 6.10 infrastructure due to the Pulp 3 changes instead, you might want to wait for Satellite 6.11 to deploy with RHEL 8 directly.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="following_the_progress_of_the_upgrade">1.3. Following the Progress of the Upgrade</h3>
<div class="paragraph">
<p>Because of the lengthy upgrade time, use a utility such as <code>screen</code> to suspend and reattach a communication session. You can then check the upgrade progress without staying connected to the command shell continuously. For more information about using the screen command, see <a href="https://access.redhat.com/articles/5247">How do I use the screen command?</a> article in the <em>Red&#160;Hat Knowledge&#160;Base</em>. You can also see the <code>screen</code> manual page for more information.</p>
</div>
<div class="paragraph">
<p>If you lose connection to the command shell where the upgrade command is running you can see the logs in <code>/var/log/foreman-installer/satellite.log</code> to check if the process completed successfully.</p>
</div>
</div>
<div class="sect2">
<h3 id="upgrading_capsules-separately-from-satellite_upgrade-guide">1.4. Upgrading Capsules Separately from Satellite</h3>
<div class="paragraph">
<p>You can upgrade Satellite to version 6.10 and keep Capsules at version 6.9 until you have the capacity to upgrade them too.</p>
</div>
<div class="paragraph">
<p>All the functionality that worked previously works on 6.9 Capsules. However, the functionality added in the 6.10 release will not work until you upgrade Capsules to 6.10.</p>
</div>
<div class="paragraph">
<p>Upgrading Capsules after upgrading Satellite can be useful in the following example scenarios:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>If you want to have several smaller outage windows instead of one larger window.</p>
</li>
<li>
<p>If Capsules in your organization are managed by several teams and are located in different locations.</p>
</li>
<li>
<p>If you use a load-balanced configuration, you can upgrade one load-balanced Capsule and keep other load-balanced Capsules at 1 version lower. This allows you to upgrade all Capsules one after another without any outage.</p>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="cloning_satellite_server">2. Cloning Satellite&#160;Server</h2>
<div class="sectionbody">
<div class="paragraph">
<p>When you upgrade Satellite&#160;Server, you can optionally create and upgrade a clone of your Satellite to ensure that you do not lose any data while you upgrade. After your upgrade is complete, you can then decommission the earlier version of Satellite&#160;Server.</p>
</div>
<div class="paragraph">
<p>Use the following procedures to clone your Satellite instances to preserve your environments in preparation for upgrade.</p>
</div>
<div class="paragraph">
<p>The Satellite clone tool does not support migrating a Capsule&#160;Server to Red Hat Enterprise Linux 7.
Instead you must backup the existing Capsule&#160;Server, restore it on Red Hat Enterprise Linux 7, then reconfigure Capsule&#160;Server.</p>
</div>
<div class="paragraph">
<div class="title">Terminology</div>
<p>Ensure that you understand the following terms:</p>
</div>
<div class="paragraph">
<p><strong>Source server</strong>: the server that you clone.</p>
</div>
<div class="paragraph">
<p><strong>Target server</strong>: the new server that you copy files to and clone the source server to.</p>
</div>
<div class="sect2">
<h3 id="sec-Cloning_Workflow_Overview">2.1. Cloning Process Overview</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Back up the source server.</p>
</li>
<li>
<p>Clone the source server to the target server.</p>
</li>
<li>
<p>Power off the source server.</p>
</li>
<li>
<p>Update the network configuration on the target server to match the target server’s IP address with its new host name.</p>
</li>
<li>
<p>Restart <strong>goferd</strong> in Content hosts and Capsules to refresh the connection.</p>
</li>
<li>
<p>Test the new target server.</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="sec-Cloning_Prerequisites">2.2. Prerequisites</h3>
<div class="paragraph">
<p>To clone Satellite&#160;Server, ensure that you have the following resources available:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A minimal install of Red&#160;Hat Enterprise Linux 7 server to become the target server. Do not install Red&#160;Hat Enterprise Linux 7 software groups, or third-party applications. Ensure that your server complies with all the specifications of <a href="https://access.redhat.com/documentation/en-us/red_hat_satellite/6.10/html-single/installing_satellite_server_from_a_connected_network/index#preparing-environment-for-satellite-installation">Preparing your Environment for Installation</a> in <em>Installing Satellite&#160;Server</em>.</p>
</li>
<li>
<p>A backup from Satellite 6.9 that you make using the <code>satellite-maintain backup</code> script. You can use a backup with or without Pulp data.</p>
</li>
<li>
<p>A Satellite subscription for the target server.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Before you begin cloning, ensure the following conditions exist:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The target server is on an isolated network. This avoids unwanted communication with Capsule&#160;Servers and hosts.</p>
</li>
<li>
<p>The target server has the capacity to store all your backup files from the source server.</p>
</li>
</ul>
</div>
<div class="paragraph">
<div class="title">Customized configuration files</div>
<p>If you have any customized configurations on your source server that are not managed by the <code>satellite-installer</code> tool or Satellite backup process, you must manually back up these files.</p>
</div>
</div>
<div class="sect2">
<h3 id="sec-Pulp_Data_Considerations">2.3. Pulp Data Considerations</h3>
<div class="paragraph">
<p>You can clone Satellite server without including Pulp data. However, for your cloned environment to work, you do require Pulp data. If the target server does not have Pulp data. it is not a fully working Satellite.</p>
</div>
<div class="paragraph">
<p>To transfer Pulp data to a target server, you have two options:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Clone using backup with Pulp data</p>
</li>
<li>
<p>Clone using backup without Pulp data and copy <code>/var/lib/pulp</code> manually from the source server.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>If your <code>pulp_data.tar</code> file is greater than 500 GB, or if you use a slow storage system, such as NFS, and your <code>pulp_data.tar</code> file is greater than 100 GB, do not include <code>pulp_data.tar</code> in the backup because this can cause memory errors during extraction. Copy the <code>pulp_data.tar</code> file from the source server to the target server.</p>
</div>
<div class="paragraph">
<div class="title">To back up without Pulp data</div>
<p>Follow the steps in the procedure in <a href="#sec_Cloning_Satellite_Server">Cloning Satellite&#160;Server</a> and replace the steps that involve cloning with Pulp data with the following steps:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Perform a backup with PostgreSQL databases active excluding the Pulp data:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># satellite-maintain backup offline --skip-pulp-content \
--assumeyes /var/backup</pre>
</div>
</div>
</li>
<li>
<p>Stop and disable the <code>satellite-maintain</code> services</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># satellite-maintain service stop
# satellite-maintain service disable</pre>
</div>
</div>
</li>
<li>
<p>Copy the Pulp data to the target server:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># rsync --archive --partial --progress --compress \
/var/lib/pulp <em>target_server.example.com:/var/lib/pulp</em></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>Proceed to <a href="#sec-Cloning_to_Target">Cloning to the Target Server</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="sec_Cloning_Satellite_Server">2.4. Cloning Satellite&#160;Server</h3>
<div class="paragraph">
<p>Use the following procedures to clone Satellite&#160;Server. Note that because of the high volume of data that you must copy and transfer as part of these procedures, it can take a significant amount of time to complete.</p>
</div>
<div class="sect3">
<h4 id="sec-Preparing_Source_Server">2.4.1. Preparing the source server for cloning</h4>
<div class="paragraph">
<p>On the source server, complete the following steps:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Verify the Pool ID of your Satellite subscription:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># subscription-manager list --consumed \
--matches 'Red&#160;Hat Satellite'|grep "<em>Pool ID</em>:"|awk '{print $3}'</pre>
</div>
</div>
<div class="paragraph">
<p>Note the <em>Pool ID</em> for later use.</p>
</div>
</li>
<li>
<p>Remove the Red&#160;Hat Satellite subscription:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># subscription-manager remove --serial=$(subscription-manager list \
--consumed \
--matches 'Red&#160;Hat Satellite'|grep "Serial:"|awk '{print $2}')</pre>
</div>
</div>
</li>
<li>
<p>Determine the size of the Pulp data:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># du -sh /var/lib/pulp/</pre>
</div>
</div>
</li>
<li>
<p>If you have less than 500 GB of Pulp data, perform a backup with PostgreSQL databases active including the Pulp data.
If you have more than 500 GB of Pulp data, skip the following steps and complete the steps in <a href="#sec-Pulp_Data_Considerations">Pulp Data Considerations</a> before you continue.</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># satellite-maintain backup offline --assumeyes /var/backup</pre>
</div>
</div>
</li>
<li>
<p>Stop and disable the <code>satellite-maintain</code> services:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># satellite-maintain service stop
# satellite-maintain service disable</pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>Proceed to <a href="#sec-Cloning_to_Target">Cloning to the Target Server</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="sec-Cloning_to_Target">2.4.2. Cloning to the Target Server</h4>
<div class="paragraph">
<p>To clone your server, complete the following steps on your target server:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>The <code>satellite-clone</code> tool defaults to using <code>/backup/</code> as the backup folder. If you copy to a different folder, update the <code>backup_dir</code> variable in the <code>/etc/satellite-clone/satellite-clone-vars.yml</code> file.</p>
</li>
<li>
<p>Place the backup files from the source Satellite in the <code>/backup/</code> folder on the target server. You can either mount the shared storage or copy the backup files to the <code>/backup/</code> folder on the target server.</p>
</li>
<li>
<p>Power off the source server.</p>
</li>
<li>
<p>Enter the following commands to register to the Customer Portal, attach subscriptions, and enable only the required subscriptions:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># subscription-manager register <em>your_customer_portal_credentials</em>
# subscription-manager attach --pool=<em>pool_ID</em>
# subscription-manager repos --disable=*
# subscription-manager repos \
--enable=rhel-7-server-rpms \
--enable=rhel-server-rhscl-7-rpms \
--enable=rhel-7-server-satellite-maintenance-6-rpms \
--enable=rhel-7-server-satellite-6.9-rpms</pre>
</div>
</div>
</li>
<li>
<p>Install the <code>satellite-clone</code> package:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># yum install satellite-clone</pre>
</div>
</div>
<div class="paragraph">
<p>After you install the <code>satellite-clone</code> tool, you can adjust any configuration to suit your own deployment in the <code>/etc/satellite-clone/satellite-clone-vars.yml</code> file.</p>
</div>
</li>
<li>
<p>Run the <code>satellite-clone</code> tool:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># satellite-clone</pre>
</div>
</div>
</li>
<li>
<p>Reconfigure DHCP, DNS, TFTP, and remote execution services.
The cloning process disables these services on the target Satellite&#160;Server to avoid conflict with the source Satellite&#160;Server.</p>
</li>
<li>
<p>Reconfigure and enable DHCP, DNS, and TFTP in the Satellite web UI. For more information, see <a href="https://access.redhat.com/documentation/en-us/red_hat_satellite/6.10/html-single/installing_satellite_server_from_a_connected_network/index#configuring-external-services">Configuring External Services on Satellite&#160;Server</a> in <em>Installing Satellite&#160;Server</em>.</p>
</li>
<li>
<p>Enable remote execution:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># satellite-installer --scenario satellite \
--enable-foreman-plugin-remote-execution \
--enable-foreman-proxy-plugin-remote-execution-ssh</pre>
</div>
</div>
</li>
<li>
<p>Log on to the Satellite web UI, with the username <code>admin</code> and the password <code>changeme</code>. Immediately update the admin password to secure credentials.</p>
</li>
<li>
<p>Ensure that the correct organization is selected.</p>
</li>
<li>
<p>Navigate to <strong>Content</strong> &gt; <strong>Subscriptions</strong>, then click <strong>Manage Manifest</strong>.</p>
</li>
<li>
<p>Click the <strong>Refresh</strong> button, then click <strong>Close</strong> to return to the list of subscriptions.</p>
</li>
<li>
<p>Verify that the available subscriptions are correct.</p>
</li>
<li>
<p>Follow the instructions in the <code>/usr/share/satellite-clone/logs/reassociate_capsules.txt</code> file to restore the associations between Capsules and their lifecycle environments.</p>
</li>
<li>
<p>Update your network configuration, for example, DNS, to match the target server’s IP address with its new host name.
The <code>satellite-clone</code> tool changes the host name to the source server&#8217;s host name.
If you want to change the host name to something different, you can use the <code>satellite-change-hostname</code> tool.
For more information, see <a href="https://access.redhat.com/documentation/en-us/red_hat_satellite/6.10/html-single/administering_red_hat_satellite/index#sect-Administering-Renaming_a_Server">Renaming a Satellite or Capsule&#160;Server</a> in <em>Administrating Red&#160;Hat Satellite</em>.</p>
</li>
<li>
<p>If the source server uses the <code>virt-who</code> daemon, install and configure it on the target server.
Copy all the <code>virt-who</code> configuration files in the <code>/etc/virt-who.d/</code> directory from the source server to the same directory on the target server.
For more information, see <a href="https://access.redhat.com/documentation/en-us/red_hat_satellite/6.10/html-single/configuring_virtual_machine_subscriptions_in_red_hat_satellite/index"><em>Configuring Virtual Machine Subscriptions in Red&#160;Hat Satellite</em></a>.
After you perform an upgrade using the following chapters, you can safely decommission the source server.</p>
</li>
</ol>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_upgrading_redhat_satellite">3. Upgrading Red&#160;Hat Satellite</h2>
<div class="sectionbody">
<div id="introduction_upgrading_satellite" class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
If you have Satellite&#160;6 installed in a high availability configuration, contact Red&#160;Hat Support before upgrading to Satellite 6.10.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Use the following procedures to upgrade your existing Red&#160;Hat Satellite to Red&#160;Hat Satellite 6.10:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="#Upgrading_Server_upgrade-guide">Upgrading Satellite&#160;Server</a></p>
</li>
<li>
<p><a href="#synchronizing_the_new_repositories">Synchronizing the New Repositories</a></p>
</li>
<li>
<p><a href="#upgrading_capsule_server">Upgrading Capsule&#160;Servers</a></p>
</li>
<li>
<p><a href="#upgrading_clients">Upgrading Satellite Clients</a></p>
</li>
<li>
<p><a href="#post-upgrade_tasks">[post-upgrade_tasks]</a></p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Before upgrading, see <a href="#upgrading_prerequisites">Prerequisites</a>.</p>
</div>
<div class="sect2">
<h3 id="Upgrading_Server_upgrade-guide">3.1. Upgrading Satellite&#160;Server</h3>
<div class="paragraph">
<p>This section describes how to upgrade Satellite&#160;Server from 6.9 to 6.10.</p>
</div>
<div class="paragraph">
<p>Update your Satellite&#160;Server 6.9 to the latest 6.9.z release before proceeding.
You can use the following command to update to the latest z-stream.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># satellite-maintain upgrade run --target-version 6.9.z</pre>
</div>
</div>
<div class="paragraph">
<p>Ensure that you have updated to the latest z-stream before upgrading to 6.10. For more information about updating Satellite&#160;Server, see <a href="#updating_satellite_server_to_next_minor_version">Updating Satellite&#160;Server</a>.</p>
</div>
<div class="paragraph">
<p>Although the process of upgrading from 6.9 to 6.10 also migrates Pulp content, this can take some considerable time.
You can reduce this time by following the procedure in <a href="#preparing_to_migrate_pulp_content">Preparing to Migrate Content to Pulp 3</a></p>
</div>
<div class="paragraph">
<p>If you have not pre-migrated content from Pulp 2 to Pulp 3, you must upgrade to the latest version of Satellite&#160;Server before starting to migrate Pulp content.</p>
</div>
<div id="upgrading_satellite_server_prerequisites" class="ulist">
<div class="title">Before You Begin</div>
<ul>
<li>
<p>Note that you can upgrade Capsules separately from Satellite.
For more information, see <a href="#upgrading_capsules-separately-from-satellite_upgrade-guide">Upgrading Capsules Separately from Satellite</a>.</p>
</li>
<li>
<p>Review and update your firewall configuration prior to upgrading your Satellite&#160;Server.
For more information, see <a href="https://access.redhat.com/documentation/en-us/red_hat_satellite/6.10/html-single/installing_satellite_server_from_a_connected_network/index#preparing-environment-for-satellite-installation">Preparing your environment for installation</a> in <em>Installing Satellite&#160;Server</em>.</p>
</li>
<li>
<p>Ensure that you do not delete the manifest from the Customer Portal or in the Satellite web UI because this removes all the entitlements of your content hosts.</p>
</li>
<li>
<p>Back up and remove all Foreman hooks before upgrading.
Restore any hooks only after Satellite is known to be working after the upgrade is complete.
Note that Foreman Hooks functionality is deprecated and will be removed in the next Satellite version.</p>
</li>
<li>
<p>If you have edited any of the default templates, back up the files either by cloning or exporting them.
Cloning is the recommended method because that prevents them being overwritten in future updates or upgrades.
To confirm if a template has been edited, you can view its <strong>History</strong> before you upgrade or view the changes in the audit log after an upgrade.
In the Satellite web UI, navigate to <strong>Monitor</strong> &gt; <strong>Audits</strong> and search for the template to see a record of changes made.
If you use the export method, restore your changes by comparing the exported template and the default template, manually applying your changes.</p>
</li>
<li>
<p>Pulp content migration occurs at 6.9, before the upgrade to 6.10.</p>
</li>
<li>
<p>Ensure there is sufficient storage space for <code>/var/lib/pulp/published</code> to double in size before starting the migration process.
Check the size of <code>/var/lib/pulp/published</code> with:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># du -sh /var/lib/pulp/published/</pre>
</div>
</div>
</li>
<li>
<p>Content migration can be run online, but uses processor, disk, and memory resources.
Sync and content view publishing operations might take longer as a result.</p>
</li>
<li>
<p>If you have not pre-migrated Pulp content, the <code>PULP_CONTENT_PREMIGRATION_BATCH_SIZE</code> setting defines the number of content units processed at the same time.
It affects the amount of RAM used and the I/O load.
The lower the value, the longer <code>satellite-maintain content prepare</code> takes to complete.
The upgrade downtime is also longer if you have content left to migrate at that point.</p>
<div class="ulist">
<ul>
<li>
<p>The default value is 1000.</p>
</li>
<li>
<p>If the system has a hard disk drive, or there are concerns about I/O load, the recommended value is 50.</p>
</li>
<li>
<p>A lower value is not recommended.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Use the following method to set <code>PULP_CONTENT_PREMIGRATION_BATCH_SIZE</code>:</p>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Create a directory and file:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ mkdir /etc/systemd/system/pulpcore-worker@.service.d/
$ vi  /etc/systemd/system/pulpcore-worker@.service.d/settings.conf</pre>
</div>
</div>
<div class="paragraph">
<p>with contents:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">[Service]
User=pulp
Environment=PULP_CONTENT_PREMIGRATION_BATCH_SIZE=1000</pre>
</div>
</div>
</li>
<li>
<p>Restart the <code>satellite-maintain</code> services using:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># systemctl daemon-reload
# satellite-maintain service restart</pre>
</div>
</div>
<div class="paragraph">
<p>For further information, see <a href="#preparing_to_migrate_pulp_content">Preparing to Migrate Content to Pulp 3</a>.</p>
</div>
</li>
</ol>
</div>
</li>
</ul>
</div>
<div class="ulist">
<div class="title">Capsule Considerations</div>
<ul>
<li>
<p>If you use Content Views to control updates to a Capsule&#160;Server’s base operating system, or for Capsule&#160;Server repository, you must publish updated versions of those Content Views.</p>
</li>
<li>
<p>Note that Satellite&#160;Server upgraded from 6.9 to 6.10 can use Capsule&#160;Servers still at 6.9.</p>
</li>
</ul>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
<div class="paragraph">
<p>If you implemented custom certificates, you must retain the content of both the <code>/root/ssl-build</code> directory and the directory in which you created any source files associated with your custom
certificates.</p>
</div>
<div class="paragraph">
<p>Failure to retain these files during an upgrade causes the upgrade to fail.
If these files have been deleted, they must be restored from a backup in order for the upgrade to proceed.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="ulist">
<div class="title">Upgrade Scenarios</div>
<ul>
<li>
<p>To upgrade a Satellite&#160;Server connected to the Red&#160;Hat Content Delivery Network, proceed to <a href="#upgrading_a_connected_satellite_server">Upgrading a Connected Satellite&#160;Server</a>.</p>
</li>
<li>
<p>To upgrade a Satellite&#160;Server not connected to the Red&#160;Hat Content Delivery Network, proceed to <a href="#upgrading_a_disconnected_satellite">Upgrading a Disconnected Satellite&#160;Server</a>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>You cannot upgrade a self-registered Satellite. You must migrate a self-registered Satellite to the Red Hat Content Delivery Network (CDN) and then perform the upgrade. To migrate a self-registered Satellite to the CDN, see <a href="https://access.redhat.com/documentation/en-us/red_hat_satellite/6.10/html-single/upgrading_and_updating_red_hat_satellite/upgrading_red_hat_satellite#migrating_a_self_registered_satellite">Migrating Self-Registered Satellites</a> in the <em>Satellite&#160;6.10 Upgrading and Updating Red&#160;Hat Satellite</em> guide.</p>
</div>
<div class="paragraph">
<div class="title">FIPS mode</div>
<p>You cannot upgrade Satellite&#160;Server from a RHEL base system that is not operating in FIPS mode to a RHEL base system that is operating in FIPS mode.</p>
</div>
<div class="paragraph">
<p>To run Satellite&#160;Server on a Red&#160;Hat Enterprise Linux base system operating in FIPS mode, you must install Satellite on a freshly provisioned RHEL base system operating in FIPS mode.
For more information, see <a href="https://access.redhat.com/documentation/en-us/red_hat_satellite/6.10/html-single/installing_satellite_server_from_a_connected_network/index#preparing-environment-for-satellite-installation">Preparing your environment for installation</a> in <em>Installing Satellite&#160;Server</em>.</p>
</div>
<div class="sect3">
<h4 id="preparing_to_migrate_pulp_content">3.1.1. Preparing to Migrate Content to Pulp 3</h4>
<div class="paragraph">
<p>The time to prepare content for Pulp 3 depends on the amount of content and the number of Content Views.
For large systems, this can mean several days of downtime.
To prevent this, pre-migrate Pulp content while running the latest version of Satellite&#160;Server 6.9.
This reduces the overall upgrade downtime.</p>
</div>
<div class="paragraph">
<p>During migration to Pulp3, the amount of data stored in the <code>/var/lib/pulp/published/</code> directory can double in size.
Ensure that there is enough space on the <code>/var/lib/pulp</code> volume.
If the user runs <code>satellite-maintain prep-6.10-upgrade</code>, the content in <code>/var/lib/pulp/content</code> does not need to be duplicated.
After Pulp2 is removed, the extra space can be claimed back, however, shrinking of XFS volumes is not possible and copying data to a different partition might be necessary in order to bring volume size down to the previous value.</p>
</div>
<div class="paragraph">
<p>During migration to Pulp 3, the amount of data stored in the PostgreSQL data directory can grow significantly.
Ensure that you have enough space for the migration.
A rough estimation of the space you require is 2-3 times the size of the MongoDB Pulp 2 database.</p>
</div>
<div class="paragraph">
<div class="title">Pre-Migration Checks</div>
<p>The sequence should always be if you have any Composite Content Views, take action on those first, and then work on the Content Views.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Ensure that all enabled repositories complete the synchronization process.</p>
</li>
<li>
<p>If any repositories are synced with a <strong>Warning</strong> or <strong>Error</strong> state, fix the underlying problem and resync the repository.</p>
</li>
<li>
<p>Ensure that no paused tasks in the system are related to any repositories or Content Views.</p>
</li>
<li>
<p>If you no longer require specific Content Views or Composite Content View Versions, you can perform a cleanup action.</p>
</li>
<li>
<p>For more information about how to perform the cleanup, see <a href="https://access.redhat.com/solutions/2760531">How to remove old content view versions in Red Hat Satellite 6 using CLI/hammer?</a> .</p>
</li>
<li>
<p>If some Content View or Composite Content View versions are not required anymore, please consider performing a cleanup of them.</p>
</li>
<li>
<p>For more information about how to perform the cleanup of older Content View or Composite Content View versions using <code>hammer_cli</code>, see <a href="https://access.redhat.com/solutions/2760531">How to remove old content view versions in Red Hat Satellite 6 using CLI/hammer?</a>.</p>
</li>
<li>
<p>If you no longer require or use certain repositories, disable those specific repositories.</p>
</li>
<li>
<p>When the cleanup process finishes, ensure that you clean up the orphan data by following the steps in <a href="https://access.redhat.com/solutions/2639291">How to delete orphaned content in /var/lib/pulp on Capsule?</a>.</p>
</li>
<li>
<p>Ensure that you can enter the following command on Satellite without error:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># foreman-rake katello:correct_repositories COMMIT=true --trace</pre>
</div>
</div>
<div class="paragraph">
<p>Use this procedure to begin migrating content from Pulp 2 to Pulp 3.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Update the file permissions before upgrading Satellite&#160;Server using the following command:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># satellite-maintain prep-6.10-upgrade</pre>
</div>
</div>
<div class="paragraph">
<p>This might take some time on high latency systems.</p>
</div>
</li>
<li>
<p>View details of the content you are pre-migrating using the following command:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># satellite-maintain content migration-stats</pre>
</div>
</div>
<div class="paragraph">
<p>Use this command as often as necessary during the migration process to determine how long the process will take.
It also identifies corrupted or missing content that might cause the migration to fail.
Output is similar to the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">Running Retrieve Pulp 2 to Pulp 3 migration statistics
============================================
Retrieve Pulp 2 to Pulp 3 migration statistics:
============Migration Summary================
Migrated/Total RPMs: 0/367633
Migrated/Total errata: 0/20780140
Migrated/Total repositories: 0/33924
Estimated migration time based on yum content: 47 hours, 23 minutes
Note: ensure there is sufficient storage space for /var/lib/pulp/published to
double in size before starting the migration process.
Check the size of /var/lib/pulp/published with 'du -sh /var/lib/pulp/published/'
Note: ensure there is sufficient storage space for postgresql.
You will need additional space for your postgresql database.
The partition holding '/var/opt/rh/rh-postgresql12/lib/pgsql/data/' will need
additional free space equivalent to the size of your Mongo db database (/var/lib/mongodb/).
[OK]</pre>
</div>
</div>
</li>
<li>
<p>Prepare your content for Pulp migration using the following command:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># satellite-maintain content prepare</pre>
</div>
</div>
<div class="paragraph">
<p>As part of its final step, <code>satellite-maintain content prepare</code> checks whether any content units are unmigrated.
If it identifies corrupted or missing content, you might see something similar to the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">============Missing/Corrupted Content Summary================
  WARNING: MISSING OR CORRUPTED CONTENT DETECTED
  Corrupted or Missing Rpm: 1000/104583
  Corrupted or missing content has been detected, you can examine the list of content in /tmp/unmigratable_content-20211025-74422-16cxfae and take action by either:
  1. Performing a 'Verify Checksum' sync under Advanced Sync Options, let it complete, and re-running the migration
  2. Deleting/disabling the affected repositories and running orphan cleanup (foreman-rake katello:delete_orphaned_content) and re-running the migration.
  3. Manually correcting files on the filesystem in /var/lib/pulp/content/ and re-running the migration
  4. Mark currently corrupted or missing content as skipped (foreman-rake katello:approve_corrupted_migration_content). This will skip migration of missing or corrupted content.</pre>
</div>
</div>
<div class="paragraph">
<p>There are several causes of corrupted or missing content:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A Repository synchronization or Content View publish or promotion occurred during the migration.</p>
</li>
<li>
<p>Files on disk in <code>/var/lib/pulp/content/</code> became corrupted due to disk rot.</p>
</li>
<li>
<p>Files in <code>/var/lib/pulp/content/</code> are missing due to past events such as disk loss with a partial restore.</p>
</li>
<li>
<p>There is some mismatch between subsystems in Satellite such as Katello and Pulp.
This can happen if a repository or content view is improperly deleted by skipping steps in a paused Red&#160;Hat Satellite Task.
Running <code>foreman-rake katello:correct_repositories COMMIT=true</code> can correct this.</p>
<div class="paragraph">
<p>You can review the list of corrupt or missing RPMs written to disk as part of the <code>satellite-maintain content migration-stats command</code>, <code>/tmp/unmigratable_content-20211025-74422-16cxfae20211120-2149-1j4pmfae</code> in the example above.</p>
</div>
<div class="paragraph">
<p>For more information about determining which repository the unmigratable contents belong to, see <a href="https://access.redhat.com/solutions/6629271">How to determine the repository to run Verify Checksum on for reported corrupted RPMs</a>.</p>
</div>
<div class="paragraph">
<p>In most cases, where repositories with unmigratable contents are configured on Satellite with the <strong>On-demand</strong> download policy and the number of missing or corrupt RPMs are low, you can mark these as skipped using the command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># foreman-rake katello:approve_corrupted_migration_content</pre>
</div>
</div>
<div class="paragraph">
<p>If you approve corrupted or missing content and proceed with the upgrade, that content will not appear in the repositories or content view versions after upgrade.</p>
</div>
<div class="paragraph">
<p>If these packages exist in the upstream repositories, they are added again when you re-synchronize the repositories after upgrade.
They are not restored to the Content Views unless you republish those Content Views.
As these packages are likely unusable, the upgrade process only detects that fact.</p>
</div>
<div class="paragraph">
<p>If you suspect a Repository synchronization or Content View publish or promotion occurred during the migration, re-running <code>satellite-maintain content prepare</code> migrates the remaining content.
If this is the first time you have run <code>satellite-maintain content prepare</code>, Red&#160;Hat recommends running it as often as necessary to try to reduce the number of corrupt or missing RPMs.
Migrating the remaining content then takes less time.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>You cannot use <strong><code>Ctrl</code> + <code>C</code></strong> to terminate the <code>satellite-maintain content prepare</code> process.
If you attempt to halt the process using <strong><code>Ctrl</code> + <code>C</code></strong> or by disconnecting your SSH session, the process does not terminate but continues in the background.
You can use the following command to terminate the process gracefully, whenever necessary, so that you can continue later.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># satellite-maintain content prepare-abort</pre>
</div>
</div>
<div class="paragraph">
<p>Note that <code>satellite-maintain content prepare-abort</code> can take several minutes to terminate the process.
You can continue the migration process using <code>satellite-maintain content prepare</code> whenever it is convenient.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>The process does not confirm that migration is complete.
You can determine how near to completion the process is by using the following command:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># satellite-maintain content migration-stats</pre>
</div>
</div>
<div class="paragraph">
<p>at intervals until the indicated migration time is at or near zero.</p>
</div>
</li>
<li>
<p>The final steps of Pulp content migration are completed when upgrading Satellite&#160;Server from 6.9 to 6.10.</p>
</li>
</ol>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>If problems occur, you can restart the pre-migration process from the beginning using the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># satellite-maintain content migration-reset</pre>
</div>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>+
. The final steps of Pulp content migration are completed when upgrading Satellite&#160;Server from 6.9 to 6.10.</p>
</div>
</div>
<div class="sect3">
<h4 id="upgrading_a_connected_satellite_server">3.1.2. Upgrading a Connected Satellite&#160;Server</h4>
<div class="paragraph">
<p>Use this procedure for a Satellite&#160;Server with access to the public internet</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
If you customize configuration files, manually or using a tool such as Hiera, these changes are overwritten when the installation script runs during upgrading or updating. You can use the <code>--noop</code> option with the satellite-installer script to test for changes. For more information, see the Red Hat Knowledgebase solution <a href="https://access.redhat.com/solutions/3351311">How to use the noop option to check for changes in Satellite config files during an upgrade.</a>
</td>
</tr>
</table>
</div>
<div class="olist arabic">
<div class="title">Upgrade Satellite&#160;Server</div>
<ol class="arabic">
<li>
<p>Create a backup.</p>
<div class="ulist">
<ul>
<li>
<p>On a virtual machine, take a snapshot.</p>
</li>
<li>
<p>On a physical machine, create a backup.</p>
<div class="paragraph">
<p>For more information about backups, see <a href="https://access.redhat.com/documentation/en-us/red_hat_satellite/6.10/html-single/administering_red_hat_satellite/index##backing-up-satellite-server-and-capsule-server">Backing Up Satellite&#160;Server and Capsule&#160;Server</a> in the <em>Administering Red&#160;Hat Satellite 6.9</em> guide.</p>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>Optional: If you made manual edits to DNS or DHCP configuration in the <code>/etc/zones.conf</code> or <code>/etc/dhcp/dhcpd.conf</code> files, back up the configuration files because the installer only supports one domain or subnet, and therefore restoring changes from these backups might be required.</p>
</li>
<li>
<p>Optional: If you made manual edits to DNS or DHCP configuration files and do not want to overwrite the changes, enter the following command:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># satellite-installer --foreman-proxy-dns-managed=false \
--foreman-proxy-dhcp-managed=false</pre>
</div>
</div>
</li>
<li>
<p>In the Satellite web UI, navigate to <strong>Hosts</strong> &gt; <strong>Discovered hosts</strong>. On the Discovered Hosts page, power off and then delete the discovered hosts. From the <strong>Select an Organization</strong> menu, select each organization in turn and repeat the process to power off and delete the discovered hosts. Make a note to reboot these hosts when the upgrade is complete.</p>
</li>
<li>
<p>Ensure that the <code>apache::purge_configs: false</code> entry is either not present or commented out in the <code>/etc/foreman-installer/custom-hiera.yaml</code> file of the Satellite 6.9/Capsule 6.9 servers which will be upgraded to 6.10.</p>
</li>
<li>
<p>Ensure that the Satellite Maintenance repository is enabled:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># subscription-manager repos --enable \
rhel-7-server-satellite-maintenance-6-rpms</pre>
</div>
</div>
</li>
<li>
<p>Check the available versions to confirm the version you want is listed:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># satellite-maintain upgrade list-versions</pre>
</div>
</div>
</li>
<li>
<p>Use the health check option to determine if the system is ready for upgrade. When prompted, enter the hammer admin user credentials to configure <code>satellite-maintain</code> with hammer credentials. These changes are applied to the <code>/etc/foreman-maintain/foreman-maintain-hammer.yml</code> file.</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># satellite-maintain upgrade check --target-version 6.10</pre>
</div>
</div>
<div class="paragraph">
<p>Review the results and address any highlighted error conditions before performing the upgrade.</p>
</div>
</li>
<li>
<p>Because of the lengthy upgrade time, use a utility such as <code>screen</code> to suspend and reattach a communication session. You can then check the upgrade progress without staying connected to the command shell continuously. For more information about using the screen command, see <a href="https://access.redhat.com/articles/5247">How do I use the screen command?</a> article in the <em>Red&#160;Hat Knowledge&#160;Base</em>.</p>
<div class="paragraph">
<p>If you lose connection to the command shell where the upgrade command is running you can see the logged messages in the <code>/var/log/foreman-installer/satellite.log</code> file to check if the process completed successfully.</p>
</div>
</li>
<li>
<p>Perform the upgrade:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># satellite-maintain upgrade run --target-version 6.10</pre>
</div>
</div>
</li>
<li>
<p>Check when the kernel packages were last updated:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># rpm -qa --last | grep kernel</pre>
</div>
</div>
</li>
<li>
<p>Optional: If a kernel update occurred since the last reboot, reboot the system:</p>
<div class="listingblock">
<div class="content">
<pre># reboot</pre>
</div>
</div>
</li>
<li>
<p>If using a BASH shell, after a successful or failed upgrade, enter:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># hash -d satellite-maintain service 2> /dev/null</pre>
</div>
</div>
</li>
<li>
<p>If you have migrated content from Pulp 2 to Pulp 3, remove all Pulp 2 content.</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># satellite-maintain content remove-pulp2</pre>
</div>
</div>
<div class="paragraph">
<p>This removes Pulp 2 RPMs, content in <code>/var/lib/pulp/content/</code>, the mongo database, and migration content in the Pulp 3 database.</p>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="upgrading_a_disconnected_satellite">3.1.3. Upgrading a Disconnected Satellite&#160;Server</h4>
<div class="paragraph">
<p>Use this procedure if your Satellite&#160;Server is not connected to the Red&#160;Hat Content Delivery Network.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
<div class="ulist">
<ul>
<li>
<p>If you customized configuration files, either manually or using a tool such as Hiera, these changes are overwritten when you enter the <code>satellite-maintain</code> command during upgrading or updating.
You can use the <code>--noop</code> option with the <code>satellite-installer</code> command to review the changes that are applied during upgrading or updating.
For more information, see the Red Hat Knowledgebase solution <a href="https://access.redhat.com/solutions/3351311">How to use the noop option to check for changes in Satellite config files during an upgrade</a>.</p>
</li>
<li>
<p>The hammer import and export commands have been replaced with <code>hammer content-import</code> and <code>hammer content-export</code> tooling.</p>
<div class="paragraph">
<p>If you have scripts that are using <code>hammer content-view version export</code>, <code>hammer content-view version export-legacy</code>, <code>hammer repository export</code>, or their respective import commands, you have to adjust them to use the <code>hammer content-export</code> command instead, along with its respective import command.</p>
</div>
</li>
<li>
<p>If you implemented custom certificates, you must retain the content of both the <code>/root/ssl-build</code> directory and the directory in which you created any source files associated with your custom certificates.</p>
<div class="paragraph">
<p>Failure to retain these files during an upgrade causes the upgrade to fail.
If these files have been deleted, they must be restored from a backup in order for the upgrade to proceed.</p>
</div>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
<div class="ulist">
<div class="title">Before You Begin</div>
<ul>
<li>
<p>Review and update your firewall configuration before upgrading your Satellite&#160;Server.
For more information, see <a href="https://access.redhat.com/documentation/en-us/red_hat_satellite/6.10/html-single/installing_satellite_server_from_a_disconnected_network/index#satellite-ports-and-firewalls-requirements_satellite">Ports and Firewalls Requirements</a> in <em>Installing Satellite&#160;Server from a Disconnected Network</em>.</p>
</li>
<li>
<p>Ensure that you do not delete the manifest from the Customer Portal or in the Satellite Web UI because this removes all the entitlements of your content hosts.</p>
</li>
<li>
<p>Back up and remove all Foreman hooks before upgrading.
Reinstate hooks only after Satellite is known to be working after the upgrade is complete.</p>
</li>
</ul>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
<div class="paragraph">
<p>If you implemented custom certificates, you must retain the content of both the <code>/root/ssl-build</code> directory and the directory in which you created any source files associated with your custom certificates.</p>
</div>
<div class="paragraph">
<p>Failure to retain these files during an upgrade causes the upgrade to fail.
If these files have been deleted, they must be restored from a backup in order for the upgrade to proceed.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="olist arabic">
<div class="title">Upgrade Disconnected Satellite&#160;Server</div>
<ol class="arabic">
<li>
<p>Create a backup.</p>
<div class="ulist">
<ul>
<li>
<p>On a virtual machine, take a snapshot.</p>
</li>
<li>
<p>On a physical machine, create a backup.</p>
</li>
</ul>
</div>
</li>
<li>
<p>A pre-upgrade script is available to detect conflicts and list hosts which have duplicate entries in Satellite&#160;Server that can be unregistered and deleted after upgrade. In addition, it will detect hosts which are not assigned to an organization. If a host is listed under <strong>Hosts</strong> &gt; <strong>All hosts</strong> without an organization association and if a content host with same name has an organization already associated with it then the content host will automatically be unregistered. This can be avoided by associating such hosts to an organization before upgrading.</p>
<div class="paragraph">
<p>Run the pre-upgrade check script to get a list of hosts that can be deleted after upgrading. If any unassociated hosts are found, associating them to an organization before upgrading is recommended.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># foreman-rake katello:upgrade_check</pre>
</div>
</div>
</li>
<li>
<p>Optional: If you made manual edits to DNS or DHCP configuration in the <code>/etc/zones.conf</code> or <code>/etc/dhcp/dhcpd.conf</code> files, back up the configuration files because the installer only supports one domain or subnet, and therefore restoring changes from these backups might be required.</p>
</li>
<li>
<p>Optional: If you made manual edits to DNS or DHCP configuration files and do not want to overwrite the changes, enter the following command:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># satellite-installer --foreman-proxy-dns-managed=false \
--foreman-proxy-dhcp-managed=false</pre>
</div>
</div>
</li>
<li>
<p>Optional: If you use PostgreSQL as an external database, on the PostgreSQL server, install the <code>rh-postgresql12-postgresql-evr</code> package, which is available from the <code>rhel-7-server-satellite-6.10-rpms</code> repository:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># yum install rh-postgresql12-postgresql-evr</pre>
</div>
</div>
</li>
<li>
<p>In the Satellite web UI, navigate to <strong>Hosts</strong> &gt; <strong>Discovered hosts</strong>. If there are discovered hosts available, turn them off and then delete all entries under the <code>Discovered hosts</code> page. Select all other organizations in turn using the organization setting menu and repeat this action as required. Reboot these hosts after the upgrade has completed.</p>
</li>
<li>
<p>Ensure that the <code>apache::purge_configs: false</code> entry is either not present or commented out in the <code>/etc/foreman-installer/custom-hiera.yaml</code> file of the Satellite 6.9/Capsule 6.9 servers which will be upgraded to 6.10.</p>
</li>
<li>
<p>Make sure all external Capsule&#160;Servers are assigned to an organization, otherwise they might get unregistered due to host-unification changes.</p>
</li>
<li>
<p>Remove old repositories:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># rm /etc/yum.repos.d/*</pre>
</div>
</div>
</li>
<li>
<p>Stop the <code>satellite-maintain</code> services.</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># satellite-maintain service stop</pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>For more information with additional steps, see <a href="#updating_satellite_server_to_next_minor_version">Section 5.2 Updating Disconnected Satellite&#160;Server</a>.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Optional: If you have applied custom Apache server configurations, note that the custom configurations are reverted to the installation defaults when you perform the upgrade.</p>
<div class="paragraph">
<p>To preview the changes that are applied during the upgrade, enter the <code>satellite-installer</code> command with the <code>--noop</code> (no operation) option. These changes are applied when you enter the <code>satellite-maintain upgrade</code> command in a following step.</p>
</div>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Add the following line to the <code>/etc/httpd/conf/httpd.conf</code> configuration file.</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">Include /etc/httpd/conf.modules.d/*.conf</pre>
</div>
</div>
</li>
<li>
<p>Restart the <code>httpd</code> service.</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># systemctl restart httpd</pre>
</div>
</div>
</li>
<li>
<p>Start the <code>postgresql</code> and <code>rh-mongodb34-mongod</code> database services.</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># systemctl start postgresql
# systemctl start rh-mongodb34-mongod</pre>
</div>
</div>
</li>
<li>
<p>Enter the <code>satellite-installer</code> command with the <code>--noop</code> option:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># satellite-installer --scenario satellite --verbose --noop</pre>
</div>
</div>
<div class="paragraph">
<p>Review the <code>/var/log/foreman-installer/satellite.log</code> to preview the changes that are applied during the upgrade. Locate the <code>+++</code> and <code>---</code> symbols that indicate the changes to the configurations files. Although entering the <code>satellite-installer</code> command with the <code>--noop</code> option does not apply any changes to your Satellite, some Puppet resources in the module expect changes to be applied and might display failure messages.</p>
</div>
</li>
<li>
<p>Stop the <code>satellite-maintain</code> services:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># satellite-maintain service stop</pre>
</div>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>Because of the lengthy upgrade time, use a utility such as <code>screen</code> to suspend and reattach a communication session. You can then check the upgrade progress without staying connected to the command shell continuously. For more information about using the screen command, see <a href="https://access.redhat.com/articles/5247">How do I use the screen command?</a> article in the <em>Red&#160;Hat Knowledge&#160;Base</em>.</p>
<div class="paragraph">
<p>If you lose connection to the command shell where the upgrade command is running you can see the logs in <code>/var/log/foreman-installer/satellite.log</code> to check if the process completed successfully.</p>
</div>
</li>
<li>
<p>Check the available versions to confirm the version you want is listed:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># satellite-maintain upgrade list-versions</pre>
</div>
</div>
</li>
<li>
<p>Use the health check option to determine if the system is ready for upgrade. When prompted, enter the hammer admin user credentials to configure <code>satellite-maintain</code> with hammer credentials. These changes are applied to the <code>/etc/foreman-maintain/foreman-maintain-hammer.yml</code> file.</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># satellite-maintain upgrade check --target-version 6.10 \
--whitelist="repositories-validate,repositories-setup"</pre>
</div>
</div>
<div class="paragraph">
<p>Review the results and address any highlighted error conditions before performing the upgrade.</p>
</div>
</li>
<li>
<p>Perform the upgrade:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># satellite-maintain upgrade run --target-version 6.10 \
--whitelist="repositories-validate,repositories-setup"</pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
<div class="paragraph">
<p>If you run the command from a directory containing a <strong><em>config</em></strong> subdirectory, you will encounter the following error:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">ERROR: Scenario (config/satellite.yaml) was not found, can not continue.</pre>
</div>
</div>
<div class="paragraph">
<p>In such a case, change directory, for example to the <strong><em>root</em></strong> user&#8217;s home directory, and run the command again.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>If the script fails due to missing or outdated packages, you must download and install these separately. For more information, see the <a href="https://access.redhat.com/documentation/en-us/red_hat_satellite/6.10/html-single/installing_satellite_server_from_a_disconnected_network/installing-satellite-server-disconnected#resolving-package-dependency-errors_satellite">Resolving Package Dependency Errors</a> section in the <em>Installing Satellite&#160;Server from a Disconnected Network</em> guide.</p>
</div>
</li>
<li>
<p>If using a BASH shell, after a successful or failed upgrade, enter:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># hash -d satellite-maintain service 2> /dev/null</pre>
</div>
</div>
</li>
<li>
<p>If you have migrated content from Pulp 2 to Pulp 3, remove all Pulp 2 content:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># satellite-maintain content remove-pulp2</pre>
</div>
</div>
<div class="paragraph">
<p>This removes uploaded and synchronized Pulp 2 packages, content in <code>/var/lib/pulp/content/</code>, MongoDB, and migration content in the Pulp 3 database.</p>
</div>
</li>
<li>
<p>Check when the kernel packages were last updated:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># rpm -qa --last | grep kernel</pre>
</div>
</div>
</li>
<li>
<p>Optional: If a kernel update occurred since the last reboot, stop the <code>satellite-maintain</code> services and reboot the system:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># satellite-maintain service stop
# reboot</pre>
</div>
</div>
</li>
<li>
<p>Optional: If you made manual edits to DNS or DHCP configuration files, check and restore any changes required to the DNS and DHCP configuration files using the backups that you made.</p>
</li>
<li>
<p>If you make changes in the previous step, restart the <code>satellite-maintain</code> services.</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># satellite-maintain service restart</pre>
</div>
</div>
</li>
<li>
<p>If you have the OpenSCAP plug-in installed, but do not have the default OpenSCAP content available, enter the following command.</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># foreman-rake foreman_openscap:bulk_upload:default</pre>
</div>
</div>
</li>
<li>
<p>In the Satellite web UI, go to <strong>Configure</strong> &gt; <strong>Discovery Rules</strong> and associate selected organizations and locations with discovery rules.</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect2">
<h3 id="synchronizing_the_new_repositories">3.2. Synchronizing the New Repositories</h3>
<div class="paragraph">
<p>You must enable and synchronize the new 6.10 repositories before you can upgrade Capsule&#160;Servers and Satellite clients.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>In the Satellite web UI, navigate to <strong>Content</strong> &gt; <strong>Red&#160;Hat Repositories</strong>.</p>
</li>
<li>
<p>Toggle the <strong>Recommended Repositories</strong> switch to the <strong>On</strong> position.</p>
</li>
<li>
<p>From the list of results, expand the following repositories and click the <strong>Enable</strong> icon to enable the repositories:</p>
<div class="ulist">
<ul>
<li>
<p>To upgrade Satellite clients, enable the <strong>Red&#160;Hat Satellite Tools 6.10</strong> repositories for all Red&#160;Hat Enterprise Linux versions that clients use.</p>
</li>
<li>
<p>If you have Capsule&#160;Servers, to upgrade them, enable the following repositories too:</p>
<div class="paragraph">
<p><strong>Red&#160;Hat Satellite Capsule 6.10 (for RHEL 7 Server) (RPMs)</strong></p>
</div>
<div class="paragraph">
<p><strong>Red&#160;Hat Satellite Maintenance 6 (for RHEL 7 Server) (RPMs)</strong></p>
</div>
<div class="paragraph">
<p><strong>Red&#160;Hat Ansible Engine 2.9 RPMs for Red Hat Enterprise Linux 7 Server</strong></p>
</div>
<div class="paragraph">
<p><strong>Red&#160;Hat Software Collections RPMs for Red&#160;Hat Enterprise Linux 7 Server</strong></p>
</div>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>If the 6.10 repositories are not available, refresh the Subscription Manifest. Navigate to <strong>Content</strong> &gt; <strong>Subscriptions</strong>, click <strong>Manage Manifest</strong>, then click <strong>Refresh</strong>.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Navigate to <strong>Content</strong> &gt; <strong>Sync Status</strong>.</p>
</li>
<li>
<p>Click the arrow next to the product to view the available repositories.</p>
</li>
<li>
<p>Select the repositories for 6.10.</p>
</li>
<li>
<p>Click <strong>Synchronize Now</strong>.</p>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
<div class="paragraph">
<p>If an error occurs when you try to synchronize a repository, refresh the manifest. If the problem persists, raise a support request. Do not delete the manifest from the Customer Portal or in the Satellite web UI; this removes all the entitlements of your content hosts.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
<li>
<p>If you use Content Views to control updates to the base operating system of Capsule&#160;Server, update those Content Views with new repositories, publish, and promote their updated versions. For more information, see <a href="https://access.redhat.com/documentation/en-us/red_hat_satellite/6.10/html-single/content_management_guide/index#Managing_Content_Views">Managing Content Views</a> in the <em>Content Management Guide</em>.</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="upgrading_capsule_server">3.3. Upgrading Capsule&#160;Servers</h3>
<div class="paragraph">
<p>This section describes how to upgrade Capsule&#160;Servers from 6.9 to 6.10.</p>
</div>
<div class="ulist">
<div class="title">Before You Begin</div>
<ul>
<li>
<p>You must upgrade Satellite&#160;Server before you can upgrade any Capsule&#160;Servers. Note that you can upgrade Capsules separately from Satellite. For more information, see <a href="#upgrading_capsules-separately-from-satellite_upgrade-guide">Upgrading Capsules Separately from Satellite</a>.</p>
</li>
<li>
<p>Ensure the Red&#160;Hat Satellite Capsule 6.10 repository is enabled in Satellite&#160;Server and synchronized.</p>
</li>
<li>
<p>Ensure that you synchronize the required repositories on Satellite&#160;Server. For more information, see <a href="#synchronizing_the_new_repositories">Synchronizing the New Repositories</a>.</p>
</li>
<li>
<p>If you use Content Views to control updates to the base operating system of Capsule&#160;Server, update those Content Views with new repositories and publish their updated versions. For more information, see <a href="https://access.redhat.com/documentation/en-us/red_hat_satellite/6.10/html-single/content_management_guide/index#Managing_Content_Views">Managing Content Views</a> in the <em>Content Management Guide</em>.</p>
</li>
<li>
<p>Ensure the Capsule&#8217;s base system is registered to the newly upgraded Satellite&#160;Server.</p>
</li>
<li>
<p>Ensure the Capsule has the correct organization and location settings in the newly upgraded Satellite&#160;Server.</p>
</li>
<li>
<p>Review and update your firewall configuration prior to upgrading your Capsule&#160;Server. For more information, see <a href="https://access.redhat.com/documentation/en-us/red_hat_satellite/6.10/html-single/installing_capsule_server/index#preparing-environment-for-capsule-installation">Preparing Your Environment for Capsule Installation</a> in <em>Installing Capsule&#160;Server</em>.</p>
</li>
</ul>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
<div class="paragraph">
<p>If you implemented custom certificates, you must retain the content of both the <code>/root/ssl-build</code> directory and the directory in which you created any source files associated with your custom
certificates.</p>
</div>
<div class="paragraph">
<p>Failure to retain these files during an upgrade causes the upgrade to fail. If
these files have been deleted, they must be restored from a backup in order for
the upgrade to proceed.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="olist arabic">
<div class="title">Upgrading Capsule&#160;Servers</div>
<ol class="arabic">
<li>
<p>Create a backup.</p>
<div class="ulist">
<ul>
<li>
<p>On a virtual machine, take a snapshot.</p>
</li>
<li>
<p>On a physical machine, create a backup.</p>
<div class="paragraph">
<p>For information on backups, see <a href="https://access.redhat.com/documentation/en-us/red_hat_satellite/6.10/html-single/administering_red_hat_satellite/index#backing-up-satellite-server-and-capsule-server">Backing Up Satellite&#160;Server and Capsule&#160;Server</a> in the <em>Administering Red&#160;Hat Satellite 6.9</em> guide.</p>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>Clean yum cache:</p>
<div class="listingblock">
<div class="content">
<pre># yum clean metadata</pre>
</div>
</div>
</li>
<li>
<p>Ensure that the <code>rubygem-foreman_maintain</code> package that provides <code>satellite-maintain</code> is installed and up to date:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># yum install rubygem-foreman_maintain</pre>
</div>
</div>
</li>
<li>
<p>On Capsule&#160;Server, verify that the <code>foreman_url</code> setting points to the Satellite FQDN:</p>
<div class="listingblock">
<div class="content">
<pre># grep foreman_url /etc/foreman-proxy/settings.yml</pre>
</div>
</div>
</li>
<li>
<p>Ensure that the <code>apache::purge_configs: false</code> entry is either not present or commented out in the <code>/etc/foreman-installer/custom-hiera.yaml</code> file of the Satellite 6.9/Capsule 6.9 servers which will be upgraded to 6.10.</p>
</li>
<li>
<p>Check the available versions to confirm the version you want is listed:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># satellite-maintain upgrade list-versions</pre>
</div>
</div>
</li>
<li>
<p>Because of the lengthy upgrade time, use a utility such as <code>screen</code> to suspend and reattach a communication session. You can then check the upgrade progress without staying connected to the command shell continuously. For more information about using the screen command, see <a href="https://access.redhat.com/articles/5247">How do I use the screen command?</a> article in the <em>Red&#160;Hat Knowledge&#160;Base</em>.</p>
<div class="paragraph">
<p>If you lose connection to the command shell where the upgrade command is running you can see the logged messages in the <code>/var/log/foreman-installer/satellite.log</code> file to check if the process completed successfully.</p>
</div>
</li>
<li>
<p>Use the health check option to determine if the system is ready for upgrade:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># satellite-maintain upgrade check --target-version 6.10</pre>
</div>
</div>
<div class="paragraph">
<p>Review the results and address any highlighted error conditions before performing the upgrade.</p>
</div>
</li>
<li>
<p>Perform the upgrade:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># satellite-maintain upgrade run --target-version 6.10</pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
<div class="paragraph">
<p>If you run the command from a directory containing a <strong><em>config</em></strong> subdirectory, you will encounter the following error:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">ERROR: Scenario (config/capsule.yaml) was not found, can not continue.</pre>
</div>
</div>
<div class="paragraph">
<p>In such a case, change directory, for example to the <strong><em>root</em></strong> user&#8217;s home directory, and run the command again.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
<li>
<p>If you have migrated content from Pulp 2 to Pulp 3, remove all Pulp 2 content.</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># satellite-maintain content remove-pulp2</pre>
</div>
</div>
<div class="paragraph">
<p>This removes Pulp 2 RPMs, content in <code>/var/lib/pulp/content/</code>, the mongo database, and migration content in the Pulp 3 database.</p>
</div>
</li>
<li>
<p>Check when the kernel packages were last updated:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># rpm -qa --last | grep kernel</pre>
</div>
</div>
</li>
<li>
<p>Optional: If a kernel update occurred since the last reboot, reboot the system:</p>
<div class="listingblock">
<div class="content">
<pre># reboot</pre>
</div>
</div>
</li>
<li>
<p>Optional: If you made manual edits to DNS or DHCP configuration files, check and restore any changes required to the DNS and DHCP configuration files using the backups made earlier.</p>
</li>
<li>
<p>Optional: If you use custom repositories, ensure that you enable these custom repositories after the upgrade completes.</p>
</li>
<li>
<p>On Satellite&#160;Server, perform a complete synchronization of the upgraded Capsule as the MongoDB and RPM repositories are not automatically migrated with Satellite.</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># hammer capsule content synchronize --name ${Capsule} --skip-metadata-check true --async</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>If you did not synchronize your repositories before upgrading your Satellite&#160;Server, running this command fails to synchronize your content with Capsule&#160;Servers.
In this case, follow <a href="#synchronizing-capsule-servers-through-satellite-web-ui_upgrade-guide">Synchronizing Capsule&#160;Servers Through Satellite Web UI</a> to synchronize your Capsule&#160;Servers.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
</ol>
</div>
<div class="olist arabic">
<div class="title">Upgrading Capsule Servers Using Remote Execution in the Satellite web UI</div>
<ol class="arabic">
<li>
<p>Create a backup.</p>
<div class="ulist">
<ul>
<li>
<p>On a virtual machine, take a snapshot.</p>
</li>
<li>
<p>On a physical machine, create a backup.</p>
<div class="paragraph">
<p>For information on backups, see <a href="https://access.redhat.com/documentation/en-us/red_hat_satellite/6.10/html-single/administering_red_hat_satellite/index#backing-up-satellite-server-and-capsule-server">Backing Up Satellite&#160;Server and Capsule&#160;Server</a> in the <em>Administering Red&#160;Hat Satellite 6.9</em> guide.</p>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>Optional: If you made manual edits to DNS or DHCP configuration in the <code>/etc/zones.conf</code> or <code>/etc/dhcp/dhcpd.conf</code> files, back up the configuration files because the installer only supports one domain or subnet, and therefore restoring changes from these backups might be required.</p>
</li>
<li>
<p>Optional: If you made manual edits to DNS or DHCP configuration files and do not want to overwrite the changes, enter the following command:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># {foreman-installer} --foreman-proxy-dns-managed=false \
--foreman-proxy-dhcp-managed=false</pre>
</div>
</div>
</li>
<li>
<p>In the Satellite web UI, navigate to <strong>Monitor</strong> &gt; <strong>Jobs</strong>.</p>
</li>
<li>
<p>Click <strong>Run Job</strong>.</p>
</li>
<li>
<p>From the <strong>Job category</strong> list, select <strong>Maintenance Operations</strong>.</p>
</li>
<li>
<p>From the <strong>Job template</strong> list, select <strong>Capsule Upgrade Playbook</strong>.</p>
</li>
<li>
<p>In the <strong>Search Query</strong> field, enter the host name of the Capsule.</p>
</li>
<li>
<p>Ensure that <strong>Resolves to</strong> shows <strong>1 host</strong>.</p>
</li>
<li>
<p>In the <strong>target_version</strong> field, enter the target version of the Capsule.</p>
</li>
<li>
<p>In the <strong>whitelist_options</strong> field, enter the whitelist options.</p>
</li>
<li>
<p>For <strong>Type of query</strong>, click <strong>Static Query</strong> or <strong>Dynamic Query</strong> depending on the type of query.</p>
</li>
<li>
<p>Select the schedule for the job execution in <strong>Schedule</strong>.</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="synchronizing-capsule-servers-through-satellite-web-ui_upgrade-guide">3.4. Synchronizing Capsule&#160;Servers Through Satellite Web UI</h3>
<div class="paragraph">
<p>Use this procedure if you did not synchronize your repositories before upgrading your Satellite&#160;Server.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>In the Satellite web UI, navigate to <strong>Infrastructure</strong> &gt; <strong>Capsules</strong>.</p>
</li>
<li>
<p>Click on the name of Capsule&#160;Server you wish to synchronize.</p>
</li>
<li>
<p>Click <strong>Synchronize</strong>.</p>
</li>
<li>
<p>Select <strong>Complete Sync</strong>.</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="upgrading_clients">3.5. Upgrading Satellite Clients</h3>
<div class="paragraph">
<p>The Satellite Tools 6.10 repository provides <code>katello-agent</code> and <code>katello-host-tools</code>, which provide communication services for managing Errata.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
The Katello agent is deprecated and will be removed in a future Satellite version.
Migrate your workloads to use the remote execution feature to update clients remotely.
For more information, see <a href="https://access.redhat.com/documentation/en-us/red_hat_satellite/6.10/html-single/managing_hosts/index#migrating-from-katello-agent-to-remote-execution_managing-hosts">Migrating from Katello Agent to Remote Execution</a> in the <em>Managing Hosts Guide</em>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>For deployments using <code>katello-agent</code> and <strong>goferd</strong>, update all clients to the new version of <code>katello-agent</code>.
For deployments not using <code>katello-agent</code> and <strong>goferd</strong>, update all clients to the new version of <code>katello-host-tools</code>.
Complete this action as soon as possible so that your clients are fully compatible with Satellite&#160;Server.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>You must have upgraded Satellite&#160;Server.</p>
</li>
<li>
<p>You must have enabled the new Satellite Tools 6.10 repositories on the Satellite.</p>
</li>
<li>
<p>You must have synchronized the new repositories in the Satellite.</p>
</li>
<li>
<p>If you have not previously installed <code>katello-agent</code> on your clients and you want to install it, use the manual method.
For more information, see <a href="#upgrading_clients_manually">Upgrade Satellite Clients Manually</a>.</p>
</li>
</ul>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
<div class="paragraph">
<p>If you implemented custom certificates, you must retain the content of both the <code>/root/ssl-build</code> directory and the directory in which you created any source files associated with your custom
certificates.</p>
</div>
<div class="paragraph">
<p>Failure to retain these files during an upgrade causes the upgrade to fail. If
these files have been deleted, they must be restored from a backup in order for
the upgrade to proceed.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="olist arabic">
<div class="title">Upgrade Satellite Clients Using the Bulk Repository Set UI:</div>
<ol class="arabic">
<li>
<p>In the Satellite web UI, navigate to <strong>Hosts</strong> &gt; <strong>Content Hosts</strong> and select the Content Hosts that you want to upgrade.</p>
</li>
<li>
<p>From the <strong>Select Action</strong> list, select <strong>Manage Repository Sets</strong>.</p>
</li>
<li>
<p>From the <strong>Repository Sets Management</strong> list, select the <strong>Red&#160;Hat Satellite Tools 6.9</strong> check box.</p>
</li>
<li>
<p>From the <strong>Select Action</strong> list, select <strong>Override to Disabled</strong>, and click <strong>Done</strong>.</p>
</li>
<li>
<p>When the process completes, on the same set of hosts from the previous steps, from the <strong>Select Action</strong> list, select <strong>Manage Repository Sets</strong>.</p>
</li>
<li>
<p>From the <strong>Repository Sets Management</strong> list, select the <strong>Red Hat Satellite Tools 6.10</strong> check box.</p>
</li>
<li>
<p>From the <strong>Select Action</strong> list, select <strong>Override to Enabled</strong>, and click <strong>Done</strong>.</p>
</li>
<li>
<p>When the process completes, on the same set of hosts from the previous steps, from the <strong>Select Action</strong> list, select <strong>Manage Packages</strong>.</p>
</li>
<li>
<p>In the <strong>Package</strong> search field, enter one of the following options depending on your configuration:</p>
<div class="ulist">
<ul>
<li>
<p>If your deployment uses <code>katello-agent</code> and <strong>goferd</strong>, enter <code>katello-agent</code>.</p>
</li>
<li>
<p>If your deployment does not use <code>katello-agent</code> and <strong>goferd</strong>, enter <code>katello-host-tools</code>.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Until <a href="https://bugzilla.redhat.com/show_bug.cgi?id=1649764">BZ#1649764</a> is resolved, from the <strong>Update</strong> list, you must select <strong>via remote execution</strong>. This is required because if you update the package using the Katello agent, the package update disrupts the communication between the client and Satellite or Capsule&#160;Server, which causes the update to fail. For more information, see <a href="https://access.redhat.com/documentation/en-us/red_hat_satellite/6.10/html-single/managing_hosts/index#configuring-and-setting-up-remote-jobs_managing-hosts">Configuring and Setting Up Remote Jobs</a> in the <em>Managing Hosts</em> guide.</p>
</li>
</ol>
</div>
<div id="upgrading_clients_manually" class="olist arabic">
<div class="title">Upgrade Satellite Clients Manually</div>
<ol class="arabic">
<li>
<p>Log into the client system.</p>
</li>
<li>
<p>Disable the repositories for the previous version of Satellite.</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># subscription-manager repos \
--disable rhel-7-server-satellite-tools-6.9-rpms</pre>
</div>
</div>
</li>
<li>
<p>Enable the Satellite Tools 6.10 repository for this version of Satellite.</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># subscription-manager repos \
--enable=rhel-7-server-satellite-tools-6.10-rpms</pre>
</div>
</div>
</li>
<li>
<p>Depending on your configuration, complete one of the following steps:</p>
<div class="ulist">
<ul>
<li>
<p>If your deployment uses <code>katello-agent</code> and <strong>goferd</strong>, enter the following command to install or upgrade <code>katello-agent</code>:</p>
<div class="listingblock">
<div class="content">
<pre># yum install katello-agent</pre>
</div>
</div>
</li>
<li>
<p>If your deployment does not use <code>katello-agent</code> and <strong>goferd</strong>, enter the following command to install or upgrade <code>katello-host-tools</code>:</p>
<div class="listingblock">
<div class="content">
<pre># yum install katello-host-tools</pre>
</div>
</div>
</li>
</ul>
</div>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_post_upgrade_tasks">4. Post-Upgrade Tasks</h2>
<div class="sectionbody">
<div id="post-upgrade_tasks" class="paragraph">
<p>Some of the procedures in this section are optional. You can choose to perform only those procedures that are relevant to your installation.</p>
</div>
<div class="paragraph">
<p>If you use the PXE-based discovery process, then you must complete the discovery upgrade procedure on Satellite and on any Capsule&#160;Server with hosts that you want to be listed in Satellite on the <strong>Hosts</strong> &gt; <strong>Discovered hosts</strong> page.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The <code>katello-agent</code> is disabled with a new installation of Satellite 6.10, making both the <code>qpidd</code> and <code>qdroutered</code> services unavailable.</p>
</li>
<li>
<p>If Satellite 6.9 is upgraded to Satellite 6.10, the <code>katello-agent</code>, as well as the <code>qpidd</code> and <code>qdroutered</code> services, remain enabled.</p>
</li>
<li>
<p>If you are not using <code>katello-agent</code> and transitioned to remote execution, you can optionally disable the <code>katello-agent</code> as a post-upgrade task for both Satellite 6.10 and Capsule 6.10:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># satellite-installer --foreman-proxy-content-enable-katello-agent false</pre>
</div>
</div>
<div class="sect2">
<h3 id="upgrading_discovery_parent">4.1. Upgrading Discovery</h3>
<div class="paragraph">
<p>This section describes updating the PXELinux template and the boot image passed to hosts that use PXE booting to register themselves with Satellite&#160;Server.</p>
</div>
<div class="paragraph">
<p>From Satellite&#160;6.10, provisioning templates now have a separate association with a subnet, and do not default to using the TFTP Capsule for that subnet. If you create subnets after the upgrade, you must specifically enable the Satellite or a Capsule to provide a proxy service for discovery templates and then configure all subnets with discovered hosts to use a specific <em>template Capsule</em>.</p>
</div>
<div class="paragraph">
<p>During the upgrade, for every subnet with a TFTP proxy enabled, the template Capsule is set to be the same as the TFTP Capsule. After the upgrade, check all subnets to verify this was set correctly.</p>
</div>
<div class="paragraph">
<p>These procedures are not required if you do not use PXE booting of hosts to enable Satellite to discover new hosts.</p>
</div>
<div class="sect3">
<h4 id="upgrading_discovery_satellite">4.1.1. Upgrading Discovery on Satellite&#160;Server</h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Update the Discovery template in the Satellite web UI:</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Navigate to <strong>Hosts</strong> &gt; <strong>Provisioning templates</strong>.</p>
</li>
<li>
<p>On the <code>PXELinux global default</code> line, click <strong>Clone</strong>.</p>
</li>
<li>
<p>Enter a new name for the template in the <strong>Name</strong> field, for example <code>ACME PXE global default</code>.</p>
</li>
<li>
<p>In the template editor field, change the line <code>ONTIMEOUT local</code> to <code>ONTIMEOUT discovery</code> and click <strong>Submit</strong>.</p>
</li>
<li>
<p>Navigate to <strong>Administer</strong> &gt; <strong>Settings</strong>.</p>
</li>
<li>
<p>Locate <code>Global default PXELinux template</code> and click on its <strong>Value</strong>.</p>
</li>
<li>
<p>Select the name of the newly created template from the menu and click the tick button.</p>
</li>
<li>
<p>Navigate to <strong>Hosts</strong> &gt; <strong>Provisioning templates</strong>.</p>
</li>
<li>
<p>Click <strong>Build PXE Default</strong>, then click <strong>OK</strong>.</p>
</li>
</ol>
</div>
</li>
<li>
<p>In the Satellite web UI, go to <strong>Configure</strong> &gt; <strong>Discovery Rules</strong> and associate selected organizations and locations with discovery rules.</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="upgrading_discovery_capsule">4.1.2. Upgrading Discovery on Capsule&#160;Servers</h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Verify that the Foreman Discovery package is current on Satellite&#160;Server.</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># satellite-maintain packages install tfm-rubygem-foreman_discovery</pre>
</div>
</div>
</li>
<li>
<p>If an update occurred in the previous step, restart the <code>satellite-maintain</code> services.</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># satellite-maintain service restart</pre>
</div>
</div>
</li>
<li>
<p>Upgrade the Discovery image on the Satellite Capsule that is either connected to the provisioning network with discovered hosts or provides TFTP services for discovered hosts.</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># satellite-maintain packages install foreman-discovery-image</pre>
</div>
</div>
</li>
<li>
<p>On the same instance, install the package which provides the Proxy service, and then restart <code>foreman-proxy</code> service.</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># satellite-maintain packages install tfm-rubygem-smart_proxy_discovery
# service foreman-proxy restart</pre>
</div>
</div>
</li>
<li>
<p>In the Satellite web UI, go to <strong>Infrastructure</strong> &gt; <strong>Capsules</strong> and verify that the relevant Capsule lists <strong>Discovery</strong> in the features column. Select <strong>Refresh</strong> from the <strong>Actions</strong> drop-down menu if necessary.</p>
</li>
<li>
<p>Go to <strong>Infrastructure</strong> &gt; <strong>Subnets</strong> and for each subnet on which you want to use discovery:</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Click the subnet name.</p>
</li>
<li>
<p>On the <strong>Capsules</strong> tab, ensure the <strong>Discovery Capsule</strong> is set to a Capsule you configured above.</p>
</li>
</ol>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="verify_subnets_have_a_template_capsule">4.1.3. Verifying Subnets have a Template Capsule</h4>
<div class="olist arabic">
<div class="title">Ensure all subnets with discovered hosts have a template Capsule:</div>
<ol class="arabic">
<li>
<p>In the Satellite web UI, navigate to <strong>Infrastructure</strong> &gt; <strong>Subnets</strong>.</p>
</li>
<li>
<p>Select the subnet you want to check.</p>
</li>
<li>
<p>On the <strong>Capsules</strong> tab, ensure a <strong>Template Capsule</strong> has been set for this subnet.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>For more information about configuring subnets with template Capsules, see <a href="https://access.redhat.com/documentation/en-us/red_hat_satellite/6.10/html-single/provisioning_guide/index#configuring-the-discovery-service">Configuring the Discovery Service</a> in the <em>Provisioning Guide</em></p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="upgrading_virt_who">4.2. Upgrading virt-who</h3>
<div class="paragraph">
<p>If virt-who is installed on Satellite&#160;Server or a Capsule&#160;Server, it will be upgraded when they are upgraded. No further action is required. If virt-who is installed elsewhere, it must be upgraded manually.</p>
</div>
<div class="paragraph">
<div class="title">Before You Begin</div>
<p>If virt-who is installed on a host registered to Satellite&#160;Server or a Capsule&#160;Server, first upgrade the host to the latest packages available in the Satellite Tools 6.10 repository. For information about upgrading hosts, see <a href="#upgrading_clients">Upgrading Satellite Clients</a>.</p>
</div>
<div class="olist arabic">
<div class="title">Upgrade virt-who Manually</div>
<ol class="arabic">
<li>
<p>Upgrade virt-who.</p>
<div class="listingblock">
<div class="content">
<pre># yum upgrade virt-who</pre>
</div>
</div>
</li>
<li>
<p>Restart the virt-who service so the new version is activated.</p>
<div class="listingblock">
<div class="content">
<pre># systemctl restart virt-who.service</pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="removing_satellite_tools_repository">4.3. Removing the Previous Version of the Satellite Tools Repository</h3>
<div class="paragraph">
<p>After completing the upgrade to Satellite 6.10, the Red&#160;Hat Satellite Tools 6.9 repository can be removed from Content Views and then disabled.</p>
</div>
<div class="paragraph">
<p>Disable Version 6.9 of the Satellite Tools Repository:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>In the Satellite web UI, navigate to <strong>Content</strong> &gt; <strong>Red Hat Repositories</strong>.</p>
</li>
<li>
<p>In the <strong>Enabled Repositories</strong> area, locate <strong>Red&#160;Hat Satellite Tools 6.9 for RHEL 7 Server RPMs x86_64</strong>.</p>
</li>
<li>
<p>Click the <strong>Disable</strong> icon to the right.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>If the repository is still contained in a Content View then you cannot disable it. Packages from a disabled repository are removed automatically by a scheduled task.</p>
</div>
</div>
<div class="sect2">
<h3 id="reclaiming-postgresql-space-after-an-upgrade_upgrade-guide">4.4. Reclaiming PostgreSQL Space</h3>
<div class="paragraph">
<p>The PostgreSQL database can use a large amount of disk space especially in heavily loaded deployments.
Use this procedure to reclaim some of this disk space on Satellite.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Stop all services, except for the <code>postgresql</code> service:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># satellite-maintain service stop --exclude postgresql</pre>
</div>
</div>
</li>
<li>
<p>Switch to the <code>postgres</code> user and reclaim space on the database:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># su - postgres -c 'vacuumdb --full --dbname=foreman'</pre>
</div>
</div>
</li>
<li>
<p>Start the other services when the vacuum completes:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># satellite-maintain service start</pre>
</div>
</div>
</li>
<li>
<p>Confirm that the files exist in the <code>/var/lib/pgsql/</code> directory:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># ls -l /var/lib/pgsql/

# du -sh /var/lib/pgsql/</pre>
</div>
</div>
</li>
<li>
<p>Delete the data from the <code>/var/lib/pgsql/</code> directory:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># rm -rf /var/lib/pgsql/*</pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="post_upgrade-updating-templates-parameters">4.5. Updating Templates, Parameters, Lookup Keys and Values</h3>
<div class="paragraph">
<p>During the upgrade process, Satellite attempts to locate macros that are deprecated for Satellite 6.10 and converts old syntax to new syntax for the default Satellite templates, parameters, and lookup keys and values. However, Satellite does not convert old syntax in the custom templates that you have created and in the cloned templates.</p>
</div>
<div class="paragraph">
<p>The process uses simple text replacement, for example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>@host.params['parameter1'] -&gt; host_param('parameter1')
@host.param_true?('parameter1') -&gt; host_param_true?('parameter1')
@host.param_false?('parameter1') -&gt; host_param_false?('parameter1')
@host.info['parameters'] -&gt; host_enc['parameters']</pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
If you use cloned templates in Satellite, verify whether the cloned templates have diverged from the latest version of the original templates in Satellite. The syntax for the same template can differ between versions of Satellite. If your cloned templates contain outdated syntax, update the syntax to match the latest version of the template.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>To ensure that this text replacement does not break or omit any variables in your files during the upgrade, check all templates, parameters, and lookup keys and values for the old syntax and replace manually.</p>
</div>
<div class="paragraph">
<p>The following error occurs because of old syntax remaining in files after the upgrade:</p>
</div>
<div class="listingblock">
<div class="content">
<pre> undefined method '#params' for Host::Managed::Jail</pre>
</div>
</div>
<div class="paragraph">
<div class="title">Fixing the outdated subscription_manager_registration snippet</div>
<p>Satellite 6.4 onwards uses the <code>redhat_register</code> snippet instead of the <code>subscription_manager_registration</code> snippet.</p>
</div>
<div class="paragraph">
<p>If you upgrade from Satellite 6.3 and earlier, ensure to replace the <code>subscription_manager_registration</code> snippet in your custom templates as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>&lt;%= snippet "subscription_manager_registration" %&gt;
               ↓
&lt;%= snippet 'redhat_register' %&gt;</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="tuning-with-predefined-profiles_upgrade-guide">4.6. Tuning Satellite&#160;Server with Predefined Profiles</h3>
<div class="paragraph">
<p>If your Satellite deployment includes more than 5000 hosts, you can use predefined tuning profiles to improve performance of Satellite.</p>
</div>
<div class="paragraph">
<p>Note that you cannot use tuning profiles on Capsules.</p>
</div>
<div class="paragraph">
<p>You can choose one of the profiles depending on the number of hosts your Satellite manages and available hardware resources.</p>
</div>
<div class="paragraph">
<p>The tuning profiles are available in the <code>/usr/share/foreman-installer/config/foreman.hiera/tuning/sizes</code> directory.</p>
</div>
<div class="paragraph">
<p>When you run the <code>satellite-installer</code> command with the <code>--tuning</code> option, deployment configuration settings are applied to Satellite in the following order:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>The default tuning profile defined in the <code>/usr/share/foreman-installer/config/foreman.hiera/tuning/common.yaml</code> file</p>
</li>
<li>
<p>The tuning profile that you want to apply to your deployment and is defined in the <code>/usr/share/foreman-installer/config/foreman.hiera/tuning/sizes/</code> directory</p>
</li>
<li>
<p>Optional: If you have configured a <code>/etc/foreman-installer/custom-hiera.yaml</code> file, Satellite applies these configuration settings.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Note that the configuration settings that are defined in the <code>/etc/foreman-installer/custom-hiera.yaml</code> file override the configuration settings that are defined in the tuning profiles.</p>
</div>
<div class="paragraph">
<p>Therefore, before applying a tuning profile, you must compare the configuration settings that are defined in the default tuning profile in <code>/usr/share/foreman-installer/config/foreman.hiera/tuning/common.yaml</code>, the tuning profile that you want to apply and your <code>/etc/foreman-installer/custom-hiera.yaml</code> file, and remove any duplicated configuration from the <code>/etc/foreman-installer/custom-hiera.yaml</code> file.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">default</dt>
<dd>
<p>Number of managed hosts: 0-5000</p>
<div class="paragraph">
<p>RAM: 20G</p>
</div>
<div class="paragraph">
<p>Number of CPU cores: 4</p>
</div>
</dd>
<dt class="hdlist1">medium</dt>
<dd>
<p>Number of managed hosts: 5001-10000</p>
<div class="paragraph">
<p>RAM: 32G</p>
</div>
<div class="paragraph">
<p>Number of CPU cores: 8</p>
</div>
</dd>
<dt class="hdlist1">large</dt>
<dd>
<p>Number of managed hosts: 10001-20000</p>
<div class="paragraph">
<p>RAM: 64G</p>
</div>
<div class="paragraph">
<p>Number of CPU cores: 16</p>
</div>
</dd>
<dt class="hdlist1">extra-large</dt>
<dd>
<p>Number of managed hosts: 20001-60000</p>
<div class="paragraph">
<p>RAM: 128G</p>
</div>
<div class="paragraph">
<p>Number of CPU cores: 32</p>
</div>
</dd>
<dt class="hdlist1">extra-extra-large</dt>
<dd>
<p>Number of managed hosts: 60000+</p>
<div class="paragraph">
<p>RAM: 256G</p>
</div>
<div class="paragraph">
<p>Number of CPU cores: 48+</p>
</div>
</dd>
</dl>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Optional: If you have configured the <code>custom-hiera.yaml</code> file on Satellite&#160;Server, back up the <code>/etc/foreman-installer/custom-hiera.yaml</code> file to <code>custom-hiera.original</code>.
You can use the backup file to restore the <code>/etc/foreman-installer/custom-hiera.yaml</code> file to its original state if it becomes corrupted:</p>
<div class="listingblock">
<div class="content">
<pre># cp /etc/foreman-installer/custom-hiera.yaml \
/etc/foreman-installer/custom-hiera.original</pre>
</div>
</div>
</li>
<li>
<p>Optional: If you have configured the <code>custom-hiera.yaml</code> file on Satellite&#160;Server, review the definitions of the default tuning profile in <code>/usr/share/foreman-installer/config/foreman.hiera/tuning/common.yaml</code> and the tuning profile that you want to apply in <code>/usr/share/foreman-installer/config/foreman.hiera/tuning/sizes/</code>.
Compare the configuration entries against the entries in your <code>/etc/foreman-installer/custom-hiera.yaml</code> file and remove any duplicated configuration settings in your <code>/etc/foreman-installer/custom-hiera.yaml</code> file.</p>
</li>
<li>
<p>Enter the <code>satellite-installer</code> command with the <code>--tuning</code> option for the profile that you want to apply.
For example, to apply the medium tuning profile settings, enter the following command:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># satellite-installer --tuning medium</pre>
</div>
</div>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_updating_satelliteserver_capsuleserver_and_content_hosts">5. Updating Satellite&#160;Server, Capsule&#160;Server, and Content Hosts</h2>
<div class="sectionbody">
<div id="introduction_updating_satellite" class="paragraph">
<p>Use this chapter to update your existing Satellite&#160;Server, Capsule&#160;Server, and Content Hosts to a new minor version, for example, from 6.10.0 to 6.10.1.</p>
</div>
<div class="paragraph">
<p>Updates patch security vulnerabilities and minor issues discovered after code is released, and are often fast and non-disruptive to your operating environment.</p>
</div>
<div class="paragraph">
<p>Before updating, back up your Satellite&#160;Server and all Capsule&#160;Servers. For more information, see <a href="https://access.redhat.com/documentation/en-us/red_hat_satellite/6.10/html-single/administering_red_hat_satellite/index#backing-up-satellite-server-and-capsule-server">Backing Up Satellite&#160;Server and Capsule&#160;Server</a> in the <em>Administering Red&#160;Hat Satellite</em> guide.</p>
</div>
<div class="sect2">
<h3 id="updating_satellite_server_to_next_minor_version">5.1. Updating Satellite&#160;Server</h3>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>Ensure that you have synchronized Satellite&#160;Server repositories for
Satellite, Capsule, and Satellite Tools 6.10.</p>
</li>
<li>
<p>Ensure each external Capsule and Content Host can be updated by
promoting the updated repositories to all relevant Content Views.</p>
</li>
</ul>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
If you customize configuration files, manually or use a tool such as Hiera, these customizations are overwritten when the installation script runs during upgrading or updating. You can use the <code>--noop</code> option with the satellite-installer script to test for changes. For more information, see the Red Hat Knowledgebase solution <a href="https://access.redhat.com/solutions/3351311">How to use the noop option to check for changes in Satellite config files during an upgrade</a>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><strong>Updating Satellite&#160;Server to the Next Minor Version</strong></p>
</div>
<div class="olist arabic">
<div class="title">To Update Satellite&#160;Server:</div>
<ol class="arabic">
<li>
<p>Ensure the Satellite Maintenance repository is enabled:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># subscription-manager repos --enable \
rhel-7-server-satellite-maintenance-6-rpms</pre>
</div>
</div>
</li>
<li>
<p>Check the available versions to confirm the next minor version is listed:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># satellite-maintain upgrade list-versions</pre>
</div>
</div>
</li>
<li>
<p>Use the health check option to determine if the system is ready for upgrade. On first use of this command, <code>satellite-maintain</code> prompts you to enter the hammer admin user credentials and saves them in the <code>/etc/foreman-maintain/foreman-maintain-hammer.yml</code> file.</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># satellite-maintain upgrade check --target-version 6.10.<em>z</em></pre>
</div>
</div>
<div class="paragraph">
<p>Review the results and address any highlighted error conditions before performing the upgrade.</p>
</div>
</li>
<li>
<p>Because of the lengthy update time, use a utility such as <code>screen</code> to suspend and reattach a communication session. You can then check the upgrade progress without staying connected to the command shell continuously. For more information about using the screen command, see <a href="https://access.redhat.com/articles/5247">How do I use the screen command?</a> article in the <em>Red&#160;Hat Knowledge&#160;Base</em>.</p>
<div class="paragraph">
<p>If you lose connection to the command shell where the upgrade command is running, you can see the logged messages in the <code>/var/log/foreman-installer/satellite.log</code> file to check if the process completed successfully.</p>
</div>
</li>
<li>
<p>Perform the upgrade:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># satellite-maintain upgrade run --target-version 6.10.<em>z</em></pre>
</div>
</div>
</li>
<li>
<p>Check when the kernel packages were last updated:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># rpm -qa --last | grep kernel</pre>
</div>
</div>
</li>
<li>
<p>Optional: If a kernel update occurred since the last reboot, stop the <code>satellite-maintain</code> services and reboot the system:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># satellite-maintain service stop
# reboot</pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_updating_disconnected_satelliteserver">5.2. Updating Disconnected Satellite&#160;Server</h3>
<div class="paragraph">
<p>This section describes the steps needed to update in an Air-gapped Disconnected setup where the connected Satellite&#160;Server (which synchronizes content from CDN) is air gapped from a disconnected Satellite&#160;Server.</p>
</div>
<div class="paragraph">
<p>Complete the following steps on the connected Satellite&#160;Server.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Ensure that you have synchronized the following repositories in your connected Satellite&#160;Server.</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">rhel-7-server-ansible-2.9-rpms
rhel-7-server-rpms
rhel-7-server-satellite-6.10-rpms
rhel-7-server-satellite-maintenance-6-rpms
rhel-server-rhscl-7-rpms</pre>
</div>
</div>
</li>
<li>
<p>Download the debug certificate of the organization and store it locally at, for example, <code>/etc/pki/katello/certs/org-debug-cert.pem</code> or a location of your choosing.</p>
</li>
<li>
<p>Create a Yum configuration file under <code>/etc/yum.repos.d</code> with the following repository information:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">[rhel-7-server-ansible-2.9-rpms]
name=Ansible 2.9 RPMs for Red Hat Enterprise Linux 7 Server x86_64
baseurl=https://satellite.example.com/pulp/content/My_Organization/Library/content/dist/rhel/server/7/$releasever/$basearch/ansible/2.9/os/
enabled=1
sslclientcert = /etc/pki/katello/certs/org-debug-cert.pem
sslclientkey = /etc/pki/katello/certs/org-debug-cert.pem
sslcacert = /etc/pki/katello/certs/katello-server-ca.crt
sslverify = 1

[rhel-7-server-rpms]
name=Red Hat Enterprise Linux 7 Server RPMs x86_64
baseurl=https://satellite.example.com/pulp/content/My_Organization/Library/content/dist/rhel/server/7/7Server/x86_64/os/
enabled=1
sslclientcert = /etc/pki/katello/certs/org-debug-cert.pem
sslclientkey = /etc/pki/katello/certs/org-debug-cert.pem
sslcacert = /etc/pki/katello/certs/katello-server-ca.crt
sslverify = 1

[rhel-7-server-satellite-6.10-rpms]
name=Red&#160;Hat Satellite&#160;6 for RHEL 7 Server RPMs x86_64
baseurl=https://satellite.example.com/pulp/content/My_Organization/Library/content/dist/rhel/server/7/7Server/x86_64/satellite/6.10/os/
enabled=1
sslclientcert = /etc/pki/katello/certs/org-debug-cert.pem
sslclientkey = /etc/pki/katello/certs/org-debug-cert.pem
sslcacert = /etc/pki/katello/certs/katello-server-ca.crt

[rhel-7-server-satellite-maintenance-6-rpms]
name=Red&#160;Hat Satellite Maintenance 6 for RHEL 7 Server RPMs x86_64
baseurl=https://satellite.example.com/pulp/content/My_Organization/Library/content/dist/rhel/server/7/7Server/x86_64/sat-maintenance/6/os/
enabled=1
sslclientcert = /etc/pki/katello/certs/org-debug-cert.pem
sslclientkey = /etc/pki/katello/certs/org-debug-cert.pem
sslcacert = /etc/pki/katello/certs/katello-server-ca.crt
sslverify = 1

[rhel-server-rhscl-7-rpms]
name=Red Hat Software Collections RPMs for Red Hat Enterprise Linux 7 Server x86_64
baseurl=https://satellite.example.com/pulp/content/My_Organization/Library/content/dist/rhel/server/7/7Server/x86_64/rhscl/1/os/
enabled=1
sslclientcert = /etc/pki/katello/certs/org-debug-cert.pem
sslclientkey = /etc/pki/katello/certs/org-debug-cert.pem
sslcacert = /etc/pki/katello/certs/katello-server-ca.crt
sslverify = 1</pre>
</div>
</div>
</li>
<li>
<p>In the configuration file, replace <code>/etc/pki/katello/certs/org-debug-cert.pem</code> in <code>sslclientcert</code> and <code>sslclientkey</code> with the location of the downloaded organization debug certificate.</p>
</li>
<li>
<p>Update <code>satellite.example.com</code> with correct FQDN for your deployment.</p>
</li>
<li>
<p>Replace <code>My_Organization</code> with the correct organization label in the <code>baseurl</code>.
To obtain the organization label, enter the command:</p>
<div class="listingblock">
<div class="content">
<pre># hammer organization list</pre>
</div>
</div>
</li>
<li>
<p>Enter the <code>reposync</code> command:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># reposync --delete --download-metadata -p ~/Satellite-repos -n \
 -r rhel-7-server-ansible-2.9-rpms \
 -r rhel-7-server-rpms \
 -r rhel-7-server-satellite-6.10-rpms \
 -r rhel-7-server-satellite-maintenance-6-rpms \
 -r rhel-server-rhscl-7-rpms</pre>
</div>
</div>
<div class="paragraph">
<p>This downloads the contents of the repositories from the connected Satellite&#160;Server and stores them in the directory <code>~/Satellite-repos</code>.
The <code>reposync</code> command in Red&#160;Hat Enterprise Linux 7 downloads the RPMs but not the Yum metadata.</p>
</div>
<div class="paragraph">
<p>Because of this, you must manually run <code>createrepo</code> in each sub-directory of <code>Satellite-repos</code>. Make sure you have the <code>createrepo</code> rpm installed. If not use the following command to install it.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># satellite-maintain packages install createrepo</pre>
</div>
</div>
<div class="paragraph">
<p>Run the following command to create repodata in each sub-directory of <code>~/Satellite-repos</code>. :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># cd ~/Satellite-repos
# for directory in */
do
  echo "Processing $directory"
  cd $directory
  createrepo .
  cd ..
done</pre>
</div>
</div>
</li>
<li>
<p>Verify that the RPMs have been downloaded and the repository data directory is generated in each of the sub-directories of <code>~/Satellite-repos</code>.</p>
</li>
<li>
<p>Archive the contents of the directory</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># cd ~
# tar czf Satellite-repos.tgz Satellite-repos</pre>
</div>
</div>
</li>
<li>
<p>Use the generated <code>Satellite-repos.tgz</code> file to upgrade in the disconnected Satellite&#160;Server.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Perform the following steps on the disconnected Satellite&#160;Server</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Copy the generated <code>Satellite-repos.tgz</code> file to your disconnected Satellite&#160;Server</p>
</li>
<li>
<p>Extract the archive to anywhere accessible by the <code>root</code> user.
In the following example <code>/root</code> is the extraction location.</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># cd /root
# tar zxf Satellite-repos.tgz</pre>
</div>
</div>
</li>
<li>
<p>Create a Yum configuration file under <code>/etc/yum.repos.d</code> with the following repository information:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">[rhel-7-server-ansible-2.9-rpms]
name=Ansible 2.9 RPMs for Red Hat Enterprise Linux 7 Server x86_64
baseurl=file:///root/Satellite-repos/rhel-7-server-ansible-2.9-rpms
enabled=1

[rhel-7-server-rpms]
name=Red Hat Enterprise Linux 7 Server RPMs x86_64
baseurl=file:///root/Satellite-repos/rhel-7-server-rpms
enabled=1

[rhel-7-server-satellite-6.10-rpms]
name=Red&#160;Hat Satellite&#160;6 for RHEL 7 Server RPMs x86_64
baseurl=file:///root/Satellite-repos/rhel-7-server-satellite-6.10-rpms
enabled=1

[rhel-7-server-satellite-maintenance-6-rpms]
name=Red&#160;Hat Satellite Maintenance 6 for RHEL 7 Server RPMs x86_64
baseurl=file:///root/Satellite-repos/rhel-7-server-satellite-maintenance-6-rpms
enabled=1

[rhel-server-rhscl-7-rpms]
name=Red Hat Software Collections RPMs for Red Hat Enterprise Linux 7 Server x86_64
baseurl=file:///root/Satellite-repos/rhel-server-rhscl-7-rpms
enabled=1</pre>
</div>
</div>
</li>
<li>
<p>In the configuration file, replace the <code>/root/Satellite-repos</code> with the extracted location.</p>
</li>
<li>
<p>Check the available versions to confirm the next minor version is listed:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># satellite-maintain upgrade list-versions</pre>
</div>
</div>
</li>
<li>
<p>Use the health check option to determine if the system is ready for upgrade.
On first use of this command, <code>satellite-maintain</code> prompts you to enter the hammer admin user credentials and saves them in the <code>/etc/foreman-maintain/foreman-maintain-hammer.yml</code> file.</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># satellite-maintain upgrade check --whitelist="check-upstream-repository,repositories-validate" --target-version 6.10.<em>z</em></pre>
</div>
</div>
</li>
<li>
<p>Review the results and address any highlighted error conditions before performing the upgrade.</p>
</li>
<li>
<p>Because of the lengthy update time, use a utility such as <code>screen</code> to suspend and reattach a communication session.
You can then check the upgrade progress without staying connected to the command shell continuously.
For more information about using the screen command, see <a href="https://access.redhat.com/articles/5247">How do I use the screen command?</a> article in the <em>Red&#160;Hat Knowledge&#160;Base</em>.</p>
<div class="paragraph">
<p>If you lose connection to the command shell where the upgrade command is running, you can see the logged messages in the <code>/var/log/foreman-installer/satellite.log</code> file to check if the process completed successfully.</p>
</div>
</li>
<li>
<p>Perform the upgrade:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># satellite-maintain upgrade run --whitelist="check-upstream-repository,repositories-validate" --target-version 6.10.<em>z</em></pre>
</div>
</div>
</li>
<li>
<p>Check when the kernel packages were last updated:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># rpm -qa --last | grep kernel</pre>
</div>
</div>
</li>
<li>
<p>Optional: If a kernel update occurred since the last reboot, stop the <code>satellite-maintain</code> services and reboot the system:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># satellite-maintain service stop
# reboot</pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="updating_capsule_server_to_next_minor_version">5.3. Updating Capsule&#160;Server</h3>
<div class="paragraph">
<p>Use this procedure to update Capsule&#160;Servers to the next minor version.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Ensure that the Satellite Maintenance repository is enabled:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># subscription-manager repos --enable \
rhel-7-server-satellite-maintenance-6-rpms</pre>
</div>
</div>
</li>
<li>
<p>Check the available versions to confirm the next minor version is listed:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># satellite-maintain upgrade list-versions</pre>
</div>
</div>
</li>
<li>
<p>Use the health check option to determine if the system is ready for upgrade:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># satellite-maintain upgrade check --target-version 6.10.<em>z</em></pre>
</div>
</div>
<div class="paragraph">
<p>Review the results and address any highlighted error conditions before performing the upgrade.</p>
</div>
</li>
<li>
<p>Because of the lengthy update time, use a utility such as <code>screen</code> to suspend and reattach a communication session. You can then check the upgrade progress without staying connected to the command shell continuously. For more information about using the screen command, see <a href="https://access.redhat.com/articles/5247">How do I use the screen command?</a> article in the <em>Red&#160;Hat Knowledge&#160;Base</em>.</p>
<div class="paragraph">
<p>If you lose connection to the command shell where the upgrade command is running, you can see the logged messages in the <code>/var/log/foreman-installer/satellite.log</code> file to check if the process completed successfully.</p>
</div>
</li>
<li>
<p>Perform the upgrade:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># satellite-maintain upgrade run --target-version 6.10.<em>z</em></pre>
</div>
</div>
</li>
<li>
<p>Check when the kernel packages were last updated:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># rpm -qa --last | grep kernel</pre>
</div>
</div>
</li>
<li>
<p>Optional: If a kernel update occurred since the last reboot, stop the <code>satellite-maintain</code> services and reboot the system:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># satellite-maintain service stop
# reboot</pre>
</div>
</div>
</li>
</ol>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated Sep 2022
</div>
</div>
</body>
</html>